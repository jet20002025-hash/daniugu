# 内存优化说明

## 问题
Render平台出现502 Bad Gateway错误，可能是内存溢出导致应用崩溃。

## 已实施的优化

### 1. 减少并行线程数
- **修改前**: 100个线程（Render环境）
- **修改后**: 20个线程，最大限制30个
- **位置**: `bull_stock_web.py` 第2266行

### 2. 减少批次大小
- **超级用户**: 从50降到30
- **VIP用户**: 从50降到30  
- **免费用户**: 从20降到15
- **位置**: `bull_stock_web.py` 的 `get_scan_config()` 函数

### 3. Gunicorn Workers配置
- **当前配置**: 2个workers
- **建议**: 如果仍然内存不足，可以降到1个worker

## 如果仍然出现502错误

### 方案1: 减少Gunicorn Workers
修改 `Procfile`:
```
web: gunicorn bull_stock_web:app --bind 0.0.0.0:$PORT --workers 1 --timeout 120 --access-logfile - --error-logfile -
```

### 方案2: 进一步减少并行线程数
修改 `bull_stock_web.py` 第2266行:
```python
default_workers = 10 if is_render else 5  # 进一步降低到10
```

### 方案3: 检查Render日志
1. 登录Render Dashboard
2. 进入服务页面
3. 查看"Logs"标签
4. 查看最新的错误信息

## 内存使用估算

**优化后**:
- Gunicorn: 2 workers × 约100MB = 200MB
- 应用基础内存: 约50MB
- 扫描时峰值: 20线程 × 5MB = 100MB
- **总计**: 约350MB（在512MB限制内）

**如果使用1个worker**:
- Gunicorn: 1 worker × 约100MB = 100MB
- 应用基础内存: 约50MB
- 扫描时峰值: 20线程 × 5MB = 100MB
- **总计**: 约250MB（更安全）

## 性能权衡

减少资源使用可能会影响性能：
- 线程数从100降到20: 速度可能降到原来的1/5
- Workers从2降到1: 并发请求处理能力降低

但考虑到512MB的内存限制，这是必要的权衡。
