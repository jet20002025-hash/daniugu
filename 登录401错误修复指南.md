# 登录 401 错误修复指南

## 问题描述

用户报告 `super` 账户反复出现 401 未授权错误，无法登录。

## 根本原因

1. **密码被强制覆盖**：`init_default_test_users()` 函数在应用启动时会强制将 `super` 用户的密码重置为默认的 `super123`，覆盖了用户通过 `/api/admin/create_super_user` 设置的自定义密码 `superzwj`。

2. **Redis 数据丢失**：在 Render 等云环境中，如果 Redis 连接不稳定或数据被清空，用户数据可能丢失。

3. **启动时初始化顺序**：默认测试用户初始化可能在用户自定义账户创建之前执行，导致密码被覆盖。

## 修复方案

### 1. 保留用户自定义密码

修改了 `user_auth_vercel.py` 和 `user_auth.py` 中的 `init_default_test_users()` 函数：

- **对于 `super` 用户**：如果已存在且密码不是默认的 `super123`，则保留现有密码（不强制覆盖）。
- **对于其他测试用户**：继续使用默认密码，确保测试环境一致性。

```python
# 对于 super 用户，如果密码不是默认的 super123，则保留现有密码（不强制覆盖）
if username == 'super':
    default_password_hash = hash_password(user_config['password'])
    current_password_hash = existing_user.get('password', '')
    
    # 如果当前密码不是默认密码，且不是空，则保留现有密码
    if current_password_hash and current_password_hash != default_password_hash:
        print(f"✅ 保留 super 用户的自定义密码（不覆盖）")
    else:
        # 如果密码是默认密码或为空，则设置为默认密码
        if current_password_hash != default_password_hash:
            existing_user['password'] = default_password_hash
            needs_update = True
```

### 2. 登录时自动恢复机制

在 `login_user()` 函数中添加了自动恢复逻辑：

- **用户不存在**：如果 `super` 用户不存在，自动创建（密码：`superzwj`）。
- **密码不匹配**：如果 `super` 用户密码不匹配，自动修复为 `superzwj`。

```python
# 对于 super 用户，如果不存在，尝试自动创建
if username == 'super':
    print(f"⚠️ super 用户不存在，尝试自动创建...")
    # 自动创建 super 用户，密码为 superzwj
    
# 对于 super 用户，如果密码不匹配，尝试自动修复
if username == 'super' and stored_password_hash:
    print(f"⚠️ super 用户密码不匹配，尝试自动修复...")
    # 自动修复密码为 superzwj
```

### 3. 启动时自动确保账户存在

在 `bull_stock_web.py` 中添加了 `ensure_super_user_exists()` 函数：

- **应用启动时**：自动检查 `super`/`superzwj` 账户是否存在。
- **不存在**：自动创建。
- **密码错误**：自动修复为 `superzwj`。
- **权限错误**：自动修复权限（VIP、超级用户、激活状态）。

```python
def ensure_super_user_exists():
    """确保 super/superzwj 账户存在，如果不存在或密码错误则自动创建/修复"""
    # 检查用户是否存在
    # 如果不存在，创建新用户（密码：superzwj）
    # 如果存在但密码错误，修复密码
    # 如果权限不正确，修复权限
```

### 4. API 登录时的自动恢复

在 `api_login()` 函数中添加了额外的恢复逻辑：

- **登录失败时**：如果 `super` 用户登录失败，尝试自动恢复账户。
- **详细日志**：记录登录失败的具体原因，便于诊断。

```python
# 对于 super 用户登录失败，尝试自动恢复
if username == 'super':
    print(f"⚠️ super 用户登录失败，尝试自动恢复账户...")
    # 尝试创建或修复 super 用户
    # 然后重新尝试登录
```

## 修复效果

1. **密码不再被覆盖**：`super` 用户的自定义密码 `superzwj` 会被保留，不会被 `init_default_test_users()` 覆盖。

2. **自动恢复**：即使账户丢失或密码错误，系统会在登录时或启动时自动恢复。

3. **详细日志**：所有恢复操作都会记录日志，便于排查问题。

4. **多重保障**：
   - 启动时检查
   - 登录时检查
   - API 登录时检查

## 测试步骤

1. **清除浏览器缓存和 Cookie**：
   - Chrome/Edge: `Ctrl+Shift+Delete` → 清除 Cookie 和缓存
   - 或使用无痕模式测试

2. **测试登录**：
   - 用户名：`super`
   - 密码：`superzwj`
   - 应该能够成功登录

3. **检查日志**：
   - 查看服务器日志，确认是否有自动恢复操作
   - 查看是否有 "保留 super 用户的自定义密码" 或 "自动修复 super 用户密码" 的消息

## 预防措施

1. **环境变量**：确保 `FLASK_SECRET_KEY` 环境变量在 Render 中已设置，避免会话失效。

2. **Redis 连接**：确保 `UPSTASH_REDIS_REST_URL` 和 `UPSTASH_REDIS_REST_TOKEN` 环境变量正确配置。

3. **定期备份**：建议定期备份 Redis 中的用户数据。

4. **监控日志**：定期检查服务器日志，关注自动恢复操作的频率。

## 相关文件

- `/Users/zwj/股票分析/user_auth_vercel.py`：Vercel/Render 环境的用户认证模块
- `/Users/zwj/股票分析/user_auth.py`：本地环境的用户认证模块
- `/Users/zwj/股票分析/bull_stock_web.py`：主 Flask 应用，包含登录 API 和启动时检查

## 注意事项

- 自动恢复机制只针对 `super` 用户，其他用户不受影响。
- 如果问题仍然存在，请检查 Redis 连接和 Flask `SECRET_KEY` 配置。
- 如果使用本地环境，确保 `users.json` 文件有写入权限。
