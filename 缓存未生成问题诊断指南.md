# 🔍 缓存未生成问题诊断指南

## ❌ 问题现象

点击"手动刷新缓存"后，仍然显示"⚠️ 缓存未生成"。

---

## 🔍 诊断步骤

### 步骤 1：检查 Vercel 部署日志

1. **登录 Vercel Dashboard**
   - 访问：https://vercel.com/dashboard
   - 选择项目 `daniugu`

2. **查看部署日志**
   - 进入 **Deployments** 页面
   - 点击最新的部署
   - 查看 **Function Logs** 或 **Build Logs**

3. **查找关键日志**

   **应该看到：**
   ```
   ✅ Vercel 环境检测到，已启用 USE_GITHUB_DATA_ONLY 模式
   📥 检测到 Vercel 环境，开始从 GitHub 下载股票数据...
   📥 正在下载: https://github.com/...
   ✅ 下载完成
   📦 正在解压: stock_data.tar.gz
   ✅ 解压完成
   ✅ 数据下载并解压成功！
   📋 正在从K线文件列表生成股票列表...
   ✅ 股票列表生成成功！
   ```

   **如果看到错误：**
   - `❌ 下载失败` → 检查 `STOCK_DATA_URL` 环境变量
   - `❌ 解压失败` → 检查数据包格式
   - `⚠️ 未找到任何K线文件` → 数据包可能未正确解压

### 步骤 2：检查环境变量

1. **在 Vercel Dashboard 检查**
   - 进入 **Settings** → **Environment Variables**
   - 确认 `STOCK_DATA_URL` 已设置
   - 确认 URL 指向正确的 GitHub Releases 数据包

2. **验证 URL 是否可访问**
   - 在浏览器中打开 `STOCK_DATA_URL` 的值
   - 应该能直接下载 `.tar.gz` 文件

### 步骤 3：手动测试刷新缓存 API

1. **访问刷新缓存 API**
   ```
   https://www.daniugu.online/api/refresh_stock_cache?force=true
   ```

2. **查看返回结果**

   **成功时应该看到：**
   ```json
   {
     "success": true,
     "message": "✅ 股票列表缓存已从 K 线文件生成，股票数: XXXX 只\n\n现在可以正常扫描了！",
     "stock_count": XXXX,
     "method": "from_kline_files",
     "is_vercel": true
   }
   ```

   **失败时可能看到：**
   ```json
   {
     "success": false,
     "message": "⚠️ K 线数据文件不存在...",
     "weekly_dir_exists": false,
     "daily_dir_exists": false
   }
   ```

### 步骤 4：检查数据包内容

1. **确认 GitHub Releases 数据包包含：**
   - `cache/daily_kline/` 目录（日K线数据）
   - `cache/weekly_kline/` 目录（周K线数据）
   - 至少有一些 `.csv` 文件

2. **如果数据包不完整：**
   - 重新创建数据包
   - 重新上传到 GitHub Releases
   - 更新 `STOCK_DATA_URL` 环境变量

---

## ✅ 解决方案

### 方案 1：数据包未下载

**症状：** 日志显示 `⚠️ 未设置 STOCK_DATA_URL` 或 `❌ 下载失败`

**解决：**
1. 在 Vercel Dashboard 设置 `STOCK_DATA_URL` 环境变量
2. 确保 URL 指向正确的 GitHub Releases 数据包
3. 重新部署应用

### 方案 2：数据包下载但解压失败

**症状：** 日志显示 `❌ 解压失败`

**解决：**
1. 检查数据包格式（应该是 `.tar.gz`）
2. 确认数据包没有损坏
3. 重新上传数据包到 GitHub Releases

### 方案 3：K 线文件不存在

**症状：** 日志显示 `⚠️ 未找到任何K线文件` 或 `K 线数据文件不存在`

**解决：**
1. 检查数据包是否包含 `cache/daily_kline/` 和 `cache/weekly_kline/` 目录
2. 确认目录中有 `.csv` 文件
3. 如果数据包不完整，重新创建并上传

### 方案 4：生成股票列表失败

**症状：** 日志显示 `⚠️ 从 K 线文件生成股票列表失败`

**解决：**
1. 检查 Vercel Function Logs 中的详细错误信息
2. 可能是文件权限问题或磁盘空间不足
3. 检查 `generate_stock_list_from_files.py` 的日志输出

---

## 🔧 快速修复步骤

### 1. 重新部署并检查日志

```bash
# 在 Vercel Dashboard 中：
1. 进入 Deployments
2. 点击最新部署右侧的 "..." 菜单
3. 选择 "Redeploy"
4. 等待部署完成
5. 查看 Function Logs
```

### 2. 手动触发数据包下载

如果数据包未下载，可以：

1. **检查环境变量**
   - 确认 `STOCK_DATA_URL` 已设置
   - 确认 URL 正确

2. **重新部署**
   - 触发新的部署，系统会自动下载数据包

### 3. 手动触发缓存生成

访问：
```
https://www.daniugu.online/api/refresh_stock_cache?force=true
```

查看返回结果，根据错误信息采取相应措施。

---

## 📋 检查清单

- [ ] `STOCK_DATA_URL` 环境变量已设置
- [ ] GitHub Releases 中有数据包
- [ ] 数据包 URL 可以正常访问
- [ ] Vercel 部署日志显示数据包下载成功
- [ ] Vercel 部署日志显示数据包解压成功
- [ ] `cache/daily_kline/` 目录存在且有文件
- [ ] `cache/weekly_kline/` 目录存在且有文件
- [ ] 刷新缓存 API 返回成功
- [ ] `cache/stock_list_all.json` 文件已生成

---

## 🐛 常见错误及解决方案

### 错误 1：`K 线数据文件不存在`

**原因：** 数据包未下载或解压失败

**解决：**
1. 检查 Vercel 部署日志
2. 确认 `STOCK_DATA_URL` 已设置
3. 重新部署应用

### 错误 2：`生成股票列表失败`

**原因：** K 线文件格式不正确或文件读取错误

**解决：**
1. 检查 K 线文件格式
2. 确认文件没有损坏
3. 查看详细错误日志

### 错误 3：`生成股票列表后，缓存仍为空`

**原因：** 文件保存失败或权限问题

**解决：**
1. 检查 Vercel Function Logs
2. 确认磁盘空间充足
3. 检查文件权限

---

## 📞 需要帮助？

如果按照上述步骤仍然无法解决：

1. **收集信息：**
   - Vercel 部署日志（特别是启动时的日志）
   - 刷新缓存 API 的返回结果
   - 环境变量配置截图

2. **检查关键点：**
   - `STOCK_DATA_URL` 是否正确
   - 数据包是否可以正常下载
   - K 线文件是否存在

3. **提供信息：**
   - 告诉我具体的错误信息
   - 提供 Vercel 日志的关键部分
