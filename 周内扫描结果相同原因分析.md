# 周内扫描结果相同原因分析

## 现象

每周 **周日、周一、周二、周三、周四** 扫到的数据**一模一样**（选股列表、匹配度、最佳买点日期相同），**只有股价不一样**。

## 根本原因

### 1. 扫描用的是 **周 K 线**，不是日 K 线

- 特征提取、匹配度计算、买点判断，全部基于 **周 K 线**。
- 周 K 的「日期」= **该周结束日**（一般为 **周五**）。

### 2. 截断规则（严格 as-of，不偷看未来）

代码逻辑（`_process_single_stock` / `_scan_stock_batch_serial`）：

```
只保留 周K日期 <= 扫描日期(scan_date) 的周
即：w = w[w['__dt'] <= scan_ts]
```

- **周一～周四**：  
  当前周的周 K 日期 = **本周五**，  
  `scan_date`（周一～周四）< 本周五 → 当前周的周 K **被排除**。  
  → 实际用的「最后一周」= **上一完整周**（上周五结束的那根周 K）。

- 因此：**同一周内的周一、周二、周三、周四**，用的都是 **同一根「最后一周」**  
  → 特征相同 → 匹配度相同 → 选股列表、最佳买点日期 **完全一致**。

### 3. 为什么只有股价不同？

- **最佳买点价格 / 当前价格** 来自 `_get_close_on_date(stock_code, scan_date)`  
  → 用的是 **扫描日当天的日 K 收盘价**。
- 所以：每天扫描，**价格**会变；**选股、匹配度、最佳买点日期**不变。

### 4. 周日为何也一样？

- 若 `scan_date` 为周日：当前周已结束，周 K 日期（周五）< 周日，当前周 **会被包含**。
- 若前端或逻辑里把「周日」等价成 **上一交易日（周五）**，则效果同周五，仍可能和「上一完整周」逻辑一致，从而和周一～周四表现相同（视具体实现而定）。  
  总之：**同周内多日共用一个「最后完整周」** 是主因。

## 代码依据

- `bull_stock_analyzer.py` 约 4171–4174 行注释：

  > 周K的「日期」通常是周结束日（如周五）。  
  > 如果 scan_date 在周中，该周的周K会包含 scan_date 之后的数据。  
  > 为避免偷看未来，必须把该周整根周K剔除，仅保留 `__dt <= scan_ts` 的周K。

- 约 3221–3223 行说明：

  > 之前为实现「周内每天结果变化」，曾尝试用「日K截至指定日期聚合周K（含未完成周）」。  
  > 但该聚合会改变周K定义/数值，导致历史（如 2025-12-31）原本可命中的个股匹配度显著下降。  
  > 本地版优先保证与训练/原扫描一致性：继续使用 akshare 周K + 按 scan_date 截断回放。

## 小结

| 项目         | 数据来源       | 周一～周四 |
|--------------|----------------|------------|
| 特征、匹配度 | 周 K（最后一周） | 同一根周 K → **相同** |
| 选股、买点日期 | 同上           | **相同**   |
| 最佳买点价格 | 日 K（scan_date 收盘） | **每天不同** |

所以：**不是 bug**，而是当前设计下，**周内不换「最后一周」→ 结果自然相同，只有股价随日 K 变**。

---

## 若希望「每天结果不一样」的可行方向

要让 **周一～周四** 的选股、匹配度也随日期变，必须让 **「当前」这一根 bar 随 scan_date 变**。

### 方案 A：as-of 聚合「当前周」周 K（仅实时扫描）

- 对 **包含 scan_date 的那一周**：  
  用 **日 K 从该周一到 scan_date** 聚合成一根 **「截至 scan_date 的未完成周」** 的周 K。
- 仅用这根聚合周 K 替代 akshare 的「整周」周 K，作为 **当前周**；  
  **历史周** 仍用 akshare 周 K，不变。
- 效果：  
  - 周一用「周一 1 天」聚合 → 一根周 K；  
  - 周二用「周一+周二」聚合 → 另一根周 K；  
  - 类推。  
  → 每天「当前」bar 不同 → 特征、匹配度、选股 **会变**。

**代价**：  
- 「当前周」的周 K 定义与 akshare 不一致，与 **历史回测 / 训练时用的周 K** 也不同。  
- 若对历史某日（如 2025-12-31）也做同样聚合，其匹配度、选股可能与现有回测结果不一致。  
- 因此更建议：**仅在有 scan_date = 今天/实时扫描时** 启用；**历史回测** 仍用现有「整周周 K + 截断」逻辑。

### 方案 B：保持现状

- 继续用 akshare 周 K + 截断，**周内结果相同、仅股价变**。  
- 优点：与训练、历史回测完全一致，逻辑简单、可复现。

---

## 建议

1. **先确认需求**：  
   - 是否 **必须** 周内每天选股/匹配度都变？  
   - 还是可以接受「周内相同，仅股价每日更新」？

2. **若必须每天变**：  
   - 采用 **方案 A**，且 **仅对「实时扫描」** 做 as-of 聚合；  
   - 历史回测、训练 **不** 使用聚合，保持现有逻辑。

3. **若可接受现状**：  
   - 维持当前实现，在文档/前端注明：  
     「周内扫描结果一致，仅股价随扫描日变化」。
