# 如何定位扫描停住的问题

## 快速检查方法

### 方法1: 使用检查工具（推荐）
```bash
python3 check_scan_status.py
```

这个工具会显示：
- 当前扫描进度和状态
- 当前正在处理的股票
- 距离最后更新的时间（如果超过30秒会警告）
- 调试日志的最后20行
- Web服务状态

### 方法2: 查看实时日志
```bash
# 实时查看日志（会持续更新）
tail -f scan_debug.log

# 查看最后100行日志
tail -100 scan_debug.log

# 查看包含错误或超时的日志
grep -i "error\|超时\|timeout" scan_debug.log | tail -20
```

### 方法3: 通过Web API查看
```bash
# 查看扫描进度
curl http://localhost:5002/api/get_scan_progress

# 查看调试日志
curl http://localhost:5002/api/get_scan_debug_log
```

## 日志文件说明

### 日志位置
- 文件：`scan_debug.log`
- 格式：`时间 - 级别 - 消息`

### 日志内容
- **INFO**: 正常处理记录（每只股票开始处理时记录）
- **WARNING**: 警告信息（如市值获取超时）
- **ERROR**: 错误信息（如数据获取超时、特征提取超时）

### 关键信息
日志中会记录：
1. 每只股票的开始处理时间
2. 超时情况（市值、周K线、特征提取）
3. 错误信息
4. 当前处理的股票代码和名称

## 问题定位步骤

### 1. 检查是否真的卡住了
运行 `python3 check_scan_status.py`，查看：
- `time_since_last_update`: 如果超过30秒，可能卡住了
- `current_stock`: 当前卡住的股票代码

### 2. 查看日志最后几行
```bash
tail -20 scan_debug.log
```

查看最后处理的股票和可能的错误信息。

### 3. 检查特定股票
如果知道卡住的股票代码（如301270），查看相关日志：
```bash
grep "301270" scan_debug.log | tail -10
```

### 4. 检查超时情况
```bash
grep "超时\|timeout" scan_debug.log | tail -20
```

查看哪些股票经常超时。

## 常见问题

### 问题1: 市值获取超时
**现象**: 日志显示 "市值获取超时"
**原因**: `ak.stock_zh_a_spot_em()` 需要获取全部股票数据，很慢
**解决**: 系统会自动跳过市值检查，继续处理

### 问题2: 周K线获取超时
**现象**: 日志显示 "周K线数据获取超时"
**原因**: 网络请求慢或数据源问题
**解决**: 系统会自动跳过该股票，继续扫描下一只

### 问题3: 特征提取超时
**现象**: 日志显示 "特征提取超时"
**原因**: 数据处理复杂或数据异常
**解决**: 系统会自动跳过该股票，继续扫描下一只

## 预防措施

1. **预先缓存市值数据**: 扫描开始前会预先获取市值缓存
2. **超时保护**: 每个步骤都有超时限制
3. **自动跳过**: 遇到问题股票自动跳过，不阻塞整个扫描
4. **详细日志**: 记录每只股票的处理情况

## 总结

如果扫描停住了：
1. 运行 `python3 check_scan_status.py` 快速查看状态
2. 查看 `scan_debug.log` 了解详细信息
3. 检查最后处理的股票代码
4. 查看是否有超时或错误记录

系统已经添加了多层保护，即使遇到问题股票也会自动跳过，不会完全卡住。





