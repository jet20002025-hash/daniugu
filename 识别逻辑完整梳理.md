# 大牛股识别系统 - 完整逻辑梳理

## 一、系统架构概览

### 1.1 核心组件
- **BullStockAnalyzer**: 主分析器类，负责整个识别流程
- **DataFetcher**: 数据获取模块，负责K线数据、市值等数据获取
- **TechnicalAnalysis**: 技术分析模块，负责技术指标计算
- **trained_model.json**: 训练好的特征模板（包含58个特征的统计信息）

### 1.2 数据流程
```
训练阶段：大牛股样本 → 分析涨幅区间 → 提取特征 → 训练特征模板
识别阶段：全市场股票 → 获取数据 → 提取特征 → 匹配度计算 → 市值检查 → 输出结果
```

---

## 二、训练阶段（特征模板构建）

### 2.1 输入：大牛股样本列表
- 默认11只大牛股：`['000592', '002104', '002759', '300436', '301005', '301232', '002788', '603778', '603122', '600343', '603216']`
- 每只股票需要：
  1. 找到涨幅最大的区间（起点到终点）
  2. 识别起点位置（成交量突增点或涨幅起点）

### 2.2 分析流程
```
1. analyze_bull_stock(stock_code)
   ├─ 获取周K线数据（2年）
   ├─ 找到涨幅最大区间
   │  ├─ 计算所有可能的起点和终点组合
   │  ├─ 计算区间涨幅
   │  └─ 选择涨幅最大的区间
   ├─ 识别起点位置
   │  ├─ 优先：成交量突增点（起点前20周内，成交量比前一周多2倍以上）
   │  └─ 备选：涨幅起点前20周位置
   └─ 提取起点前40周的特征
```

### 2.3 特征提取（extract_features_at_start_point）

#### 2.3.1 成交量特征（量）
1. **起点当周量比**（核心指标）
   - 计算：起点当周成交量 / 起点前10周平均成交量
   - 意义：放量启动是关键信号

2. **起点前10/20/40周平均成交量**
   - 用于计算量比和萎缩程度

3. **成交量萎缩程度**（核心指标）
   - 计算：起点前10周均量 / 起点前20周均量
   - 意义：缩量整理是蓄势过程

4. **起点前40周最大量**
   - 记录最大成交量及其对应的最低价和日期

5. **是否跌破最大量最低价**（核心指标）
   - 判断起点价格是否跌破最大成交量对应的最低价
   - 意义：洗盘完成，价格回到主力成本区

6. **起点量比最大量**
   - 计算：起点当周成交量 / 起点前40周最大量

#### 2.3.2 价格特征（价）
1. **价格相对位置**（核心指标）
   - 计算：(起点价格 - 起点前20周最低价) / (起点前20周最高价 - 起点前20周最低价) * 100
   - 意义：相对低位是必要条件

2. **相对高点跌幅**
   - 计算：(起点前20周最高价 - 起点价格) / 起点前20周最高价 * 100

3. **起点前20/40周最高价和最低价**

4. **起点前20周波动幅度**
   - 计算：(最高价 - 最低价) / 最低价 * 100

#### 2.3.3 均线特征
1. **价格相对MA5/MA10/MA20**（核心指标）
   - 计算：(起点价格 - MA值) / MA值 * 100
   - 意义：站上均线是技术突破

2. **均线多头排列**（核心指标）
   - 判断：MA5 > MA10 > MA20
   - 意义：趋势向上

3. **均线粘合度**（核心指标）
   - 计算：均线之间的离散程度
   - 意义：均线粘合后发散是启动信号

#### 2.3.4 技术指标特征
1. **MACD指标**（核心指标）
   - MACD_DIF、MACD_DEA、MACD值
   - MACD零轴上方：判断是否在零轴上方

2. **RSI指标**（核心指标）
   - RSI值（相对强弱指标）

3. **布林带指标**
   - 布林带宽度、价格相对布林带位置

4. **OBV能量潮**（核心指标）
   - OBV值、OBV趋势（上升/下降）

5. **筹码集中度**
   - 计算筹码分布特征

#### 2.3.5 其他特征
- 起点前20周波动率（核心指标）
- 起点当周价涨量增
- 起点价格
- 等等...

**总计：58个特征**

### 2.4 特征模板训练（train_features）
```
1. 收集所有大牛股样本的特征
2. 对每个特征计算统计信息：
   - 均值
   - 中位数
   - 标准差
   - 最小值
   - 最大值
   - 样本数
3. 保存到 trained_model.json
```

---

## 三、识别阶段（全市场扫描）

### 3.1 扫描入口（scan_all_stocks）
```
输入参数：
- min_match_score: 最小匹配度阈值（默认0.6）
- max_market_cap: 最大市值限制（默认60亿）
- scan_date: 扫描日期（可选，用于历史回测）
- scan_session: 扫描时间段（可选：noon/close）

流程：
1. 检查是否已训练特征模型
2. 获取全市场股票列表（约5000+只）
3. 调用 _scan_stock_batch 进行扫描
   ├─ 并行扫描（_scan_stock_batch_parallel）
   └─ 串行扫描（_scan_stock_batch_serial）
```

### 3.2 单只股票处理流程（_process_single_stock）

#### 步骤1：获取周K线数据
```
1. 优先使用本地缓存数据（快速）
   - 检查 cache/weekly_kline/{code}.csv
   - 检查 cache/weekly_kline/{code}.json
   
2. 如果本地没有，尝试从网络下载
   - 使用 akshare 或 baostock API
   - 下载后保存到本地缓存
   
3. 如果指定了 scan_date，进行数据截断
   - 找到扫描日期所在周的周结束日期
   - 截断周K线数据到该周（包含该周）
   - 确保至少有40周数据
   
4. 如果数据不足40周，跳过该股票
```

#### 步骤2：提取特征
```
调用 extract_features_at_start_point：
- stock_code: 股票代码
- current_idx: 当前索引（最新一周或scan_date对应的周）
- lookback_weeks: 回看周数（40周）
- weekly_df: 周K线数据

提取58个特征（与训练阶段相同）
```

#### 步骤3：计算匹配度（_calculate_match_score）

**V3算法：基于中位数+标准差的高斯衰减评分**

```
核心特征（12个，权重3.0）：
- 起点当周量比
- 价格相对位置
- 成交量萎缩程度
- 价格相对MA20
- 起点前20周波动率
- 是否跌破最大量最低价
- 均线多头排列
- MACD零轴上方
- RSI
- 均线粘合度
- 布林带宽度
- OBV趋势

普通特征（46个，权重1.0）

匹配度计算：
1. 对每个特征：
   - 计算z-score = |目标值 - 中位数| / 标准差
   - 使用高斯衰减：score = exp(-0.25 * z²)
   - 如果在[min, max]范围内：score = max(基础分, 0.6)
   - 如果超出范围：额外惩罚 = exp(-超出距离 * 3)

2. 加权求和：
   - 核心特征：score * 3.0
   - 普通特征：score * 1.0
   - 总匹配度 = 加权总分 / 加权总数

3. 返回：
   - 总匹配度（0-1之间）
   - 各特征匹配详情
   - 核心特征匹配详情
```

#### 步骤4：市值检查（同步检查）
```
1. 如果 max_market_cap > 0：
   - 使用超时机制获取市值（最多2.5秒）
   - 如果市值 > max_market_cap：直接跳过该股票
   - 如果市值获取失败或超时：继续处理（不因市值获取失败而丢失股票）

2. 记录市值信息到候选股票
```

#### 步骤5：记录候选股票
```
如果匹配度 >= min_match_score 且市值 <= max_market_cap：
- 记录为候选股票
- 包含信息：
  - 股票代码、名称
  - 匹配度
  - 最佳买点日期、价格
  - 当前价格
  - 市值
  - 所有特征值
  - 核心特征匹配详情
```

### 3.3 并行扫描（_scan_stock_batch_parallel）
```
1. 使用 ThreadPoolExecutor 创建线程池
2. 默认工作线程数：本地环境30个，最大50个
3. 对每只股票调用 _process_single_stock
4. 实时收集结果：
   - 找到一只，立即添加到 candidates
   - 更新进度：found、candidates、current_stock
   - 实时输出到前端
```

### 3.4 串行扫描（_scan_stock_batch_serial）
```
1. 顺序处理每只股票
2. 每只股票的处理流程与并行扫描相同
3. 支持断点续扫（如果被停止，可以继续）
```

---

## 四、匹配度算法详解

### 4.1 核心思想
- **基于统计分布**：使用中位数和标准差描述特征分布
- **高斯衰减评分**：距离中位数越近，分数越高
- **核心特征加权**：核心特征权重是普通特征的3倍

### 4.2 评分公式
```
对于每个特征：
1. 计算z-score = |目标值 - 中位数| / 标准差

2. 基础分 = exp(-0.25 * z²)
   - z=0 → 1.0
   - z=1 → 0.78
   - z=2 → 0.37
   - z=3 → 0.11

3. 如果在[min, max]范围内：
   score = max(基础分, 0.6)  # 最低0.6分

4. 如果超出范围：
   score = 基础分 * 惩罚系数 * 0.8
   惩罚系数 = exp(-超出距离 * 3)

5. 加权：
   - 核心特征：score * 3.0
   - 普通特征：score * 1.0

6. 总匹配度 = 加权总分 / 加权总数
```

### 4.3 匹配度范围
- **训练样本**：通常0.82-0.95
- **符合条件的股票**：>= min_match_score（默认0.6，实际使用0.93+）
- **不符合条件的股票**：< min_match_score

---

## 五、数据获取策略

### 5.1 优先级
```
1. 本地缓存（最快）
   - cache/weekly_kline/{code}.csv
   - cache/weekly_kline/{code}.json

2. 网络下载（如果本地没有）
   - akshare API
   - baostock API（备用）
   - 下载后保存到本地缓存
```

### 5.2 数据要求
- **周K线数据**：至少40周（约200个交易日）
- **数据完整性**：必须有日期、开盘、收盘、最高、最低、成交量

### 5.3 历史回测支持
- 如果指定 `scan_date`：
  - 强制使用本地缓存（确保历史一致性）
  - 截断数据到指定日期所在周
  - 模拟"在那个时间点扫描"的效果

---

## 六、性能优化

### 6.1 并行处理
- 本地环境：30个工作线程（最大50个）
- 每只股票处理超时：5秒
- 市值获取超时：2.5秒

### 6.2 缓存机制
- 周K线数据本地缓存
- 市值数据缓存（避免重复获取）

### 6.3 实时显示
- 找到一只股票，立即显示一只
- 使用 `window._liveScanCandidateMap` 缓存已找到的股票
- 前端每500ms轮询一次进度

---

## 七、关键参数

### 7.1 扫描参数
- **min_match_score**: 最小匹配度阈值（默认0.6，实际使用0.93+）
- **max_market_cap**: 最大市值限制（默认60亿，实际使用100亿）
- **scan_date**: 扫描日期（可选，用于历史回测）
- **scan_session**: 扫描时间段（可选：noon/close）

### 7.2 特征参数
- **lookback_weeks**: 回看周数（40周，约200个交易日）
- **核心特征数量**: 12个
- **总特征数量**: 58个

### 7.3 超时参数
- **单只股票处理超时**: 5秒
- **市值获取超时**: 2.5秒
- **周K线获取超时**: 8秒（在data_fetcher中）

---

## 八、输出结果

### 8.1 候选股票信息
```json
{
  "股票代码": "000001",
  "股票名称": "平安银行",
  "匹配度": 0.956,
  "最佳买点日期": "2025-12-31",
  "最佳买点价格": 10.50,
  "当前价格": 10.50,
  "市值": 50.23,
  "特征": {...},  // 58个特征值
  "核心特征匹配": {...}  // 12个核心特征的匹配详情
}
```

### 8.2 扫描结果
```json
{
  "success": true,
  "message": "扫描完成",
  "candidates": [...],  // 候选股票列表（按匹配度降序）
  "found_count": 2,
  "total_scanned": 5473,
  "scan_date": "2025-12-31",
  "scan_session": "close"
}
```

---

## 九、完整流程图

```
【训练阶段】
大牛股样本 → 分析涨幅区间 → 识别起点 → 提取58个特征 → 计算统计信息 → 保存特征模板

【识别阶段】
全市场股票列表
    ↓
并行/串行处理每只股票
    ↓
【单只股票处理】
1. 获取周K线数据（优先本地，其次网络）
   ↓
2. 如果指定scan_date，截断数据到该周
   ↓
3. 提取58个特征（起点前40周）
   ↓
4. 计算匹配度（V3算法：高斯衰减）
   ↓
5. 如果匹配度 < 阈值：跳过
   ↓
6. 检查市值（同步检查，超时2.5秒）
   ↓
7. 如果市值 > 限制：跳过
   ↓
8. 记录为候选股票
    ↓
收集所有候选股票
    ↓
按匹配度排序
    ↓
输出结果（实时显示）
```

---

## 十、关键设计决策

### 10.1 为什么使用周K线？
- 减少数据量，提高处理速度
- 过滤日线噪音，捕捉趋势
- 与训练阶段保持一致

### 10.2 为什么使用中位数+标准差？
- 中位数对异常值不敏感
- 标准差描述数据离散程度
- 高斯衰减提供平滑的评分曲线

### 10.3 为什么核心特征权重3倍？
- 核心特征对识别大牛股最关键
- 提高核心特征的区分度
- 确保核心特征匹配度高的股票排名靠前

### 10.4 为什么市值检查在扫描时同步进行？
- 避免扫描大量不符合市值条件的股票
- 提高扫描效率
- 确保结果符合市值限制

---

## 十一、系统特点

### 11.1 优势
1. **实时显示**：找到一只显示一只，用户体验好
2. **历史回测**：支持指定日期扫描，模拟历史情况
3. **数据缓存**：本地缓存提高速度
4. **并行处理**：多线程提高扫描速度
5. **超时保护**：避免单个股票卡住整个扫描

### 11.2 限制
1. **数据依赖**：需要至少40周数据
2. **特征数量**：58个特征，计算量较大
3. **市值获取**：可能因网络问题超时
4. **匹配度阈值**：需要根据实际情况调整

---

## 十二、总结

这是一个基于**统计学习**的大牛股识别系统：
- **训练阶段**：从11只大牛股样本中提取58个特征的统计分布
- **识别阶段**：在全市场股票中寻找特征匹配度高的股票
- **匹配算法**：使用高斯衰减评分，核心特征加权
- **实时性**：并行处理+实时显示，用户体验好
- **准确性**：通过匹配度阈值和市值限制，筛选出符合条件的股票

核心思想：**大牛股在启动前有共同的特征模式，通过统计学习找到这些模式，然后在全市场中寻找匹配的股票。**
