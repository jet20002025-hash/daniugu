# Vercel 数据源方案：中国大陆用户 · 速度与准确性兼顾

## 一、约束与目标

| 项目 | 说明 |
|------|------|
| **Vercel 限制** | 单次函数执行 **10 秒**（Hobby），超时即中断 |
| **访问者** | 中国大陆用户 |
| **数据需求** | ① 扫描用 K 线（历史） ② 需要时的**实时/最新**数据 |
| **目标** | 兼顾**速度**与**准确性**，在 10 秒内可完成的操作不超时 |

---

## 二、推荐总体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Vercel（10 秒限制）                                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  ① 扫描用数据：100% GitHub 数据包（不实时拉取）                             │
│  ② 实时/最新数据：按需、小批量，从 腾讯/新浪/东方财富 三选一 + 兜底          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
              ┌──────────┐   ┌──────────┐   ┌──────────────┐
              │ 腾讯行情  │   │ 新浪财经  │   │ 东方财富      │
              │ 实时价格  │   │ K 线等   │   │ K 线 / 修复   │
              └──────────┘   └──────────┘   └──────────────┘
```

- **扫描**：只用 GitHub 缓存，不占 10 秒、不依赖外网 API。
- **实时/最新**：仅在「需要时」调用，且**小批量、短超时**，从 腾讯 → 新浪 → 东方财富 的优先级 + 兜底。

---

## 三、数据源对比（简要）

| 数据源 | 适用场景 | 速度 | 准确性 | 批量能力 | 大陆访问 |
|--------|----------|------|--------|----------|----------|
| **腾讯 qt.gtimg.cn** | 实时价、涨跌幅、最新一条 | ⭐⭐⭐ 最快 | ⭐⭐⭐ 高 | ✅ **支持** 多码逗号分隔 | ✅ 友好 |
| **新浪 quotes.sina.cn** | 日 K / 周 K，datalen 可控 | ⭐⭐ 较快 | ⭐⭐⭐ 高 | ❌ 单只/请求 | ✅ 友好 |
| **东方财富 push2his** | 日 K / 周 K，修复、备用 | ⭐⭐ 较快 | ⭐⭐⭐ 高 | ❌ 单只/请求 | ✅ 友好 |
| **akshare** | 全市场列表、多接口封装 | ⭐ 较慢 | ⭐⭐⭐ 高 | 视底层接口 | ⚠️ 视网络 |

- **速度**：腾讯接口最轻，一次请求可批量拿多只实时价；新浪/东财单只 K 线。
- **准确性**：三家对 A 股行情均常用，准确性均可接受；你已有新浪 + 腾讯兜底、东财修复的实践。
- **批量**：腾讯 `q=sh600519,sz000001` 等逗号分隔即可批量，**最适合在 10 秒内做「按需、小批量」实时**。

---

## 四、具体方案

### 1. 扫描用数据：GitHub 数据包（保持不变）

- **做法**：Vercel 上 **仅使用** GitHub 数据包（你当前的 `USE_GITHUB_DATA_ONLY` + `STOCK_DATA_URL`）。
- **原因**：
  - 全市场扫描涉及 5000+ 只股票，实时拉 K 线在 10 秒内不可行。
  - 用 GitHub 预打包的日 K / 周 K，扫描阶段**零外网请求**，不占 10 秒，且数据一致、可复现。
- **结论**：扫描 **不从网络实时获取**，仅从 GitHub；此部分不动。

### 2. 实时/最新数据：何时用、用谁、怎么用

「需要时」典型场景：

- 展示**最新价、涨跌幅**（如自选、扫描结果前 N 只）。
- 补齐**今日**一根 K 线（你已有「今日 only」更新逻辑）。
- 修复/校验**最近几日**的 K 线（你已有东财修复脚本）。

下面按**在 Vercel 内**、**在 Vercel 外**分开说。

---

#### 方案 A：在 Vercel 内提供「小批量实时价」API（推荐）

- **用途**：只做「少量股票」的**最新价、涨跌幅**等，例如自选、扫描结果前 20～50 只。
- **数据源**：**腾讯 qt.gtimg.cn** 为主；失败时再试新浪 or 东财（视你现有封装而定）。
- **形式**：  
  `GET /api/realtime_prices?codes=000001,600519,000858`  
  单次请求拉取多只（例如 ≤50 只），**一轮请求 + 解析**控制在 **&lt;5 秒**，留余量给 10 秒。
- **实现要点**：
  - 使用批量接口：`http://qt.gtimg.cn/q=sz000001,sh600519,sz000858`（你当前 `update_data_sina._get_tencent_realtime_price` 是单只，可另写批量版）。
  - 超时设 **3～5 秒**，失败即返回已拿到的部分或明确错误，不重试多轮。
  - 前端：只对「当前可见/关心的」股票调用，例如分页、折叠的部分不请求。
- **优点**：  
  - 腾讯在国内访问快、接口轻，批量一次搞定，易满足 10 秒。  
  - 不改扫描架构，只在「需要展示实时」时按需拉。

---

#### 方案 B：今日 K 线 / 增量更新（放 Vercel 外）

- **用途**：每日「今日 only」增量更新、补齐最新一根日 K / 周 K。
- **数据源**：**新浪为主**，**腾讯实时价兜底**（你现有 `update_data_sina` + `_get_tencent_realtime_price` 逻辑可保留）。
- **部署位置**：**本地 / 自有服务器 / 国内云** 的 cron 或定时任务，**不要**放在 Vercel 函数里跑。
- **原因**：  
  - 全市场 5000+ 只，即便多线程也要较长时间，远超 10 秒。  
  - 大陆用户访问境内服务器拉新浪/腾讯，延迟更低，且无 10 秒限制。
- **结论**：  
  - 「今日数据更新」继续用 **新浪 + 腾讯兜底**，逻辑不变；  
  - **执行环境**改为本地 / 国内后端，**不**在 Vercel。

---

#### 方案 C：修复、校验最近 K 线（Vercel 外）

- **用途**：少数股票 K 线异常时的修复、校验。
- **数据源**：**东方财富**（你已有 `fix_data_eastmoney`）或 **新浪**。
- **部署**：同方案 B，放在 **Vercel 外**（本地/国内）跑。
- **原因**：可能涉及多只、多日，耗时长，不适合 10 秒函数。

---

### 3. 数据源优先级与兜底（汇总）

| 场景 | 主数据源 | 兜底 | 执行位置 |
|------|----------|------|----------|
| 扫描用 K 线 | GitHub 数据包 | 无（不实时拉） | Vercel |
| 小批量实时价（≤50 只） | **腾讯** qt.gtimg.cn | 新浪 / 东财 单只实时 or 最近 1 根 K | Vercel |
| 今日 K 线 / 增量更新 | **新浪** | **腾讯** 实时价 | 本地 / 国内后端 |
| K 线修复、校验 | **东方财富** 或 新浪 | 视情况 | 本地 / 国内后端 |

- **腾讯**：实时价、批量、速度最优，作为 Vercel 内「按需实时」的**主方案**。  
- **新浪**：K 线成熟、你已在用，继续做**今日/增量**的主来源；必要时也可做实时价兜底。  
- **东方财富**：**修复、校验**时用；若有现成接口，亦可作实时兜底。

---

## 五、实施顺序建议

1. **保持现状**  
   - 扫描：100% GitHub；  
   - 今日更新：新浪 + 腾讯兜底，在 **Vercel 外** 跑。

2. **新增「小批量实时价」API（Vercel）**  
   - 新增 `GET /api/realtime_prices?codes=...`；  
   - 实现腾讯批量 `qt.gtimg.cn/q=...`，超时 3～5 秒，返回最新价、涨跌幅等；  
   - 前端：自选、扫描结果前 N 只等场景调用该 API。

3. **（可选）兜底**  
   - 腾讯失败时，对少量股票用新浪 or 东财拉「最近 1 根 K」或简易实时接口做兜底；  
   - 仍保持「小批量、短超时」，避免逼近 10 秒。

4. **（可选）简单监控**  
   - 对 `realtime_prices` 的耗时、成功率打点；  
   - 若腾讯经常超时，再考虑限流、降批大小或切部分流量到新浪/东财。

---

## 六、方案总结

| 问题 | 建议 |
|------|------|
| 扫描数据从哪来？ | **仅 GitHub**，不从网络实时获取。 |
| 需要实时/最新时用谁？ | **腾讯** 为主（批量实时价），**新浪** 做 K 线与兜底，**东方财富** 做修复与校验。 |
| 速度 vs 准确性？ | 腾讯批量实时价 **速度最快**，三家准确性都可用；用「腾讯主 + 新浪/东财兜底」兼顾两者。 |
| 10 秒限制怎么满足？ | 扫描不碰实时 API；实时只做**小批量、单次请求、短超时**，且仅 **实时价** 在 Vercel 内。 |
| 大陆用户体验？ | 腾讯/新浪/东财均国内可访问；今日更新与修复放在**本地/国内**跑，延迟更优。 |

**简要结论**：  
- **扫描**：GitHub 数据包，不动。  
- **实时/最新**：需要时再拉；**小批量实时价**用 **腾讯**，在 Vercel 内；**今日 K 线、修复**用 **新浪 + 腾讯兜底**、**东财**，在 Vercel 外。这样既满足 10 秒限制，又兼顾速度与准确性，并适合中国大陆用户访问。

---

## 七、附录：腾讯批量实时接口示例

```text
# 单只
GET http://qt.gtimg.cn/q=sz000001

# 批量（逗号分隔）
GET http://qt.gtimg.cn/q=sz000001,sh600519,sz000858
```

返回为 `~` 分割的字段，包含现价、涨跌幅、成交量等；你现有 `_get_tencent_realtime_price` 解析单只的逻辑可复用在批量返回的逐段解析上。  
具体字段含义可参考你项目内 `update_data_sina._get_tencent_realtime_price` 及腾讯相关文档。

---

*文档版本：2026-01；适用场景：Vercel 部署、中国大陆用户、10 秒限制。*
