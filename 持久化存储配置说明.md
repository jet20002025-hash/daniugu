# 📦 持久化存储配置说明

## ✅ 已实现持久化存储功能

现在用户认证模块已支持持久化存储，用户数据不会因为代码更新而丢失。

## 🎯 支持的存储方案

### 1. Upstash Redis（推荐，免费）

**优点**：
- ✅ 免费额度充足（每天 10,000 次请求）
- ✅ 数据持久化，重启后保留
- ✅ 多实例同步
- ✅ 性能好，延迟低

**配置步骤**：

1. 注册 Upstash 账号
   - 访问 https://upstash.com/
   - 点击 "Sign Up" 注册账号（免费）

2. 创建 Redis 数据库
   - 登录后，点击 "Create Database"
   - 选择区域（推荐选择离服务器最近的区域）
   - 点击 "Create"

3. 获取连接信息
   - 在数据库详情页，找到 "REST API" 部分
   - 复制 `UPSTASH_REDIS_REST_URL` 和 `UPSTASH_REDIS_REST_TOKEN`

4. 在 Vercel 配置环境变量
   - 进入 Vercel Dashboard → 项目 → Settings → Environment Variables
   - 添加以下环境变量：
     ```
     UPSTASH_REDIS_REST_URL=https://your-redis-url.upstash.io
     UPSTASH_REDIS_REST_TOKEN=your-token-here
     ```
   - 点击 "Save"

5. 重新部署
   - Vercel 会自动检测到新环境变量并重新部署
   - 或者在 Vercel Dashboard 手动触发重新部署

### 2. Vercel KV（如果已配置）

如果你已经在 Vercel 项目中配置了 KV，系统会自动使用 Vercel KV。

**配置步骤**：
1. 在 Vercel Dashboard → Storage → Create → KV
2. 创建 KV 数据库
3. 系统会自动配置连接

### 3. 内存存储（不推荐生产环境）

如果没有配置任何持久化存储，系统会使用内存存储。
⚠️ **注意**：内存存储在每次部署/重启后会丢失所有用户数据。

## 🔍 检查存储状态

系统启动时会自动检测可用的存储后端，并在日志中显示：
- ✅ `使用 Upstash Redis 持久化存储` - 使用 Upstash Redis
- ✅ `使用 Vercel KV 持久化存储` - 使用 Vercel KV
- ⚠️ `使用内存存储（数据不会持久化，重启后会丢失）` - 使用内存存储

## 📊 数据存储结构

### 用户数据（users）
```json
{
  "username": {
    "username": "用户名",
    "email": "邮箱",
    "password": "加密后的密码",
    "created_at": "创建时间",
    "last_login": "最后登录时间",
    "invite_code": "使用的邀请码",
    "is_active": true,
    "is_vip": false
  }
}
```

### 邀请码数据（invite_codes）
```json
{
  "INVITE001": {
    "code": "INVITE001",
    "created_at": "创建时间",
    "used": false,
    "used_by": "使用者",
    "used_at": "使用时间",
    "max_uses": 1,
    "use_count": 0
  }
}
```

## 🚀 使用步骤

1. **配置 Upstash Redis**（推荐）
   - 按照上面的步骤配置 Upstash Redis
   - 在 Vercel 添加环境变量
   - 重新部署

2. **验证存储**
   - 访问网站并注册一个新用户
   - 重新部署网站
   - 尝试登录，用户数据应该还在

## ⚠️ 注意事项

1. **备份数据**：虽然数据已持久化，但建议定期备份重要数据
2. **环境变量安全**：不要将 `UPSTASH_REDIS_REST_TOKEN` 提交到 Git
3. **免费额度**：Upstash 免费额度每天 10,000 次请求，对于小型应用足够使用

## 📝 故障排除

### 如果看到 "使用内存存储" 警告

1. 检查环境变量是否已正确配置
2. 确认 `UPSTASH_REDIS_REST_URL` 和 `UPSTASH_REDIS_REST_TOKEN` 都已添加
3. 确认环境变量已应用到正确的环境（Production、Preview、Development）
4. 重新部署项目

### 如果用户数据丢失

1. 检查日志，确认使用的是哪种存储后端
2. 如果使用的是内存存储，需要配置 Upstash Redis
3. 检查 Upstash Redis 连接是否正常
4. 检查环境变量是否正确

## 🔄 迁移数据

如果需要从内存存储迁移到 Upstash Redis：

1. 导出当前用户数据（如果有）
2. 配置 Upstash Redis
3. 在 Vercel 添加环境变量
4. 重新部署
5. 用户注册后数据会自动保存到 Redis

---

**配置完成后，用户数据将永久保存，不会因为代码更新或重启而丢失！** 🎉

