# 扫描显示不可变逻辑（严禁修改）

**无论怎么改程序，下面两条逻辑都不能动：**

---

## 1. 找到一只，显示一只

- 扫描过程中，**每找到一只符合条件的股票，就要立即在结果区显示出来**，不能等全部扫完再一起显示。
- 实现要点：
  - 后端：`get_progress` 的 `progress.candidates`、`bull_stock_analyzer` 的 `self.progress['candidates']`、`vercel_scan_helper` 的 `progress['candidates']` 必须**持续把新命中的候选追加进去**，供轮询拉取。
  - 前端：`startProgressPolling` 轮询到 `progress.candidates` 或 `progress.found > 0` 时，必须调用 `updateLiveScanResults(progress)`，把新候选**合并进 `window._liveScanCandidateMap` 并立即渲染**。
- **禁止**：改成“扫完再一次性展示”“只展示进度不展示候选”等，导致无法“找到一只显示一只”。

---

## 2. 过程找到的结果和最后显示的结果要一致

- **扫描过程中**在结果区已经展示过的股票集合，必须和**扫描结束后的最终结果**完全一致，不能多、不能少、不能换一套数据源。
- 实现要点：
  - **唯一数据源**：`window._liveScanCandidateMap` 是整个过程（从开始到结束）的**唯一累积结果**。只做**合并、追加**（如 `progress.candidates` 合并入 Map），**禁止**在完成时用别的接口（如 `get_scan_results`）或别的结构**覆盖、替换**该 Map。仅在**新一轮扫描开始时**清空 `_liveScanCandidateMap`，完成/停止时不得清空。
  - **完成 / 停止时**：若 `_liveScanCandidateMap` 已有数据，**必须**用 `updateLiveScanResults(progress)` 从 Map 渲染最终结果；**禁止**用 `displayScanResults(get_scan_results)` 之类覆盖掉实时已展示的内容。只有在 Map 为空（异常兜底）时，才允许用 `get_scan_results` 补数并**合并进 Map** 后再用 `updateLiveScanResults` 渲染。
  - **禁止**：扫描完成时用 `displayScanResults` 或 `get_scan_results` 的结果覆盖 `_liveScanCandidateMap` 或直接覆盖 `#buyPointsResult` 已显示的实时结果，导致“过程”和“最后”不一致。

---

## 涉及文件与位置（修改时务必保留上述行为）

| 文件 | 作用 |
|------|------|
| `templates/bull_stock_web.html` | `updateLiveScanResults`、`startProgressPolling`、`scanCheckInterval` 完成/停止分支、`autoContinueScan` 批次完成分支、`displayScanResults` 的调用处 |
| `bull_stock_web.py` | `get_progress` 中 `progress.candidates` 的清洗与返回，不能清空导致前端拿不到 |
| `bull_stock_analyzer.py` | `self.progress['candidates']` 的更新（并行/串行扫描） |
| `vercel_scan_helper.py` | `progress['candidates']` 的写入与 `save_scan_progress` |

---

*文档版本：2025-01，逻辑一经确认勿随意改动。*
