<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ç‰›è‚¡åˆ†æå™¨ - æ·»åŠ å¤§ç‰›è‚¡</title>
    <!-- ECharts CDN - ä½¿ç”¨å¤šä¸ªå¤‡ç”¨æº -->
    <script>
        // åŠ è½½EChartsçš„å¤šä¸ªCDNæºï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼Œå›½å†…ä¼˜å…ˆï¼‰
        const echartsCDNs = [
            'https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js',           // BootCDNï¼ˆå›½å†…ï¼Œé¦–é€‰ï¼Œæœ€å¿«ï¼‰
            'https://unpkg.com/echarts@5.4.3/dist/echarts.min.js',                      // unpkgï¼ˆå›½é™…ï¼Œå¤‡ç”¨1ï¼Œè¾ƒç¨³å®šï¼‰
            'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js',           // jsDelivrï¼ˆå›½é™…ï¼Œå¤‡ç”¨2ï¼‰
            'https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js'      // Cloudflareï¼ˆå›½é™…ï¼Œå¤‡ç”¨3ï¼‰
        ];
        
        let echartsLoaded = false;
        let currentCDNIndex = 0;
        
        function loadECharts(cdnIndex = 0) {
            if (cdnIndex >= echartsCDNs.length) {
                console.error('âŒ æ‰€æœ‰ECharts CDNæºåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                // å¦‚æœæ‰€æœ‰CDNéƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
                document.addEventListener('DOMContentLoaded', function() {
                    const body = document.body;
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#ff4444;color:white;padding:15px;text-align:center;z-index:99999;';
                    errorDiv.innerHTML = 'âš ï¸ EChartsåº“åŠ è½½å¤±è´¥ï¼Œå›¾è¡¨åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚è¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚';
                    body.insertBefore(errorDiv, body.firstChild);
                });
                return;
            }
            
            const script = document.createElement('script');
            script.src = echartsCDNs[cdnIndex];
            script.async = true;
            
            script.onload = function() {
                if (typeof echarts !== 'undefined') {
                    echartsLoaded = true;
                    console.log('âœ… EChartsåŠ è½½æˆåŠŸï¼Œä½¿ç”¨CDN:', echartsCDNs[cdnIndex]);
                    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥EChartså·²åŠ è½½
                    window.dispatchEvent(new Event('echartsLoaded'));
                } else {
                    // åŠ è½½æˆåŠŸä½†echartsæœªå®šä¹‰ï¼Œå°è¯•ä¸‹ä¸€ä¸ª
                    loadECharts(cdnIndex + 1);
                }
            };
            
            script.onerror = function() {
                console.warn('âš ï¸ CDNåŠ è½½å¤±è´¥:', echartsCDNs[cdnIndex], 'ï¼Œå°è¯•ä¸‹ä¸€ä¸ªCDNæº...');
                // ç§»é™¤å¤±è´¥çš„scriptæ ‡ç­¾
                script.remove();
                // å°è¯•ä¸‹ä¸€ä¸ªCDN
                loadECharts(cdnIndex + 1);
            };
            
            document.head.appendChild(script);
        }
        
        // å¼€å§‹åŠ è½½ECharts
        loadECharts();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .add-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stocks-list {
            margin-top: 30px;
        }
        
        .stocks-list h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .stock-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .stock-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .stock-info {
            flex: 1;
        }
        
        .stock-code {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stock-name {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stock-meta {
            font-size: 12px;
            color: #999;
        }
        
        .stock-actions {
            display: flex;
            gap: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            border-radius: 8px;
            display: none;
            z-index: 10000;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
            font-size: 15px;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .message.show {
            display: block;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .progress-container {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .progress-container.show {
            display: block;
        }
        
        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }
        
        .progress-status {
            font-weight: 500;
            color: #667eea;
        }
    </style>
    <script>
        // âœ… ç§»é™¤é¡µé¢åŠ è½½å‰çš„ç™»å½•æ£€æŸ¥ï¼ˆåç«¯å·²æœ‰æ£€æŸ¥ï¼Œé¿å…é˜»å¡å‰ç«¯æ¸²æŸ“ï¼‰
        // åç«¯ / è·¯ç”±å·²ç»æœ‰ @require_login è£…é¥°å™¨ï¼Œæœªç™»å½•ä¼šè‡ªåŠ¨è·³è½¬
        // è¿™æ ·å¯ä»¥é¿å…å‰ç«¯é˜»å¡ï¼Œæå‡é¡µé¢åŠ è½½é€Ÿåº¦
        console.log('[é¡µé¢åŠ è½½] è·³è¿‡å‰ç«¯ç™»å½•æ£€æŸ¥ï¼Œä¾èµ–åç«¯æ£€æŸ¥');
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div>
                    <h1>ğŸ‚ å¤§ç‰›è‚¡åˆ†æå™¨</h1>
                    <p>æ·»åŠ å¤§ç‰›è‚¡ï¼Œåˆ†æå¤§æ¶¨å‰çš„ç‰¹å¾</p>
                </div>
                <div id="userInfoDisplay" style="text-align: right; padding: 10px; background: #f8f9fa; border-radius: 8px; min-width: 200px;">
                    <div style="font-size: 12px; color: #666;">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class="content">
            <!-- æ¶ˆæ¯æç¤º -->
            <div id="message" class="message"></div>
            
            <!-- æ·»åŠ è¡¨å• -->
            <div class="add-form">
                <h2 style="margin-bottom: 20px; color: #333; display: flex; justify-content: space-between; align-items: center;">
                    <span>æ·»åŠ å¤§ç‰›è‚¡</span>
                    <span style="font-size: 14px; font-weight: normal; color: #666;">
                        å·²æ·»åŠ  <span id="stockCount" style="font-weight: bold; color: #667eea;">0</span> åªè‚¡ç¥¨
                    </span>
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="stockCode">è‚¡ç¥¨ä»£ç  *</label>
                        <input type="text" id="stockCode" placeholder="ä¾‹å¦‚ï¼š000001" maxlength="6">
                    </div>
                    <div class="form-group">
                        <label for="stockName">è‚¡ç¥¨åç§°ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="stockName" placeholder="ä¾‹å¦‚ï¼šå¹³å®‰é“¶è¡Œï¼ˆä¸å¡«å°†è‡ªåŠ¨è·å–ï¼‰">
                    </div>
                </div>
                <!-- åŠŸèƒ½æŒ‰é’®ç»„ï¼ˆæ ¹æ®ç¯å¢ƒå’Œç”¨æˆ·ç­‰çº§æ˜¾ç¤ºï¼‰ -->
                <div class="btn-group" id="functionButtonsGroup">
                    <!-- æœ¬åœ°ç‰ˆæœ¬ï¼šæ˜¾ç¤ºæ‰€æœ‰åŠŸèƒ½ -->
                    <div id="localVersionButtons" style="display: none;">
                        <!-- æœ¬åœ°ç‰ˆæœ¬æ‰«æå‚æ•°ï¼ˆé»˜è®¤å±•å¼€ï¼Œå¯æŠ˜å ï¼‰ -->
                        <div id="localScanParams" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="toggleLocalScanParams()">
                                <h3 style="margin: 0; color: #333; font-size: 14px; font-weight: 600;">âš™ï¸ æ‰«æå‚æ•°è®¾ç½®</h3>
                                <span id="localScanParamsToggle" style="color: #666; font-size: 12px;">â–² æ”¶èµ·</span>
                            </div>
                            <div id="localScanParamsContent" style="display: block;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px;">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">é€‰æ‹©æ¨¡å‹</label>
                                        <div style="display: flex; gap: 5px; align-items: flex-start;">
                                            <select id="modelSelector" style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;" onchange="switchModel()">
                                                <option value="">åŠ è½½ä¸­...</option>
                                            </select>
                                            <button id="deleteModelBtn" onclick="deleteModel()" style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;" title="åˆ é™¤é€‰ä¸­çš„æ¨¡å‹">ğŸ—‘ï¸</button>
                                        </div>
                                        <small style="color: #999; font-size: 11px;">é€‰æ‹©è¦ä½¿ç”¨çš„ç‰¹å¾æ¨¡å‹</small>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">åŒ¹é…åº¦é˜ˆå€¼</label>
                                        <input type="number" id="localMinMatchScore" placeholder="0.93" value="0.93" min="0.6" max="1.0" step="0.01" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                        <small style="color: #999; font-size: 11px;">èŒƒå›´ï¼š0.8-1.0</small>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">æœ€å¤§å¸‚å€¼ï¼ˆäº¿å…ƒï¼‰</label>
                                        <input type="number" id="localMaxMarketCap" placeholder="100" value="100" min="0" max="500" step="1" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                        <small style="color: #999; font-size: 11px;">èŒƒå›´ï¼š0-500äº¿ï¼Œé»˜è®¤100äº¿</small>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">æ‰«ææ•°é‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="number" id="localScanLimit" placeholder="ç•™ç©ºè¡¨ç¤ºå…¨éƒ¨" min="1" step="1" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                        <small style="color: #999; font-size: 11px;">å»ºè®®å…ˆæµ‹è¯•100åª</small>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">æŒ‡å®šæ‰«ææ—¥æœŸï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="date" id="localScanDate" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                        <small style="color: #999; font-size: 11px;">ç•™ç©º=ä½¿ç”¨æœ€æ–°æ•°æ®</small>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">æ—¶é—´æ®µï¼ˆæ ‡ç­¾ï¼‰</label>
                                        <select id="localScanSession" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                            <option value="close" selected>æ”¶ç›˜ï¼ˆé»˜è®¤ï¼‰</option>
                                            <option value="noon">åˆç›˜</option>
                                        </select>
                                        <small style="color: #999; font-size: 11px;">æœ¬åœ°å‘¨çº¿æ¨¡å‹ä¸åŒºåˆ†åˆ†æ—¶ï¼Œæ­¤å¤„ç”¨äºè®°å½•/åŒºåˆ†ä»»åŠ¡</small>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">å¼ºåˆ¶åˆ·æ–°ï¼ˆå¯é€‰ï¼‰</label>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                            <input type="checkbox" id="localForceRefresh" style="cursor: pointer;">
                                            <span>è·³è¿‡ç¼“å­˜ï¼Œé‡æ–°æ‹‰å–æ•°æ®ï¼ˆä¸ç¨³å®šæ—¶å»ºè®®å…³é—­ï¼‰</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addStock()">æ·»åŠ è‚¡ç¥¨</button>
                        <button class="btn btn-secondary" onclick="clearStocks()">æ¸…ç©ºæ‰€æœ‰</button>
                        <button class="btn btn-primary" onclick="startAutoDataUpdate()" style="background: #3498db;">ğŸ“¥ æ›´æ–°æ•°æ®</button>
                        <button class="btn btn-primary" onclick="analyzeAllStocks()" style="background: #27ae60;">åˆ†ææ‰€æœ‰è‚¡ç¥¨</button>
                        <button class="btn btn-primary" onclick="trainFeatures()" style="background: #e67e22;">è®­ç»ƒç‰¹å¾æ¨¡å‹</button>
                        <button class="btn btn-primary" onclick="scanAllStocks()" style="background: #e74c3c;" id="scanAllStocksBtn">ğŸ” æ‰«æå…¨å¸‚åœº</button>
                        <button class="btn btn-primary" onclick="stopScan()" style="background: #95a5a6;" id="stopScanBtn" disabled>ğŸ›‘ åœæ­¢æ‰«æ</button>
                    </div>
                    
                    <!-- ç½‘ç»œç‰ˆæœ¬ï¼šæ ¹æ®ç”¨æˆ·ç­‰çº§æ˜¾ç¤º -->
                    <div id="webVersionButtons" style="display: none;">
                        <!-- VIPç”¨æˆ·ï¼šå¯ä»¥æ‰«æå…¨å¸‚åœºï¼ˆæ— é™æ¬¡ï¼‰ -->
                        <div id="vipUserButtons" style="display: none;">
                            <!-- VIPè‡ªå®šä¹‰æ‰«æå‚æ•°ï¼ˆé»˜è®¤å±•å¼€ï¼Œå¯æŠ˜å ï¼‰ -->
                            <div id="vipScanParams" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #9b59b6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="toggleVipScanParams()">
                                    <h3 style="margin: 0; color: #333; font-size: 14px; font-weight: 600;">âš™ï¸ è‡ªå®šä¹‰æ‰«æå‚æ•°ï¼ˆVIPä¸“äº«ï¼‰</h3>
                                    <span id="vipScanParamsToggle" style="color: #666; font-size: 12px;">â–² æ”¶èµ·</span>
                                </div>
                                <div id="vipScanParamsContent" style="display: block;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px;">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">åŒ¹é…åº¦é˜ˆå€¼</label>
                                            <input type="number" id="minMatchScore" placeholder="0.93" value="0.93" min="0.6" max="1.0" step="0.01" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                            <small style="color: #999; font-size: 11px;">èŒƒå›´ï¼š0.6-1.0ï¼ˆå»ºè®®0.93ï¼Œæ›´ä¸¥æ ¼ï¼‰</small>
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">æœ€å¤§å¸‚å€¼ï¼ˆäº¿å…ƒï¼‰</label>
                                            <input type="number" id="maxMarketCap" placeholder="100" value="100" min="0" max="500" step="1" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                            <small style="color: #999; font-size: 11px;">èŒƒå›´ï¼š0-500äº¿</small>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                            <input type="checkbox" id="excludeST" checked style="cursor: pointer;">
                                            <span>æ’é™¤STè‚¡ç¥¨</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                            <input type="checkbox" id="excludeSuspended" checked style="cursor: pointer;">
                                            <span>æ’é™¤åœç‰Œè‚¡ç¥¨</span>
                                        </label>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 10px;">
                                        <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">è¡Œä¸šç­›é€‰ï¼ˆå¯é€‰ï¼Œç•™ç©ºè¡¨ç¤ºå…¨éƒ¨ï¼‰</label>
                                        <input type="text" id="industryFilter" placeholder="ä¾‹å¦‚ï¼šè®¡ç®—æœºã€åŒ»è¯ã€ç”µå­" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                        <small style="color: #999; font-size: 11px;">è¾“å…¥è¡Œä¸šå…³é”®è¯ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”</small>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">è‡ªå®šä¹‰è‚¡ç¥¨æ± ï¼ˆå¯é€‰ï¼Œè‚¡ç¥¨ä»£ç ç”¨é€—å·åˆ†éš”ï¼‰</label>
                                        <textarea id="customStockPool" placeholder="ä¾‹å¦‚ï¼š000001,000002,600000" rows="2" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px; resize: vertical;"></textarea>
                                        <small style="color: #999; font-size: 11px;">ç•™ç©ºè¡¨ç¤ºæ‰«æå…¨å¸‚åœº</small>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="startAutoDataUpdate()" style="background: #3498db;">ğŸ“¥ æ›´æ–°æ•°æ®</button>
                                <button class="btn btn-primary" onclick="scanAllStocks()" style="background: #e74c3c;" id="scanAllStocksBtnWeb">ğŸ” æ‰«æå…¨å¸‚åœºï¼ˆVIPæ— é™æ¬¡ï¼‰</button>
                                <button class="btn btn-primary" onclick="stopScan()" style="background: #95a5a6;" id="stopScanBtnWeb" disabled>ğŸ›‘ åœæ­¢æ‰«æ</button>
                            <button class="btn btn-primary" onclick="viewVipScanHistory()" style="background: #9b59b6; font-size: 13px; padding: 8px 15px;">
                                ğŸ“š æŸ¥çœ‹å†å²è®°å½•ï¼ˆ30å¤©ï¼‰
                            </button>
                            <button class="btn btn-primary" onclick="viewWatchlist()" style="background: #e67e22; font-size: 13px; padding: 8px 15px;">
                                â­ æˆ‘çš„å…³æ³¨ï¼ˆæœ€å¤š50åªï¼‰
                            </button>
                        </div>
                        </div>
                        
                        <!-- å…è´¹ç”¨æˆ·ï¼šåªæ˜¾ç¤ºæŸ¥çœ‹ç»“æœæŒ‰é’® -->
                        <div id="freeUserButtons" style="display: none;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="startAutoDataUpdate()" style="background: #3498db;">ğŸ“¥ æ›´æ–°æ•°æ®</button>
                                <button class="btn btn-primary" onclick="viewScanResults()" style="background: #667eea;">ğŸ“Š æŸ¥çœ‹æ‰«æç»“æœ</button>
                                <button class="btn btn-primary" onclick="showVipUpgradeInfo()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: bold;">ğŸ’ å‡çº§ä¸ºVIPå®¢æˆ·</button>
                            </div>
                        </div>
                        
                        <!-- è¶…çº§ç”¨æˆ·ï¼šæ˜¾ç¤ºæ‰€æœ‰åŠŸèƒ½ -->
                        <div id="superUserButtons" style="display: none;">
                            <!-- è¶…çº§ç”¨æˆ·æ‰«æå‚æ•°ï¼ˆé»˜è®¤å±•å¼€ï¼Œå¯æŠ˜å ï¼‰ -->
                            <div id="superScanParams" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e67e22;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;" onclick="toggleSuperScanParams()">
                                    <h3 style="margin: 0; color: #333; font-size: 14px; font-weight: 600;">âš™ï¸ æ‰«æå‚æ•°è®¾ç½®</h3>
                                    <span id="superScanParamsToggle" style="color: #666; font-size: 12px;">â–² æ”¶èµ·</span>
                                </div>
                                <div id="superScanParamsContent" style="display: block;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px;">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">é€‰æ‹©æ¨¡å‹</label>
                                            <div style="display: flex; gap: 5px; align-items: flex-start;">
                                                <select id="superModelSelector" style="flex: 1; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px; background: #fff;" onchange="switchModelSuper()">
                                                    <option value="">åŠ è½½ä¸­...</option>
                                                </select>
                                                <button id="superDeleteModelBtn" onclick="deleteModelSuper()" style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;" title="åˆ é™¤é€‰ä¸­çš„æ¨¡å‹">ğŸ—‘ï¸</button>
                                            </div>
                                            <small style="color: #999; font-size: 11px;">é€‰æ‹©è¦ä½¿ç”¨çš„ç‰¹å¾æ¨¡å‹</small>
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">åŒ¹é…åº¦é˜ˆå€¼</label>
                                            <input type="number" id="superMinMatchScore" placeholder="0.93" value="0.93" min="0.6" max="1.0" step="0.01" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                            <small style="color: #999; font-size: 11px;">èŒƒå›´ï¼š0.8-1.0</small>
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">æœ€å¤§å¸‚å€¼ï¼ˆäº¿å…ƒï¼‰</label>
                                            <input type="number" id="superMaxMarketCap" placeholder="100" value="100" min="0" max="500" step="1" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                            <small style="color: #999; font-size: 11px;">èŒƒå›´ï¼š0-500äº¿ï¼Œé»˜è®¤100äº¿</small>
                                        </div>
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">æ‰«ææ•°é‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰</label>
                                            <input type="number" id="superScanLimit" placeholder="ç•™ç©ºè¡¨ç¤ºå…¨éƒ¨" min="1" step="1" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                                            <small style="color: #999; font-size: 11px;">å»ºè®®å…ˆæµ‹è¯•100åª</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="addStock()">æ·»åŠ è‚¡ç¥¨</button>
                            <button class="btn btn-secondary" onclick="clearStocks()">æ¸…ç©ºæ‰€æœ‰</button>
                            <button class="btn btn-primary" onclick="startAutoDataUpdate()" style="background: #3498db;">ğŸ“¥ æ›´æ–°æ•°æ®</button>
                            <button class="btn btn-primary" onclick="analyzeAllStocks()" style="background: #27ae60;">åˆ†ææ‰€æœ‰è‚¡ç¥¨</button>
                            <button class="btn btn-primary" onclick="trainFeatures()" style="background: #e67e22;">è®­ç»ƒç‰¹å¾æ¨¡å‹</button>
                            <button class="btn btn-primary" onclick="scanAllStocks()" style="background: #e74c3c;" id="scanAllStocksBtnSuper">ğŸ” æ‰«æå…¨å¸‚åœº</button>
                            <button class="btn btn-primary" onclick="stopScan()" style="background: #95a5a6;" id="stopScanBtnSuper" disabled>ğŸ›‘ åœæ­¢æ‰«æ</button>
                        </div>
                    </div>
                </div>
                
                <!-- åè½¬ä¸ªè‚¡ç­›é€‰æ¡ä»¶ï¼ˆä»…æœ¬åœ°ç‰ˆæœ¬æ˜¾ç¤ºï¼‰ -->
                <div id="reversalStockSection" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #9b59b6; display: none;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">ğŸ“ˆ æœç´¢åè½¬ä¸ªè‚¡ï¼ˆä¸Šå‘¨é˜´çº¿+æœ¬å‘¨é˜³çº¿ï¼‰</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 13px; font-weight: 500;">æœ€å¤§å¸‚å€¼ï¼ˆäº¿å…ƒï¼‰</label>
                            <input type="number" id="reversalMarketCapMax" placeholder="ä¾‹å¦‚: 100" value="100" min="0" step="0.1" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="scanReversalStocks()" style="background: #9b59b6; font-size: 15px; padding: 12px 24px;">ğŸ” å¼€å§‹æœç´¢</button>
                    </div>
                </div>
                
                <!-- åè½¬ä¸ªè‚¡æ‰«æç»“æœåŒºåŸŸ -->
                <div id="reversalResults" style="margin-top: 20px; display: none;"></div>
                
                <!-- KDJæ¨¡å¼ç­›é€‰æ¡ä»¶ï¼ˆä»…æœ¬åœ°ç‰ˆæœ¬æ˜¾ç¤ºï¼‰ -->
                <div id="kdjModeSection" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e74c3c; display: none;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">ğŸ“Š KDJæ¨¡å¼ï¼ˆæ—¥/å‘¨/æœˆKDJè¶…å–ç­›é€‰ï¼‰</h3>
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 13px;">ç­›é€‰æ—¥KDJã€å‘¨KDJã€æœˆKDJçš„Kã€Dã€Jå€¼éƒ½åœ¨æŒ‡å®šé˜ˆå€¼ä»¥ä¸‹çš„ä¸ªè‚¡ï¼ˆKDJå‚æ•°: 9,3,3ï¼‰</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 13px; font-weight: 500;">KDJé˜ˆå€¼ï¼ˆK/D/Jéƒ½è¦å°äºæ­¤å€¼ï¼‰</label>
                            <input type="number" id="kdjThreshold" placeholder="ä¾‹å¦‚: 20" value="20" min="0" max="100" step="1" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 13px; font-weight: 500;">è¿”å›æ•°é‡é™åˆ¶</label>
                            <input type="number" id="kdjLimit" placeholder="ä¾‹å¦‚: 50" value="50" min="1" max="200" step="1" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="scanKdjStocks()" style="background: #e74c3c; font-size: 15px; padding: 12px 24px;" id="scanKdjBtn">ğŸ” å¼€å§‹KDJæ‰«æ</button>
                        <button class="btn btn-secondary" onclick="stopKdjScan()" style="background: #95a5a6; font-size: 15px; padding: 12px 24px;" id="stopKdjBtn" disabled>ğŸ›‘ åœæ­¢æ‰«æ</button>
                    </div>
                </div>

                <!-- KDJæ¨¡å¼æ‰«æç»“æœåŒºåŸŸ -->
                <div id="kdjResults" style="margin-top: 20px; display: none;"></div>
                
                <!-- å‘¨Kçº¿å›¾æ¨¡æ€æ¡† -->
                <div id="weeklyKlineModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow: auto;">
                    <div style="max-width: 1200px; margin: 20px auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 id="weeklyKlineTitle" style="margin: 0; color: #333;">å‘¨Kçº¿å›¾</h3>
                            <button onclick="closeWeeklyKline()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 16px;">å…³é—­</button>
                        </div>
                        <div id="weeklyKlineChart" style="width: 100%; height: 600px;"></div>
                    </div>
                </div>
                
                <!-- è¿›åº¦æ¡ -->
                <div id="progressContainer" class="progress-container" style="margin-top: 20px;">
                    <div class="progress-bar-wrapper">
                        <div id="progressBarFill" class="progress-bar-fill" style="width: 0%;">0%</div>
                    </div>
                    <div class="progress-info">
                        <span id="progressStatus" class="progress-status">å‡†å¤‡ä¸­...</span>
                        <span id="progressDetail">-</span>
                    </div>
                </div>
                
                <!-- æ‰¾ä¹°ç‚¹åŠŸèƒ½ -->
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ” æ‰¾ä¹°ç‚¹åŠŸèƒ½</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">åŒ¹é…åº¦é˜ˆå€¼</label>
                            <input type="number" id="buyPointMatchThreshold" placeholder="0.95" value="0.95" min="0.6" max="1.0" step="0.01" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                            <small style="color: #999; font-size: 11px;">èŒƒå›´ï¼š0.6-1.0ï¼Œé»˜è®¤0.95</small>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 12px; font-weight: 500;">æœç´¢å¹´æ•°</label>
                            <input type="number" id="buyPointSearchYears" placeholder="5" value="5" min="1" max="10" step="1" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px;">
                            <small style="color: #999; font-size: 11px;">èŒƒå›´ï¼š1-10å¹´ï¼Œé»˜è®¤5å¹´</small>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="findBuyPointCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç " style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                        <button class="btn btn-primary" onclick="findBuyPoints()" style="background: #9b59b6;">æŸ¥æ‰¾ä¹°ç‚¹</button>
                    </div>
                    <div id="buyPointsResult" style="margin-top: 15px;"></div>
                </div>
                
            </div>
            
            <!-- è‚¡ç¥¨åˆ—è¡¨ -->
            <div class="stocks-list" id="stocksListSection">
                <h2>å·²æ·»åŠ çš„å¤§ç‰›è‚¡</h2>
                <div id="stocksContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>è¿˜æ²¡æœ‰æ·»åŠ å¤§ç‰›è‚¡</p>
                        <p style="font-size: 12px; margin-top: 10px;">è¯·åœ¨ä¸Šæ–¹è¾“å…¥è‚¡ç¥¨ä»£ç æ·»åŠ </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 3000);
        }
        
        // æ·»åŠ è‚¡ç¥¨
        async function addStock() {
            const code = document.getElementById('stockCode').value.trim();
            const name = document.getElementById('stockName').value.trim();
            
            if (!code) {
                showMessage('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
                return;
            }
            
            if (code.length !== 6 || !/^\d+$/.test(code)) {
                showMessage('è‚¡ç¥¨ä»£ç å¿…é¡»æ˜¯6ä½æ•°å­—', 'error');
                return;
            }
            
            try {
                showMessage('æ­£åœ¨æ·»åŠ è‚¡ç¥¨ï¼Œè¯·ç¨å€™...', 'success');
                
                const response = await fetch('/api/add_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        name: name || null
                    })
                });
                
                // æ£€æŸ¥HTTPçŠ¶æ€ç 
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTPé”™è¯¯:', response.status, errorText);
                    showMessage(`æ·»åŠ å¤±è´¥: HTTP ${response.status} - ${errorText.substring(0, 100)}`, 'error');
                    return;
                }
                
                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('æœåŠ¡å™¨è¿”å›éJSONæ•°æ®:', text.substring(0, 200));
                    showMessage('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„æ•°æ®ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—', 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('æ·»åŠ è‚¡ç¥¨ç»“æœ:', result);
                
                if (result.success) {
                    showMessage(result.message || 'âœ… æ·»åŠ æˆåŠŸ', 'success');
                    document.getElementById('stockCode').value = '';
                    document.getElementById('stockName').value = '';
                    // å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°åˆ—è¡¨ï¼Œç¡®ä¿æ•°æ®å·²ä¿å­˜
                    setTimeout(() => {
                        loadStocks();
                    }, 500);
                } else {
                    // å¦‚æœæ˜¯é‡å¤æ·»åŠ ï¼Œæ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
                    showMessage(result.message || 'âŒ æ·»åŠ å¤±è´¥', 'error');
                    // å¦‚æœè‚¡ç¥¨å·²å­˜åœ¨ï¼Œä¸æ¸…ç©ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·çŸ¥é“
                    if (result.message && result.message.includes('å·²å­˜åœ¨')) {
                        // å¯ä»¥é€‰æ‹©ä¸æ¸…ç©ºï¼Œæˆ–è€…æ¸…ç©º
                        // document.getElementById('stockCode').value = '';
                    }
                }
            } catch (error) {
                console.error('æ·»åŠ è‚¡ç¥¨å¼‚å¸¸:', error);
                showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ç§»é™¤è‚¡ç¥¨
        async function removeStock(code) {
            if (!confirm(`ç¡®å®šè¦ç§»é™¤è‚¡ç¥¨ ${code} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/remove_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadStocks();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('ç§»é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰è‚¡ç¥¨
        async function clearStocks() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²æ·»åŠ çš„å¤§ç‰›è‚¡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear_stocks', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadStocks();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½è‚¡ç¥¨åˆ—è¡¨
        // æ£€æŸ¥åŒ¹é…åº¦çŠ¶æ€å¹¶æ›´æ–°UI
        async function checkMatchScoreStatus() {
            try {
                // âœ… æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼ˆ2ç§’ï¼Œå¿«é€Ÿå¤±è´¥ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.warn('[checkMatchScoreStatus] è¯·æ±‚è¶…æ—¶ï¼ˆ2ç§’ï¼‰ï¼Œä¸­æ–­è¯·æ±‚');
                    controller.abort();
                }, 2000); // âœ… å‡å°‘åˆ°2ç§’
                
                let response;
                try {
                    response = await fetch('/api/get_trained_features', {
                        signal: controller.signal,
                        cache: 'no-store'
                    });
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        console.warn('[checkMatchScoreStatus] è¯·æ±‚è¶…æ—¶ï¼Œè·³è¿‡æ£€æŸ¥');
                        return; // è¶…æ—¶ç›´æ¥è¿”å›ï¼Œä¸é˜»å¡é¡µé¢
                    }
                    throw fetchError;
                }
                
                if (!response.ok) {
                    console.error('[checkMatchScoreStatus] HTTPé”™è¯¯:', response.status);
                    return;
                }
                
                const result = await response.json();
                
                console.log('æ¨¡å‹æ£€æŸ¥ç»“æœ:', result);
                console.log('æ¨¡å‹æ£€æŸ¥è¯¦æƒ…:', {
                    success: result.success,
                    hasCommonFeatures: !!result.common_features,
                    commonFeaturesLength: result.common_features ? Object.keys(result.common_features).length : 0,
                    commonFeaturesKeys: result.common_features ? Object.keys(result.common_features).slice(0, 5) : []
                });
                
                // æ£€æŸ¥æ¨¡å‹æ˜¯å¦å­˜åœ¨ï¼šsuccess ä¸º true ä¸” common_features å­˜åœ¨ä¸”ä¸ä¸ºç©º
                const hasFeatures = result.success && 
                    result.common_features && 
                    Object.keys(result.common_features).length > 0;
                
                console.log('hasFeatures:', hasFeatures);
                
                if (hasFeatures) {
                    // æ¨¡å‹å­˜åœ¨ï¼Œéšè—è­¦å‘Šä¿¡æ¯
                    const messageEl = document.getElementById('message');
                    if (messageEl && messageEl.textContent.includes('è¯·å…ˆæ·»åŠ å¤§ç‰›è‚¡')) {
                        messageEl.classList.remove('show');
                        messageEl.textContent = '';
                    }
                    
                    // å¦‚æœåŒ¹é…åº¦å·²è¾¾æ ‡ï¼Œéšè—åˆ†æå’Œè®­ç»ƒæŒ‰é’®
                    if (result.match_score_ready) {
                        const analyzeBtn = document.querySelector('button[onclick="analyzeAllStocks()"]');
                        const trainBtn = document.querySelector('button[onclick="trainFeatures()"]');
                        
                        if (analyzeBtn) {
                            analyzeBtn.style.display = 'none';
                        }
                        if (trainBtn) {
                            trainBtn.style.display = 'none';
                        }
                        
                        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                        const btnGroup = document.querySelector('.btn-group');
                        if (btnGroup && !document.getElementById('matchScoreReadyMsg')) {
                            const msg = document.createElement('div');
                            msg.id = 'matchScoreReadyMsg';
                            msg.style.cssText = 'padding: 10px; background: #d4edda; color: #155724; border-radius: 6px; margin-top: 10px; font-size: 14px;';
                            msg.innerHTML = `âœ… åŒ¹é…åº¦å·²è¾¾æ ‡ï¼ˆæœ€é«˜: ${result.max_match_score.toFixed(3)} >= 0.95ï¼‰ï¼Œå¯ç›´æ¥æµ‹è¯•ï¼`;
                            btnGroup.appendChild(msg);
                        }
                    } else {
                        // æ¨¡å‹å­˜åœ¨ä½†åŒ¹é…åº¦æœªè¾¾æ ‡ï¼Œæ˜¾ç¤ºæç¤º
                        const btnGroup = document.querySelector('.btn-group');
                        if (btnGroup && !document.getElementById('modelLoadedMsg')) {
                            const msg = document.createElement('div');
                            msg.id = 'modelLoadedMsg';
                            msg.style.cssText = 'padding: 10px; background: #d1ecf1; color: #0c5460; border-radius: 6px; margin-top: 10px; font-size: 14px;';
                            msg.innerHTML = `âœ… æ¨¡å‹å·²åŠ è½½ï¼ˆç‰¹å¾æ•°: ${Object.keys(result.common_features).length}ï¼‰ï¼Œå¯ä»¥ç›´æ¥æ‰«æå…¨å¸‚åœºï¼`;
                            btnGroup.appendChild(msg);
                        }
                    }
                } else {
                    // æ¨¡å‹ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºè­¦å‘Šï¼ˆä½†åªåœ¨å¿…è¦æ—¶æ˜¾ç¤ºï¼Œé¿å…é¡µé¢åŠ è½½æ—¶é—ªçƒï¼‰
                    console.log('æ¨¡å‹ä¸å­˜åœ¨ï¼Œéœ€è¦è®­ç»ƒ');
                }
            } catch (error) {
                console.error('æ£€æŸ¥åŒ¹é…åº¦çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        async function loadStocks(retryCount = 0) {
            const maxRetries = 1; // âœ… å‡å°‘é‡è¯•æ¬¡æ•°
            try {
                console.log('[loadStocks] å¼€å§‹è·å–è‚¡ç¥¨åˆ—è¡¨... (å°è¯• ' + (retryCount + 1) + '/' + (maxRetries + 1) + ')');
                
                // âœ… æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼ˆ3ç§’ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // âœ… å‡å°‘åˆ°3ç§’è¶…æ—¶
                
                const response = await fetch('/api/get_stocks', {
                    signal: controller.signal,
                    cache: 'no-cache' // ç¦ç”¨ç¼“å­˜
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    console.error('[loadStocks] HTTPé”™è¯¯:', response.status);
                    const container = document.getElementById('stocksContainer');
                    const countEl = document.getElementById('stockCount');
                    if (countEl) countEl.textContent = '0';
                    if (container) {
                        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: HTTP ${response.status}</p><p style="font-size: 12px; margin-top: 10px;">è¯·åˆ·æ–°é¡µé¢é‡è¯•</p></div>`;
                    }
                    return;
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('[loadStocks] æœåŠ¡å™¨è¿”å›éJSONæ•°æ®:', text.substring(0, 200));
                    return;
                }
                
                const result = await response.json();
                console.log('[loadStocks] è·å–ç»“æœ:', result);
                
                const container = document.getElementById('stocksContainer');
                const countEl = document.getElementById('stockCount');
                
                if (!container || !countEl) {
                    console.error('[loadStocks] æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´  - container:', container, 'countEl:', countEl);
                    return;
                }
                
                // å…¼å®¹ä¸åŒçš„è¿”å›æ ¼å¼ - ä¸æ£€æŸ¥successå­—æ®µï¼Œç›´æ¥ä½¿ç”¨countå’Œstocks
                const stockCount = result.count !== undefined ? result.count : (result.stocks ? result.stocks.length : 0);
                const stocks = result.stocks || [];
                
                // æ›´æ–°è®¡æ•°
                countEl.textContent = stockCount;
                
                if (stockCount === 0 || stocks.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <p>è¿˜æ²¡æœ‰æ·»åŠ å¤§ç‰›è‚¡</p>
                            <p style="font-size: 12px; margin-top: 10px;">è¯·åœ¨ä¸Šæ–¹è¾“å…¥è‚¡ç¥¨ä»£ç æ·»åŠ </p>
                        </div>
                    `;
                    console.log('[loadStocks] æ˜¾ç¤ºç©ºçŠ¶æ€');
                } else {
                    container.innerHTML = stocks.map(stock => {
                        // ä½¿ç”¨æ–¹æ‹¬å·è®¿é—®ä¸­æ–‡å­—æ®µåï¼Œç¡®ä¿å…¼å®¹æ€§
                        const code = stock['ä»£ç '] || stock.ä»£ç  || '';
                        const name = stock['åç§°'] || stock.åç§° || '';
                        const addTime = stock['æ·»åŠ æ—¶é—´'] || stock.æ·»åŠ æ—¶é—´ || '';
                        const dataCount = stock['æ•°æ®æ¡æ•°'] || stock.æ•°æ®æ¡æ•° || 0;
                        
                        return `
                            <div class="stock-item" id="stock-${code}">
                                <div class="stock-item-header">
                                    <div class="stock-info">
                                        <div class="stock-code">${code}</div>
                                        <div class="stock-name">${name}</div>
                                        <div class="stock-meta">
                                            æ·»åŠ æ—¶é—´: ${addTime} | æ•°æ®æ¡æ•°: ${dataCount}
                                        </div>
                                    </div>
                                    <div class="stock-actions">
                                        <button class="btn btn-primary" onclick="analyzeStock('${code}')" style="background: #27ae60; margin-right: 10px;">åˆ†æ</button>
                                        <button class="btn btn-danger" onclick="removeStock('${code}')">ç§»é™¤</button>
                                    </div>
                                </div>
                                <div class="stock-item-content" id="analysis-${code}">
                                    <!-- åˆ†æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('[loadStocks] å¼‚å¸¸:', error);
                
                // âœ… å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ä¸”è¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œè‡ªåŠ¨é‡è¯•ï¼ˆå‡å°‘å»¶è¿Ÿï¼‰
                if ((error.name === 'TypeError' || error.name === 'Failed to fetch' || error.message.includes('fetch')) && retryCount < maxRetries) {
                    console.log('[loadStocks] ç½‘ç»œé”™è¯¯ï¼Œ1ç§’åé‡è¯•...');
                    setTimeout(() => {
                        loadStocks(retryCount + 1);
                    }, 1000); // âœ… å‡å°‘åˆ°1ç§’
                    return;
                }
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errorMsg = error.name === 'AbortError' ? 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥' : 
                                (error.message || 'ç½‘ç»œè¿æ¥å¤±è´¥');
                showMessage('åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥: ' + errorMsg, 'error');
                
                const container = document.getElementById('stocksContainer');
                const countEl = document.getElementById('stockCount');
                if (countEl) countEl.textContent = '0';
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨</p>
                            <p style="font-size: 12px; margin-top: 10px;">é”™è¯¯: ${errorMsg}</p>
                            <p style="font-size: 12px; margin-top: 5px;">
                                <button onclick="location.reload()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                    åˆ·æ–°é¡µé¢
                                </button>
                            </p>
                        </div>`;
                }
            }
        }
        
        // å›è½¦é”®æ·»åŠ  - å»¶è¿Ÿç»‘å®šï¼Œç¡®ä¿DOMå·²åŠ è½½
        function bindEnterKeyEvents() {
            const stockCodeEl = document.getElementById('stockCode');
            const stockNameEl = document.getElementById('stockName');
            
            if (stockCodeEl) {
                stockCodeEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addStock();
                    }
                });
            }
            
            if (stockNameEl) {
                stockNameEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addStock();
                    }
                });
            }
        }
        
        // ç¡®ä¿DOMåŠ è½½åå†ç»‘å®šäº‹ä»¶
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', bindEnterKeyEvents);
        } else {
            bindEnterKeyEvents();
        }
        
        // åˆ†æå•åªè‚¡ç¥¨
        async function analyzeStock(code) {
            showMessage('æ­£åœ¨åˆ†æ ' + code + '...', 'success');
            
            try {
                const response = await fetch('/api/analyze_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                });
                
                const result = await response.json();
                
                if (result.success && result.interval) {
                    const interval = result.interval;
                    const analysisDiv = document.getElementById('analysis-' + code);
                    
                    analysisDiv.innerHTML = `
                        <div class="analysis-result">
                            <h4>ğŸ“ˆ æ¶¨å¹…æœ€å¤§åŒºé—´åˆ†æç»“æœ</h4>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">èµ·ç‚¹æ—¥æœŸ:</span>
                                <span class="analysis-result-value">${interval.èµ·ç‚¹æ—¥æœŸ}</span>
                            </div>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">èµ·ç‚¹ä»·æ ¼:</span>
                                <span class="analysis-result-value">${interval.èµ·ç‚¹ä»·æ ¼.toFixed(2)} å…ƒ</span>
                            </div>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">ç»ˆç‚¹æ—¥æœŸ:</span>
                                <span class="analysis-result-value">${interval.ç»ˆç‚¹æ—¥æœŸ}</span>
                            </div>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">ç»ˆç‚¹ä»·æ ¼:</span>
                                <span class="analysis-result-value">${interval.ç»ˆç‚¹ä»·æ ¼.toFixed(2)} å…ƒ</span>
                            </div>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">æ¶¨å¹…:</span>
                                <span class="analysis-result-value gain-positive">${interval.æ¶¨å¹….toFixed(2)}% (ç¿»${interval.ç¿»å€å€æ•°.toFixed(2)}å€)</span>
                            </div>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">äº¤æ˜“æ—¥æ•°:</span>
                                <span class="analysis-result-value">${interval.äº¤æ˜“æ—¥æ•°} å¤©</span>
                            </div>
                        </div>
                    `;
                    analysisDiv.classList.add('show');
                    showMessage(result.message, 'success');
                } else {
                    showMessage(result.message || 'åˆ†æå¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('åˆ†æå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤º/éšè—è¿›åº¦æ¡
        function showProgress() {
            document.getElementById('progressContainer').classList.add('show');
        }
        
        function hideProgress() {
            document.getElementById('progressContainer').classList.remove('show');
        }
        
        function updateProgress(percentage, status, detail) {
            document.getElementById('progressBarFill').style.width = percentage + '%';
            document.getElementById('progressBarFill').textContent = percentage.toFixed(1) + '%';
            document.getElementById('progressStatus').textContent = status;
            document.getElementById('progressDetail').textContent = detail;
        }
        
        // è½®è¯¢è¿›åº¦
        let progressInterval = null;
        
        function startProgressPolling() {
            console.log('[å®æ—¶æ˜¾ç¤º] startProgressPolling å¼€å§‹, currentScanId=' + (window.currentScanId || 'null'));
            // ä¸åœ¨æ­¤å¤„è®¾ _scanJustCleared=falseï¼Œé¿å…åœ¨æ‹¿åˆ°æ–° scan_id å‰ç”¨æ—§ progress è¦†ç›–æ¸…ç©ºç»“æœï¼›è§ scanAllStocks å†… result.success / ç»§ç»­æ‰«æ / åå°å·²å¯åŠ¨ ç­‰åˆ†æ”¯
            if (progressInterval) {
                clearInterval(progressInterval);
                console.log('[startProgressPolling] æ¸…é™¤æ—§çš„è¿›åº¦è½®è¯¢');
            }
            
            progressInterval = setInterval(async () => {
                try {
                    const scanId = window.currentScanId || '';
                    const url = '/api/get_progress' + (scanId ? '?scan_id=' + encodeURIComponent(scanId) : '');
                    const response = await fetch(url, {
                        cache: 'no-store',
                        credentials: 'same-origin',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    if (response.status === 401) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                        showMessage('ç™»å½•å·²è¿‡æœŸæˆ–æœåŠ¡å·²é‡å¯ï¼Œè¯·é‡æ–°ç™»å½•åé‡è¯•', 'error');
                        if (typeof isScanning !== 'undefined') isScanning = false;
                        return;
                    }
                    const result = await response.json();
                    
                    if (result.success && result.progress) {
                        const progress = result.progress;
                        if (window._scanJustCleared) return;  // åˆšæ¸…ç©ºï¼Œå¿½ç•¥æ—§è½®è¯¢å›è°ƒï¼Œé¿å…è¦†ç›–
                        
                        // âœ… ä»…å½“åç«¯æ˜ç¡®æ˜¯â€œæ‰«æä»»åŠ¡â€æ—¶ï¼Œæ‰å…è®¸å†™å…¥ buyPointsResultï¼ˆé¿å…è¦†ç›–â€œæ‰¾ä¹°ç‚¹â€ç­‰å…¶ä»–åŠŸèƒ½çš„å±•ç¤ºï¼‰
                        const isScanProgress = (progress.type === 'scan' || progress.type === 'scan_all_stocks');
                        // ã€å®æ—¶æ˜¾ç¤º-æ—¥å¿—ã€‘è½®è¯¢ get_progress è¿”å›
                        const cLen = (progress.candidates && progress.candidates.length) || 0;
                        const cIsArr = Array.isArray(progress.candidates);
                        console.log('[å®æ—¶æ˜¾ç¤º] get_progress: found=' + (progress.found ?? 'undefined') + ', candidates=' + (cIsArr ? cLen + 'åª' : 'éæ•°ç»„(' + (typeof progress.candidates) + ')') + ', status=' + (progress.status || ''));
                        
                        let detailText = progress.detail || '';
                        if (progress.found !== undefined) {
                            detailText += ` | å·²æ‰¾åˆ°: ${progress.found} åª`;
                        }
                        
                        // å¦‚æœæœ‰æ•°æ®è­¦å‘Šï¼Œæ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
                        if (progress.data_warning) {
                            detailText += `\n${progress.data_warning}`;
                            // æ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
                            showMessage(progress.data_warning, 'warning');
                        }
                        
                        updateProgress(progress.percentage, progress.status, detailText);

                        // âœ… æ‰«æè¿‡ç¨‹ä¸­ï¼šå®æ—¶æŠŠæ–°æ‰¾åˆ°çš„å€™é€‰æ¸²æŸ“å‡ºæ¥ï¼ˆæ‰¾åˆ°ä¸€åªæ˜¾ç¤ºä¸€åªï¼‰
                        try {
                            // åªè¦æœ‰ candidates å°±æ˜¾ç¤ºï¼Œä¸ä¸¥æ ¼æ£€æŸ¥ type
                            if (isScanProgress && Array.isArray(progress.candidates) && progress.candidates.length > 0) {
                                console.log('[å®æ—¶æ˜¾ç¤º] è¿›åº¦è½®è¯¢â†’ æœ‰candidatesï¼Œè°ƒç”¨ updateLiveScanResults');
                                updateLiveScanResults(progress);
                            } else if (isScanProgress && progress.found > 0) {
                                console.log('[å®æ—¶æ˜¾ç¤º] è¿›åº¦è½®è¯¢â†’ found>0 ä½† candidates ä¸ºç©ºï¼Œä»è°ƒç”¨ updateLiveScanResults');
                                // å³ä½¿candidatesä¸ºç©ºï¼Œä¹Ÿæ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
                                updateLiveScanResults(progress);
                            } else if (isScanProgress && (progress.status === 'è¿›è¡Œä¸­' || progress.status === 'running')) {
                                console.log('[å®æ—¶æ˜¾ç¤º] è¿›åº¦è½®è¯¢â†’ è¿›è¡Œä¸­ä¸”æ— candidatesï¼Œä»…æ›´æ–°è¿›åº¦æ–‡æ¡ˆ');
                                // æ‰«æè¿›è¡Œä¸­ä½†è¿˜æ²¡æœ‰æ‰¾åˆ°è‚¡ç¥¨ï¼Œæ˜¾ç¤ºè¿›åº¦æç¤º
                                const container = document.getElementById('buyPointsResult');
                                if (container) {
                                    const current = progress.current || 0;
                                    const total = progress.total || 0;
                                    const percentage = progress.percentage || 0;
                                    // âœ… ç›‘æ§ï¼šæ˜¾ç¤ºå½“å‰å¤„ç†çš„è‚¡ç¥¨
                                    const currentStock = progress.current_stock || '';
                                    const currentStockName = progress.current_stock_name || '';
                                    const currentStockInfo = currentStock ? `<p style="color: #667eea; font-size: 13px; font-weight: bold; margin-top: 8px;">ğŸ“ å½“å‰å¤„ç†: ${currentStock} ${currentStockName}</p>` : '';
                                    
                                    container.innerHTML = `<div style="text-align: center; padding: 20px; color: #666; background: white; border-radius: 6px; margin-top: 15px;">
                                        <span style="font-size: 24px;">ğŸ”</span>
                                        <p style="margin-top: 10px;">æ­£åœ¨æ‰«æå…¨å¸‚åœºï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨å°†å®æ—¶æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
                                        <p style="color: #999; font-size: 12px; margin-top: 5px;">å·²æ‰«æ: ${current}/${total} (${percentage.toFixed(1)}%)</p>
                                        <p style="color: #999; font-size: 12px;">å½“å‰çŠ¶æ€: ${progress.detail || progress.status || 'æ‰«æä¸­'}</p>
                                        ${currentStockInfo}
                                        ${progress.data_warning ? `<p style="color: #e74c3c; font-size: 12px; margin-top: 5px; font-weight: bold;">${progress.data_warning}</p>` : ''}
                                    </div>`;
                                }
                            }
                        } catch (e) {
                            console.error('[å®æ—¶æ˜¾ç¤º] è¿›åº¦è½®è¯¢-å®æ—¶å±•ç¤ºå€™é€‰å¤±è´¥:', e);
                        }
                        
                        // å¦‚æœå®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
                        if (progress.status === 'å®Œæˆ' || progress.status === 'å¤±è´¥' || progress.status === 'ç©ºé—²') {
                            // âœ… ç©ºé—²ï¼šè¡¨ç¤ºå½“å‰æ²¡æœ‰æ‰«æä»»åŠ¡ï¼›ä¸è¦è¦†ç›– buyPointsResultï¼ˆå¦åˆ™ä¼šå‡ºç°â€œ0/0 æ‰«æå®Œæˆâ€çš„å‡è±¡ï¼‰
                            if (progress.status === 'ç©ºé—²') {
                                clearInterval(progressInterval);
                                progressInterval = null;
                                if (typeof isScanning !== 'undefined') isScanning = false;
                                return;
                            }
                            
                            // âœ… å…³é”®ï¼šåœ¨åœæ­¢è½®è¯¢å‰ï¼Œæœ€åä¸€æ¬¡æ›´æ–°æ˜¾ç¤ºç»“æœï¼ˆä»…é™æ‰«æä»»åŠ¡ï¼‰
                            if (isScanProgress && progress.status === 'å®Œæˆ') {
                                // ç¡®ä¿æ˜¾ç¤ºæœ€ç»ˆç»“æœï¼ˆå³ä½¿candidatesä¸ºç©ºï¼Œä¹Ÿè¦ä»ç¼“å­˜ä¸­è·å–ï¼‰
                                updateLiveScanResults(progress);
                                
                                // âœ… å¦‚æœæ‰«æå®Œæˆä½†ç»“æœè¿˜æ²¡æ˜¾ç¤ºï¼Œå°è¯•ä»åç«¯è·å–
                                const foundCount = progress.found || 0;
                                const cachedCount = window._liveScanCandidateMap ? Object.keys(window._liveScanCandidateMap).length : 0;
                                
                                if (foundCount > 0 && cachedCount === 0) {
                                    // æ‰«æå®Œæˆï¼Œæ‰¾åˆ°äº†è‚¡ç¥¨ï¼Œä½†ç¼“å­˜ä¸ºç©ºï¼Œä»åç«¯è·å–
                                    console.log('[æ‰«æå®Œæˆ] å‘ç°ç»“æœæœªåŒæ­¥ï¼Œä»åç«¯è·å–æœ€ç»ˆç»“æœ...');
                                    fetch('/api/get_scan_results')
                                        .then(response => response.json())
                                        .then(resultsResult => {
                                            if (resultsResult.success && resultsResult.candidates && resultsResult.candidates.length > 0) {
                                                // å°†ç»“æœåŒæ­¥åˆ°ç¼“å­˜å¹¶æ˜¾ç¤º
                                                if (!window._liveScanCandidateMap) window._liveScanCandidateMap = {};
                                                for (const c of resultsResult.candidates) {
                                                    const code = c.è‚¡ç¥¨ä»£ç  || c.code || '';
                                                    const date = c.æœ€ä½³ä¹°ç‚¹æ—¥æœŸ || c.buy_date || '';
                                                    if (!code) continue;
                                                    const key = `${code}__${date}`;
                                                    window._liveScanCandidateMap[key] = c;
                                                }
                                                // æ›´æ–°æ˜¾ç¤º
                                                updateLiveScanResults({
                                                    ...progress,
                                                    candidates: resultsResult.candidates
                                                });
                                            }
                                        })
                                        .catch(error => {
                                            console.error('[æ‰«æå®Œæˆ] è·å–æœ€ç»ˆç»“æœå¤±è´¥:', error);
                                        });
                                }
                            }
                            
                            clearInterval(progressInterval);
                            progressInterval = null;
                            
                            if (progress.status === 'å®Œæˆ') {
                                // âœ… å…³é”®ï¼šæ‰«æå®Œæˆåé‡ç½® isScanning æ ‡å¿—ï¼Œå…è®¸é‡æ–°æ‰«æ
                                isScanning = false;
                                console.log('[startProgressPolling] æ‰«æå®Œæˆï¼Œé‡ç½® isScanning = false');
                                
                                // âœ… å¦‚æœæ‰«æå®Œæˆï¼Œä¿å­˜scan_idï¼ˆç”¨äºä¸‹æ¬¡æ¯”è¾ƒï¼‰
                                if (progress.scan_id) {
                                    const lastParams = getLastScanParams();
                                    if (lastParams) {
                                        lastParams.scan_id = progress.scan_id;
                                        saveLastScanParams(lastParams);
                                        console.log('[startProgressPolling] âœ… æ‰«æå®Œæˆï¼Œå·²ä¿å­˜scan_id:', progress.scan_id);
                                    }
                                }
                                
                                // ã€ä¸å¯å˜ã€‘è¿‡ç¨‹ä¸æœ€åä¸€è‡´ï¼šä¸è°ƒç”¨ displayScanResultsï¼Œä¸è¦†ç›– updateLiveScanResults çš„å®æ—¶ç»“æœã€‚è§ æ‰«ææ˜¾ç¤ºä¸å¯å˜é€»è¾‘.md
                                setTimeout(() => {
                                    hideProgress();
                                    // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯ï¼Œä½†ä¸è¦†ç›–å·²æ˜¾ç¤ºçš„ç»“æœ
                                    const foundCount = progress.found || (progress.candidates ? progress.candidates.length : 0) || (window._liveScanCandidateMap ? Object.keys(window._liveScanCandidateMap).length : 0);
                                    const totalScanned = progress.current || progress.total || 0;
                                    if (foundCount > 0) {
                                        showMessage(`æ‰«æå®Œæˆï¼å…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œæ‰¾åˆ° ${foundCount} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨`, 'success');
                                    } else {
                                        showMessage(`æ‰«æå®Œæˆï¼å…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œæœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨`, 'warning');
                                    }
                                }, 1000);  // 1ç§’åéšè—è¿›åº¦æ¡
                            } else if (progress.status === 'å¤±è´¥' || progress.status === 'ç©ºé—²') {
                                // âœ… å…³é”®ï¼šæ‰«æå¤±è´¥æˆ–ç©ºé—²æ—¶ä¹Ÿé‡ç½® isScanning æ ‡å¿—
                                isScanning = false;
                                console.log(`[startProgressPolling] æ‰«æ${progress.status}ï¼Œé‡ç½® isScanning = false`);
                            }
                        }
                    } else {
                        console.log('[å®æ—¶æ˜¾ç¤º] get_progress: success=' + (result.success) + ', æœ‰progress=' + !!(result.progress));
                    }
                } catch (error) {
                    console.error('[å®æ—¶æ˜¾ç¤º] è·å–è¿›åº¦å¤±è´¥:', error);
                }
            }, 500); // æ¯500msè½®è¯¢ä¸€æ¬¡
        }

        // ========== ã€ä¸å¯å˜é€»è¾‘ï¼Œä¸¥ç¦ä¿®æ”¹ã€‘ ==========
        // 1. æ‰¾åˆ°ä¸€åªï¼Œæ˜¾ç¤ºä¸€åªï¼šæœ¬å‡½æ•°è´Ÿè´£æŠŠ progress.candidates åˆå¹¶è¿› _liveScanCandidateMap å¹¶ç«‹å³æ¸²æŸ“
        // 2. è¿‡ç¨‹ä¸æœ€åä¸€è‡´ï¼šæœ€ç»ˆç»“æœå¿…é¡»ä» _liveScanCandidateMap æ¸²æŸ“ï¼Œç¦æ­¢ç”¨ get_scan_results/displayScanResults è¦†ç›–
        // è¯¦è§ï¼šæ‰«ææ˜¾ç¤ºä¸å¯å˜é€»è¾‘.md
        // ============================================
        function updateLiveScanResults(progress) {
            try {
            if (window._scanJustCleared) return;  // åˆšæ¸…ç©ºï¼Œä¸å†™å…¥æ—§æ•°æ®
            const candidates = progress.candidates || [];
            const isArray = Array.isArray(candidates);
            console.log('[å®æ—¶æ˜¾ç¤º] updateLiveScanResults å…¥å‚: found=' + (progress.found ?? 'undefined') + ', candidates=' + (isArray ? candidates.length + 'åª' : 'éæ•°ç»„') + ', status=' + (progress.status || ''));
            
            // å¦‚æœæ²¡æœ‰candidatesæ•°ç»„ï¼Œä½†found > 0ï¼Œè‡³å°‘æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
            if (!isArray && progress.found === 0) {
                console.log('[å®æ—¶æ˜¾ç¤º] updateLiveScanResults æå‰ return: !isArray ä¸” found===0');
                return;
            }

            if (!window._liveScanCandidateMap) window._liveScanCandidateMap = {};

            // åˆå¹¶å»é‡ï¼škey=è‚¡ç¥¨ä»£ç +ä¹°ç‚¹æ—¥æœŸ
            let mergedIn = 0;
            if (isArray) {
                for (const c of candidates) {
                    const code = c.è‚¡ç¥¨ä»£ç  || c.code || '';
                    const date = c.æœ€ä½³ä¹°ç‚¹æ—¥æœŸ || c.buy_date || '';
                    if (!code) continue;
                    const key = `${code}__${date}`;
                    window._liveScanCandidateMap[key] = c;
                    mergedIn++;
                }
            }
            if (isArray && candidates.length > 0) {
                console.log('[å®æ—¶æ˜¾ç¤º] åˆå¹¶è¿› Map: æœ¬æ¬¡ ' + mergedIn + ' åªï¼ŒMap å…± ' + Object.keys(window._liveScanCandidateMap).length + ' åª');
                if (mergedIn === 0) console.warn('[å®æ—¶æ˜¾ç¤º] æœ¬æ‰¹ ' + candidates.length + ' æ¡å‡æ— æœ‰æ•ˆ è‚¡ç¥¨ä»£ç ï¼Œé¦–æ¡ keys:', Object.keys(candidates[0] || {}));
            }

            let merged = Object.values(window._liveScanCandidateMap);
            merged.sort((a, b) => (b.åŒ¹é…åº¦ || b.match_score || 0) - (a.åŒ¹é…åº¦ || a.match_score || 0));
            // å‰ç«¯æœ€å¤šå±•ç¤º 30 åªï¼ŒæŒ‰åŒ¹é…åº¦ä»é«˜åˆ°ä½ï¼›è¶…è¿‡ 30 åªæ—¶ï¼ŒåŒ¹é…åº¦æœ€ä½çš„ä¼šè¢«æ›´é«˜çš„æ›¿æ¢å‡ºå±•ç¤ºåˆ—è¡¨
            let top = merged.slice(0, 30);
            console.log('[å®æ—¶æ˜¾ç¤º] åˆå¹¶å merged=' + merged.length + ', top=' + top.length);

            const container = document.getElementById('buyPointsResult');
            if (!container) {
                console.error('[å®æ—¶æ˜¾ç¤º] buyPointsResult å®¹å™¨ä¸å­˜åœ¨');
                return;
            }
            
            // âœ… å…³é”®ï¼šå¦‚æœæ‰«æå·²å®Œæˆä½†mergedä¸ºç©ºï¼Œä¸”progress.found > 0ï¼Œè¯´æ˜ç»“æœåœ¨progress.candidatesä¸­ä½†æ²¡åŒæ­¥åˆ°ç¼“å­˜
            // è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœprogress.candidatesæœ‰æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨å®ƒ
            if (merged.length === 0 && (progress.status === 'å®Œæˆ' || progress.status === 'completed') && progress.found > 0) {
                console.log('[å®æ—¶æ˜¾ç¤º] åˆ†æ”¯: å®Œæˆ+found>0 ä¸” merged=0');
                // æ‰«æå®Œæˆä½†ç¼“å­˜ä¸ºç©ºï¼Œå°è¯•ä»progress.candidatesè·å–
                if (Array.isArray(progress.candidates) && progress.candidates.length > 0) {
                    console.log('[å®æ—¶æ˜¾ç¤º] ä» progress.candidates æ¢å¤ï¼Œå…± ' + progress.candidates.length + ' åª');
                    // å°†progress.candidatesæ·»åŠ åˆ°ç¼“å­˜
                    for (const c of progress.candidates) {
                        const code = c.è‚¡ç¥¨ä»£ç  || c.code || '';
                        const date = c.æœ€ä½³ä¹°ç‚¹æ—¥æœŸ || c.buy_date || '';
                        if (!code) continue;
                        const key = `${code}__${date}`;
                        window._liveScanCandidateMap[key] = c;
                    }
                    // é‡æ–°åˆå¹¶
                    merged = Object.values(window._liveScanCandidateMap);
                    merged.sort((a, b) => (b.åŒ¹é…åº¦ || b.match_score || 0) - (a.åŒ¹é…åº¦ || a.match_score || 0));
                    top = merged.slice(0, 30);
                } else {
                    console.log('[å®æ—¶æ˜¾ç¤º] å®Œæˆ+found>0 ä¸” progress.candidates ä¸ºç©ºï¼Œæ˜¾ç¤ºã€Œæ­£åœ¨åŠ è½½ç»“æœã€');
                    // âœ… å¦‚æœprogress.candidatesä¹Ÿä¸ºç©ºï¼Œä½†found > 0ï¼Œè¯´æ˜æ•°æ®è¿˜æ²¡åŒæ­¥è¿‡æ¥
                    // è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¾ç¤º"æ­£åœ¨åŠ è½½ç»“æœ..."è€Œä¸æ˜¯"æ­£åœ¨æ‰«æ..."
                    const current = progress.current || 0;
                    const total = progress.total || 0;
                    const foundCount = progress.found || 0;
                    container.innerHTML = `<div style="text-align: center; padding: 20px; color: #666; background: white; border-radius: 6px; margin-top: 15px;">
                        <span style="font-size: 24px;">â³</span>
                        <p style="margin-top: 10px;">æ‰«æå·²å®Œæˆï¼Œæ­£åœ¨åŠ è½½ç»“æœ...</p>
                        <p style="color: #999; font-size: 12px; margin-top: 5px;">å·²æ‰«æ: ${current}/${total} (100.0%)</p>
                        <p style="color: #667eea; font-size: 14px; margin-top: 10px; font-weight: bold;">æ‰¾åˆ° ${foundCount} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</p>
                    </div>`;
                    return;
                }
            }
            
            // å¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è‚¡ç¥¨ï¼Œæ˜¾ç¤ºè¿›åº¦æç¤º
            if (merged.length === 0) {
                console.log('[å®æ—¶æ˜¾ç¤º] åˆ†æ”¯: merged=0ï¼Œæ˜¾ç¤ºè¿›åº¦æç¤ºæˆ–è¡¥æ•‘');
                const current = progress.current || 0;
                const total = progress.total || 0;
                const percentage = progress.percentage || 0;
                // âœ… ç›‘æ§ï¼šæ˜¾ç¤ºå½“å‰å¤„ç†çš„è‚¡ç¥¨
                const currentStock = progress.current_stock || '';
                const currentStockName = progress.current_stock_name || '';
                const currentStockInfo = currentStock ? `<p style="color: #667eea; font-size: 13px; font-weight: bold; margin-top: 8px;">ğŸ“ å½“å‰å¤„ç†: ${currentStock} ${currentStockName}</p>` : '';
                
                // âœ… å¦‚æœæ‰«æå·²å®Œæˆä½†æ²¡æ‰¾åˆ°è‚¡ç¥¨ï¼Œæ˜¾ç¤ºå®Œæˆæç¤º
                const isCompleted = (progress.status === 'å®Œæˆ' || progress.status === 'completed');
                const foundCount = progress.found || 0;
                
                // âœ… è¿›è¡Œä¸­ä½† found>0 ä¸”åˆ—è¡¨ä¸ºç©ºï¼šå¯èƒ½æ˜¯ get_progress çš„ candidates æœªåŒæ­¥ï¼Œç”¨ get_scan_results è¡¥æ•‘ä»¥å®æ—¶æ˜¾ç¤º
                if (!isCompleted && foundCount > 0) {
                    const now = Date.now();
                    window._lastGetScanResultsForLive = window._lastGetScanResultsForLive || 0;
                    if (now - window._lastGetScanResultsForLive > 2000) {
                        window._lastGetScanResultsForLive = now;
                        const scanId = window.currentScanId || '';
                        console.log('[å®æ—¶æ˜¾ç¤º] è¡¥æ•‘: è¯·æ±‚ get_scan_results' + (scanId ? '?scan_id=' + scanId : ''));
                        fetch('/api/get_scan_results' + (scanId ? '?scan_id=' + encodeURIComponent(scanId) : ''), { cache: 'no-store' })
                            .then(r => r.json())
                            .then(res => {
                                console.log('[å®æ—¶æ˜¾ç¤º] get_scan_results è¿”å›: success=' + res.success + ', candidates=' + (res.candidates ? res.candidates.length : 0));
                                if (res.success && res.candidates && res.candidates.length > 0) {
                                    if (!window._liveScanCandidateMap) window._liveScanCandidateMap = {};
                                    for (const c of res.candidates) {
                                        const code = c.è‚¡ç¥¨ä»£ç  || c.code || '';
                                        const date = c.æœ€ä½³ä¹°ç‚¹æ—¥æœŸ || c.buy_date || '';
                                        if (!code) continue;
                                        const key = `${code}__${date}`;
                                        window._liveScanCandidateMap[key] = c;
                                    }
                                    updateLiveScanResults({ ...progress, candidates: res.candidates });
                                } else {
                                    console.log('[å®æ—¶æ˜¾ç¤º] get_scan_results æ— å¯ç”¨ candidates');
                                }
                            })
                            .catch(err => { console.error('[å®æ—¶æ˜¾ç¤º] get_scan_results è¯·æ±‚å¤±è´¥:', err); });
                    }
                }
                
                // âœ… å…³é”®ä¿®å¤ï¼šå¦‚æœæ‰«æå®Œæˆä¸”found > 0ï¼Œä¸åº”è¯¥æ˜¾ç¤º"æ­£åœ¨æ‰«æ..."
                if (isCompleted && foundCount > 0) {
                    // âœ… å…³é”®ï¼šæ‰«æå®Œæˆä½†ç¼“å­˜ä¸ºç©ºï¼Œå°è¯•ä»åç«¯è·å–
                    console.log('[updateLiveScanResults] æ‰«æå®Œæˆä½†ç¼“å­˜ä¸ºç©ºï¼ŒfoundCount=' + foundCount + 'ï¼Œå°è¯•ä»åç«¯è·å–...');
                    fetch('/api/get_scan_results', { cache: 'no-store' })
                        .then(response => response.json())
                        .then(resultsResult => {
                                console.log('[å®æ—¶æ˜¾ç¤º] æ‰«æå®Œæˆ- get_scan_results: success=' + resultsResult.success + ', candidates=' + (resultsResult.candidates ? resultsResult.candidates.length : 0));
                                if (resultsResult.success && resultsResult.candidates && resultsResult.candidates.length > 0) {
                                    // å°†ç»“æœåŒæ­¥åˆ°ç¼“å­˜å¹¶æ˜¾ç¤º
                                    if (!window._liveScanCandidateMap) window._liveScanCandidateMap = {};
                                    for (const c of resultsResult.candidates) {
                                        const code = c.è‚¡ç¥¨ä»£ç  || c.code || '';
                                        const date = c.æœ€ä½³ä¹°ç‚¹æ—¥æœŸ || c.buy_date || '';
                                        if (!code) continue;
                                        const key = `${code}__${date}`;
                                        window._liveScanCandidateMap[key] = c;
                                    }
                                    // é‡æ–°è°ƒç”¨ updateLiveScanResults æ˜¾ç¤ºç»“æœ
                                    updateLiveScanResults({
                                        ...progress,
                                        candidates: resultsResult.candidates
                                    });
                                } else {
                                    // åç«¯ä¹Ÿæ²¡æœ‰ç»“æœï¼Œæ˜¾ç¤ºåŠ è½½æç¤º
                                    console.log('[å®æ—¶æ˜¾ç¤º] æ‰«æå®Œæˆ- get_scan_results æ— å¯ç”¨æ•°æ®ï¼Œæ˜¾ç¤ºåŠ è½½æç¤º');
                                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #666; background: white; border-radius: 6px; margin-top: 15px;">
                                    <span style="font-size: 24px;">â³</span>
                                    <p style="margin-top: 10px;">æ‰«æå·²å®Œæˆï¼Œæ­£åœ¨åŠ è½½ç»“æœ...</p>
                                    <p style="color: #999; font-size: 12px; margin-top: 5px;">å·²æ‰«æ: ${current}/${total} (100.0%)</p>
                                    <p style="color: #667eea; font-size: 14px; margin-top: 10px; font-weight: bold;">æ‰¾åˆ° ${foundCount} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</p>
                                </div>`;
                            }
                        })
                        .catch(error => {
                            console.error('[å®æ—¶æ˜¾ç¤º] æ‰«æå®Œæˆ- get_scan_results å¤±è´¥:', error);
                            // å³ä½¿è·å–å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºæ‰¾åˆ°çš„æ•°é‡
                            container.innerHTML = `<div style="text-align: center; padding: 20px; color: #666; background: white; border-radius: 6px; margin-top: 15px;">
                                <span style="font-size: 24px;">â³</span>
                                <p style="margin-top: 10px;">æ‰«æå·²å®Œæˆï¼Œæ­£åœ¨åŠ è½½ç»“æœ...</p>
                                <p style="color: #999; font-size: 12px; margin-top: 5px;">å·²æ‰«æ: ${current}/${total} (100.0%)</p>
                                <p style="color: #667eea; font-size: 14px; margin-top: 10px; font-weight: bold;">æ‰¾åˆ° ${foundCount} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</p>
                            </div>`;
                        });
                    return;
                }
                
                const completedMsg = isCompleted ? '<p style="color: #e74c3c; font-size: 14px; margin-top: 10px; font-weight: bold;">âŒ æ‰«æå®Œæˆï¼Œæœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</p>' : '';
                
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #666; background: white; border-radius: 6px; margin-top: 15px;">
                    <span style="font-size: 24px;">ğŸ”</span>
                    <p style="margin-top: 10px;">${isCompleted ? 'æ‰«æå·²å®Œæˆ' : 'æ­£åœ¨æ‰«æå…¨å¸‚åœºï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨å°†å®æ—¶æ˜¾ç¤ºåœ¨è¿™é‡Œ...'}</p>
                    <p style="color: #999; font-size: 12px; margin-top: 5px;">å·²æ‰«æ: ${current}/${total} (${percentage.toFixed(1)}%)</p>
                    <p style="color: #999; font-size: 12px;">å½“å‰çŠ¶æ€: ${progress.detail || progress.status || 'æ‰«æä¸­'}</p>
                    ${currentStockInfo}
                    ${completedMsg}
                </div>`;
                return;
            }

            // æ¸²æŸ“è¡¨æ ¼ï¼ˆä¸æœ€ç»ˆç»“æœæ ¼å¼å…¼å®¹ï¼‰
            // ã€ä¸å¯å˜ã€‘æ‰«æåˆ°ä¸€åªã€å®æ—¶æ˜¾ç¤ºä¸€åªï¼›æ­¤å¤„åªä» _liveScanCandidateMap æ¸²æŸ“ï¼Œä¿è¯è¿‡ç¨‹ä¸æœ€åä¸€è‡´
            console.log('[å®æ—¶æ˜¾ç¤º] åˆ†æ”¯: æ¸²æŸ“è¡¨æ ¼ merged=' + merged.length + ', top=' + top.length);
            let html = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">';
            // å¦‚æœæ‰«æå·²å®Œæˆï¼Œæ˜¾ç¤º"æ‰«æå®Œæˆ"ï¼Œå¦åˆ™æ˜¾ç¤º"æ‰«æä¸­"
            const statusText = (progress.status === 'å®Œæˆ' || progress.status === 'completed') ? 'âœ… æ‰«æå®Œæˆ' : 'â±ï¸ æ‰«æä¸­å®æ—¶ç»“æœ';
            html += `<h4>${statusText}ï¼šå·²æ‰¾åˆ° ${merged.length} åªï¼ˆå±•ç¤ºå‰ ${top.length} åªï¼‰</h4>`;
            // âœ… ç›‘æ§ï¼šæ˜¾ç¤ºå½“å‰å¤„ç†çš„è‚¡ç¥¨
            const currentStock = progress.current_stock || '';
            const currentStockName = progress.current_stock_name || '';
            const currentStockInfo = currentStock ? ` | ğŸ“ å½“å‰: ${currentStock} ${currentStockName}` : '';
            html += `<p style="color: #666; font-size: 12px;">å·²æ‰«æ: ${progress.current || 0}/${progress.total || 0} | å½“å‰çŠ¶æ€: ${progress.status || ''}${currentStockInfo}</p>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px;">';
            html += '<tr style="background: #f0f0f0;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æ’å</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è‚¡ç¥¨ä»£ç </th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è‚¡ç¥¨åç§°</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">åŒ¹é…åº¦</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æœ€ä½³ä¹°ç‚¹æ—¥æœŸ</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æœ€ä½³ä¹°ç‚¹ä»·æ ¼</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å½“å‰ä»·æ ¼</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å¸‚å€¼(äº¿)</th></tr>';

            top.forEach((candidate, index) => {
                const matchScore = candidate.åŒ¹é…åº¦ || candidate.match_score || 0;
                const matchColor = matchScore >= 0.8 ? '#27ae60' : matchScore >= 0.7 ? '#f39c12' : '#e74c3c';
                const stockCode = candidate.è‚¡ç¥¨ä»£ç  || candidate.code || '';
                const stockName = candidate.è‚¡ç¥¨åç§° || candidate.name || '';
                const buyDate = candidate.æœ€ä½³ä¹°ç‚¹æ—¥æœŸ || candidate.buy_date || '';
                const buyPrice = candidate.æœ€ä½³ä¹°ç‚¹ä»·æ ¼ || candidate.buy_price || 0;
                const currentPrice = candidate.å½“å‰ä»·æ ¼ || candidate.current_price || 0;
                const marketCap = candidate.å¸‚å€¼ || candidate.market_cap || '';

                html += `<tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #667eea;">${stockCode}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${stockName}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; color: ${matchColor}; font-weight: bold;">${Number(matchScore).toFixed(3)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${buyDate}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #e74c3c;">${Number(buyPrice).toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${currentPrice ? Number(currentPrice).toFixed(2) : ''}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${marketCap === null || marketCap === undefined ? '' : marketCap}</td>
                </tr>`;
            });

            html += '</table></div>';
            container.innerHTML = html;
            } catch (e) {
                console.error('[å®æ—¶æ˜¾ç¤º] updateLiveScanResults å¼‚å¸¸:', e);
            }
        }
        
        function stopProgressPolling() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }
        
        // åˆ†ææ‰€æœ‰è‚¡ç¥¨
        async function analyzeAllStocks() {
            if (!confirm('ç¡®å®šè¦åˆ†ææ‰€æœ‰å·²æ·»åŠ çš„å¤§ç‰›è‚¡å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) {
                return;
            }
            
            showMessage('æ­£åœ¨åˆ†ææ‰€æœ‰è‚¡ç¥¨ï¼Œè¯·ç¨å€™...', 'success');
            showProgress();
            updateProgress(0, 'å‡†å¤‡ä¸­', 'å¼€å§‹åˆ†æ...');
            startProgressPolling();
            
            try {
                const response = await fetch('/api/analyze_all', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                stopProgressPolling();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // åˆ·æ–°è‚¡ç¥¨åˆ—è¡¨ä»¥æ˜¾ç¤ºåˆ†æç»“æœ
                    loadStocks();
                    
                    // ä¸ºæ¯ä¸ªæœ‰åˆ†æç»“æœçš„è‚¡ç¥¨æ˜¾ç¤ºç»“æœ
                    if (result.results) {
                        result.results.forEach(item => {
                            if (item.åˆ†æç»“æœ && item.åˆ†æç»“æœ.success && item.åˆ†æç»“æœ.interval) {
                                const code = item.è‚¡ç¥¨ä»£ç ;
                                const interval = item.åˆ†æç»“æœ.interval;
                                const analysisDiv = document.getElementById('analysis-' + code);
                                
                                if (analysisDiv) {
                                    analysisDiv.innerHTML = `
                                        <div class="analysis-result">
                                            <h4>ğŸ“ˆ æ¶¨å¹…æœ€å¤§åŒºé—´åˆ†æç»“æœ</h4>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">èµ·ç‚¹æ—¥æœŸ:</span>
                                                <span class="analysis-result-value">${interval.èµ·ç‚¹æ—¥æœŸ}</span>
                                            </div>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">èµ·ç‚¹ä»·æ ¼:</span>
                                                <span class="analysis-result-value">${interval.èµ·ç‚¹ä»·æ ¼.toFixed(2)} å…ƒ</span>
                                            </div>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">ç»ˆç‚¹æ—¥æœŸ:</span>
                                                <span class="analysis-result-value">${interval.ç»ˆç‚¹æ—¥æœŸ}</span>
                                            </div>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">ç»ˆç‚¹ä»·æ ¼:</span>
                                                <span class="analysis-result-value">${interval.ç»ˆç‚¹ä»·æ ¼.toFixed(2)} å…ƒ</span>
                                            </div>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">æ¶¨å¹…:</span>
                                                <span class="analysis-result-value gain-positive">${interval.æ¶¨å¹….toFixed(2)}% (ç¿»${interval.ç¿»å€å€æ•°.toFixed(2)}å€)</span>
                                            </div>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">äº¤æ˜“æ—¥æ•°:</span>
                                                <span class="analysis-result-value">${interval.äº¤æ˜“æ—¥æ•°} å¤©</span>
                                            </div>
                                        </div>
                                    `;
                                    analysisDiv.classList.add('show');
                                }
                            }
                        });
                    }
                } else {
                    showMessage(result.message || 'åˆ†æå¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('åˆ†æå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // è®­ç»ƒç‰¹å¾æ¨¡å‹
        async function trainFeatures() {
            if (!confirm('ç¡®å®šè¦è®­ç»ƒç‰¹å¾æ¨¡å‹å—ï¼Ÿéœ€è¦å…ˆåˆ†ææ‰€æœ‰å¤§ç‰›è‚¡ã€‚')) {
                return;
            }
            
            showMessage('æ­£åœ¨è®­ç»ƒç‰¹å¾æ¨¡å‹ï¼Œè¯·ç¨å€™...', 'success');
            showProgress();
            updateProgress(0, 'å‡†å¤‡ä¸­', 'å¼€å§‹è®­ç»ƒ...');
            startProgressPolling();
            
            try {
                const response = await fetch('/api/train_features', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                stopProgressPolling();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // æ˜¾ç¤ºè®­ç»ƒç»“æœ
                    if (result.common_features) {
                        let resultHtml = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">';
                        resultHtml += '<h4>è®­ç»ƒç»“æœï¼š</h4>';
                        resultHtml += `<p>æ ·æœ¬æ•°: ${result.sample_count}</p>`;
                        resultHtml += `<p>ç‰¹å¾æ•°: ${Object.keys(result.common_features).length}</p>`;
                        resultHtml += '<h5>æ ¸å¿ƒç‰¹å¾ï¼š</h5><ul>';
                        const coreFeatures = ['èµ·ç‚¹å½“æ—¥é‡æ¯”', 'ä»·æ ¼ç›¸å¯¹ä½ç½®', 'æˆäº¤é‡èç¼©ç¨‹åº¦', 'ä»·æ ¼ç›¸å¯¹MA20', 'èµ·ç‚¹å‰20å¤©æ³¢åŠ¨ç‡'];
                        coreFeatures.forEach(feature => {
                            if (result.common_features[feature]) {
                                const stats = result.common_features[feature];
                                resultHtml += `<li><strong>${feature}</strong>: å‡å€¼=${stats.å‡å€¼}, èŒƒå›´[${stats.æœ€å°å€¼}, ${stats.æœ€å¤§å€¼}]</li>`;
                            }
                        });
                        resultHtml += '</ul></div>';
                        document.getElementById('buyPointsResult').innerHTML = resultHtml;
                    }
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('è®­ç»ƒå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æŸ¥æ‰¾ä¹°ç‚¹
        async function findBuyPoints() {
            const code = document.getElementById('findBuyPointCode').value.trim();
            
            if (!code) {
                showMessage('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
                return;
            }
            
            if (code.length !== 6 || !/^\d+$/.test(code)) {
                showMessage('è‚¡ç¥¨ä»£ç å¿…é¡»æ˜¯6ä½æ•°å­—', 'error');
                return;
            }
            
            // âœ… è·å–åŒ¹é…åº¦é˜ˆå€¼å’Œæœç´¢å¹´æ•°
            const matchThresholdInput = document.getElementById('buyPointMatchThreshold');
            const searchYearsInput = document.getElementById('buyPointSearchYears');
            const matchThreshold = matchThresholdInput ? parseFloat(matchThresholdInput.value) || 0.95 : 0.95;
            const searchYears = searchYearsInput ? parseInt(searchYearsInput.value) || 5 : 5;
            
            // éªŒè¯é˜ˆå€¼èŒƒå›´
            if (matchThreshold < 0.6 || matchThreshold > 1.0) {
                showMessage('åŒ¹é…åº¦é˜ˆå€¼å¿…é¡»åœ¨0.6-1.0ä¹‹é—´', 'error');
                return;
            }
            
            // éªŒè¯æœç´¢å¹´æ•°èŒƒå›´
            if (searchYears < 1 || searchYears > 10) {
                showMessage('æœç´¢å¹´æ•°å¿…é¡»åœ¨1-10å¹´ä¹‹é—´', 'error');
                return;
            }
            
            // âœ… å…³é”®ï¼šåœæ­¢è¿›åº¦è½®è¯¢ï¼ˆé¿å…"æ‰«æå…¨å¸‚åœº"çš„è¿›åº¦è¦†ç›–"æ‰¾ä¹°ç‚¹"çš„ç»“æœï¼‰
            stopProgressPolling();
            
            // æ¸…é™¤ä¹‹å‰çš„ç»“æœ
            const resultDiv = document.getElementById('buyPointsResult');
            if (resultDiv) {
                resultDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><span style="font-size: 24px;">ğŸ”</span><br>æ­£åœ¨æŸ¥æ‰¾ä¹°ç‚¹ï¼Œè¯·ç¨å€™...</div>';
            }
            
            showMessage(`æ­£åœ¨æŸ¥æ‰¾ä¹°ç‚¹ï¼ˆåŒ¹é…åº¦é˜ˆå€¼: ${matchThreshold}, æœç´¢å¹´æ•°: ${searchYears}å¹´ï¼‰ï¼Œè¯·ç¨å€™...`, 'success');
            
            try {
                const response = await fetch('/api/find_buy_points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        tolerance: 0.3,
                        search_years: searchYears,  // âœ… ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„æœç´¢å¹´æ•°
                        match_threshold: matchThreshold  // âœ… ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„åŒ¹é…åº¦é˜ˆå€¼
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('æœåŠ¡å™¨è¿”å›éJSONæ•°æ®:', text.substring(0, 200));
                    throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„æ•°æ®');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.buy_points && result.buy_points.length > 0) {
                        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                        let statsHtml = '';
                        if (result.statistics) {
                            statsHtml = `<div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; border-left: 4px solid #27ae60;">
                                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                                    <div><strong>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š</strong></div>
                                    <div><strong>æ‰¾åˆ°ä¹°ç‚¹æ€»æ•°:</strong> <span style="color: #1976d2; font-weight: bold; font-size: 16px;">${result.statistics.total}</span></div>
                                    <div><strong>æœ€ä½³ä¹°ç‚¹ï¼ˆ10å‘¨å†…ç¿»å€ï¼‰:</strong> <span style="color: #f39c12; font-weight: bold; font-size: 16px;">â­ ${result.statistics.best_buy_points}</span></div>
                                    <div><strong>4å‘¨ç›ˆåˆ©:</strong> <span style="color: #27ae60; font-weight: bold;">${result.statistics.profitable_4w}</span></div>
                                    <div><strong>10å‘¨ç›ˆåˆ©:</strong> <span style="color: #27ae60; font-weight: bold;">${result.statistics.profitable_10w}</span></div>
                                </div>
                                ${result.max_match_score ? `<div style="margin-top: 10px; color: #555; font-size: 13px;">æœ€é«˜åŒ¹é…åº¦: ${result.max_match_score.toFixed(3)} | å¹³å‡åŒ¹é…åº¦: ${result.avg_match_score ? result.avg_match_score.toFixed(3) : 'N/A'}</div>` : ''}
                            </div>`;
                        }
                        
                        // âœ… ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„åŒ¹é…åº¦é˜ˆå€¼è¿›è¡Œç­›é€‰ï¼ˆè€Œä¸æ˜¯ç¡¬ç¼–ç çš„0.9ï¼‰
                        const filteredBuyPoints = result.buy_points.filter(bp => {
                            const matchScore = bp.åŒ¹é…åº¦ || bp['åŒ¹é…åº¦'] || 0;
                            return matchScore > matchThreshold;  // âœ… ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„åŒ¹é…åº¦é˜ˆå€¼
                        });
                        
                        // è·å–è‚¡ç¥¨ä»£ç å’Œåç§°ï¼ˆä¼˜å…ˆä½¿ç”¨è¾“å…¥çš„ä»£ç ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼‰
                        const stockCode = code || result.stock_code || '';
                        const stockName = result.stock_name || '';
                        
                        // æ„å»ºæ˜¾ç¤ºåç§°ï¼šå¦‚æœæœ‰æœ‰æ•ˆçš„è‚¡ç¥¨åç§°ï¼ˆä¸ç­‰äºä»£ç ï¼‰ï¼Œæ˜¾ç¤º"ä»£ç  åç§°"ï¼Œå¦åˆ™åªæ˜¾ç¤ºä»£ç 
                        let displayName = stockCode;
                        if (stockName && stockName.trim() !== '' && stockName !== stockCode) {
                            displayName = `${stockCode} ${stockName}`;
                        }
                        
                        let html = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">';
                        html += statsHtml;
                        html += `<h4>${displayName} - æ‰¾åˆ° ${filteredBuyPoints.length} ä¸ªå†å²ä¹°ç‚¹ï¼ˆåŒ¹é…åº¦>${matchThreshold}ï¼‰ï¼š</h4>`;
                        if (result.buy_points.length > filteredBuyPoints.length) {
                            html += `<p style="color: #999; font-size: 12px; margin-top: 5px;">å·²è¿‡æ»¤ ${result.buy_points.length - filteredBuyPoints.length} ä¸ªåŒ¹é…åº¦â‰¤${matchThreshold}çš„ä¹°ç‚¹</p>`;
                        }
                        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
                        html += '<tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">æ—¥æœŸ</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ä»·æ ¼</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">åŒ¹é…åº¦</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">4å‘¨æ¶¨å¹…</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">10å‘¨æ¶¨å¹…</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">10å‘¨æœ€å¤§æ¶¨å¹…</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">20å‘¨æ¶¨å¹…</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">æœ€ä½³ä¹°ç‚¹</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">æœ€ä½³å–ç‚¹ä»·æ ¼</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">æ­¢æŸä»·æ ¼</th></tr>';
                        
                        filteredBuyPoints.forEach(bp => {
                            // ä½¿ç”¨æ–¹æ‹¬å·è®¿é—®å±æ€§ï¼Œå› ä¸ºå±æ€§åå¯èƒ½åŒ…å«æ•°å­—æˆ–ç‰¹æ®Šå­—ç¬¦
                            const gain4w = bp['ä¹°å…¥å4å‘¨æ¶¨å¹…'] !== undefined ? bp['ä¹°å…¥å4å‘¨æ¶¨å¹…'] : (bp.ä¹°å…¥å4å‘¨æ¶¨å¹… !== undefined ? bp.ä¹°å…¥å4å‘¨æ¶¨å¹… : null);
                            const gain10w = bp['ä¹°å…¥å10å‘¨æ¶¨å¹…'] !== undefined ? bp['ä¹°å…¥å10å‘¨æ¶¨å¹…'] : (bp.ä¹°å…¥å10å‘¨æ¶¨å¹… !== undefined ? bp.ä¹°å…¥å10å‘¨æ¶¨å¹… : null);
                            const maxGain10w = bp['10å‘¨å†…æœ€å¤§æ¶¨å¹…'] !== undefined ? bp['10å‘¨å†…æœ€å¤§æ¶¨å¹…'] : null;
                            const gain20w = bp['ä¹°å…¥å20å‘¨æ¶¨å¹…'] !== undefined ? bp['ä¹°å…¥å20å‘¨æ¶¨å¹…'] : (bp.ä¹°å…¥å20å‘¨æ¶¨å¹… !== undefined ? bp.ä¹°å…¥å20å‘¨æ¶¨å¹… : null);
                            const isBest = bp['æ˜¯å¦æœ€ä½³ä¹°ç‚¹'] !== undefined ? bp['æ˜¯å¦æœ€ä½³ä¹°ç‚¹'] : (bp.æ˜¯å¦æœ€ä½³ä¹°ç‚¹ !== undefined ? bp.æ˜¯å¦æœ€ä½³ä¹°ç‚¹ : false);
                            
                            // ä¸­å›½è‚¡å¸‚ä¹ æƒ¯ï¼šä¸Šæ¶¨ç”¨çº¢è‰²ï¼Œä¸‹è·Œç”¨ç»¿è‰²
                            // ä¸Šæ¶¨ï¼ˆ>0ï¼‰ç”¨çº¢è‰² #e74c3cï¼Œä¸‹è·Œï¼ˆ<=0ï¼‰ç”¨ç»¿è‰² #27ae60
                            const gain4wColor = gain4w !== null ? (gain4w > 0 ? '#e74c3c' : '#27ae60') : '#999';
                            const gain10wColor = gain10w !== null ? (gain10w > 0 ? '#e74c3c' : '#27ae60') : '#999';
                            const maxGain10wColor = maxGain10w !== null ? (maxGain10w > 0 ? '#e74c3c' : '#27ae60') : '#999';
                            const gain20wColor = gain20w !== null ? (gain20w > 0 ? '#e74c3c' : '#27ae60') : '#999';
                            const bestMark = isBest ? '<span style="color: #f39c12; font-weight: bold;">â­ æœ€ä½³</span>' : '';
                            
                            const matchScore = bp.åŒ¹é…åº¦ || bp['åŒ¹é…åº¦'] || 0;
                            const matchScoreColor = matchScore >= 0.95 ? '#27ae60' : (matchScore >= 0.9 ? '#f39c12' : '#e74c3c');
                            
                            html += `<tr style="${isBest ? 'background: linear-gradient(135deg, #fff9e6 0%, #ffe0b2 100%); font-weight: bold;' : ''}">
                                <td style="padding: 10px; border: 1px solid #ddd;">${bp.æ—¥æœŸ || bp['æ—¥æœŸ'] || 'N/A'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-weight: ${isBest ? 'bold' : 'normal'};">${(bp.ä»·æ ¼ || bp['ä»·æ ¼'] || 0).toFixed(2)} å…ƒ</td>
                                <td style="padding: 10px; border: 1px solid #ddd; color: ${matchScoreColor}; font-weight: bold;">${matchScore.toFixed(3)}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; color: ${gain4wColor}; font-weight: ${gain4w !== null && gain4w > 0 ? 'bold' : 'normal'};">${gain4w !== null ? gain4w.toFixed(2) + '%' : 'N/A'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; color: ${gain10wColor}; font-weight: ${gain10w !== null && gain10w > 0 ? 'bold' : 'normal'};">${gain10w !== null ? gain10w.toFixed(2) + '%' : 'N/A'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; color: ${maxGain10wColor}; font-weight: ${maxGain10w !== null && maxGain10w > 50 ? 'bold' : 'normal'};">${maxGain10w !== null ? maxGain10w.toFixed(2) + '%' : 'N/A'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; color: ${gain20wColor}; font-weight: ${gain20w !== null && gain20w > 0 ? 'bold' : 'normal'};">${gain20w !== null ? gain20w.toFixed(2) + '%' : 'N/A'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${bestMark}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #ff9800;">
                                    ${(() => {
                                        const sellPrice = bp.æœ€ä½³å–ç‚¹ä»·æ ¼ !== undefined ? bp.æœ€ä½³å–ç‚¹ä»·æ ¼ : bp['æœ€ä½³å–ç‚¹ä»·æ ¼'];
                                        const sellWeeks = bp.æœ€ä½³å–ç‚¹å‘¨æ•° !== undefined ? bp.æœ€ä½³å–ç‚¹å‘¨æ•° : bp['æœ€ä½³å–ç‚¹å‘¨æ•°'];
                                        const sellType = bp.å–ç‚¹ç±»å‹ || bp['å–ç‚¹ç±»å‹'];
                                        if (sellPrice !== null && sellPrice !== undefined) {
                                            let html = sellPrice.toFixed(2) + ' å…ƒ';
                                            if (sellWeeks !== null && sellWeeks !== undefined) {
                                                if (sellWeeks < 0) {
                                                    html += '<br><span style="font-size: 11px; color: #999;">(æ•°æ®ä¸è¶³' + Math.abs(sellWeeks) + 'å‘¨)</span>';
                                                } else {
                                                    html += '<br><span style="font-size: 11px; color: #666;">(' + sellWeeks + 'å‘¨å)</span>';
                                                }
                                            }
                                            if (sellType) {
                                                html += '<br><span style="font-size: 11px; color: ' + (sellType === 'é¢„æµ‹å–ç‚¹' ? '#e74c3c' : '#27ae60') + ';">' + 
                                                        (sellType === 'é¢„æµ‹å–ç‚¹' ? 'ğŸ”® é¢„æµ‹' : 'ğŸ“Š å†å²') + '</span>';
                                            }
                                            return html;
                                        } else {
                                            return '<span style="color: #999; font-size: 12px;">æ•°æ®ä¸è¶³<br>(ä¹°å…¥åæ— è¶³å¤Ÿæ•°æ®)</span>';
                                        }
                                    })()}
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #e74c3c;">
                                    ${(() => {
                                        const stopLoss = bp.æ­¢æŸä»·æ ¼ !== undefined ? bp.æ­¢æŸä»·æ ¼ : bp['æ­¢æŸä»·æ ¼'];
                                        const buyPrice = bp.ä»·æ ¼ !== undefined ? bp.ä»·æ ¼ : bp['ä»·æ ¼'];
                                        if (stopLoss !== null && stopLoss !== undefined && buyPrice !== null && buyPrice !== undefined) {
                                            const lossPercent = Math.abs((stopLoss - buyPrice) / buyPrice * 100);
                                            return stopLoss.toFixed(2) + ' å…ƒ' + 
                                                   '<br><span style="font-size: 11px; color: #999;">(æ­¢æŸ-' + lossPercent.toFixed(1) + '%)</span>';
                                        } else {
                                            return 'N/A';
                                        }
                                    })()}
                                </td>
                            </tr>`;
                        });
                        
                        html += '</table></div></div>';
                        
                        // å¦‚æœè¿‡æ»¤åæ²¡æœ‰ä¹°ç‚¹ï¼Œæ˜¾ç¤ºæç¤ºï¼ˆä¿ç•™è‚¡ç¥¨åç§°ï¼‰
                        if (filteredBuyPoints.length === 0) {
                            html = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">';
                            html += statsHtml;
                            html += `<h4>${displayName} - æœªæ‰¾åˆ°åŒ¹é…åº¦>${matchThreshold}çš„ä¹°ç‚¹</h4>`;
                            if (result.buy_points.length > 0) {
                                html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; color: #856404; font-size: 12px;">æç¤ºï¼šå…±æœ‰ ${result.buy_points.length} ä¸ªä¹°ç‚¹ï¼Œä½†åŒ¹é…åº¦å‡â‰¤${matchThreshold}</div>`;
                            }
                            html += '</div>';
                        }
                        
                        document.getElementById('buyPointsResult').innerHTML = html;
                        showMessage(result.message, 'success');
                    } else {
                        document.getElementById('buyPointsResult').innerHTML = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; color: #999;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¹°ç‚¹</div>';
                        showMessage('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¹°ç‚¹', 'error');
                    }
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('æŸ¥æ‰¾ä¹°ç‚¹å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åœæ­¢æ‰«æ
        let scanCheckInterval = null;  // å­˜å‚¨æ‰«ææ£€æŸ¥çš„interval ID
        
        async function stopScan() {
            if (!confirm('ç¡®å®šè¦åœæ­¢å½“å‰æ‰«æå—ï¼Ÿ')) {
                return;
            }
            
            try {
                // è·å–å½“å‰æ‰«æçš„ scan_idï¼ˆå¦‚æœæœ‰ï¼‰
                const scanId = window.currentScanId || null;
                console.log('[stopScan] åœæ­¢æ‰«æï¼Œscan_id:', scanId);
                
                const requestBody = {};
                if (scanId) {
                    requestBody.scan_id = scanId;
                }
                
                const response = await fetch('/api/stop_scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[stopScan] HTTPé”™è¯¯:', response.status, errorText);
                    let errorMsg = `åœæ­¢æ‰«æå¤±è´¥: HTTP ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMsg = errorJson.message || errorMsg;
                    } catch (e) {
                        errorMsg += ` - ${errorText.substring(0, 100)}`;
                    }
                    showMessage(errorMsg, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('[stopScan] åœæ­¢æ‰«æå“åº”:', result);
                
                if (result.success) {
                    showMessage('å·²å‘é€åœæ­¢æ‰«æè¯·æ±‚ï¼Œæ­£åœ¨åœæ­¢...', 'success');
                    // ä¸ç«‹å³ç¦ç”¨åœæ­¢æŒ‰é’®ï¼Œç­‰å¾…æ‰«æçœŸæ­£åœæ­¢
                    // åœæ­¢æŒ‰é’®ä¼šåœ¨çŠ¶æ€å˜ä¸º"å·²åœæ­¢"æ—¶è‡ªåŠ¨ç¦ç”¨
                    
                    // ç­‰å¾…å‡ ç§’åæ£€æŸ¥çŠ¶æ€ï¼Œå¦‚æœå·²åœæ­¢åˆ™è·å–ç»“æœ
                    setTimeout(async () => {
                        try {
                            const progressResponse = await fetch('/api/get_scan_progress');
                            const progress = await progressResponse.json();
                            
                            if (progress && progress.status === 'å·²åœæ­¢') {
                                // ç¦ç”¨åœæ­¢æŒ‰é’®
                                const stopBtn = document.getElementById('stopScanBtn');
                                if (stopBtn) {
                                    stopBtn.disabled = true;
                                }
                                
                                // æ ¹æ®æ‰«æç±»å‹è·å–ä¸åŒçš„ç»“æœ
                                if (progress.type === 'reversal_scan') {
                                    // åè½¬æ‰«æå·²åœæ­¢ï¼Œè·å–åè½¬æ‰«æç»“æœ
                                    const resultsResponse = await fetch('/api/get_reversal_scan_results');
                                    const resultsResult = await resultsResponse.json();
                                    console.log('åœæ­¢åçš„åè½¬æ‰«æç»“æœ:', resultsResult);
                                    
                                    if (resultsResult.success) {
                                        if (resultsResult.stocks && resultsResult.stocks.length > 0) {
                                            displayReversalResults(resultsResult);
                                            const foundCount = resultsResult.found_count || resultsResult.stocks.length || 0;
                                            const totalScanned = progress.total || 0;
                                            showMessage(`åè½¬æ‰«æå·²åœæ­¢ï¼Œå…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ ${foundCount} åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶ã€‚`, 'success');
                                        } else {
                                            const totalScanned = progress.total || 0;
                                            const current = progress.current || 0;
                                            showMessage(`åè½¬æ‰«æå·²åœæ­¢ï¼Œå…±æ‰«æ ${current}/${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ 0 åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶ã€‚`, 'warning');
                                        }
                                    }
                                } else {
                                    // æ™®é€šæ‰«æå·²åœæ­¢ï¼Œè·å–æ™®é€šæ‰«æç»“æœ
                                    const resultsResponse = await fetch('/api/get_scan_results');
                                    const resultsResult = await resultsResponse.json();
                                    console.log('åœæ­¢åçš„æ‰«æç»“æœ:', resultsResult);
                                    
                                    if (resultsResult.success) {
                                        await displayScanResults(resultsResult);
                                        const foundCount = resultsResult.found_count || resultsResult.candidates?.length || 0;
                                        const totalScanned = resultsResult.total_scanned || 0;
                                        if (foundCount > 0) {
                                            showMessage(`æ‰«æå·²åœæ­¢ï¼Œå…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ ${foundCount} åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶ã€‚å¯ä»¥ç‚¹å‡»"æ‰«æå…¨å¸‚åœº"ç»§ç»­æ‰«æã€‚`, 'success');
                                        } else {
                                            showMessage(`æ‰«æå·²åœæ­¢ï¼Œå…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ 0 åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶ã€‚å¯ä»¥ç‚¹å‡»"æ‰«æå…¨å¸‚åœº"ç»§ç»­æ‰«æã€‚`, 'warning');
                                        }
                                    }
                                }
                                
                                // åœæ­¢è¿›åº¦è½®è¯¢
                                stopProgressPolling();
                                hideProgress();
                            }
                        } catch (error) {
                            console.error('æ£€æŸ¥åœæ­¢çŠ¶æ€å¤±è´¥:', error);
                        }
                    }, 2000); // 2ç§’åæ£€æŸ¥ä¸€æ¬¡
                } else {
                    showMessage('åœæ­¢æ‰«æå¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('[stopScan] åœæ­¢æ‰«æå¼‚å¸¸:', error);
                const errorMsg = error.name === 'AbortError' 
                    ? 'åœæ­¢æ‰«æè¯·æ±‚è¶…æ—¶ï¼Œä½†å¯èƒ½å·²å‘é€ã€‚è¯·ç­‰å¾…å‡ ç§’åæŸ¥çœ‹çŠ¶æ€ã€‚'
                    : `åœæ­¢æ‰«æå¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                showMessage(errorMsg, 'error');
            }
        }
        
        // æ‰«æå…¨å¸‚åœº
        let isScanning = false; // é˜²æ­¢é‡å¤ç‚¹å‡»
        
        // âœ… ä¿å­˜ä¸Šä¸€æ¬¡çš„æ‰«ææ¡ä»¶
        function getLastScanParams() {
            try {
                const saved = localStorage.getItem('last_scan_params');
                return saved ? JSON.parse(saved) : null;
            } catch (e) {
                return null;
            }
        }
        
        function saveLastScanParams(params) {
            try {
                localStorage.setItem('last_scan_params', JSON.stringify(params));
                localStorage.setItem('last_scan_result_scan_id', params.scan_id || '');
            } catch (e) {
                console.warn('[scanAllStocks] ä¿å­˜æ‰«ææ¡ä»¶å¤±è´¥:', e);
            }
        }
        
        function compareScanParams(params1, params2) {
            // æ¯”è¾ƒæ‰€æœ‰å…³é”®å‚æ•°
            const keys = ['min_match_score', 'max_market_cap', 'limit', 'scan_date', 'scan_session', 
                         'exclude_st', 'exclude_suspended', 'industry_filter', 'custom_stock_pool'];
            
            for (const key of keys) {
                const val1 = params1[key];
                const val2 = params2[key];
                
                // å¤„ç†null/undefined/ç©ºå­—ç¬¦ä¸²çš„ç­‰ä»·æ€§
                const normalize = (v) => {
                    if (v === null || v === undefined || v === '') return null;
                    if (typeof v === 'string') return v.trim();
                    if (typeof v === 'number') return v;
                    return v;
                };
                
                if (normalize(val1) !== normalize(val2)) {
                    console.log(`[scanAllStocks] å‚æ•°ä¸åŒ: ${key} = ${val1} vs ${val2}`);
                    return false;
                }
            }
            
            return true;
        }
        
        async function scanAllStocks() {
            console.log('[scanAllStocks] å¼€å§‹æ‰§è¡Œæ‰«æå‡½æ•°');
            
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (isScanning) {
                console.warn('[scanAllStocks] æ‰«æå·²åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
                showMessage('æ‰«ææ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»', 'warning');
                return;
            }
            
            // âœ… æ”¶é›†å½“å‰æ‰«ææ¡ä»¶ï¼ˆåœ¨æ‰€æœ‰å‚æ•°æ”¶é›†å®Œæˆåï¼‰
            // æ³¨æ„ï¼šå‚æ•°æ”¶é›†é€»è¾‘åœ¨åé¢ï¼Œè¿™é‡Œå…ˆå®šä¹‰å˜é‡
            
            isScanning = true;
            
            // ç‚¹å‡»æ‰«æå…¨å¸‚åœºï¼šç«‹å³æ¸…ç©ºæ˜¾ç¤ºå†…å®¹ï¼Œå†æŒ‰æ–°æ¡ä»¶æ˜¾ç¤ºæ–°å†…å®¹ï¼ˆé€»è¾‘ä¸å¯å»¶åï¼‰
            stopProgressPolling();
            window._scanJustCleared = true;
            window.currentScanId = null;
            window.currentScanResults = null;
            window._liveScanCandidateMap = {};
            const _resultContainer = document.getElementById('buyPointsResult');
            if (_resultContainer) {
                _resultContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; background: white; border-radius: 6px; margin-top: 15px;"><span style="font-size: 24px;">ğŸ”</span><br><p style="margin-top: 10px;">æ­£åœ¨æ‰«æå…¨å¸‚åœºï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨å°†å®æ—¶æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p><p style="color: #999; font-size: 12px; margin-top: 5px;">è¯·ç¨å€™...</p></div>';
            }
            
            // âœ… å…ˆæ”¶é›†æ‰€æœ‰æ‰«æå‚æ•°ï¼ˆåœ¨æ¸…é™¤ç»“æœä¹‹å‰ï¼‰
            let currentParams = {};
            
            // âœ… å…ˆå£°æ˜æ‰€æœ‰å˜é‡ï¼Œé¿å… "Cannot access before initialization" é”™è¯¯
            let minMatch, maxCap, scanLimit, excludeST, excludeSuspended, industryFilter, customStockPool;
            let scanDate = null;
            let scanSession = 'close';
            
            // æ ¹æ®ç”¨æˆ·ç±»å‹æ”¶é›†å‚æ•°
            const localVersionButtonsPanel = document.getElementById('localVersionButtons');
            const superUserButtonsPanel = document.getElementById('superUserButtons');
            const vipUserButtonsPanel = document.getElementById('vipUserButtons');
            
            if (isLocalEnvironment() && localVersionButtonsPanel && localVersionButtonsPanel.offsetParent !== null) {
                // æœ¬åœ°ç‰ˆæœ¬å‚æ•°
                const localMinMatchScoreInput = document.getElementById('localMinMatchScore');
                const localMaxMarketCapInput = document.getElementById('localMaxMarketCap');
                const localScanLimitInput = document.getElementById('localScanLimit');
                const localScanDateInput = document.getElementById('localScanDate');
                const localScanSessionInput = document.getElementById('localScanSession');
                
                if (localMinMatchScoreInput) {
                    minMatch = parseFloat(localMinMatchScoreInput.value) || 0.93;
                    maxCap = parseFloat(localMaxMarketCapInput?.value) || 100;
                    scanLimit = localScanLimitInput?.value ? parseInt(localScanLimitInput.value) : null;
                    scanDate = (localScanDateInput?.value || '').trim() || null;
                    scanSession = (localScanSessionInput?.value || 'close').trim();
                    excludeST = true;
                    excludeSuspended = true;
                    industryFilter = '';
                    customStockPool = '';
                    
                    currentParams = {
                        min_match_score: minMatch,
                        max_market_cap: maxCap,
                        limit: scanLimit,
                        scan_date: scanDate,
                        scan_session: scanSession,
                        exclude_st: excludeST,
                        exclude_suspended: excludeSuspended,
                        industry_filter: industryFilter,
                        custom_stock_pool: customStockPool
                    };
                }
            } else if (superUserButtonsPanel && superUserButtonsPanel.offsetParent !== null) {
                // è¶…çº§ç”¨æˆ·å‚æ•°
                const superMinMatchScoreInput = document.getElementById('superMinMatchScore');
                const superMaxMarketCapInput = document.getElementById('superMaxMarketCap');
                
                if (superMinMatchScoreInput) {
                    minMatch = parseFloat(superMinMatchScoreInput.value) || 0.93;
                    maxCap = parseFloat(superMaxMarketCapInput?.value) || 100;
                    scanLimit = null;
                    scanDate = null;
                    scanSession = 'close';
                    excludeST = true;
                    excludeSuspended = true;
                    industryFilter = '';
                    customStockPool = '';
                    
                    currentParams = {
                        min_match_score: minMatch,
                        max_market_cap: maxCap,
                        limit: scanLimit,
                        scan_date: scanDate,
                        scan_session: scanSession,
                        exclude_st: excludeST,
                        exclude_suspended: excludeSuspended,
                        industry_filter: industryFilter,
                        custom_stock_pool: customStockPool
                    };
                }
            } else if (vipUserButtonsPanel && vipUserButtonsPanel.offsetParent !== null) {
                // VIPç”¨æˆ·å‚æ•°
                const minMatchScoreInput = document.getElementById('minMatchScore');
                const maxMarketCapInput = document.getElementById('maxMarketCap');
                const excludeSTInput = document.getElementById('excludeST');
                const excludeSuspendedInput = document.getElementById('excludeSuspended');
                const industryFilterInput = document.getElementById('industryFilter');
                const customStockPoolInput = document.getElementById('customStockPool');
                
                if (minMatchScoreInput) {
                    minMatch = parseFloat(minMatchScoreInput.value) || 0.93;
                    maxCap = parseFloat(maxMarketCapInput?.value) || 100;
                    excludeST = excludeSTInput?.checked !== false;
                    excludeSuspended = excludeSuspendedInput?.checked !== false;
                    industryFilter = (industryFilterInput?.value || '').trim();
                    customStockPool = (customStockPoolInput?.value || '').trim();
                    scanLimit = null;
                    scanDate = null;
                    scanSession = 'close';
                    
                    currentParams = {
                        min_match_score: minMatch,
                        max_market_cap: maxCap,
                        limit: scanLimit,
                        scan_date: scanDate,
                        scan_session: scanSession,
                        exclude_st: excludeST,
                        exclude_suspended: excludeSuspended,
                        industry_filter: industryFilter,
                        custom_stock_pool: customStockPool
                    };
                }
            }
            
            // ç«‹å³æ˜¾ç¤ºåˆå§‹åŒ–æç¤ºï¼ˆæ¸…ç©ºå·²åœ¨å‡½æ•°å¼€å¤´å®Œæˆï¼‰
            showProgress();
            updateProgress(0, 'åˆå§‹åŒ–ä¸­', 'æ­£åœ¨åˆå§‹åŒ–æ‰«æä»»åŠ¡ï¼Œè¯·ç¨å€™...');
            showMessage('æ­£åœ¨åˆå§‹åŒ–æ‰«æä»»åŠ¡ï¼Œè¯·ç¨å€™...', 'info');
            
            // å…ˆæ£€æŸ¥ç”¨æˆ·æ‰«ææƒé™
            try {
                updateProgress(0, 'æ£€æŸ¥æƒé™', 'æ­£åœ¨æ£€æŸ¥ç”¨æˆ·æƒé™...');
                // ä½¿ç”¨ç‹¬ç«‹çš„ AbortControllerï¼Œé¿å…ä¸å…¶ä»–è¯·æ±‚å†²çª
                const userInfoController = new AbortController();
                const userInfoTimeoutId = setTimeout(() => {
                    console.warn('[scanAllStocks] è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚è¶…æ—¶ï¼ˆ5ç§’ï¼‰ï¼Œä¸­æ–­è¯·æ±‚');
                    userInfoController.abort();
                }, 5000); // 5ç§’è¶…æ—¶
                
                let userInfoResponse;
                try {
                    userInfoResponse = await fetch('/api/user_info', {
                        signal: userInfoController.signal,
                        cache: 'no-store'
                    });
                    clearTimeout(userInfoTimeoutId);
                } catch (fetchError) {
                    clearTimeout(userInfoTimeoutId);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ AbortError
                    if (fetchError && (fetchError.name === 'AbortError' || fetchError.message?.includes('aborted') || fetchError.message?.includes('signal is aborted'))) {
                        console.warn('[scanAllStocks] è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚è¢«ä¸­æ–­ï¼ˆAbortErrorï¼‰ï¼Œç»§ç»­æ‰§è¡Œ');
                        // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
                        // è·³å‡º try-catchï¼Œç»§ç»­æ‰§è¡Œåç»­ä»£ç 
                        throw fetchError; // é‡æ–°æŠ›å‡ºï¼Œè®©å¤–å±‚ catch å¤„ç†
                    } else {
                        throw fetchError; // é‡æ–°æŠ›å‡ºé AbortError çš„é”™è¯¯
                    }
                }
                
                const userInfoResult = await userInfoResponse.json();
                
                if (userInfoResult.success && userInfoResult.user) {
                    const user = userInfoResult.user;
                    const restrictions = user.scan_restrictions || {};
                    
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰«æ
                    if (!restrictions.can_scan_now) {
                        const errorMsg = restrictions.scan_time_error || 'å½“å‰æ—¶é—´ä¸å…è®¸æ‰«æ';
                        // å¦‚æœæ˜¯å…è´¹ç”¨æˆ·ï¼Œæç¤ºç³»ç»Ÿè‡ªåŠ¨æ‰«æ
                        if (user.tier === 'free') {
                            showMessage('å…è´¹ç”¨æˆ·ç”±ç³»ç»Ÿæ¯å¤©15:00è‡ªåŠ¨æ‰«æï¼Œè¯·ç›´æ¥æŸ¥çœ‹æ‰«æç»“æœ', 'info');
                        } else {
                            showMessage(errorMsg, 'error');
                        }
                        isScanning = false; // é‡ç½®æ ‡å¿—
                        return;
                    }
                    
                    // æ£€æŸ¥æ¯æ—¥æ‰«ææ¬¡æ•°
                    if (!restrictions.can_scan_daily) {
                        const errorMsg = restrictions.daily_error || 'å·²è¾¾åˆ°æ¯æ—¥æ‰«ææ¬¡æ•°é™åˆ¶';
                        // å¦‚æœæ˜¯å…è´¹ç”¨æˆ·ï¼Œæç¤ºç³»ç»Ÿè‡ªåŠ¨æ‰«æ
                        if (user.tier === 'free') {
                            showMessage('å…è´¹ç”¨æˆ·ç”±ç³»ç»Ÿæ¯å¤©15:00è‡ªåŠ¨æ‰«æï¼Œè¯·ç›´æ¥æŸ¥çœ‹æ‰«æç»“æœ', 'info');
                        } else {
                            showMessage(errorMsg, 'error');
                        }
                        isScanning = false; // é‡ç½®æ ‡å¿—
                        return;
                    }
                    
                    // æ˜¾ç¤ºç”¨æˆ·ç­‰çº§å’Œé™åˆ¶ä¿¡æ¯
                    const tierNames = {
                        'free': 'å…è´¹ç‰ˆ',
                        'premium': 'VIPä¼šå‘˜',
                        'super': 'è¶…çº§ç”¨æˆ·'
                    };
                    const tierName = tierNames[user.tier] || 'æœªçŸ¥';
                    console.log(`[scanAllStocks] ç”¨æˆ·ç­‰çº§: ${tierName}, å½“å‰æ—¶é—´: ${restrictions.current_time}`);
                    
                    // å…è´¹ç”¨æˆ·æç¤º
                    if (user.tier === 'free') {
                        showMessage('å…è´¹ç”¨æˆ·ç”±ç³»ç»Ÿæ¯å¤©15:00è‡ªåŠ¨æ‰«æï¼Œè¯·ç›´æ¥æŸ¥çœ‹æ‰«æç»“æœ', 'info');
                        isScanning = false; // é‡ç½®æ ‡å¿—
                        return;
                    }
                }
            } catch (error) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ AbortError
                if (error && (error.name === 'AbortError' || error.message?.includes('aborted') || error.message?.includes('signal is aborted'))) {
                    console.warn('[scanAllStocks] è·å–ç”¨æˆ·ä¿¡æ¯æ—¶è¯·æ±‚è¢«ä¸­æ–­ï¼ˆAbortErrorï¼‰ï¼Œç»§ç»­æ‰§è¡Œ');
                } else {
                    console.warn('[scanAllStocks] è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                }
                // ç»§ç»­æ‰§è¡Œï¼Œä¸é˜»æ­¢æ‰«æ
            }
            
            // âœ… æå‰è¯»å–â€œæœ¬åœ°æ‰«ææ—¥æœŸ/æ—¶é—´æ®µâ€ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­æ—§æ‰«æï¼ˆé¿å…å‚æ•°å˜æ›´å´ç»§ç»­æ—§ä»»åŠ¡ï¼‰
            const normalizeDate = (d) => {
                if (!d) return null;
                try { return String(d).trim().replaceAll('/', '-'); } catch (e) { return String(d).trim(); }
            };
            const desiredScanDate = normalizeDate(document.getElementById('localScanDate')?.value || null);
            const desiredScanSession = (document.getElementById('localScanSession')?.value || 'close').trim();

            // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æ‰«æ
            try {
                updateProgress(0, 'æ£€æŸ¥çŠ¶æ€', 'æ­£åœ¨æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æ‰«æ...');
                console.log('[scanAllStocks] æ£€æŸ¥å½“å‰è¿›åº¦çŠ¶æ€...');
                // æ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ—¶
                let progressResponse;
                try {
                    progressResponse = await fetch('/api/get_progress', {
                        cache: 'no-store',
                        credentials: 'same-origin',
                        headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' },
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.warn('[scanAllStocks] è·å–è¿›åº¦è¶…æ—¶ï¼Œè·³è¿‡æ£€æŸ¥ï¼Œç›´æ¥å¼€å§‹æ‰«æ');
                        // è¶…æ—¶åç›´æ¥ç»§ç»­ï¼Œä¸é˜»å¡æ‰«æ
                        progressResponse = { ok: false, status: 408 };
                    } else {
                        throw error;
                    }
                }
                if (progressResponse.status === 401) {
                    showMessage('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•åé‡è¯•', 'error');
                    isScanning = false;
                    hideProgress();
                    return;
                }
                if (!progressResponse.ok) {
                    console.warn('[scanAllStocks] è·å–è¿›åº¦å¤±è´¥:', progressResponse.status);
                    // å¦‚æœè·å–è¿›åº¦å¤±è´¥ï¼ˆåŒ…æ‹¬è¶…æ—¶ï¼‰ï¼Œç›´æ¥ç»§ç»­æ‰«æï¼Œä¸é˜»å¡
                    progressResult = { success: true, progress: { status: 'ç©ºé—²' } };
                } else {
                    progressResult = await progressResponse.json();
                }
                console.log('[scanAllStocks] å½“å‰è¿›åº¦çŠ¶æ€:', progressResult);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„æ‰«æï¼ˆçŠ¶æ€ä¸º"è¿›è¡Œä¸­"ï¼‰ï¼Œå¦‚æœæœ‰åˆ™è¯¢é—®æ˜¯å¦ç»§ç»­
                if (progressResult.success && progressResult.progress && progressResult.progress.status === 'è¿›è¡Œä¸­') {
                    const existingProgress = progressResult.progress;
                    if (existingProgress.scan_id && existingProgress.total_batches > 1) {
                        const currentBatch = existingProgress.batch || 0;
                        const totalBatches = existingProgress.total_batches;
                        // å¦‚æœç”¨æˆ·è®¾ç½®äº† scan_date / scan_sessionï¼Œä¸”ä¸å½“å‰ä»»åŠ¡ä¸åŒï¼šä¸è¦â€œç»§ç»­â€ï¼Œåº”å½“é‡æ–°å¼€å§‹
                        const existingDate = normalizeDate(existingProgress.scan_date || null);
                        const existingSession = (existingProgress.scan_session || 'close').trim();
                        const paramsChanged = (desiredScanDate || desiredScanSession) && (existingDate !== desiredScanDate || existingSession !== desiredScanSession);
                        if (paramsChanged) {
                            if (!confirm(`æ£€æµ‹åˆ°æœªå®Œæˆçš„æ‰«æï¼ˆå·²å¤„ç† ${currentBatch}/${totalBatches} æ‰¹ï¼‰ï¼Œä½†ä½ å·²ä¿®æ”¹æ‰«æå‚æ•°ï¼ˆæ—¥æœŸ/æ—¶é—´æ®µï¼‰ã€‚\n\nç‚¹å‡»â€œç¡®å®šâ€ï¼šåœæ­¢æ—§æ‰«æå¹¶é‡æ–°å¼€å§‹\nç‚¹å‡»â€œå–æ¶ˆâ€ï¼šä¿æŒæ—§æ‰«æï¼ˆä¸ä½¿ç”¨æ–°å‚æ•°ï¼‰`)) {
                                isScanning = false;
                                return;
                            }
                            // åœæ­¢æ—§æ‰«æï¼Œç»§ç»­èµ°ä¸‹é¢â€œé‡æ–°å¼€å§‹æ‰«æâ€çš„æµç¨‹
                            try { await stopScan(); } catch (e) { console.warn('[scanAllStocks] åœæ­¢æ—§æ‰«æå¤±è´¥ï¼ˆå¿½ç•¥ï¼‰:', e); }
                        } else if (confirm(`æ£€æµ‹åˆ°æœªå®Œæˆçš„æ‰«æï¼ˆå·²å¤„ç† ${currentBatch}/${totalBatches} æ‰¹ï¼‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ï¼Œç‚¹å‡»"å–æ¶ˆ"é‡æ–°å¼€å§‹`)) {
                            // ç»§ç»­æ‰«æ
                            showMessage('ç»§ç»­æ‰«æ...', 'success');
                            window._scanJustCleared = false;  // å…è®¸è½®è¯¢å†™å…¥æœ¬è½®çš„ç»§ç»­ç»“æœ
                            if (existingProgress.scan_id) window.currentScanId = existingProgress.scan_id;  // è®©è½®è¯¢å¸¦ scan_id
                            showProgress();
                            updateProgress(
                                existingProgress.percentage || 0,
                                existingProgress.status || 'è¿›è¡Œä¸­',
                                existingProgress.detail || 'ç»§ç»­æ‰«æ...'
                            );
                            startProgressPolling();
                            // ä½¿ç”¨ç°æœ‰çš„ scan_id ç»§ç»­æ‰«æ
                            autoContinueScan(existingProgress.scan_id, currentBatch, totalBatches);
                            isScanning = false; // é‡ç½®æ ‡å¿—
                            return; // ç›´æ¥è¿”å›ï¼Œä¸é‡æ–°å¼€å§‹æ‰«æ
                        }
                        // å¦‚æœç”¨æˆ·é€‰æ‹©å–æ¶ˆï¼Œç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç é‡æ–°å¼€å§‹æ‰«æ
                    }
                } else if (progressResult.success && progressResult.progress && progressResult.progress.status === 'å·²åœæ­¢') {
                    // å¦‚æœæ‰«æå·²åœæ­¢ï¼Œç›´æ¥é‡æ–°å¼€å§‹ï¼Œä¸è¯¢é—®
                    console.log('[scanAllStocks] æ£€æµ‹åˆ°å·²åœæ­¢çš„æ‰«æï¼Œé‡æ–°å¼€å§‹');
                }
            } catch (error) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ AbortError
                if (error && (error.name === 'AbortError' || error.message?.includes('aborted') || error.message?.includes('signal is aborted'))) {
                    console.warn('[scanAllStocks] æ£€æŸ¥æ‰«æçŠ¶æ€æ—¶è¯·æ±‚è¢«ä¸­æ–­ï¼ˆAbortErrorï¼‰ï¼Œç»§ç»­æ‰§è¡Œ');
                    // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
                } else {
                    console.error('âŒ [scanAllStocks] æ£€æŸ¥æ‰«æçŠ¶æ€å¤±è´¥:', error);
                    // å®‰å…¨åœ°è®¿é—®é”™è¯¯å±æ€§
                    try {
                        console.error('âŒ [scanAllStocks] é”™è¯¯è¯¦æƒ…:', {
                            name: error?.name || 'Unknown',
                            message: error?.message || 'Unknown error',
                            stack: error?.stack || 'No stack trace'
                        });
                    } catch (e) {
                        console.error('âŒ [scanAllStocks] æ— æ³•è·å–é”™è¯¯è¯¦æƒ…:', e);
                    }
                }
            }
            
            // å…ˆæ£€æŸ¥æ˜¯å¦å·²è®­ç»ƒç‰¹å¾æ¨¡å‹
            try {
                updateProgress(0, 'æ£€æŸ¥æ¨¡å‹', 'æ­£åœ¨æ£€æŸ¥ç‰¹å¾æ¨¡å‹...');
                // ä½¿ç”¨ç‹¬ç«‹çš„ AbortControllerï¼Œé¿å…ä¸å…¶ä»–è¯·æ±‚å†²çª
                const featuresController = new AbortController();
                const featuresTimeoutId = setTimeout(() => {
                    console.warn('[scanAllStocks] æ£€æŸ¥ç‰¹å¾æ¨¡å‹è¯·æ±‚è¶…æ—¶ï¼ˆ5ç§’ï¼‰ï¼Œä¸­æ–­è¯·æ±‚');
                    featuresController.abort();
                }, 5000); // 5ç§’è¶…æ—¶
                
                let featuresResponse;
                try {
                    featuresResponse = await fetch('/api/get_trained_features', {
                        signal: featuresController.signal,
                        cache: 'no-store'
                    });
                    clearTimeout(featuresTimeoutId);
                } catch (fetchError) {
                    clearTimeout(featuresTimeoutId);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ AbortError
                    if (fetchError && (fetchError.name === 'AbortError' || fetchError.message?.includes('aborted') || fetchError.message?.includes('signal is aborted'))) {
                        console.warn('[scanAllStocks] æ£€æŸ¥ç‰¹å¾æ¨¡å‹è¯·æ±‚è¶…æ—¶ï¼ˆAbortErrorï¼‰ï¼Œè·³è¿‡æ£€æŸ¥ï¼Œç»§ç»­æ‰§è¡Œæ‰«æ');
                        // è¶…æ—¶æ—¶è·³è¿‡æ£€æŸ¥ï¼Œç»§ç»­æ‰§è¡Œæ‰«æï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œä½†æ‰«æå¯èƒ½ä»ç„¶å¯ä»¥ç»§ç»­ï¼‰
                        // ä¸è¿”å›ï¼Œç»§ç»­æ‰§è¡Œåç»­ä»£ç 
                    } else {
                        throw fetchError; // é‡æ–°æŠ›å‡ºé AbortError çš„é”™è¯¯
                    }
                }
                
                // å¦‚æœè¯·æ±‚æˆåŠŸï¼Œè§£æå“åº”
                if (featuresResponse && featuresResponse.ok) {
                    const featuresResult = await featuresResponse.json();
                    
                    console.log('ç‰¹å¾æ¨¡å‹æ£€æŸ¥ç»“æœ:', featuresResult);
                    console.log('ç‰¹å¾æ¨¡å‹æ£€æŸ¥è¯¦æƒ…:', {
                        success: featuresResult.success,
                        hasCommonFeatures: !!featuresResult.common_features,
                        commonFeaturesLength: featuresResult.common_features ? Object.keys(featuresResult.common_features).length : 0,
                        message: featuresResult.message
                    });
                    
                    // æ£€æŸ¥æ¨¡å‹æ˜¯å¦å­˜åœ¨ï¼šsuccess ä¸º true ä¸” common_features å­˜åœ¨ä¸”ä¸ä¸ºç©º
                    const hasFeatures = featuresResult.success && 
                        featuresResult.common_features && 
                        Object.keys(featuresResult.common_features).length > 0;
                    
                    console.log('hasFeatures (scanAllStocks):', hasFeatures);
                    
                    if (!hasFeatures) {
                        showMessage('è¯·å…ˆæ·»åŠ å¤§ç‰›è‚¡ã€åˆ†æè‚¡ç¥¨å¹¶è®­ç»ƒç‰¹å¾æ¨¡å‹ï¼', 'error');
                        isScanning = false; // é‡ç½®æ ‡å¿—
                        return;
                    }
                }
            } catch (error) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ AbortError
                if (error && (error.name === 'AbortError' || error.message?.includes('aborted') || error.message?.includes('signal is aborted'))) {
                    console.warn('[scanAllStocks] æ£€æŸ¥ç‰¹å¾æ¨¡å‹æ—¶è¯·æ±‚è¢«ä¸­æ–­ï¼ˆAbortErrorï¼‰ï¼Œè·³è¿‡æ£€æŸ¥ï¼Œç»§ç»­æ‰§è¡Œæ‰«æ');
                    // è¶…æ—¶æ—¶è·³è¿‡æ£€æŸ¥ï¼Œç»§ç»­æ‰§è¡Œæ‰«æï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œä½†æ‰«æå¯èƒ½ä»ç„¶å¯ä»¥ç»§ç»­ï¼‰
                    // ä¸è¿”å›ï¼Œç»§ç»­æ‰§è¡Œåç»­ä»£ç 
                } else {
                    console.error('âŒ [scanAllStocks] æ£€æŸ¥ç‰¹å¾æ¨¡å‹å¤±è´¥:', error);
                    // å®‰å…¨åœ°è®¿é—®é”™è¯¯å±æ€§
                    try {
                        console.error('âŒ [scanAllStocks] é”™è¯¯è¯¦æƒ…:', {
                            name: error?.name || 'Unknown',
                            message: error?.message || 'Unknown error',
                            stack: error?.stack || 'No stack trace'
                        });
                    } catch (e) {
                        console.error('âŒ [scanAllStocks] æ— æ³•è·å–é”™è¯¯è¯¦æƒ…:', e);
                    }
                    // æ£€æŸ¥å¤±è´¥æ—¶ï¼Œä»ç„¶ç»§ç»­æ‰§è¡Œï¼Œä¸è¦é˜»æ­¢æ‰«æ
                    console.warn('[scanAllStocks] æ£€æŸ¥ç‰¹å¾æ¨¡å‹å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œæ‰«æï¼ˆå¯èƒ½åœ¨æœåŠ¡å™¨ç«¯ä¼šæœ‰é¢å¤–æ£€æŸ¥ï¼‰');
                }
            }
            
            // æ£€æŸ¥æ˜¯VIPç”¨æˆ·ã€æœ¬åœ°ç‰ˆæœ¬è¿˜æ˜¯è¶…çº§ç”¨æˆ·ï¼ˆä¼˜å…ˆæ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬ï¼‰
            // âœ… æ³¨æ„ï¼šå˜é‡å·²åœ¨å‡½æ•°å¼€å§‹å¤„å£°æ˜ï¼ˆç¬¬2062è¡Œï¼‰ï¼Œè¿™é‡Œä¸å†é‡å¤å£°æ˜
            
            // å…ˆæ£€æŸ¥ç¯å¢ƒï¼Œæœ¬åœ°ç¯å¢ƒä¼˜å…ˆä½¿ç”¨æœ¬åœ°å‚æ•°é¢æ¿
            const isLocal = isLocalEnvironment();
            const localVersionButtons = document.getElementById('localVersionButtons');
            const localParamsPanel = document.getElementById('localScanParams');
            const vipParamsPanel = document.getElementById('vipScanParams');
            const superParamsPanel = document.getElementById('superScanParams');
            
            // æœ¬åœ°ç¯å¢ƒï¼šä¼˜å…ˆæ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬å‚æ•°é¢æ¿ï¼ˆæ£€æŸ¥çˆ¶å…ƒç´ æ˜¯å¦æ˜¾ç¤ºï¼‰
            if (isLocal && localVersionButtons && localVersionButtons.style.display !== 'none' && localParamsPanel) {
                // æœ¬åœ°ç‰ˆæœ¬ï¼šä»è¡¨å•è·å–å‚æ•°
                const localMinMatchScoreInput = document.getElementById('localMinMatchScore');
                const localMaxMarketCapInput = document.getElementById('localMaxMarketCap');
                const localScanLimitInput = document.getElementById('localScanLimit');
                const localScanDateInput = document.getElementById('localScanDate');
                const localScanSessionInput = document.getElementById('localScanSession');
                
                if (localMinMatchScoreInput) {
                    minMatch = parseFloat(localMinMatchScoreInput.value) || 0.93;
                    maxCap = parseFloat(localMaxMarketCapInput?.value) || 100;
                    scanLimit = localScanLimitInput?.value ? parseInt(localScanLimitInput.value) : null;
                    scanDate = (localScanDateInput?.value || '').trim() || null;
                    scanSession = (localScanSessionInput?.value || 'close').trim();
                    excludeST = true;
                    excludeSuspended = true;
                    industryFilter = '';
                    customStockPool = '';
                    
                    // âœ… ä¿å­˜å½“å‰å‚æ•°
                    currentParams = {
                        min_match_score: minMatch,
                        max_market_cap: maxCap,
                        limit: scanLimit,
                        scan_date: scanDate,
                        scan_session: scanSession,
                        exclude_st: excludeST,
                        exclude_suspended: excludeSuspended,
                        industry_filter: industryFilter,
                        custom_stock_pool: customStockPool
                    };
                    
                    console.log('[scanAllStocks] æœ¬åœ°ç‰ˆæœ¬å‚æ•°:', { minMatch, maxCap, scanLimit, scanDate, scanSession });
                    
                    if (!confirm(`ç¡®å®šè¦å¼€å§‹æ‰«æå—ï¼Ÿ\n\næ‰«æå‚æ•°ï¼š\n- åŒ¹é…åº¦é˜ˆå€¼ï¼š${minMatch}\n- æœ€å¤§å¸‚å€¼ï¼š${maxCap}äº¿å…ƒ\n${scanLimit ? `- æ‰«ææ•°é‡é™åˆ¶ï¼š${scanLimit}åª\n` : ''}${scanDate ? `- æŒ‡å®šæ‰«ææ—¥æœŸï¼š${scanDate}\n` : ''}- æ—¶é—´æ®µï¼š${scanSession === 'noon' ? 'åˆç›˜' : 'æ”¶ç›˜'}\nè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚`)) {
                        isScanning = false; // é‡ç½®æ ‡å¿—
                        return;
                    }
                }
            } else if (superUserButtonsPanel && superUserButtonsPanel.offsetParent !== null) {
                // è¶…çº§ç”¨æˆ·ï¼šæ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§ï¼ˆä½¿ç”¨ offsetParentï¼Œæ›´å¯é ï¼‰
                const superMinMatchScoreInput = document.getElementById('superMinMatchScore');
                const superMaxMarketCapInput = document.getElementById('superMaxMarketCap');
                const superScanLimitInput = document.getElementById('superScanLimit');
                
                if (superMinMatchScoreInput) {
                    minMatch = parseFloat(superMinMatchScoreInput.value) || 0.93;
                    maxCap = parseFloat(superMaxMarketCapInput?.value) || 100;
                    scanLimit = superScanLimitInput?.value ? parseInt(superScanLimitInput.value) : null;
                    excludeST = true;
                    excludeSuspended = true;
                    industryFilter = '';
                    customStockPool = '';
                    
                    console.log('[scanAllStocks] è¶…çº§ç”¨æˆ·å‚æ•°:', { minMatch, maxCap, scanLimit });
                    
                    if (!confirm(`ç¡®å®šè¦å¼€å§‹æ‰«æå—ï¼Ÿ\n\næ‰«æå‚æ•°ï¼š\n- åŒ¹é…åº¦é˜ˆå€¼ï¼š${minMatch}\n- æœ€å¤§å¸‚å€¼ï¼š${maxCap}äº¿å…ƒ\n${scanLimit ? `- æ‰«ææ•°é‡é™åˆ¶ï¼š${scanLimit}åª\n` : ''}\nè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚`)) {
                        isScanning = false; // é‡ç½®æ ‡å¿—
                        return;
                    }
                }
            } else if (vipUserButtonsPanel && vipUserButtonsPanel.offsetParent !== null) {
                // VIPç”¨æˆ·ï¼šæ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§ï¼ˆä½¿ç”¨ offsetParentï¼Œæ›´å¯é ï¼‰
                const minMatchScoreInput = document.getElementById('minMatchScore');
                const maxMarketCapInput = document.getElementById('maxMarketCap');
                const excludeSTInput = document.getElementById('excludeST');
                const excludeSuspendedInput = document.getElementById('excludeSuspended');
                const industryFilterInput = document.getElementById('industryFilter');
                const customStockPoolInput = document.getElementById('customStockPool');
                
                if (minMatchScoreInput) {
                    minMatch = parseFloat(minMatchScoreInput.value) || 0.93;
                    maxCap = parseFloat(maxMarketCapInput?.value) || 100;
                    excludeST = excludeSTInput?.checked !== false; // é»˜è®¤true
                    excludeSuspended = excludeSuspendedInput?.checked !== false; // é»˜è®¤true
                    industryFilter = (industryFilterInput?.value || '').trim();
                    customStockPool = (customStockPoolInput?.value || '').trim();
                    scanLimit = null; // VIPç”¨æˆ·æ”¯æŒå…¨å¸‚åœºæ‰«æï¼Œä¸ä½¿ç”¨limit
                    
                    // âœ… å…³é”®ï¼šç¡®ä¿ maxCap æ˜¯æ•°å­—ç±»å‹ï¼Œå¹¶æ‰“å°è¯¦ç»†æ—¥å¿—
                    if (isNaN(maxCap) || maxCap <= 0) {
                        console.warn('[scanAllStocks] âš ï¸ maxCap æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼ 100');
                        maxCap = 100;
                    }
                    console.log('[scanAllStocks] VIPç”¨æˆ·å‚æ•°:', { 
                        minMatch, 
                        maxCap, 
                        maxCapType: typeof maxCap,
                        maxMarketCapInputValue: maxMarketCapInput?.value,
                        excludeST, 
                        excludeSuspended, 
                        industryFilter, 
                        customStockPool 
                    });
                    
                    if (!confirm(`ç¡®å®šè¦å¼€å§‹æ‰«æå—ï¼Ÿ\n\næ‰«æå‚æ•°ï¼š\n- åŒ¹é…åº¦é˜ˆå€¼ï¼š${minMatch}\n- æœ€å¤§å¸‚å€¼ï¼š${maxCap}äº¿å…ƒ\n- æ’é™¤STè‚¡ç¥¨ï¼š${excludeST ? 'æ˜¯' : 'å¦'}\n- æ’é™¤åœç‰Œè‚¡ç¥¨ï¼š${excludeSuspended ? 'æ˜¯' : 'å¦'}\n${industryFilter ? `- è¡Œä¸šç­›é€‰ï¼š${industryFilter}\n` : ''}${customStockPool ? `- è‡ªå®šä¹‰è‚¡ç¥¨æ± ï¼š${customStockPool}\n` : ''}\nè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆçº¦5000åªè‚¡ç¥¨ï¼‰ã€‚`)) {
                        isScanning = false; // é‡ç½®æ ‡å¿—
                        return;
                    }
                }
            } else {
                // å…œåº•æ–¹æ¡ˆï¼šä½¿ç”¨é»˜è®¤å€¼ï¼ˆå¦‚æœè¾“å…¥æ¡†ä¸å¯è§ï¼‰
                // ä¸åç«¯é»˜è®¤ä¸€è‡´ï¼›è‹¥ç»“æœè¿‡å¤šå¯è°ƒé«˜(0.95+)ï¼Œè¿‡å°‘å¯è°ƒä½(0.90)
                minMatch = 0.93;
                maxCap = 100;
                scanLimit = null;
                excludeST = true;
                excludeSuspended = true;
                industryFilter = '';
                customStockPool = '';
                scanDate = null;
                scanSession = 'close';
                
                // âœ… ä¿å­˜å½“å‰å‚æ•°
                currentParams = {
                    min_match_score: minMatch,
                    max_market_cap: maxCap,
                    limit: scanLimit,
                    scan_date: scanDate,
                    scan_session: scanSession,
                    exclude_st: excludeST,
                    exclude_suspended: excludeSuspended,
                    industry_filter: industryFilter,
                    custom_stock_pool: customStockPool
                };
                
                console.warn('[scanAllStocks] æ— æ³•ç¡®å®šå‚æ•°æ¥æºï¼Œä½¿ç”¨é»˜è®¤å€¼:', { minMatch, maxCap });
                
                if (!confirm(`ç¡®å®šè¦å¼€å§‹æ‰«æå—ï¼Ÿ\n\næ‰«æå‚æ•°ï¼š\n- åŒ¹é…åº¦é˜ˆå€¼ï¼š${minMatch}ï¼ˆé»˜è®¤ï¼‰\n- æœ€å¤§å¸‚å€¼ï¼š${maxCap}äº¿å…ƒï¼ˆé»˜è®¤ï¼‰\nè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆçº¦5000åªè‚¡ç¥¨ï¼‰ã€‚`)) {
                    isScanning = false; // é‡ç½®æ ‡å¿—
                    return;
                }
            }
            
            // âœ… æ¯”è¾ƒå½“å‰å‚æ•°å’Œä¸Šä¸€æ¬¡å‚æ•°ï¼ˆåœ¨æ‰€æœ‰å‚æ•°æ”¶é›†å®Œæˆåï¼‰
            const lastParams = getLastScanParams();
            
            if (lastParams && compareScanParams(currentParams, lastParams)) {
                console.log('[scanAllStocks] âœ… æ‰«ææ¡ä»¶ä¸ä¸Šä¸€æ¬¡å®Œå…¨ç›¸åŒï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜ç»“æœ...');
                
                // è·å–ä¸Šä¸€æ¬¡çš„scan_id
                const lastScanId = localStorage.getItem('last_scan_result_scan_id');
                
                if (lastScanId) {
                    // å°è¯•è·å–ç¼“å­˜çš„ç»“æœ
                    try {
                        updateProgress(0, 'æ£€æŸ¥ç¼“å­˜', 'æ­£åœ¨æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜ç»“æœ...');
                        const cachedResultResponse = await fetch(`/api/get_scan_results?scan_id=${lastScanId}`, {
                            cache: 'no-store',
                            headers: { 'Cache-Control': 'no-cache' }
                        });
                        
                        if (cachedResultResponse.ok) {
                            const cachedResult = await cachedResultResponse.json();
                            
                            if (cachedResult.success && cachedResult.candidates && cachedResult.candidates.length > 0) {
                                console.log(`[scanAllStocks] âœ… æ‰¾åˆ°ç¼“å­˜ç»“æœï¼Œå…± ${cachedResult.candidates.length} åªè‚¡ç¥¨`);
                                showMessage(`âœ… ä½¿ç”¨ç¼“å­˜ç»“æœï¼ˆå…± ${cachedResult.candidates.length} åªè‚¡ç¥¨ï¼Œæ¡ä»¶ä¸ä¸Šæ¬¡ç›¸åŒï¼‰`, 'success');
                                
                                // ç›´æ¥æ˜¾ç¤ºç¼“å­˜ç»“æœ
                                await displayScanResults(cachedResult);
                                isScanning = false;
                                stopProgressPolling();
                                hideProgress();
                                return; // ç›´æ¥è¿”å›ï¼Œä¸é‡æ–°æ‰«æ
                            }
                        }
                    } catch (e) {
                        console.warn('[scanAllStocks] è·å–ç¼“å­˜ç»“æœå¤±è´¥ï¼Œç»§ç»­é‡æ–°æ‰«æ:', e);
                    }
                }
                
                // å¦‚æœæ²¡æœ‰ç¼“å­˜ç»“æœï¼Œç»§ç»­é‡æ–°æ‰«æ
                console.log('[scanAllStocks] æœªæ‰¾åˆ°ç¼“å­˜ç»“æœï¼Œç»§ç»­é‡æ–°æ‰«æ...');
            } else {
                if (lastParams) {
                    console.log('[scanAllStocks] âš ï¸ æ‰«ææ¡ä»¶å·²æ”¹å˜ï¼Œå¿…é¡»é‡æ–°æ‰«æ');
                    console.log('[scanAllStocks] æ¡ä»¶å˜åŒ–è¯¦æƒ…:', {
                        last: lastParams,
                        current: currentParams
                    });
                } else {
                    console.log('[scanAllStocks] é¦–æ¬¡æ‰«ææˆ–æ²¡æœ‰ä¸Šæ¬¡è®°å½•ï¼Œå¼€å§‹æ–°æ‰«æ');
                }
            }
            
            console.log('å¼€å§‹æ‰«æï¼Œå‚æ•°:', { minMatch, maxCap, scanLimit, scanDate, scanSession });

            // âœ… å…³é”®ï¼šæ¯æ¬¡â€œé‡æ–°æ‰«æå…¨å¸‚åœºâ€æ—¶ï¼Œå…ˆæ¸…ç©ºä¸Šä¸€æ¬¡æ‰¾åˆ°çš„ç»“æœ
            // é¿å…ç”¨æˆ·åœ¨æ–°ä¸€è½®æ‰«æå°šæœªè¿”å›è¿›åº¦å‰ï¼Œä»çœ‹åˆ°æ—§çš„å€™é€‰åˆ—è¡¨
            stopProgressPolling();  // å†æ¬¡åœæ­¢æ—§è½®è¯¢ï¼ˆé˜²å¾¡ï¼šè‹¥å‰é¢æœ‰åˆ†æ”¯æœªç»è¿‡ 2268 çš„ stopï¼‰
            window.currentScanId = null;
            window.currentScanResults = null;
            window._liveScanCandidateMap = {};  // æ¸…ç©ºå®æ—¶å€™é€‰ç¼“å­˜ï¼Œä»…å±•ç¤ºæœ¬è½®æ–°å†…å®¹
            try {
                const resultContainer = document.getElementById('buyPointsResult');
                if (resultContainer) {
                    // æ˜¾ç¤ºåˆå§‹æç¤ºï¼Œè€Œä¸æ˜¯"å·²æ¸…ç©ºä¸Šä¸€æ¬¡æ‰«æç»“æœ"ï¼ˆé¿å…ç”¨æˆ·è¯¯è§£ï¼‰
                    resultContainer.innerHTML = `
                        <div style="margin-top: 15px; padding: 20px; background: white; border-radius: 6px; text-align: center; color: #666;">
                            <span style="font-size: 24px;">ğŸ”</span>
                            <p style="margin-top: 10px;">æ­£åœ¨æ‰«æå…¨å¸‚åœºï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨å°†å®æ—¶æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
                            <p style="color: #999; font-size: 12px; margin-top: 5px;">è¯·ç¨å€™...</p>
                        </div>
                    `;
                }
            } catch (e) {
                console.warn('[scanAllStocks] æ¸…ç©ºæ—§ç»“æœå¤±è´¥ï¼ˆå¿½ç•¥ï¼‰:', e);
            }
            
            // å¯ç”¨åœæ­¢æŒ‰é’®
            const stopBtn = document.getElementById('stopScanBtn');
            if (stopBtn) {
                stopBtn.disabled = false;
            }
            
            // æ˜¾ç¤ºå‡†å¤‡é˜¶æ®µçš„æç¤º
            showProgress();
            updateProgress(0, 'å‡†å¤‡ä¸­', 'æ­£åœ¨å‡†å¤‡æ‰«æä»»åŠ¡...');
            showMessage('æ­£åœ¨å‡†å¤‡æ‰«æä»»åŠ¡ï¼Œè¯·ç¨å€™...', 'info');
            
            // å…ˆæ£€æµ‹ç¼“å­˜çŠ¶æ€ï¼Œç„¶åæ˜¾ç¤ºç›¸åº”çš„æç¤º
            updateProgress(0, 'æ£€æµ‹ä¸­', 'æ­£åœ¨æ£€æµ‹ç¼“å­˜çŠ¶æ€...');
            
            // å…ˆæ£€æŸ¥ç¼“å­˜çŠ¶æ€ï¼ˆé€šè¿‡ä¸€ä¸ªè½»é‡çº§çš„ API è°ƒç”¨ï¼‰
            let cacheStatus = 'æœªçŸ¥';
            let cachedStockCount = 0;
            try {
                console.log('[scanAllStocks] æ£€æµ‹ç¼“å­˜çŠ¶æ€...');
                const cacheCheckResponse = await fetch('/api/check_cache_status', {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (cacheCheckResponse.ok) {
                    const cacheResult = await cacheCheckResponse.json();
                    if (cacheResult.success) {
                        cacheStatus = cacheResult.cache_exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨';
                        cachedStockCount = cacheResult.cached_stock_count || 0;
                        console.log(`[scanAllStocks] ç¼“å­˜çŠ¶æ€: ${cacheStatus}, è‚¡ç¥¨æ•°: ${cachedStockCount}`);
                    }
                }
            } catch (e) {
                console.warn('[scanAllStocks] æ£€æµ‹ç¼“å­˜çŠ¶æ€å¤±è´¥ï¼ˆç»§ç»­æ‰§è¡Œï¼‰:', e);
            }
            
            // æ ¹æ®ç¼“å­˜çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æç¤º
            if (cacheStatus === 'å­˜åœ¨' && cachedStockCount > 0) {
                showMessage(`æ­£åœ¨ä»ç¼“å­˜è·å–è‚¡ç¥¨æ•°æ®ï¼ˆ${cachedStockCount} åªè‚¡ç¥¨ï¼‰...`, 'success');
                updateProgress(0, 'è·å–ä¸­', `æ­£åœ¨ä»ç¼“å­˜è·å–è‚¡ç¥¨æ•°æ®ï¼ˆ${cachedStockCount} åªè‚¡ç¥¨ï¼‰...`);
            } else if (cacheStatus === 'ä¸å­˜åœ¨') {
                showMessage('æ­£åœ¨è·å–è‚¡ç¥¨æ•°æ®ï¼ˆä» APIï¼‰...', 'info');
                updateProgress(0, 'è·å–ä¸­', 'æ­£åœ¨ä» API è·å–è‚¡ç¥¨æ•°æ®ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´...');
            } else {
                showMessage('æ­£åœ¨å‡†å¤‡æ‰«æä»»åŠ¡ï¼Œè¯·ç¨å€™...', 'info');
                updateProgress(0, 'å‡†å¤‡ä¸­', 'æ­£åœ¨å‡†å¤‡æ‰«æä»»åŠ¡...');
            }
            
            // æœ¬åœ°ç¯å¢ƒç›´æ¥ä½¿ç”¨æœ¬åœ°æ•°æ®æ‰«æï¼ˆæ•°æ®æ›´æ–°åªåœ¨ç™»å½•æ—¶è¿›è¡Œä¸€æ¬¡ï¼‰
            if (isLocalEnvironment()) {
                console.log('[scanAllStocks] æœ¬åœ°ç¯å¢ƒï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°æ•°æ®æ‰«æ');
            }
            
            // æ˜¾ç¤ºå¯åŠ¨æ‰«æçš„æç¤º
            updateProgress(0, 'å¯åŠ¨ä¸­', 'æ­£åœ¨å¯åŠ¨æ‰«æä»»åŠ¡ï¼Œè¯·ç¨å€™...');
            showMessage('æ­£åœ¨å¯åŠ¨æ‰«æä»»åŠ¡ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...', 'info');
            
            startProgressPolling();
            
            try {
                // ç¡®ä¿ stopBtn åœ¨ä½œç”¨åŸŸå†…
                const stopBtn = document.getElementById('stopScanBtn');
                // ä½¿ç”¨AbortControllerè®¾ç½®è¶…æ—¶ï¼ˆ60ç§’ï¼‰
                // åœ¨Vercelç¯å¢ƒä¸­ï¼Œç¬¬ä¸€æ‰¹å¤„ç†å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼ˆè·å–è‚¡ç¥¨åˆ—è¡¨ã€å¤„ç†ç¬¬ä¸€æ‰¹ç­‰ï¼‰
                // æ¯ä¸ªè¯·æ±‚ä½¿ç”¨ç‹¬ç«‹çš„ controllerï¼Œé¿å…å¤šè®¾å¤‡/å¤šæ ‡ç­¾é¡µå†²çª
                const controller = new AbortController();
                let timeoutId = null;
                
                // è®¾ç½®è¶…æ—¶ï¼Œä½†åªåœ¨è¯·æ±‚çœŸæ­£è¶…æ—¶æ—¶æ‰ä¸­æ–­
                // âœ… ç½‘ç»œç¯å¢ƒï¼ˆRenderï¼‰éœ€è¦æ›´é•¿è¶…æ—¶ï¼ˆ90ç§’ï¼‰ï¼Œå› ä¸ºæœåŠ¡å™¨å¯èƒ½ä¼‘çœ éœ€è¦å”¤é†’
                // âœ… æœ¬åœ°ç¯å¢ƒä½¿ç”¨çŸ­è¶…æ—¶ï¼ˆ60ç§’ï¼‰
                const requestTimeout = isNetworkEnvironment() ? 90000 : 60000;
                timeoutId = setTimeout(() => {
                    console.warn(`[scanAllStocks] è¯·æ±‚è¶…æ—¶ï¼ˆ${requestTimeout/1000}ç§’ï¼‰ï¼Œä¸­æ–­è¯·æ±‚`);
                    console.warn('[scanAllStocks] æ³¨æ„ï¼šè™½ç„¶è¯·æ±‚è¢«ä¸­æ–­ï¼Œä½†æ‰«æå¯èƒ½å·²åœ¨åå°å¯åŠ¨');
                    updateProgress(0, 'å¤„ç†ä¸­', 'è¯·æ±‚å·²æäº¤ï¼Œæ­£åœ¨åå°å¤„ç†ï¼Œè¯·ç»§ç»­ç­‰å¾…...');
                    controller.abort();
                }, requestTimeout);
                
                // åœ¨å‘é€è¯·æ±‚å‰æ›´æ–°æç¤º
                updateProgress(0, 'æäº¤ä¸­', 'æ­£åœ¨æäº¤æ‰«æè¯·æ±‚...');
                
                let response;
                try {
                    response = await fetch('/api/scan_all_stocks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            min_match_score: minMatch,
                            max_market_cap: maxCap,  // âœ… ç¡®ä¿ä¼ é€’å¸‚å€¼å‚æ•°
                            limit: scanLimit,
                            // æœ¬åœ°ç‰ˆæ–°å¢ï¼šæŒ‡å®šæ‰«ææ—¥æœŸ/æ—¶é—´æ®µï¼ˆæ—¶é—´æ®µä»…ä½œä¸ºæ ‡ç­¾ï¼‰
                            scan_date: scanDate,
                            scan_session: scanSession,
                            force_refresh: !!document.getElementById('localForceRefresh')?.checked,
                            exclude_st: excludeST,
                            exclude_suspended: excludeSuspended,
                            industry_filter: industryFilter,
                            custom_stock_pool: customStockPool
                        }),
                        signal: controller.signal
                    });
                } catch (fetchError) {
                    // æ¸…é™¤è¶…æ—¶
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                        timeoutId = null;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ AbortError
                    if (fetchError.name === 'AbortError' || fetchError.message?.includes('aborted') || fetchError.message?.includes('Failed to fetch')) {
                        console.warn('[scanAllStocks] è¯·æ±‚è¢«ä¸­æ–­æˆ–å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼š');
                        console.warn(`  1. è¯·æ±‚è¶…æ—¶ï¼ˆ${requestTimeout/1000}ç§’ï¼‰- è¿™åœ¨ç½‘ç»œç¯å¢ƒä¸­å¯èƒ½å‘ç”Ÿï¼Œå› ä¸ºæœåŠ¡å™¨å¯èƒ½ä¼‘çœ éœ€è¦å”¤é†’æˆ–å¤„ç†éœ€è¦æ—¶é—´`);
                        console.warn('  2. ç½‘ç»œè¿æ¥ä¸­æ–­æˆ–ä¸ç¨³å®š');
                        console.warn('  3. ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡/æ ‡ç­¾é¡µå¯åŠ¨äº†æ‰«æ');
                        console.warn('[scanAllStocks] æ­£åœ¨æ£€æŸ¥æ‰«ææ˜¯å¦å·²åœ¨åå°å¯åŠ¨...');
                        
                        // å°è¯•æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„æ‰«æä»»åŠ¡ï¼ˆé€šè¿‡è¿›åº¦APIï¼‰
                        try {
                            const checkResponse = await fetch('/api/get_progress', {
                                cache: 'no-store',
                                credentials: 'same-origin',
                                headers: { 'Cache-Control': 'no-cache' }
                            });
                            const checkResult = await checkResponse.json();
                            if (checkResponse.status === 401) {
                                showMessage('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•åé‡è¯•', 'error');
                                return;
                            }
                            if (checkResult.success && checkResult.progress) {
                                const status = checkResult.progress.status || 'ç©ºé—²';
                                const scanId = checkResult.progress.scan_id;
                                
                                // æ£€æŸ¥æ˜¯å¦ä¸ºæ´»è·ƒçŠ¶æ€ï¼ˆåŒ…æ‹¬"å‡†å¤‡ä¸­"ã€"è·å–ä¸­"ã€"å¯åŠ¨ä¸­"ã€"å¤„ç†ä¸­"ï¼‰
                                if (status !== 'ç©ºé—²' && status !== 'å·²å®Œæˆ' && status !== 'å·²åœæ­¢' && status !== 'é”™è¯¯' && status !== 'å¤±è´¥') {
                                    // æ‰«æå·²ç»åœ¨è¿›è¡Œä¸­
                                    console.log('[scanAllStocks] âœ… æ‰«æå·²åœ¨åå°å¯åŠ¨ï¼', checkResult.progress);
                                    showMessage('æ‰«æå·²åœ¨åå°å¯åŠ¨ï¼è¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'success');
                                    window._scanJustCleared = false;  // å…è®¸è½®è¯¢å†™å…¥æœ¬è½®çš„è¿›åº¦
                                    if (scanId) {
                                        window.currentScanId = scanId;  // è®©è½®è¯¢å¸¦ scan_id æ‹‰å–æ­£ç¡®è¿›åº¦
                                        console.log(`[scanAllStocks] å·²è®¾ç½® currentScanId: ${scanId}`);
                                    }
                                    
                                    // å¦‚æœè¿”å›äº†scan_idï¼Œå°è¯•ç»§ç»­å¤„ç†åç»­æ‰¹æ¬¡
                                    if (scanId && checkResult.progress.total_batches > 1) {
                                        const totalBatches = checkResult.progress.total_batches;
                                        const currentBatch = checkResult.progress.batch || 0;
                                        
                                        console.log(`[scanAllStocks] æ£€æµ‹åˆ°æ´»è·ƒæ‰«æ: scan_id=${scanId}, å½“å‰æ‰¹æ¬¡=${currentBatch}/${totalBatches}`);
                                        
                                        // å¦‚æœè¿˜æœ‰æ›´å¤šæ‰¹æ¬¡ï¼Œè‡ªåŠ¨ç»§ç»­å¤„ç†
                                        if (currentBatch < totalBatches) {
                                            console.log(`[scanAllStocks] è‡ªåŠ¨ç»§ç»­å¤„ç†å‰©ä½™æ‰¹æ¬¡: ${currentBatch + 1}/${totalBatches}`);
                                            autoContinueScan(scanId, currentBatch, totalBatches);
                                        }
                                    }
                                    
                                    // ä¸åœæ­¢è¿›åº¦è½®è¯¢ï¼Œç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°
                                    return; // ç›´æ¥è¿”å›ï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                                }
                            } else {
                                // æ²¡æœ‰æ´»è·ƒçš„æ‰«æä»»åŠ¡
                                console.warn('[scanAllStocks] âš ï¸ æœªæ£€æµ‹åˆ°æ´»è·ƒçš„æ‰«æä»»åŠ¡ï¼Œå¯èƒ½æ‰«æå¯åŠ¨å¤±è´¥');
                                
                                // ç½‘ç»œç¯å¢ƒï¼šå¯èƒ½æ˜¯æœåŠ¡å™¨å“åº”æ…¢ï¼Œå¢åŠ ç­‰å¾…æ—¶é—´
                                if (isNetworkEnvironment()) {
                                    console.log('[scanAllStocks] ç½‘ç»œç¯å¢ƒï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨å“åº”æ…¢ï¼Œç»§ç»­ç­‰å¾…...');
                                    showMessage('è¯·æ±‚è¶…æ—¶ï¼Œä½†æ‰«æå¯èƒ½æ­£åœ¨åå°å¯åŠ¨ï¼ˆç½‘ç»œç¯å¢ƒå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼‰ã€‚è¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'info');
                                    
                                    // ç»§ç»­ç­‰å¾…æ›´é•¿æ—¶é—´ï¼ˆç½‘ç»œç¯å¢ƒï¼‰ï¼Œå¹¶å¤šæ¬¡æ£€æŸ¥
                                    let checkCount = 0;
                                    const maxChecks = 8; // å¢åŠ åˆ°8æ¬¡ï¼ˆæœ€å¤š80ç§’ï¼‰
                                    const checkInterval = 10000; // æ¯æ¬¡é—´éš”10ç§’
                                    
                                    const checkProgress = setInterval(() => {
                                        checkCount++;
                                        console.log(`[scanAllStocks] ç¬¬ ${checkCount} æ¬¡æ£€æŸ¥æ‰«æçŠ¶æ€...`);
                                        
                                        fetch('/api/get_progress', { 
                                            cache: 'no-store', 
                                            credentials: 'same-origin',
                                            headers: { 'Cache-Control': 'no-cache' }
                                        })
                                            .then(r => r.json())
                                            .then(result => {
                                                console.log(`[scanAllStocks] ç¬¬ ${checkCount} æ¬¡æ£€æŸ¥ç»“æœ:`, result);
                                                
                                                if (result.success && result.progress) {
                                                    const status = result.progress.status || 'ç©ºé—²';
                                                    const scanId = result.progress.scan_id;
                                                    
                                                    console.log(`[scanAllStocks] æ‰«æçŠ¶æ€: ${status}, scan_id: ${scanId || 'æ— '}`);
                                                    
                                                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ´»è·ƒçŠ¶æ€ï¼ˆåŒ…æ‹¬"å‡†å¤‡ä¸­"ï¼‰
                                                    if (status !== 'ç©ºé—²' && status !== 'å·²å®Œæˆ' && status !== 'å·²åœæ­¢' && status !== 'é”™è¯¯' && status !== 'å¤±è´¥') {
                                                        console.log('[scanAllStocks] âœ… æ‰«æå·²å¯åŠ¨ï¼', result.progress);
                                                        clearInterval(checkProgress);
                                                        showMessage('æ‰«æå·²å¯åŠ¨ï¼è¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'success');
                                                        window._scanJustCleared = false;
                                                        if (scanId) {
                                                            window.currentScanId = scanId;
                                                            console.log(`[scanAllStocks] å·²è®¾ç½® currentScanId: ${scanId}`);
                                                        }
                                                        return; // æ‰¾åˆ°æ´»è·ƒæ‰«æï¼Œåœæ­¢æ£€æŸ¥
                                                    }
                                                    
                                                    // å¦‚æœçŠ¶æ€æ˜¯"å‡†å¤‡ä¸­"ï¼Œä¹Ÿè®¤ä¸ºæ˜¯æ´»è·ƒçš„
                                                    if (status === 'å‡†å¤‡ä¸­' || status === 'è·å–ä¸­' || status === 'å¯åŠ¨ä¸­' || status === 'å¤„ç†ä¸­') {
                                                        console.log('[scanAllStocks] âœ… æ£€æµ‹åˆ°æ‰«ææ­£åœ¨å‡†å¤‡/å¯åŠ¨ä¸­ï¼', result.progress);
                                                        clearInterval(checkProgress);
                                                        showMessage('æ‰«ææ­£åœ¨å¯åŠ¨ä¸­ï¼Œè¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'success');
                                                        window._scanJustCleared = false;
                                                        if (scanId) {
                                                            window.currentScanId = scanId;
                                                            console.log(`[scanAllStocks] å·²è®¾ç½® currentScanId: ${scanId}`);
                                                        }
                                                        return; // æ‰¾åˆ°æ´»è·ƒæ‰«æï¼Œåœæ­¢æ£€æŸ¥
                                                    }
                                                }
                                                
                                                // è¾¾åˆ°æœ€å¤§æ£€æŸ¥æ¬¡æ•°
                                                if (checkCount >= maxChecks) {
                                                    console.warn('[scanAllStocks] âš ï¸ å·²è¾¾åˆ°æœ€å¤§æ£€æŸ¥æ¬¡æ•°ï¼Œä»æœªæ£€æµ‹åˆ°æ´»è·ƒæ‰«æ');
                                                    clearInterval(checkProgress);
                                                    showMessage('æ‰«æå¯èƒ½æœªæˆåŠŸå¯åŠ¨ã€‚è¯·åˆ·æ–°é¡µé¢åé‡è¯•ï¼Œæˆ–æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ã€‚', 'warning');
                                                }
                                            })
                                            .catch(e => {
                                                console.error(`[scanAllStocks] ç¬¬ ${checkCount} æ¬¡æ£€æŸ¥è¿›åº¦å¤±è´¥:`, e);
                                                if (checkCount >= maxChecks) {
                                                    clearInterval(checkProgress);
                                                    showMessage('æ— æ³•æ£€æŸ¥æ‰«æçŠ¶æ€ã€‚è¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚', 'warning');
                                                }
                                            });
                                    }, checkInterval);
                                } else {
                                    // æœ¬åœ°ç¯å¢ƒï¼šå¿«é€Ÿå¤±è´¥
                                    showMessage('è¯·æ±‚è¶…æ—¶ï¼Œæ‰«æå¯èƒ½æœªæˆåŠŸå¯åŠ¨ã€‚è¯·ç¨åé‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚', 'warning');
                                    // ç»§ç»­ç­‰å¾…å‡ ç§’ï¼Œä»¥é˜²æ‰«æåˆšåˆšå¯åŠ¨ä½†è¿˜æœªæ›´æ–°è¿›åº¦
                                    setTimeout(() => {
                                        // å†æ¬¡æ£€æŸ¥è¿›åº¦
                                        fetch('/api/get_progress', { cache: 'no-store', credentials: 'same-origin' })
                                            .then(r => r.json())
                                            .then(result => {
                                                if (result.success && result.progress) {
                                                    const status = result.progress.status || 'ç©ºé—²';
                                                    if (status !== 'ç©ºé—²' && status !== 'å·²å®Œæˆ' && status !== 'å·²åœæ­¢' && status !== 'é”™è¯¯' && status !== 'å¤±è´¥') {
                                                        showMessage('æ‰«æå·²å¯åŠ¨ï¼è¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'success');
                                                        if (result.progress.scan_id) {
                                                            window.currentScanId = result.progress.scan_id;
                                                        }
                                                    }
                                                }
                                            })
                                            .catch(e => console.error('æ£€æŸ¥è¿›åº¦å¤±è´¥:', e));
                                    }, 3000);
                                }
                                return; // ç›´æ¥è¿”å›ï¼Œä¸æŠ›å‡ºé”™è¯¯
                            }
                        } catch (checkError) {
                            console.error('[scanAllStocks] æ£€æŸ¥æ‰«æçŠ¶æ€å¤±è´¥:', checkError);
                            showMessage('è¯·æ±‚è¶…æ—¶ï¼Œä½†æ— æ³•ç¡®è®¤æ‰«æçŠ¶æ€ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åæŸ¥çœ‹æ‰«æç»“æœã€‚', 'warning');
                            // ä¸åœæ­¢è¿›åº¦è½®è¯¢ï¼Œç»§ç»­ç­‰å¾…å¯èƒ½çš„è¿›åº¦æ›´æ–°
                            return; // ç›´æ¥è¿”å›ï¼Œä¸æŠ›å‡ºé”™è¯¯
                        }
                    }
                    
                    // å…¶ä»–é”™è¯¯ç»§ç»­æŠ›å‡º
                    console.error('[scanAllStocks] fetch è¯·æ±‚å¤±è´¥ï¼ˆé AbortErrorï¼‰:', fetchError);
                    throw fetchError;
                }
                
                // è¯·æ±‚æˆåŠŸï¼Œæ¸…é™¤è¶…æ—¶
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                
                if (!response.ok) {
                    let errorText;
                    try {
                        errorText = await response.text();
                    } catch (textError) {
                        // å¦‚æœè¯»å–é”™è¯¯å“åº”æ–‡æœ¬æ—¶å‡ºé”™ï¼ˆå¯èƒ½æ˜¯ AbortErrorï¼‰
                        if (textError.name === 'AbortError' || textError.message?.includes('aborted')) {
                            console.warn('[scanAllStocks] è¯»å–é”™è¯¯å“åº”æ—¶è¢«ä¸­æ–­');
                            showMessage('è¯·æ±‚å·²ä¸­æ–­ï¼Œä½†æ‰«æå¯èƒ½å·²åœ¨åå°å¯åŠ¨ã€‚è¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'warning');
                            return; // ç›´æ¥è¿”å›
                        }
                        errorText = `æ— æ³•è¯»å–é”™è¯¯å“åº”: ${textError.message}`;
                    }
                    console.error('[scanAllStocks] HTTPé”™è¯¯å“åº”:', {
                        status: response.status,
                        statusText: response.statusText,
                        body: errorText
                    });
                    
                    // å°è¯•è§£æ JSON å“åº”ï¼Œæå–è¯¦ç»†é”™è¯¯ä¿¡æ¯
                    let errorResult = null;
                    try {
                        errorResult = JSON.parse(errorText);
                    } catch (parseError) {
                        // å¦‚æœä¸æ˜¯ JSONï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬
                        console.warn('[scanAllStocks] é”™è¯¯å“åº”ä¸æ˜¯ JSON æ ¼å¼');
                    }
                    
                    // å¦‚æœæ˜¯ 400 é”™è¯¯ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ•°æ®ä¸è¶³é”™è¯¯
                    if (response.status === 400 && errorResult) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°æ®ä¸è¶³é”™è¯¯
                        if (errorResult.error_code === 'DATA_INSUFFICIENT' || errorResult.need_download) {
                            const freshness = errorResult.freshness || {};
                            const outdatedCount = freshness.outdated_count || 0;
                            const totalCount = freshness.total || 0;
                            const latestDate = freshness.latest_data_date || 'æœªçŸ¥';
                            const targetDate = freshness.target_date || 'ä»Šå¤©';
                            const outdatedPct = totalCount > 0 ? (outdatedCount/totalCount*100).toFixed(1) : 0;
                            
                            const errorMsg = `æ•°æ®ä¸è¶³ï¼Œæ— æ³•è¿›è¡Œæ‰«æï¼\n\n` +
                                `è¿‡æœŸæ•°æ®: ${outdatedCount}/${totalCount} (${outdatedPct}%)\n` +
                                `æœ€æ–°æ•°æ®æ—¥æœŸ: ${latestDate}\n` +
                                `ç›®æ ‡æ‰«ææ—¥æœŸ: ${targetDate}\n\n` +
                                `è¯·å…ˆä¸‹è½½æ•°æ®åå†è¿›è¡Œæ‰«æã€‚`;
                            
                            showMessage(errorMsg, 'error');
                            
                            // åœ¨æœ¬åœ°ç¯å¢ƒä¸­ï¼Œæ˜¾ç¤ºä¸‹è½½æ•°æ®çš„æŒ‰é’®æç¤º
                            if (isLocalEnvironment()) {
                                setTimeout(() => {
                                    // âœ… å…ˆæ£€æŸ¥æ—¶é—´ï¼Œå¦‚æœæ˜¯15:00åï¼Œä¸æç¤ºæ›´æ–°
                                    fetch('/api/get_data_update_timestamp')
                                        .then(res => res.json())
                                        .then(result => {
                                            if (result.success && result.should_skip) {
                                                console.log(`[scanAllStocks] ${result.message || 'äº¤æ˜“å·²ç»“æŸï¼Œè·³è¿‡æ•°æ®æ›´æ–°æç¤º'}`);
                                                return; // è·³è¿‡æç¤º
                                            }
                                            // å¦‚æœå…è®¸æ›´æ–°ï¼Œå†æç¤ºç”¨æˆ·
                                            if (confirm('æ£€æµ‹åˆ°æ•°æ®ä¸è¶³ã€‚æ˜¯å¦ç°åœ¨å¯åŠ¨æ•°æ®ä¸‹è½½ï¼Ÿ\n\nï¼ˆæ‚¨ä¹Ÿå¯ä»¥ç¨ååœ¨"æ•°æ®ç®¡ç†"ä¸­æ‰‹åŠ¨ä¸‹è½½ï¼‰')) {
                                                // è‡ªåŠ¨å¯åŠ¨æ•°æ®ä¸‹è½½
                                                if (typeof startAutoDataUpdate === 'function') {
                                                    startAutoDataUpdate();
                                                }
                                            }
                                        })
                                        .catch(err => {
                                            console.error('[scanAllStocks] æ£€æŸ¥æ—¶é—´æˆ³å¤±è´¥:', err);
                                            // æ£€æŸ¥å¤±è´¥æ—¶ï¼Œä»ç„¶æç¤ºï¼ˆä¿å®ˆç­–ç•¥ï¼‰
                                            if (confirm('æ£€æµ‹åˆ°æ•°æ®ä¸è¶³ã€‚æ˜¯å¦ç°åœ¨å¯åŠ¨æ•°æ®ä¸‹è½½ï¼Ÿ\n\nï¼ˆæ‚¨ä¹Ÿå¯ä»¥ç¨ååœ¨"æ•°æ®ç®¡ç†"ä¸­æ‰‹åŠ¨ä¸‹è½½ï¼‰')) {
                                                if (typeof startAutoDataUpdate === 'function') {
                                                    startAutoDataUpdate();
                                                }
                                            }
                                        });
                                }, 500);
                            }
                            
                            // åœæ­¢è¿›åº¦è½®è¯¢å’Œéšè—è¿›åº¦æ¡
                            stopProgressPolling();
                            hideProgress();
                            if (stopBtn) {
                                stopBtn.disabled = true;
                            }
                            isScanning = false; // é‡ç½®æ ‡å¿—
                            return; // ç›´æ¥è¿”å›
                        }
                        
                        // å…¶ä»– 400 é”™è¯¯ï¼ˆå¦‚ç¼“å­˜ä¸å­˜åœ¨ï¼‰
                        const errorMsg = errorResult.message || 'è¯·æ±‚é”™è¯¯';
                        let autoRefreshed = false;
                        console.error('[scanAllStocks] ç¼“å­˜ä¸å­˜åœ¨é”™è¯¯:', {
                            cache_exists: errorResult.cache_exists,
                            is_in_trading_time: errorResult.is_in_trading_time,
                            is_vercel: errorResult.is_vercel,
                            current_time: errorResult.current_time,
                            suggestion: errorResult.suggestion
                        });
                        
                        // å¦‚æœå»ºè®®æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ï¼šå…ˆè‡ªåŠ¨å°è¯•åˆ·æ–°ä¸€æ¬¡ï¼ŒæˆåŠŸåˆ™æç¤ºç”¨æˆ·é‡è¯•æ‰«æï¼›å¤±è´¥å†æ˜¾ç¤ºæ‰‹åŠ¨æŒ‰é’®
                        if (errorResult.suggestion === 'æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜' || errorResult.message.includes('æ‰‹åŠ¨è§¦å‘ç¼“å­˜åˆ·æ–°') || (errorResult.cache_exists === false && errorResult.is_vercel)) {
                            showMessage('æ­£åœ¨è‡ªåŠ¨åˆ·æ–°ç¼“å­˜ï¼Œè¯·ç¨å€™...', 'info');
                            updateProgress(0, 'åˆ·æ–°ç¼“å­˜', 'æ­£åœ¨è‡ªåŠ¨åˆ·æ–°ç¼“å­˜...');
                            let refreshMsgShown = false;
                            try {
                                const refreshUrl = (window.location.origin || '') + '/api/refresh_stock_cache?force=true';
                                const ctrl = new AbortController();
                                const t = setTimeout(() => ctrl.abort(), 90000);
                                const r = await fetch(refreshUrl, { method: 'GET', cache: 'no-store', headers: { 'Cache-Control': 'no-cache' }, signal: ctrl.signal });
                                clearTimeout(t);
                                const rr = await r.json().catch(() => ({}));
                                if (rr && rr.success) {
                                    autoRefreshed = true;
                                    showMessage('âœ… ç¼“å­˜å·²åˆ·æ–°ï¼è¯·å†æ¬¡ç‚¹å‡»æ‰«ææŒ‰é’®ã€‚', 'success');
                                    stopProgressPolling();
                                    hideProgress();
                                    if (stopBtn) stopBtn.disabled = true;
                                    isScanning = false;
                                    return;
                                }
                                if (rr && typeof rr.message === 'string') {
                                    const brief = rr.message.replace(/\*\*/g, '').split('\n')[0].trim() || 'åˆ·æ–°å¤±è´¥ï¼Œè¯· 2 åˆ†é’Ÿåå†è¯•ã€‚';
                                    showMessage(brief, 'warning');
                                } else {
                                    showMessage(errorMsg, 'error');
                                }
                                refreshMsgShown = true;
                            } catch (e) {
                                if (e && e.name === 'AbortError') {
                                    showMessage('åˆ·æ–°è¶…æ—¶ï¼Œè¯· 2 åˆ†é’Ÿåå†è¯•æˆ–ç‚¹å‡»ã€Œæ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ã€ã€‚', 'warning');
                                } else {
                                    console.warn('[scanAllStocks] è‡ªåŠ¨åˆ·æ–°ç¼“å­˜å¤±è´¥:', e);
                                    showMessage('åˆ·æ–°è¯·æ±‚å¤±è´¥ï¼Œè¯· 2 åˆ†é’Ÿåå†è¯•æˆ–æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ã€‚', 'warning');
                                }
                                refreshMsgShown = true;
                            }
                            if (!autoRefreshed && !refreshMsgShown) {
                                showMessage(errorMsg, 'error');
                            }
                        } else {
                            showMessage(errorMsg, 'error');
                        }
                        
                        // è‹¥è‡ªåŠ¨åˆ·æ–°æœªæˆåŠŸï¼Œæ˜¾ç¤ºæ‰‹åŠ¨åˆ·æ–°ç¼“å­˜æŒ‰é’®ï¼ˆä»…å½“åˆšå°è¯•è¿‡è‡ªåŠ¨åˆ·æ–°ä¸”å¤±è´¥æ—¶ï¼‰
                        if (!autoRefreshed && (errorResult.suggestion === 'æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜' || errorResult.message.includes('æ‰‹åŠ¨è§¦å‘ç¼“å­˜åˆ·æ–°') || (errorResult.cache_exists === false && errorResult.is_vercel))) {
                            // æ˜¾ç¤ºä¸€ä¸ªå¸¦æœ‰åˆ·æ–°ç¼“å­˜æŒ‰é’®çš„æç¤º
                            const refreshCacheDiv = document.createElement('div');
                            refreshCacheDiv.id = 'refreshCachePrompt';
                            refreshCacheDiv.style.cssText = `
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                background: #fff3cd;
                                border: 2px solid #ffc107;
                                border-radius: 8px;
                                padding: 20px;
                                max-width: 600px;
                                z-index: 10000;
                                box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                            `;
                            refreshCacheDiv.innerHTML = `
                                <h3 style="margin-top: 0; color: #856404;">âš ï¸ ç¼“å­˜æœªç”Ÿæˆ</h3>
                                <p style="color: #856404; margin-bottom: 15px;">éœ€è¦å…ˆåˆ·æ–°è‚¡ç¥¨åˆ—è¡¨ç¼“å­˜æ‰èƒ½ç»§ç»­æ‰«æã€‚</p>
                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button id="cancelRefreshBtn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                                    <button id="refreshCacheBtn" style="padding: 8px 16px; background: #ffc107; color: #856404; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜</button>
                                </div>
                            `;
                            document.body.appendChild(refreshCacheDiv);
                            
                            // ç»‘å®šæŒ‰é’®äº‹ä»¶
                            document.getElementById('cancelRefreshBtn').onclick = () => {
                                refreshCacheDiv.remove();
                            };
                            document.getElementById('refreshCacheBtn').onclick = async () => {
                                refreshCacheDiv.remove();
                                showMessage('æ­£åœ¨æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ï¼Œè¯·ç¨å€™...', 'info');
                                
                                try {
                                    const refreshUrl = (window.location.origin || '') + '/api/refresh_stock_cache?force=true';
                                    const ctrl = new AbortController();
                                    const t = setTimeout(() => ctrl.abort(), 90000);
                                    const refreshResponse = await fetch(refreshUrl, {
                                        method: 'GET',
                                        cache: 'no-store',
                                        headers: { 'Cache-Control': 'no-cache' },
                                        signal: ctrl.signal
                                    });
                                    clearTimeout(t);
                                    
                                    const refreshResult = await refreshResponse.json();
                                    
                                    if (refreshResult.success) {
                                        showMessage(`âœ… ${refreshResult.message || 'ç¼“å­˜åˆ·æ–°æˆåŠŸï¼'}`, 'success');
                                        // ç­‰å¾… 2 ç§’åè‡ªåŠ¨é‡æ–°æ£€æŸ¥ç¼“å­˜çŠ¶æ€
                                        setTimeout(async () => {
                                            try {
                                                const cacheCheckResponse = await fetch('/api/check_cache_status', {
                                                    method: 'GET',
                                                    cache: 'no-store',
                                                    headers: { 'Cache-Control': 'no-cache' }
                                                });
                                                if (cacheCheckResponse.ok) {
                                                    const cacheResult = await cacheCheckResponse.json();
                                                    if (cacheResult.success && cacheResult.cache_exists && cacheResult.cached_stock_count > 0) {
                                                        showMessage(`âœ… ç¼“å­˜å·²ç”Ÿæˆï¼ˆ${cacheResult.cached_stock_count} åªè‚¡ç¥¨ï¼‰ï¼Œç°åœ¨å¯ä»¥æ‰«æäº†ï¼`, 'success');
                                                    }
                                                }
                                            } catch (e) {
                                                console.warn('[refreshCache] æ£€æŸ¥ç¼“å­˜çŠ¶æ€å¤±è´¥:', e);
                                            }
                                        }, 2000);
                                    } else {
                                        // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                                        const errorMsg = refreshResult.message || 'ç¼“å­˜åˆ·æ–°å¤±è´¥';
                                        showMessage(`âŒ ${errorMsg}`, 'error');
                                        
                                        // å¦‚æœæ˜¯æ•°æ®åŒ…æœªä¸‹è½½çš„é”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„æç¤º
                                        if (errorMsg.includes('K çº¿æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨') || errorMsg.includes('æ•°æ®åŒ…')) {
                                            showMessage('ğŸ’¡ æç¤ºï¼šè¯·æ£€æŸ¥ Vercel éƒ¨ç½²æ—¥å¿—ï¼Œç¡®è®¤ GitHub æ•°æ®åŒ…æ˜¯å¦å·²ä¸‹è½½ã€‚', 'info');
                                        }
                                    }
                                } catch (error) {
                                    if (error && error.name === 'AbortError') {
                                        showMessage('âŒ åˆ·æ–°è¶…æ—¶ï¼Œè¯· 2 åˆ†é’Ÿåå†è¯•ã€‚', 'error');
                                    } else {
                                        console.warn('[refreshCache] åˆ·æ–°ç¼“å­˜å¤±è´¥:', error);
                                        showMessage(`âŒ åˆ·æ–°ç¼“å­˜å¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯'}`, 'error');
                                    }
                                    const tipUrl = (window.location.origin || '') + '/api/refresh_stock_cache?force=true';
                                    showMessage('ğŸ’¡ æç¤ºï¼šå¯å¤åˆ¶é“¾æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä»¥åˆ·æ–°: ' + tipUrl, 'info');
                                }
                            };
                        }
                        
                        // åœæ­¢è¿›åº¦è½®è¯¢å’Œéšè—è¿›åº¦æ¡
                        stopProgressPolling();
                        hideProgress();
                        if (stopBtn) {
                            stopBtn.disabled = true;
                        }
                        isScanning = false; // é‡ç½®æ ‡å¿—
                        return; // ç›´æ¥è¿”å›ï¼Œä¸æŠ›å‡ºé”™è¯¯
                    }
                    
                    // å…¶ä»–é”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼ˆä½¿ç”¨åŸå§‹é”™è¯¯æ–‡æœ¬æˆ–è§£æåçš„æ¶ˆæ¯ï¼‰
                    const errorMessage = errorResult?.message || errorText.substring(0, 500);
                    throw new Error(`HTTPé”™è¯¯ ${response.status}: ${response.statusText}\nå“åº”å†…å®¹: ${errorMessage}`);
                }
                
                let responseText;
                try {
                    responseText = await response.text();
                    console.log('[scanAllStocks] API åŸå§‹å“åº”:', responseText);
                } catch (textError) {
                    // å¦‚æœè¯»å–å“åº”æ–‡æœ¬æ—¶å‡ºé”™ï¼ˆå¯èƒ½æ˜¯ AbortErrorï¼‰
                    if (textError.name === 'AbortError' || textError.message?.includes('aborted') || textError.message?.includes('signal is aborted')) {
                        console.warn('[scanAllStocks] è¯»å–å“åº”æ—¶è¢«ä¸­æ–­ï¼Œä½†æ‰«æå¯èƒ½å·²åœ¨åå°å¯åŠ¨');
                        showMessage('è¯·æ±‚å·²ä¸­æ–­ï¼Œä½†æ‰«æå¯èƒ½å·²åœ¨åå°å¯åŠ¨ã€‚è¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'warning');
                        return; // ç›´æ¥è¿”å›
                    }
                    throw textError; // å…¶ä»–é”™è¯¯ç»§ç»­æŠ›å‡º
                }
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('[scanAllStocks] JSONè§£æå¤±è´¥:', parseError);
                    console.error('[scanAllStocks] å“åº”å†…å®¹:', responseText);
                    throw new Error(`æœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„JSONæ ¼å¼\nå“åº”å†…å®¹: ${responseText.substring(0, 200)}`);
                }
                
                console.log('[scanAllStocks] æ‰«æAPIå“åº”:', result);
                
                if (!result) {
                    console.error('[scanAllStocks] API è¿”å›ç©ºç»“æœ');
                    showMessage('æ‰«æå¯åŠ¨å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›ç©ºç»“æœ', 'error');
                    stopProgressPolling();
                    hideProgress();
                    if (stopBtn) {
                        stopBtn.disabled = true;
                    }
                    return;
                }
                
                if (result.success) {
                    console.log('[scanAllStocks] æ‰«æå¯åŠ¨æˆåŠŸï¼Œå¤„ç†å“åº”...');
                    window._scanJustCleared = false;  // æ–°æ‰«æå·²å¯åŠ¨ï¼Œå…è®¸è½®è¯¢å†™å…¥ç»“æœï¼ˆæ­¤å‰ä¸€ç›´å¿½ç•¥æ—§ progressï¼‰
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ Vercel åˆ†æ‰¹æ‰«ææ¨¡å¼
                    const scanId = result.scan_id;
                    const hasMore = result.has_more;
                    const totalBatches = result.total_batches;
                    
                    // âœ… ä¿å­˜å½“å‰æ‰«ææ¡ä»¶å’Œscan_idï¼ˆç”¨äºä¸‹æ¬¡æ¯”è¾ƒï¼‰
                    if (scanId && Object.keys(currentParams).length > 0) {
                        currentParams.scan_id = scanId;
                        saveLastScanParams(currentParams);
                        console.log('[scanAllStocks] âœ… å·²ä¿å­˜æ‰«ææ¡ä»¶å’Œscan_id:', { scan_id: scanId, params: currentParams });
                    }
                    
                    if (scanId && hasMore !== undefined) {
                        // Vercel åˆ†æ‰¹æ‰«ææ¨¡å¼
                        showMessage(`æ‰«æå·²å¼€å§‹ï¼ˆå…± ${totalBatches} æ‰¹ï¼‰ï¼Œæ­£åœ¨å¤„ç†ç¬¬ 1 æ‰¹...`, 'success');
                        
                        // ä¿å­˜ scan_id åˆ°å…¨å±€å˜é‡
                        window.currentScanId = scanId;
                        window.currentScanBatches = totalBatches;
                        window.currentScanBatch = 1;
                        
                        // æ‰«ææˆåŠŸå¯åŠ¨ï¼Œä¸é‡ç½® isScanningï¼ˆæ‰«ææ­£åœ¨è¿›è¡Œä¸­ï¼‰
                        // å¼€å§‹è‡ªåŠ¨å¤„ç†ä¸‹ä¸€æ‰¹æ¬¡
                        autoContinueScan(scanId, 1, totalBatches);
                    } else {
                        // æœ¬åœ°ç¯å¢ƒï¼šä¼ ç»Ÿè½®è¯¢æ¨¡å¼
                        showMessage('æ‰«æå·²å¼€å§‹ï¼Œè¯·ç­‰å¾…å®Œæˆ...', 'success');
                        // æ‰«ææˆåŠŸå¯åŠ¨ï¼Œä¸é‡ç½® isScanningï¼ˆæ‰«ææ­£åœ¨è¿›è¡Œä¸­ï¼‰
                        
                        // è½®è¯¢æ‰«æç»“æœï¼ˆç§»é™¤å›ºå®šè¶…æ—¶ï¼Œåªè¦æ‰«æåœ¨è¿›è¡Œä¸­å°±ç»§ç»­ç­‰å¾…ï¼‰
                        let checkCount = 0;
                        let lastProgressTime = Date.now(); // è®°å½•æœ€åè¿›åº¦æ›´æ–°æ—¶é—´
                        let noUpdateCount = 0; // è¿ç»­æœªæ›´æ–°æ¬¡æ•°
                        scanCheckInterval = setInterval(async () => {
                            checkCount++;
                            
                            try {
                                const progressResponse = await fetch('/api/get_progress', {
                                    cache: 'no-store',
                                    credentials: 'same-origin',
                                    headers: { 'Cache-Control': 'no-cache' }
                                });
                                if (progressResponse.status === 401) {
                                    clearInterval(scanCheckInterval);
                                    scanCheckInterval = null;
                                    stopProgressPolling();
                                    showMessage('ç™»å½•å·²è¿‡æœŸæˆ–æœåŠ¡å·²é‡å¯ï¼Œè¯·é‡æ–°ç™»å½•åé‡è¯•', 'error');
                                    if (typeof isScanning !== 'undefined') isScanning = false;
                                    if (stopBtn) stopBtn.disabled = true;
                                    return;
                                }
                                const progressResult = await progressResponse.json();
                                
                                if (progressResult.success && progressResult.progress) {
                                    const progress = progressResult.progress;
                                    try { updateLiveScanResults(progress); } catch (e) { console.warn('[scanCheckInterval] updateLiveScanResults:', e); }
                                    
                                    // âœ… å¦‚æœæ‰«æå®Œæˆï¼Œä¿å­˜scan_idï¼ˆç”¨äºä¸‹æ¬¡æ¯”è¾ƒï¼‰
                                    if (progress.status === 'å®Œæˆ' && progress.scan_id && Object.keys(currentParams).length > 0) {
                                        currentParams.scan_id = progress.scan_id;
                                        saveLastScanParams(currentParams);
                                        console.log('[scanAllStocks] âœ… æ‰«æå®Œæˆï¼Œå·²ä¿å­˜æ‰«ææ¡ä»¶å’Œscan_id');
                                    }
                                    
                                    // æ£€æŸ¥è¿›åº¦æ˜¯å¦é•¿æ—¶é—´æœªæ›´æ–°ï¼ˆå¯èƒ½å¡ä½äº†ï¼‰
                                    if (progress.last_update_time) {
                                        const timeSinceUpdate = (Date.now() / 1000) - progress.last_update_time;
                                        
                                        // å¦‚æœè¿›åº¦æœ‰æ›´æ–°ï¼Œé‡ç½®è®¡æ•°å™¨
                                        if (progress.percentage > 0 || progress.current > 0) {
                                            const currentProgress = progress.percentage || 0;
                                            const currentTime = Date.now();
                                            if (currentProgress > 0 || currentTime - lastProgressTime > 1000) {
                                                lastProgressTime = currentTime;
                                                noUpdateCount = 0; // é‡ç½®æœªæ›´æ–°è®¡æ•°
                                            }
                                        }
                                        
                                        // å¦‚æœè¶…è¿‡10åˆ†é’Ÿæœªæ›´æ–°ï¼Œæ‰è®¤ä¸ºå¯èƒ½å¡ä½äº†ï¼ˆå…¨å¸‚åœºæ‰«æéœ€è¦å¾ˆé•¿æ—¶é—´ï¼‰
                                        if (timeSinceUpdate > 600) {  // 10åˆ†é’Ÿæœªæ›´æ–°ï¼Œå¯èƒ½å¡ä½äº†
                                            noUpdateCount++;
                                            console.warn(`âš ï¸ è¿›åº¦å·² ${timeSinceUpdate.toFixed(0)} ç§’æœªæ›´æ–°ï¼Œå¯èƒ½å¡åœ¨: ${progress.current_stock || 'æœªçŸ¥è‚¡ç¥¨'}`);
                                            
                                            // å¦‚æœè¿ç»­5æ¬¡æ£€æŸ¥éƒ½è¶…è¿‡10åˆ†é’Ÿæœªæ›´æ–°ï¼Œæ‰çœŸæ­£è®¤ä¸ºå¡ä½äº†
                                            if (noUpdateCount >= 5) {
                                                clearInterval(scanCheckInterval);
                                                scanCheckInterval = null;
                                                stopProgressPolling();
                                                showMessage(`æ‰«æå¯èƒ½å·²å¡ä½ï¼ˆå·²è¶…è¿‡ ${Math.floor(timeSinceUpdate / 60)} åˆ†é’Ÿæœªæ›´æ–°ï¼‰ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æˆ–æ‰‹åŠ¨åœæ­¢æ‰«æ`, 'error');
                                                return;
                                            }
                                        } else {
                                            noUpdateCount = 0; // æœ‰æ›´æ–°ï¼Œé‡ç½®è®¡æ•°
                                        }
                                    }
                                    
                                    updateProgress(
                                        progress.percentage || 0,
                                        progress.status || 'è¿›è¡Œä¸­',
                                        progress.detail || 'æ‰«æä¸­...'
                                    );
                                    
                                    // å¦‚æœçŠ¶æ€æ˜¯"è¿›è¡Œä¸­"ï¼Œç»§ç»­ç­‰å¾…ï¼Œä¸è®¾ç½®è¶…æ—¶
                                    if (progress.status === 'è¿›è¡Œä¸­') {
                                        // ç»§ç»­ç­‰å¾…ï¼Œä¸è®¾ç½®è¶…æ—¶é™åˆ¶
                                        // æ¯100æ¬¡æ£€æŸ¥è¾“å‡ºä¸€æ¬¡æ—¥å¿—ï¼ˆçº¦100ç§’ï¼‰
                                        if (checkCount % 100 === 0) {
                                            console.log(`æ‰«æè¿›è¡Œä¸­... å·²æ£€æŸ¥ ${checkCount} æ¬¡ï¼Œå½“å‰è¿›åº¦: ${progress.percentage}%`);
                                        }
                                    } else if (progress.status === 'å®Œæˆ') {
                                        clearInterval(scanCheckInterval);
                                        scanCheckInterval = null;
                                        stopProgressPolling();
                                        if (stopBtn) stopBtn.disabled = true;
                                        if (typeof isScanning !== 'undefined') isScanning = false;
                                        // ã€ä¸å¯å˜ã€‘è¿‡ç¨‹ä¸æœ€åä¸€è‡´ï¼šæœ‰å®æ—¶ç¼“å­˜æ—¶åªä» _liveScanCandidateMap æ¸²æŸ“ï¼Œä¸è¦†ç›–
                                        const cached = window._liveScanCandidateMap ? Object.keys(window._liveScanCandidateMap).length : 0;
                                        if (cached > 0) {
                                            updateLiveScanResults(progress);
                                            const totalScanned = progress.current || progress.total || 0;
                                            showMessage(`æ‰«æå®Œæˆï¼å…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œæ‰¾åˆ° ${cached} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨`, 'success');
                                        } else {
                                            const resultsResponse = await fetch('/api/get_scan_results', { cache: 'no-store', credentials: 'same-origin' });
                                            const resultsResult = await resultsResponse.json();
                                            if (resultsResult.success) {
                                                await displayScanResults(resultsResult);
                                                const foundCount = resultsResult.found_count || 0;
                                                const totalScanned = resultsResult.total_scanned || 0;
                                                showMessage(foundCount > 0 ? `æ‰«æå®Œæˆï¼å…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ ${foundCount} åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶` : `æ‰«æå®Œæˆï¼å…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ 0 åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶`, foundCount > 0 ? 'success' : 'warning');
                                            } else {
                                                showMessage(`æ‰«æå®Œæˆï¼å…±æ‰«æ ${resultsResult.total_scanned || 0} åªè‚¡ç¥¨ï¼Œå…±æœ‰ 0 åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶ã€‚${resultsResult.message || ''}`, 'warning');
                                            }
                                        }
                                    } else if (progress.status === 'å¤±è´¥' || progress.status === 'å·²åœæ­¢') {
                                        clearInterval(scanCheckInterval);
                                        scanCheckInterval = null;
                                        stopProgressPolling();
                                        
                                        // ç¦ç”¨åœæ­¢æŒ‰é’®
                                        if (stopBtn) {
                                            stopBtn.disabled = true;
                                        }
                                        
                                        // é‡ç½®æ‰«ææ ‡å¿—
                                        if (typeof isScanning !== 'undefined') {
                                            isScanning = false;
                                        }
                                        
                                        if (progress.status === 'å·²åœæ­¢') {
                                            // ã€ä¸å¯å˜ã€‘è¿‡ç¨‹ä¸æœ€åä¸€è‡´ï¼šæœ‰å®æ—¶ç¼“å­˜æ—¶åªä» _liveScanCandidateMap æ¸²æŸ“ï¼Œä¸è¦†ç›–
                                            const cached = window._liveScanCandidateMap ? Object.keys(window._liveScanCandidateMap).length : 0;
                                            if (cached > 0) {
                                                updateLiveScanResults(progress);
                                                const totalScanned = progress.current || progress.total || 0;
                                                showMessage(`æ‰«æå·²åœæ­¢ï¼Œå…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ ${cached} åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶`, 'success');
                                            } else {
                                                try {
                                                    const resultsResponse = await fetch('/api/get_scan_results', { cache: 'no-store', credentials: 'same-origin' });
                                                    const resultsResult = await resultsResponse.json();
                                                    if (resultsResult.success) {
                                                        await displayScanResults(resultsResult);
                                                        const foundCount = resultsResult.found_count || resultsResult.candidates?.length || 0;
                                                        const totalScanned = resultsResult.total_scanned || 0;
                                                        showMessage(foundCount > 0 ? `æ‰«æå·²åœæ­¢ï¼Œå…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ ${foundCount} åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶` : `æ‰«æå·²åœæ­¢ï¼Œå…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ 0 åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶`, foundCount > 0 ? 'success' : 'warning');
                                                    } else {
                                                        showMessage(`æ‰«æå·²åœæ­¢ï¼Œå…±æ‰«æ ${resultsResult.total_scanned || 0} åªè‚¡ç¥¨ï¼Œå…±æœ‰ 0 åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶ã€‚${resultsResult.message || ''}`, 'warning');
                                                    }
                                                } catch (error) {
                                                    console.error('è·å–åœæ­¢åçš„æ‰«æç»“æœå¤±è´¥:', error);
                                                    showMessage('æ‰«æå·²åœæ­¢ï¼Œä½†è·å–ç»“æœæ—¶å‡ºé”™: ' + error.message, 'warning');
                                                }
                                            }
                                        } else {
                                            showMessage(progress.detail || 'æ‰«æå¤±è´¥', 'error');
                                        }
                                    }
                                } else {
                                    // å¦‚æœè·å–è¿›åº¦å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡é‡å¯äº†
                                    console.warn('æ— æ³•è·å–è¿›åº¦ä¿¡æ¯ï¼Œæ‰«æå¯èƒ½å·²åœæ­¢');
                                }
                            } catch (error) {
                                console.error('æ£€æŸ¥æ‰«æç»“æœå¤±è´¥:', error);
                                // å¦‚æœè¿ç»­å¤šæ¬¡å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡é—®é¢˜
                                if (checkCount > 10 && checkCount % 10 === 0) {
                                    console.warn(`âš ï¸ å·²è¿ç»­ ${checkCount} æ¬¡æ— æ³•è·å–è¿›åº¦ï¼Œæ‰«æå¯èƒ½å·²åœæ­¢`);
                                }
                            }
                        }, 1000); // æ¯1ç§’æ£€æŸ¥ä¸€æ¬¡
                    }
                } else {
                    // æ‰«æå¯åŠ¨å¤±è´¥
                    console.error('[scanAllStocks] æ‰«æå¯åŠ¨å¤±è´¥:', result);
                    const errorMsg = result.message || 'æœªçŸ¥é”™è¯¯';
                    showMessage('æ‰«æå¯åŠ¨å¤±è´¥: ' + errorMsg, 'error');
                    stopProgressPolling();
                    hideProgress();
                    if (stopBtn) {
                        stopBtn.disabled = true;
                    }
                    isScanning = false; // é‡ç½®æ ‡å¿—
                }
            } catch (error) {
                // è¯¦ç»†é”™è¯¯æ—¥å¿—
                isScanning = false; // é‡ç½®æ ‡å¿—
                const errorInfo = {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    toString: error.toString()
                };
                
                console.error('âŒ [scanAllStocks] æ‰«æè¿‡ç¨‹å‡ºé”™:', error);
                console.error('âŒ [scanAllStocks] é”™è¯¯è¯¦æƒ…:', errorInfo);
                console.error('âŒ [scanAllStocks] é”™è¯¯å¯¹è±¡:', error);
                
                // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ AbortErrorï¼ˆåº”è¯¥åœ¨æ˜¾ç¤ºé”™è¯¯ä¹‹å‰å¤„ç†ï¼‰
                if (error.name === 'AbortError' || error.message?.includes('aborted') || error.message?.includes('signal is aborted') || error.message?.includes('Failed to fetch')) {
                    // è¯·æ±‚è¶…æ—¶æˆ–è¢«ä¸­æ–­ï¼Œä½†æ‰«æå¯èƒ½å·²åœ¨åå°å¯åŠ¨
                    console.warn('[scanAllStocks] è¯·æ±‚è¢«ä¸­æ–­ï¼ˆAbortError/Failed to fetchï¼‰ï¼Œå¯èƒ½åŸå› ï¼š');
                    console.warn('  1. è¯·æ±‚è¶…æ—¶ï¼ˆ60ç§’ï¼‰- è¿™åœ¨Vercelç¯å¢ƒä¸­å¯èƒ½å‘ç”Ÿ');
                    console.warn('  2. ç½‘ç»œè¿æ¥ä¸­æ–­æˆ–ä¸ç¨³å®š');
                    console.warn('  3. ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡/æ ‡ç­¾é¡µå¯åŠ¨äº†æ‰«æ');
                    console.warn('[scanAllStocks] æ­£åœ¨æ£€æŸ¥æ‰«ææ˜¯å¦å·²åœ¨åå°å¯åŠ¨...');
                    
                    // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºæ¡†ï¼Œåªæ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
                    const existingErrorDiv = document.getElementById('scanErrorDisplay');
                    if (existingErrorDiv) {
                        existingErrorDiv.remove();
                    }
                    
                    showMessage('è¯·æ±‚å·²ä¸­æ–­ï¼Œä½†æ‰«æå¯èƒ½å·²åœ¨åå°å¯åŠ¨ã€‚è¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'warning');
                    // ä¸åœæ­¢è¿›åº¦è½®è¯¢ï¼Œå› ä¸ºæ‰«æå¯èƒ½åœ¨åå°ç»§ç»­
                    return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œåç»­çš„é”™è¯¯å¤„ç†
                }
                
                // å…¶ä»–é”™è¯¯æ‰æ˜¾ç¤ºé”™è¯¯æç¤ºæ¡†
                // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                const errorMsg = `æ‰«æå¯åŠ¨å¤±è´¥: ${error.name || 'æœªçŸ¥é”™è¯¯'}\né”™è¯¯ä¿¡æ¯: ${error.message || 'æ— è¯¦ç»†ä¿¡æ¯'}\n\nè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰è·å–æ›´å¤šè¯¦æƒ…`;
                showMessage(errorMsg, 'error');
                
                // åˆ›å»ºä¸€ä¸ªå¯è§çš„é”™è¯¯æ˜¾ç¤ºåŒºåŸŸ
                const errorDiv = document.createElement('div');
                errorDiv.id = 'scanErrorDisplay';
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #ff4444;
                    color: white;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 10000;
                    max-width: 400px;
                    font-family: monospace;
                    font-size: 12px;
                    line-height: 1.5;
                `;
                errorDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 10px; font-size: 14px;">âŒ æ‰«æé”™è¯¯</div>
                    <div><strong>é”™è¯¯ç±»å‹:</strong> ${error.name || 'æœªçŸ¥'}</div>
                    <div><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message || 'æ— è¯¦ç»†ä¿¡æ¯'}</div>
                    ${error.stack ? `<div style="margin-top: 10px; font-size: 11px; opacity: 0.9;"><strong>å †æ ˆ:</strong><br><pre style="white-space: pre-wrap; word-wrap: break-word;">${error.stack.substring(0, 500)}</pre></div>` : ''}
                    <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; background: white; color: #ff4444; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>
                `;
                document.body.appendChild(errorDiv);
                
                // 10ç§’åè‡ªåŠ¨ç§»é™¤é”™è¯¯æ˜¾ç¤º
                setTimeout(() => {
                    const errDiv = document.getElementById('scanErrorDisplay');
                    if (errDiv) {
                        errDiv.remove();
                    }
                }, 10000);
                
                // AbortError å·²ç»åœ¨ä¸Šé¢å¤„ç†å¹¶è¿”å›äº†ï¼Œè¿™é‡Œä¸ä¼šæ‰§è¡Œåˆ°ï¼ˆå·²åºŸå¼ƒçš„ä»£ç ï¼Œä¿ç•™ä½œä¸ºå‚è€ƒï¼‰
                if (false && error.name === 'AbortError') {
                    // è¯·æ±‚è¶…æ—¶æˆ–è¢«ä¸­æ–­ï¼Œä½†æ‰«æå¯èƒ½å·²åœ¨åå°å¯åŠ¨ï¼ˆæ­¤ä»£ç å·²è¢«ä¸Šé¢çš„å¤„ç†æ›¿æ¢ï¼‰
                    console.warn('[scanAllStocks] è¯·æ±‚è¢«ä¸­æ–­ï¼ˆAbortErrorï¼‰ï¼Œå¯èƒ½åŸå› ï¼š');
                    console.warn('  1. è¯·æ±‚è¶…æ—¶ï¼ˆ60ç§’ï¼‰- è¿™åœ¨Vercelç¯å¢ƒä¸­å¯èƒ½å‘ç”Ÿ');
                    console.warn('  2. ç½‘ç»œè¿æ¥ä¸­æ–­æˆ–ä¸ç¨³å®š');
                    console.warn('  3. ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡/æ ‡ç­¾é¡µå¯åŠ¨äº†æ‰«æ');
                    console.warn('[scanAllStocks] ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°ï¼Œæ‰«æå¯èƒ½åœ¨åå°ç»§ç»­...');
                    
                    // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºæ¡†ï¼Œåªæ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
                    const errorDiv = document.getElementById('scanErrorDisplay');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                    
                    showMessage('è¯·æ±‚å·²ä¸­æ–­ï¼Œä½†æ‰«æå¯èƒ½å·²åœ¨åå°å¯åŠ¨ã€‚è¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'warning');
                    // ä¸åœæ­¢è¿›åº¦è½®è¯¢ï¼Œå› ä¸ºæ‰«æå¯èƒ½åœ¨åå°ç»§ç»­
                    return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œåç»­çš„é”™è¯¯å¤„ç†
                } else {
                    // ç¦ç”¨åœæ­¢æŒ‰é’®
                    const stopBtn = document.getElementById('stopScanBtn');
                    if (stopBtn) {
                        stopBtn.disabled = true;
                    }
                    stopProgressPolling();
                    hideProgress();
                    console.error('[scanAllStocks] æ‰«æå¤±è´¥ï¼Œå·²åœæ­¢è¿›åº¦è½®è¯¢');
                }
            }
        }
        
        // æœç´¢åè½¬ä¸ªè‚¡ï¼ˆä¸Šå‘¨é˜´çº¿+æœ¬å‘¨é˜³çº¿ï¼‰
        async function scanReversalStocks() {
            console.log('scanReversalStocks å‡½æ•°è¢«è°ƒç”¨');
            
            // è·å–ç­›é€‰æ¡ä»¶
            const marketCapMaxInput = document.getElementById('reversalMarketCapMax');
            const marketCapMax = marketCapMaxInput ? parseFloat(marketCapMaxInput.value) : 100;
            
            if (isNaN(marketCapMax) || marketCapMax < 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æœ€å¤§å¸‚å€¼ï¼ˆâ‰¥0ï¼‰', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦æœç´¢ä¸Šå‘¨é˜´çº¿+æœ¬å‘¨é˜³çº¿çš„åè½¬ä¸ªè‚¡å—ï¼Ÿ\nç­›é€‰æ¡ä»¶ï¼šå¸‚å€¼ < ${marketCapMax}äº¿å…ƒ\nè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚`)) {
                console.log('ç”¨æˆ·å–æ¶ˆäº†æœç´¢');
                return;
            }
            
            console.log('å¼€å§‹æœç´¢åè½¬ä¸ªè‚¡...', { marketCapMax });
            showMessage(`å¼€å§‹æœç´¢åè½¬ä¸ªè‚¡ï¼ˆå¸‚å€¼ < ${marketCapMax}äº¿å…ƒï¼‰ï¼Œè¯·ç¨å€™...`, 'success');
            showProgress();
            updateProgress(0, 'å‡†å¤‡ä¸­', 'å¼€å§‹æœç´¢åè½¬ä¸ªè‚¡...');
            
            // å¯ç”¨åœæ­¢æŒ‰é’®
            const stopBtn = document.getElementById('stopScanBtn');
            if (stopBtn) {
                stopBtn.disabled = false;
            }
            
            try {
                console.log('å‘é€è¯·æ±‚åˆ° /api/scan_reversal_stocks');
                const controller = new AbortController();
                // åè½¬è‚¡ç¥¨æ‰«æä¹Ÿå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè®¾ç½®45ç§’è¶…æ—¶
                const timeoutId = setTimeout(() => {
                    console.warn('[scanReversalStocks] è¯·æ±‚è¶…æ—¶ï¼ˆ45ç§’ï¼‰ï¼Œä¸­æ–­è¯·æ±‚');
                    controller.abort();
                }, 45000);
                
                const response = await fetch('/api/scan_reversal_stocks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        market_cap_max: marketCapMax
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('æ”¶åˆ°å“åº”:', result);
                
                if (result.success) {
                    console.log('æœç´¢å·²å¯åŠ¨ï¼Œå¼€å§‹è½®è¯¢è¿›åº¦');
                    // å¼€å§‹è½®è¯¢è¿›åº¦
                    let reversalCheckInterval = setInterval(async () => {
                        try {
                            // è·å–è¿›åº¦
                            const progressResponse = await fetch('/api/get_scan_progress');
                            if (!progressResponse.ok) {
                                console.error('è·å–è¿›åº¦å¤±è´¥:', progressResponse.status);
                                return;
                            }
                            
                            const progress = await progressResponse.json();
                            console.log('è¿›åº¦æ›´æ–°:', progress);
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯åè½¬æ‰«æ
                            if (progress && progress.type === 'reversal_scan') {
                                updateProgress(
                                    progress.percentage || 0,
                                    progress.status || 'è¿›è¡Œä¸­',
                                    progress.detail || 'æœç´¢ä¸­...'
                                );
                                
                                if (progress.status === 'å®Œæˆ') {
                                    clearInterval(reversalCheckInterval);
                                    stopProgressPolling();
                                    
                                    // ç¦ç”¨åœæ­¢æŒ‰é’®
                                    if (stopBtn) {
                                        stopBtn.disabled = true;
                                    }
                                    
                                    // è·å–æ‰«æç»“æœ
                                    const resultsResponse = await fetch('/api/get_reversal_scan_results');
                                    const resultsResult = await resultsResponse.json();
                                    
                                    if (resultsResult.success && resultsResult.stocks) {
                                        displayReversalResults(resultsResult);
                                        showMessage(`æœç´¢å®Œæˆï¼æ‰¾åˆ° ${resultsResult.found_count || 0} åªåè½¬ä¸ªè‚¡`, 'success');
                                    } else {
                                        showMessage(resultsResult.message || 'æœç´¢å®Œæˆï¼Œä½†æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨', 'error');
                                    }
                                    } else if (progress.status === 'å¤±è´¥' || progress.status === 'å·²åœæ­¢') {
                                        clearInterval(reversalCheckInterval);
                                        stopProgressPolling();
                                        
                                        // ç¦ç”¨åœæ­¢æŒ‰é’®
                                        if (stopBtn) {
                                            stopBtn.disabled = true;
                                        }
                                        
                                        if (progress.status === 'å·²åœæ­¢') {
                                            // å·²åœæ­¢ï¼Œè·å–åè½¬æ‰«æç»“æœ
                                            const resultsResponse = await fetch('/api/get_reversal_scan_results');
                                            const resultsResult = await resultsResponse.json();
                                            
                                            if (resultsResult.success && resultsResult.stocks) {
                                                displayReversalResults(resultsResult);
                                                const foundCount = resultsResult.found_count || resultsResult.stocks.length || 0;
                                                const totalScanned = progress.total || 0;
                                                showMessage(`åè½¬æ‰«æå·²åœæ­¢ï¼Œå…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ ${foundCount} åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶ã€‚`, 'success');
                                            } else {
                                                const totalScanned = progress.total || 0;
                                                const current = progress.current || 0;
                                                showMessage(`åè½¬æ‰«æå·²åœæ­¢ï¼Œå…±æ‰«æ ${current}/${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ 0 åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶ã€‚`, 'warning');
                                            }
                                        } else {
                                            showMessage(progress.detail || 'æœç´¢å¤±è´¥', 'error');
                                        }
                                    }
                            }
                        } catch (error) {
                            console.error('æ£€æŸ¥åè½¬æ‰«æè¿›åº¦å¤±è´¥:', error);
                        }
                    }, 1000); // æ¯1ç§’æ£€æŸ¥ä¸€æ¬¡
                } else {
                    // ç¦ç”¨åœæ­¢æŒ‰é’®
                    if (stopBtn) {
                        stopBtn.disabled = true;
                    }
                    stopProgressPolling();
                    hideProgress();
                    showMessage(result.message || 'æœç´¢å¯åŠ¨å¤±è´¥', 'error');
                    console.error('æœç´¢å¯åŠ¨å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('æœç´¢åè½¬ä¸ªè‚¡å‡ºé”™:', error);
                if (error.name === 'AbortError') {
                    showMessage('è¯·æ±‚è¶…æ—¶ï¼Œä½†æœç´¢å¯èƒ½å·²åœ¨åå°å¯åŠ¨ï¼Œè¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'warning');
                } else {
                    // ç¦ç”¨åœæ­¢æŒ‰é’®
                    if (stopBtn) {
                        stopBtn.disabled = true;
                    }
                    stopProgressPolling();
                    hideProgress();
                    console.error('æœç´¢å¤±è´¥:', error);
                    showMessage('æœç´¢å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
                }
            }
        }
        
        // ==================== KDJæ¨¡å¼æ‰«æ ====================
        
        // KDJæ¨¡å¼æ‰«æ
        let kdjScanInterval = null;
        
        async function scanKdjStocks() {
            console.log('scanKdjStocks å‡½æ•°è¢«è°ƒç”¨');
            
            // è·å–ç­›é€‰æ¡ä»¶
            const thresholdInput = document.getElementById('kdjThreshold');
            const limitInput = document.getElementById('kdjLimit');
            const threshold = thresholdInput ? parseFloat(thresholdInput.value) : 20;
            const limit = limitInput ? parseInt(limitInput.value) : 50;
            
            if (isNaN(threshold) || threshold < 0 || threshold > 100) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„KDJé˜ˆå€¼ï¼ˆ0-100ï¼‰', 'error');
                return;
            }
            
            console.log('å¼€å§‹KDJæ¨¡å¼æ‰«æ...', { threshold, limit });
            showMessage(`å¼€å§‹KDJæ¨¡å¼æ‰«æï¼ˆé˜ˆå€¼ < ${threshold}ï¼‰ï¼Œè¯·ç¨å€™...`, 'success');
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            showProgress();
            updateProgress(0, 'åˆå§‹åŒ–', 'å‡†å¤‡å¼€å§‹KDJæ‰«æ...');
            
            // ç¦ç”¨æ‰«ææŒ‰é’®ï¼Œå¯ç”¨åœæ­¢æŒ‰é’®
            const scanBtn = document.getElementById('scanKdjBtn');
            const stopBtn = document.getElementById('stopKdjBtn');
            if (scanBtn) {
                scanBtn.disabled = true;
                scanBtn.textContent = 'â³ æ‰«æä¸­...';
            }
            if (stopBtn) {
                stopBtn.disabled = false;
            }
            
            try {
                console.log('å‘é€è¯·æ±‚åˆ° /api/scan_kdj');
                const response = await fetch('/api/scan_kdj', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        threshold: threshold,
                        limit: limit
                    })
                });
                
                const result = await response.json();
                console.log('KDJæ‰«æå¯åŠ¨ç»“æœ:', result);
                
                if (result.success) {
                    // å¼€å§‹è½®è¯¢è¿›åº¦
                    startKdjProgressPolling();
                } else {
                    showMessage(result.message || 'KDJæ‰«æå¯åŠ¨å¤±è´¥', 'error');
                    resetKdjScanButtons();
                    hideProgress();
                }
            } catch (error) {
                console.error('KDJæ‰«æå¯åŠ¨å‡ºé”™:', error);
                showMessage('KDJæ‰«æå¯åŠ¨å‡ºé”™: ' + error.message, 'error');
                resetKdjScanButtons();
                hideProgress();
            }
        }
        
        // å¯åŠ¨KDJè¿›åº¦è½®è¯¢
        function startKdjProgressPolling() {
            if (kdjScanInterval) {
                clearInterval(kdjScanInterval);
            }
            
            kdjScanInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/get_kdj_scan_progress');
                    const progress = await response.json();
                    
                    if (progress.success) {
                        // æ›´æ–°è¿›åº¦æ¡
                        updateProgress(
                            progress.percentage || 0,
                            progress.status === 'running' ? 'æ‰«æä¸­' : progress.status,
                            `${progress.message || ''} (å·²æ‰«æ: ${progress.processed}/${progress.total}, æ‰¾åˆ°: ${progress.found} åª)`
                        );
                        
                        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                        if (progress.status === 'completed' || progress.status === 'stopped') {
                            clearInterval(kdjScanInterval);
                            kdjScanInterval = null;
                            
                            // è·å–æœ€ç»ˆç»“æœ
                            const resultsResponse = await fetch('/api/get_kdj_scan_results');
                            const results = await resultsResponse.json();
                            
                            if (results.success) {
                                displayKdjResults(results);
                                showMessage(results.message || `æ‰¾åˆ° ${results.count} åªç¬¦åˆæ¡ä»¶çš„ä¸ªè‚¡`, 'success');
                            }
                            
                            resetKdjScanButtons();
                            hideProgress();
                        }
                    }
                } catch (error) {
                    console.error('è·å–KDJè¿›åº¦å‡ºé”™:', error);
                }
            }, 1000);  // æ¯ç§’æ›´æ–°ä¸€æ¬¡
        }
        
        // åœæ­¢KDJæ‰«æ
        async function stopKdjScan() {
            try {
                const response = await fetch('/api/stop_kdj_scan', { method: 'POST' });
                const result = await response.json();
                console.log('åœæ­¢KDJæ‰«æç»“æœ:', result);
                showMessage('æ­£åœ¨åœæ­¢KDJæ‰«æ...', 'warning');
            } catch (error) {
                console.error('åœæ­¢KDJæ‰«æå‡ºé”™:', error);
            }
        }
        
        // é‡ç½®KDJæ‰«ææŒ‰é’®çŠ¶æ€
        function resetKdjScanButtons() {
            const scanBtn = document.getElementById('scanKdjBtn');
            const stopBtn = document.getElementById('stopKdjBtn');
            if (scanBtn) {
                scanBtn.disabled = false;
                scanBtn.textContent = 'ğŸ” å¼€å§‹KDJæ‰«æ';
            }
            if (stopBtn) {
                stopBtn.disabled = true;
            }
        }
        
        // æ˜¾ç¤ºKDJæ‰«æç»“æœ
        function displayKdjResults(result) {
            const container = document.getElementById('kdjResults');
            container.style.display = 'block';
            
            if (!result.data || result.data.length === 0) {
                container.innerHTML = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; color: #999;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¸ªè‚¡ï¼ˆæ—¥/å‘¨/æœˆKDJéƒ½åœ¨é˜ˆå€¼ä»¥ä¸‹ï¼‰</div>';
                return;
            }
            
            let html = '<div style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += `<h3 style="margin-bottom: 15px; color: #333;">ğŸ“Š KDJæ¨¡å¼æ‰«æç»“æœï¼ˆæ‰¾åˆ° ${result.count} åªï¼‰</h3>`;
            
            // æ˜¾ç¤ºç­›é€‰æ¡ä»¶
            html += '<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #e74c3c;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">ğŸ“‹ ç­›é€‰æ¡ä»¶ï¼š</h4>';
            html += '<ul style="margin: 0; padding-left: 20px; color: #555; font-size: 13px; line-height: 1.8;">';
            html += '<li>âœ… KDJå‚æ•°: 9, 3, 3</li>';
            html += `<li>âœ… æ—¥KDJ: K < ${result.threshold}, D < ${result.threshold}, J < ${result.threshold}</li>`;
            html += `<li>âœ… å‘¨KDJ: K < ${result.threshold}, D < ${result.threshold}, J < ${result.threshold}</li>`;
            html += `<li>âœ… æœˆKDJ: K < ${result.threshold}, D < ${result.threshold}, J < ${result.threshold}</li>`;
            html += '</ul>';
            html += '<p style="margin: 10px 0 0 0; color: #888; font-size: 12px;">ğŸ’¡ æç¤º: KDJå€¼è¶Šä½è¡¨ç¤ºè¶Šè¶…å–ï¼Œå¯èƒ½å­˜åœ¨åå¼¹æœºä¼š</p>';
            html += '</div>';
            
            // åˆ›å»ºè¡¨æ ¼
            html += '<div style="overflow-x: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 1200px;">';
            html += '<thead><tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">æ’å</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">è‚¡ç¥¨ä»£ç </th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">è‚¡ç¥¨åç§°</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">å½“å‰ä»·æ ¼</th>';
            html += '<th style="padding: 10px; text-align: center; border: 1px solid #dee2e6;" colspan="3">æ—¥KDJ</th>';
            html += '<th style="padding: 10px; text-align: center; border: 1px solid #dee2e6;" colspan="3">å‘¨KDJ</th>';
            html += '<th style="padding: 10px; text-align: center; border: 1px solid #dee2e6;" colspan="3">æœˆKDJ</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">KDJå¹³å‡</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">æ“ä½œ</th>';
            html += '</tr>';
            html += '<tr style="background: #f0f0f0;">';
            html += '<th style="padding: 5px; border: 1px solid #dee2e6;"></th>';
            html += '<th style="padding: 5px; border: 1px solid #dee2e6;"></th>';
            html += '<th style="padding: 5px; border: 1px solid #dee2e6;"></th>';
            html += '<th style="padding: 5px; border: 1px solid #dee2e6;"></th>';
            html += '<th style="padding: 5px; text-align: center; border: 1px solid #dee2e6; font-size: 12px; color: #666;">K</th>';
            html += '<th style="padding: 5px; text-align: center; border: 1px solid #dee2e6; font-size: 12px; color: #666;">D</th>';
            html += '<th style="padding: 5px; text-align: center; border: 1px solid #dee2e6; font-size: 12px; color: #666;">J</th>';
            html += '<th style="padding: 5px; text-align: center; border: 1px solid #dee2e6; font-size: 12px; color: #666;">K</th>';
            html += '<th style="padding: 5px; text-align: center; border: 1px solid #dee2e6; font-size: 12px; color: #666;">D</th>';
            html += '<th style="padding: 5px; text-align: center; border: 1px solid #dee2e6; font-size: 12px; color: #666;">J</th>';
            html += '<th style="padding: 5px; text-align: center; border: 1px solid #dee2e6; font-size: 12px; color: #666;">K</th>';
            html += '<th style="padding: 5px; text-align: center; border: 1px solid #dee2e6; font-size: 12px; color: #666;">D</th>';
            html += '<th style="padding: 5px; text-align: center; border: 1px solid #dee2e6; font-size: 12px; color: #666;">J</th>';
            html += '<th style="padding: 5px; border: 1px solid #dee2e6;"></th>';
            html += '<th style="padding: 5px; border: 1px solid #dee2e6;"></th>';
            html += '</tr></thead><tbody>';
            
            result.data.forEach((stock, index) => {
                // æ ¹æ®Jå€¼å†³å®šé¢œè‰²ï¼ˆJå€¼è¶Šä½è¶Šè¶…å–ï¼‰
                const getColor = (val) => {
                    if (val < 0) return '#c0392b';  // æ·±çº¢è‰²ï¼ˆæåº¦è¶…å–ï¼‰
                    if (val < 10) return '#e74c3c'; // çº¢è‰²ï¼ˆå¼ºè¶…å–ï¼‰
                    return '#e67e22';  // æ©™è‰²ï¼ˆè¶…å–ï¼‰
                };
                
                html += '<tr style="border-bottom: 1px solid #dee2e6;">';
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold; color: #9b59b6;">${index + 1}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><a href="#" onclick="showWeeklyKline('${stock['è‚¡ç¥¨ä»£ç ']}', '${stock['è‚¡ç¥¨åç§°']}'); return false;" style="color: #3498db; text-decoration: none;">${stock['è‚¡ç¥¨ä»£ç ']}</a></td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['è‚¡ç¥¨åç§°']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['å½“å‰ä»·æ ¼']} å…ƒ</td>`;
                
                // æ—¥KDJ
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${getColor(stock['æ—¥K'])};">${stock['æ—¥K']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${getColor(stock['æ—¥D'])};">${stock['æ—¥D']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${getColor(stock['æ—¥J'])};">${stock['æ—¥J']}</td>`;
                
                // å‘¨KDJ
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${getColor(stock['å‘¨K'])};">${stock['å‘¨K']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${getColor(stock['å‘¨D'])};">${stock['å‘¨D']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${getColor(stock['å‘¨J'])};">${stock['å‘¨J']}</td>`;
                
                // æœˆKDJ
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${getColor(stock['æœˆK'])};">${stock['æœˆK']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${getColor(stock['æœˆD'])};">${stock['æœˆD']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; color: ${getColor(stock['æœˆJ'])};">${stock['æœˆJ']}</td>`;
                
                // KDJå¹³å‡
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: bold; color: ${getColor(stock['KDJå¹³å‡'])};">${stock['KDJå¹³å‡']}</td>`;
                
                // æ“ä½œ
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">`;
                html += `<button class="btn btn-sm" onclick="showWeeklyKline('${stock['è‚¡ç¥¨ä»£ç ']}', '${stock['è‚¡ç¥¨åç§°']}')" style="background: #9b59b6; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">å‘¨Kçº¿</button>`;
                html += `<button class="btn btn-sm" onclick="findBuyPoints('${stock['è‚¡ç¥¨ä»£ç ']}')" style="background: #3498db; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">æ‰¾ä¹°ç‚¹</button>`;
                html += `</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += '</div>';
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // æ˜¾ç¤ºåè½¬ä¸ªè‚¡æ‰«æç»“æœ
        function displayReversalResults(result) {
            const container = document.getElementById('reversalResults');
            container.style.display = 'block';
            
            if (!result.stocks || result.stocks.length === 0) {
                container.innerHTML = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; color: #999;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åè½¬ä¸ªè‚¡</div>';
                return;
            }
            
            let html = '<div style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += `<h3 style="margin-bottom: 15px; color: #333;">ğŸ“ˆ åè½¬ä¸ªè‚¡æœç´¢ç»“æœï¼ˆæ‰¾åˆ° ${result.found_count || result.stocks.length} åªï¼‰</h3>`;
            
            // æ˜¾ç¤ºç­›é€‰æ¡ä»¶
            const marketCapMax = result.market_cap_max || 100;
            html += '<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #9b59b6;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">ğŸ“‹ ç­›é€‰æ¡ä»¶ï¼š</h4>';
            html += '<ul style="margin: 0; padding-left: 20px; color: #555; font-size: 13px; line-height: 1.8;">';
            html += '<li>âœ… ä¸Šå‘¨æ˜¯é˜´çº¿ï¼ˆæ”¶ç›˜ä»· < å¼€ç›˜ä»·ï¼‰</li>';
            html += '<li>âœ… æœ¬å‘¨æ˜¯é˜³çº¿ï¼ˆæ”¶ç›˜ä»· > å¼€ç›˜ä»·ï¼‰</li>';
            html += '<li>âœ… æœ¬å‘¨æ­¢è·Œï¼ˆæœ¬å‘¨æ”¶ç›˜ä»· â‰¥ ä¸Šå‘¨æ”¶ç›˜ä»·ï¼Œæˆ–æœ¬å‘¨æ¶¨å¹… > 0ï¼‰</li>';
            html += '<li>âœ… è‚¡ä»·åœ¨5å‘¨å‡çº¿ä¹‹ä¸Šï¼ˆå½“å‰ä»·æ ¼ > MA5ï¼‰</li>';
            html += `<li>âœ… å¸‚å€¼ < ${marketCapMax}äº¿å…ƒ</li>`;
            html += '</ul>';
            html += '</div>';
            
            // åˆ›å»ºè¡¨æ ¼
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">è‚¡ç¥¨ä»£ç </th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">è‚¡ç¥¨åç§°</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">ä¸Šå‘¨æ—¥æœŸ</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">ä¸Šå‘¨æ¶¨è·Œå¹…</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">æœ¬å‘¨æ—¥æœŸ</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">æœ¬å‘¨æ¶¨è·Œå¹…</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">å½“å‰ä»·æ ¼</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">5å‘¨å‡çº¿</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">ä»·æ ¼ç›¸å¯¹MA5</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">å¸‚å€¼(äº¿)</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">æ“ä½œ</th>';
            html += '</tr></thead><tbody>';
            
            result.stocks.forEach(stock => {
                const lastWeekChange = parseFloat(stock['ä¸Šå‘¨æ¶¨è·Œå¹…']) || 0;
                const thisWeekChange = parseFloat(stock['æœ¬å‘¨æ¶¨è·Œå¹…']) || 0;
                const lastWeekColor = lastWeekChange >= 0 ? '#e74c3c' : '#27ae60';
                const thisWeekColor = thisWeekChange >= 0 ? '#e74c3c' : '#27ae60';
                
                const ma5 = parseFloat(stock['5å‘¨å‡çº¿']) || 0;
                const priceToMa5 = parseFloat(stock['ä»·æ ¼ç›¸å¯¹MA5']) || 0;
                const priceToMa5Color = priceToMa5 >= 0 ? '#e74c3c' : '#27ae60';
                
                html += '<tr style="border-bottom: 1px solid #dee2e6;">';
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['è‚¡ç¥¨ä»£ç ']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['è‚¡ç¥¨åç§°']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['ä¸Šå‘¨æ—¥æœŸ']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; color: ${lastWeekColor};">${lastWeekChange.toFixed(2)}%</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['æœ¬å‘¨æ—¥æœŸ']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; color: ${thisWeekColor};">${thisWeekChange.toFixed(2)}%</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['å½“å‰ä»·æ ¼'].toFixed(2)} å…ƒ</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${ma5.toFixed(2)} å…ƒ</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; color: ${priceToMa5Color};">${priceToMa5 >= 0 ? '+' : ''}${priceToMa5.toFixed(2)}%</td>`;
                const marketCap = stock['å¸‚å€¼'] !== null && stock['å¸‚å€¼'] !== undefined ? stock['å¸‚å€¼'].toFixed(2) : 'N/A';
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${marketCap}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><button class="btn btn-sm" onclick="showWeeklyKline('${stock['è‚¡ç¥¨ä»£ç ']}', '${stock['è‚¡ç¥¨åç§°']}')" style="background: #9b59b6; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">å‘¨Kçº¿</button><button class="btn btn-sm" onclick="findBuyPoints('${stock['è‚¡ç¥¨ä»£ç ']}')" style="background: #3498db; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">æ‰¾ä¹°ç‚¹</button></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // æ˜¾ç¤ºå‘¨Kçº¿å›¾
        let weeklyKlineChart = null;
        async function showWeeklyKline(stockCode, stockName) {
            const modal = document.getElementById('weeklyKlineModal');
            const title = document.getElementById('weeklyKlineTitle');
            const chartDiv = document.getElementById('weeklyKlineChart');
            
            title.textContent = `${stockCode} ${stockName} - å‘¨Kçº¿å›¾`;
            modal.style.display = 'block';
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            chartDiv.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">æ­£åœ¨åŠ è½½å‘¨Kçº¿æ•°æ®...</div>';
            
            try {
                const response = await fetch('/api/get_weekly_kline_for_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: stockCode })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    chartDiv.innerHTML = `<div style="text-align: center; padding: 50px; color: #e74c3c;">${data.error}</div>`;
                    return;
                }
                
                // æ£€æŸ¥ ECharts æ˜¯å¦å·²åŠ è½½
                if (typeof echarts === 'undefined') {
                    chartDiv.innerHTML = '<div style="text-align: center; padding: 50px; color: #ff4444;">âš ï¸ EChartsåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
                    return;
                }
                
                // ç»˜åˆ¶Kçº¿å›¾
                if (weeklyKlineChart) {
                    weeklyKlineChart.dispose();
                }
                // ç¡®ä¿å®¹å™¨æœ‰å°ºå¯¸
                chartDiv.style.width = '100%';
                chartDiv.style.height = '600px';
                weeklyKlineChart = echarts.init(chartDiv);
                
                // å‡†å¤‡Kçº¿æ•°æ®ï¼ˆECharts candlestickæ ¼å¼ï¼š[å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]ï¼‰
                const klineData = data.kline.map((k) => [k[0], k[1], k[2], k[3]]);  // [å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]
                
                // ç¡®ä¿å‡çº¿æ•°æ®é•¿åº¦ä¸Kçº¿æ•°æ®ä¸€è‡´ï¼Œå°†nullå€¼å¤„ç†ä¸ºundefinedï¼ˆEChartsä¼šè·³è¿‡undefinedï¼‰
                const ma5Data = data.ma5.map(v => v === null ? undefined : v);
                const ma10Data = data.ma10.map(v => v === null ? undefined : v);
                const ma20Data = data.ma20.map(v => v === null ? undefined : v);
                const ma60Data = data.ma60.map(v => v === null ? undefined : v);
                
                console.log('Kçº¿æ•°æ®:', klineData.slice(0, 5));  // è°ƒè¯•ï¼šæ˜¾ç¤ºå‰5æ¡æ•°æ®
                console.log('æ—¥æœŸæ•°æ®:', data.dates.slice(0, 5));  // è°ƒè¯•ï¼šæ˜¾ç¤ºå‰5ä¸ªæ—¥æœŸ
                console.log('MA5æ•°æ®:', ma5Data.slice(0, 5));  // è°ƒè¯•ï¼šæ˜¾ç¤ºå‰5æ¡MA5æ•°æ®
                
                const option = {
                    title: {
                        text: `${data.name} (${data.code}) å‘¨Kçº¿å›¾`,
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    legend: {
                        data: ['Kçº¿', 'MA5', 'MA10', 'MA20', 'MA60', 'æˆäº¤é‡'],
                        top: 30
                    },
                    grid: [
                        {
                            left: '10%',
                            right: '8%',
                            top: '15%',
                            height: '50%'
                        },
                        {
                            left: '10%',
                            right: '8%',
                            top: '70%',
                            height: '15%'
                        }
                    ],
                    xAxis: [
                        {
                            type: 'category',
                            data: data.dates,
                            scale: true,
                            boundaryGap: false,
                            axisLine: { onZero: false },
                            splitLine: { show: false },
                            min: 'dataMin',
                            max: 'dataMax'
                        },
                        {
                            type: 'category',
                            gridIndex: 1,
                            data: data.dates,
                            scale: true,
                            boundaryGap: false,
                            axisLine: { onZero: false },
                            axisTick: { show: false },
                            splitLine: { show: false },
                            min: 'dataMin',
                            max: 'dataMax'
                        }
                    ],
                    yAxis: [
                        {
                            scale: true,
                            splitArea: {
                                show: true
                            }
                        },
                        {
                            scale: true,
                            gridIndex: 1,
                            splitNumber: 2,
                            axisLabel: { show: false },
                            axisLine: { show: false },
                            axisTick: { show: false },
                            splitLine: { show: false }
                        }
                    ],
                    dataZoom: [
                        {
                            type: 'inside',
                            xAxisIndex: [0, 1],
                            start: 80,
                            end: 100
                        },
                        {
                            show: true,
                            xAxisIndex: [0, 1],
                            type: 'slider',
                            top: '90%',
                            start: 80,
                            end: 100
                        }
                    ],
                    series: [
                        {
                            name: 'Kçº¿',
                            type: 'candlestick',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: klineData,
                            itemStyle: {
                                // ä¸­å›½Kçº¿ä¹ æƒ¯ï¼šä¸Šæ¶¨ç”¨çº¢è‰²å®ä½“ï¼Œä¸‹è·Œç”¨ç»¿è‰²å®ä½“
                                color: '#ff4444',  // ä¸Šæ¶¨ï¼šçº¢è‰²å®ä½“ï¼ˆæ”¶ç›˜ä»· > å¼€ç›˜ä»·ï¼‰
                                color0: '#00aa00', // ä¸‹è·Œï¼šç»¿è‰²å®ä½“ï¼ˆæ”¶ç›˜ä»· < å¼€ç›˜ä»·ï¼‰
                                borderColor: '#ff4444',  // ä¸Šæ¶¨ï¼šçº¢è‰²è¾¹æ¡†
                                borderColor0: '#00aa00'  // ä¸‹è·Œï¼šç»¿è‰²è¾¹æ¡†
                            },
                            emphasis: {
                                itemStyle: {
                                    borderWidth: 2
                                }
                            }
                        },
                        {
                            name: 'MA5',
                            type: 'line',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: ma5Data,
                            smooth: false,
                            lineStyle: { width: 2, color: '#ff7f00' },
                            showSymbol: false,
                            connectNulls: false
                        },
                        {
                            name: 'MA10',
                            type: 'line',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: ma10Data,
                            smooth: false,
                            lineStyle: { width: 2, color: '#00ff00' },
                            showSymbol: false,
                            connectNulls: false
                        },
                        {
                            name: 'MA20',
                            type: 'line',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: ma20Data,
                            smooth: false,
                            lineStyle: { width: 2, color: '#0000ff' },
                            showSymbol: false,
                            connectNulls: false
                        },
                        {
                            name: 'MA60',
                            type: 'line',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: ma60Data,
                            smooth: false,
                            lineStyle: { width: 2, color: '#ff00ff' },
                            showSymbol: false,
                            connectNulls: false
                        },
                        {
                            name: 'æˆäº¤é‡',
                            type: 'bar',
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            data: data.volumes,
                            itemStyle: {
                                // æˆäº¤é‡é¢œè‰²ï¼šä¸Šæ¶¨ç”¨çº¢è‰²ï¼Œä¸‹è·Œç”¨ç»¿è‰²ï¼ˆç¬¦åˆä¸­å›½Kçº¿ä¹ æƒ¯ï¼‰
                                color: function(params) {
                                    const k = data.kline[params.dataIndex];
                                    // k[0]æ˜¯å¼€ç›˜ä»·ï¼Œk[1]æ˜¯æ”¶ç›˜ä»·
                                    return k[1] >= k[0] ? '#ff4444' : '#00aa00';
                                }
                            }
                        }
                    ]
                };
                
                try {
                    weeklyKlineChart.setOption(option, true);  // notMerge=trueï¼Œå®Œå…¨æ›¿æ¢é…ç½®
                    console.log('Kçº¿å›¾é…ç½®å·²è®¾ç½®');
                    
                    // ç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“
                    setTimeout(() => {
                        if (weeklyKlineChart) {
                            weeklyKlineChart.resize();
                            console.log('Kçº¿å›¾å·²è°ƒæ•´å°ºå¯¸');
                        }
                    }, 200);
                } catch (chartError) {
                    console.error('è®¾ç½®Kçº¿å›¾é…ç½®å¤±è´¥:', chartError);
                    chartDiv.innerHTML = `<div style="text-align: center; padding: 50px; color: #e74c3c;">å›¾è¡¨æ¸²æŸ“å¤±è´¥: ${chartError.message}</div>`;
                    return;
                }
                
                // å“åº”å¼è°ƒæ•´
                window.addEventListener('resize', function() {
                    if (weeklyKlineChart) {
                        weeklyKlineChart.resize();
                    }
                });
                
            } catch (error) {
                console.error('åŠ è½½å‘¨Kçº¿æ•°æ®å¤±è´¥:', error);
                chartDiv.innerHTML = `<div style="text-align: center; padding: 50px; color: #e74c3c;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function closeWeeklyKline() {
            const modal = document.getElementById('weeklyKlineModal');
            modal.style.display = 'none';
            if (weeklyKlineChart) {
                weeklyKlineChart.dispose();
                weeklyKlineChart = null;
            }
        }
        
        // æ˜¾ç¤ºæ‰«æç»“æœ
        async function displayScanResults(result) {
            const container = document.getElementById('buyPointsResult');
            
            // âœ… å¦‚æœæ˜¾ç¤ºç»“æœæ—¶ï¼Œä¿å­˜scan_idï¼ˆä»resultæˆ–å…¨å±€å˜é‡è·å–ï¼‰
            const scanId = result.scan_id || window.currentScanId;
            if (scanId) {
                const lastParams = getLastScanParams();
                if (lastParams) {
                    lastParams.scan_id = scanId;
                    saveLastScanParams(lastParams);
                    console.log('[displayScanResults] âœ… å·²ä¿å­˜scan_id:', scanId);
                }
            }
            
            // è·å–æ‰«ææ€»æ•°å’Œæ‰¾åˆ°çš„æ•°é‡
            const totalScanned = result.total_scanned || 0;
            const foundCount = result.found_count || 0;
            let candidates = result.candidates || [];
            
            // âœ… å…³é”®ä¿®å¤ï¼šå¦‚æœ candidates ä¸ºç©ºï¼Œä½† foundCount > 0ï¼Œæ£€æŸ¥å®æ—¶ç¼“å­˜
            if ((!candidates || candidates.length === 0) && foundCount > 0) {
                console.log('[displayScanResults] candidatesä¸ºç©ºä½†foundCount>0ï¼Œæ£€æŸ¥å®æ—¶ç¼“å­˜...');
                if (window._liveScanCandidateMap && Object.keys(window._liveScanCandidateMap).length > 0) {
                    candidates = Object.values(window._liveScanCandidateMap);
                    candidates.sort((a, b) => (b.åŒ¹é…åº¦ || b.match_score || 0) - (a.åŒ¹é…åº¦ || a.match_score || 0));
                    console.log(`[displayScanResults] âœ… ä»å®æ—¶ç¼“å­˜æ¢å¤ ${candidates.length} åªè‚¡ç¥¨`);
                } else {
                    // å¦‚æœç¼“å­˜ä¹Ÿä¸ºç©ºï¼Œå°è¯•ä»åç«¯è·å–
                    console.log('[displayScanResults] å®æ—¶ç¼“å­˜ä¹Ÿä¸ºç©ºï¼Œå°è¯•ä»åç«¯è·å–...');
                    try {
                        const response = await fetch('/api/get_scan_results', { cache: 'no-store' });
                        if (response.ok) {
                            const backendResult = await response.json();
                            if (backendResult.success && backendResult.candidates && backendResult.candidates.length > 0) {
                                candidates = backendResult.candidates;
                                console.log(`[displayScanResults] âœ… ä»åç«¯è·å– ${candidates.length} åªè‚¡ç¥¨`);
                            }
                        }
                    } catch (e) {
                        console.warn('[displayScanResults] ä»åç«¯è·å–å¤±è´¥:', e);
                    }
                }
            }
            
            // å³ä½¿æ²¡æ‰¾åˆ°è‚¡ç¥¨ï¼Œä¹Ÿæ˜¾ç¤ºç»“æœæç¤º
            if (!candidates || candidates.length === 0) {
                const noResultHtml = `
                    <div style="margin-top: 15px; padding: 20px; background: white; border-radius: 6px; text-align: center;">
                        <div style="font-size: 16px; color: #e74c3c; margin-bottom: 10px;">âŒ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</div>
                        <div style="font-size: 14px; color: #666; margin-top: 10px;">
                            å…±æ‰«æ <strong style="color: #667eea;">${totalScanned}</strong> åªè‚¡ç¥¨ï¼Œå…±æœ‰ <strong style="color: #e74c3c;">0</strong> åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 10px;">
                            æç¤ºï¼šå¯ä»¥å°è¯•é™ä½åŒ¹é…åº¦é˜ˆå€¼æˆ–è°ƒæ•´å…¶ä»–æ‰«æå‚æ•°
                        </div>
                    </div>
                `;
                container.innerHTML = noResultHtml;
                return;
            }
            
            // æŒ‰åŒ¹é…åº¦ä»é«˜åˆ°ä½æ’åºï¼Œå‰ç«¯æœ€å¤šå±•ç¤º 30 åªï¼›è¶…è¿‡ 30 åªæ—¶ï¼ŒåŒ¹é…åº¦æœ€ä½çš„ä¸ä¼šå‡ºç°åœ¨åˆ—è¡¨ä¸­
            candidates.sort((a, b) => (b.åŒ¹é…åº¦ || b.match_score || 0) - (a.åŒ¹é…åº¦ || a.match_score || 0));
            const displayCandidates = candidates.slice(0, 30);
            
            // æ£€æŸ¥ç”¨æˆ·ç­‰çº§ï¼ˆVIPç”¨æˆ·æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®ï¼‰
            let exportButtons = '';
            try {
                const user = await getUserInfo();
                if (user && (user.tier === 'premium' || user.tier === 'super' || user.is_super)) {
                    // ä¿å­˜ç»“æœåˆ°å…¨å±€å˜é‡ï¼Œä¾›å¯¼å‡ºå‡½æ•°ä½¿ç”¨
                    window.currentScanResults = result;
                    const candidatesJson = JSON.stringify(result.candidates).replace(/'/g, "\\'");
                    exportButtons = `
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <span style="color: #666; font-size: 13px; font-weight: bold;">ğŸ’ VIPä¸“äº«åŠŸèƒ½ï¼š</span>
                            <button class="btn btn-primary" onclick="exportScanResults('excel')" style="background: #27ae60; font-size: 13px; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">
                                ğŸ“¥ å¯¼å‡ºExcel
                            </button>
                            <button class="btn btn-primary" onclick="exportScanResults('csv')" style="background: #3498db; font-size: 13px; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">
                                ğŸ“¥ å¯¼å‡ºCSV
                            </button>
                            <button class="btn btn-primary" onclick="exportScanResults('json')" style="background: #9b59b6; font-size: 13px; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">
                                ğŸ“¥ å¯¼å‡ºJSON
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
            
            let html = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">';
            html += `<h4>ğŸ¯ æ‰«æç»“æœï¼šæ‰¾åˆ° ${result.found_count} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ï¼ˆæ˜¾ç¤ºå‰ ${displayCandidates.length} åªï¼‰</h4>`;
            const sd = result.scan_date || '';
            const ss = result.scan_session || '';
            html += `<p style="color: #666; font-size: 12px;">æ‰«ææ€»æ•°: ${result.total_scanned} åª${sd ? ` | æ‰«ææ—¥æœŸ(as-of): <strong>${sd}</strong>` : ''}${ss ? ` | æ—¶é—´æ®µ: <strong>${ss === 'noon' ? 'åˆç›˜' : 'æ”¶ç›˜'}</strong>` : ''}</p>`;
            html += exportButtons;
            // æ£€æŸ¥ç”¨æˆ·ç­‰çº§ï¼ŒVIPç”¨æˆ·æ˜¾ç¤º"åŠ å…¥å…³æ³¨"æŒ‰é’®
            let showWatchlistButton = false;
            try {
                const user = await getUserInfo();
                if (user && (user.tier === 'premium' || user.tier === 'super' || user.is_super)) {
                    showWatchlistButton = true;
                }
            } catch (e) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
            }
            
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px;">';
            html += '<tr style="background: #f0f0f0;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æ’å</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è‚¡ç¥¨ä»£ç </th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è‚¡ç¥¨åç§°</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">åŒ¹é…åº¦</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æœ€ä½³ä¹°ç‚¹æ—¥æœŸ</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æœ€ä½³ä¹°ç‚¹ä»·æ ¼</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å½“å‰ä»·æ ¼</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å¸‚å€¼(äº¿)</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æ“ä½œ</th></tr>';
            
            displayCandidates.forEach((candidate, index) => {
                const matchColor = (candidate.åŒ¹é…åº¦ || candidate.match_score || 0) >= 0.8 ? '#27ae60' : (candidate.åŒ¹é…åº¦ || candidate.match_score || 0) >= 0.7 ? '#f39c12' : '#e74c3c';
                const stockCode = candidate.è‚¡ç¥¨ä»£ç  || candidate.code || '';
                const stockName = candidate.è‚¡ç¥¨åç§° || candidate.name || '';
                const buyDate = candidate.æœ€ä½³ä¹°ç‚¹æ—¥æœŸ || candidate.buy_date || '';
                const buyPrice = candidate.æœ€ä½³ä¹°ç‚¹ä»·æ ¼ || candidate.buy_price || 0;
                const matchScore = candidate.åŒ¹é…åº¦ || candidate.match_score || 0;
                
                html += `<tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #667eea;">${stockCode}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${stockName}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; color: ${matchColor}; font-weight: bold;">${matchScore.toFixed(3)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${buyDate}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #e74c3c;">${buyPrice.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${(candidate.å½“å‰ä»·æ ¼ || candidate.current_price || 0).toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${candidate.å¸‚å€¼ || candidate.market_cap ? (candidate.å¸‚å€¼ || candidate.market_cap).toFixed(2) : 'N/A'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="analyzeStockDetail('${stockCode}', '${stockName}', '${buyDate}', ${buyPrice}, ${matchScore})" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ” æ·±åº¦åˆ†æ</button>
                            ${showWatchlistButton ? `<button onclick="addToWatchlist('${stockCode}', '${stockName}', ${buyPrice}, '${buyDate}', ${matchScore})" style="background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">â­ åŠ å…¥å…³æ³¨</button>` : ''}
                        </div>
                    </td>
                </tr>`;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç½‘ç»œç¯å¢ƒï¼ˆRenderç­‰ï¼‰
        function isNetworkEnvironment() {
            const hostname = window.location.hostname;
            return hostname !== 'localhost' && hostname !== '127.0.0.1' && !hostname.startsWith('192.168.') && !hostname.startsWith('10.');
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆæ·»åŠ è¶…æ—¶æ§åˆ¶å’Œé‡è¯•æœºåˆ¶ï¼‰
        async function checkLoginStatus(retryCount = 0) {
            const maxRetries = 0; // âœ… ä¸é‡è¯•ï¼Œç›´æ¥è¿”å›
            // âœ… ç½‘ç»œç¯å¢ƒï¼ˆRenderï¼‰éœ€è¦æ›´é•¿è¶…æ—¶ï¼ˆ60ç§’ï¼‰ï¼Œå› ä¸ºæœåŠ¡å™¨å¯èƒ½ä¼‘çœ éœ€è¦å”¤é†’
            // âœ… æœ¬åœ°ç¯å¢ƒä½¿ç”¨çŸ­è¶…æ—¶ï¼ˆ2ç§’ï¼‰
            const timeout = isNetworkEnvironment() ? 60000 : 2000;
            
            try {
                // æ·»åŠ è¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    if (isNetworkEnvironment()) {
                        console.warn(`[checkLoginStatus] è¯·æ±‚è¶…æ—¶ï¼ˆ${timeout/1000}ç§’ï¼‰ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨æ­£åœ¨å”¤é†’ï¼Œè¯·ç¨åé‡è¯•`);
                    } else {
                        console.warn(`[checkLoginStatus] è¯·æ±‚è¶…æ—¶ï¼ˆ${timeout/1000}ç§’ï¼‰ï¼Œè¿”å› false`);
                    }
                    controller.abort();
                }, timeout);
                
                let response;
                try {
                    console.log(`[checkLoginStatus] æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€... (å°è¯• ${retryCount + 1}/${maxRetries + 1})`);
                    response = await fetch('/api/check_login', {
                        method: 'GET',
                        signal: controller.signal,
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError' || fetchError.message?.includes('aborted')) {
                        console.warn(`[checkLoginStatus] è¯·æ±‚è¶…æ—¶æˆ–ä¸­æ–­ï¼Œè¿”å› falseï¼ˆä¸è·³è½¬ï¼‰`);
                        return false; // è¶…æ—¶è¿”å›falseï¼Œä¸è·³è½¬ï¼Œè®©ç”¨æˆ·é‡è¯•
                    }
                    // ç½‘ç»œé”™è¯¯æ—¶ä¸ç«‹å³è·³è½¬ï¼Œç»™ç”¨æˆ·é‡è¯•çš„æœºä¼š
                    console.warn('[checkLoginStatus] ç½‘ç»œé”™è¯¯ï¼Œè¿”å› falseï¼ˆä¸è·³è½¬ï¼‰');
                    return false;
                }
                
                if (!response.ok) {
                    console.error(`[checkLoginStatus] HTTPé”™è¯¯: ${response.status}`);
                    return false;
                }
                
                const result = await response.json();
                
                if (!result.success || !result.logged_in) {
                    // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                    console.log('[checkLoginStatus] ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
                    window.location.href = '/login';
                    return false;
                }
                console.log(`[checkLoginStatus] âœ… ç”¨æˆ·å·²ç™»å½•`);
                return true;
            } catch (error) {
                console.error(`[checkLoginStatus] æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:`, error);
                return false;
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬åœ°ç¯å¢ƒï¼ˆéVercelï¼‰
        // ========== æ•°æ®è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ ==========
        let dataUpdatePollingInterval = null;
        
        async function startAutoDataUpdate() {
            console.log('[æ•°æ®æ›´æ–°] æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ•°æ®...');
            
            try {
                // âœ… æ£€æŸ¥æ˜¯å¦åº”è¯¥è·³è¿‡æ›´æ–°ï¼ˆäº¤æ˜“æ—¥15:00åå·²æ›´æ–°è¿‡ï¼‰ï¼Œä¼˜å…ˆæ£€æŸ¥
                try {
                    const timestampResp = await fetch('/api/get_data_update_timestamp');
                    const timestampResult = await timestampResp.json();
                    if (timestampResult.success && timestampResult.should_skip) {
                        console.log(`[æ•°æ®æ›´æ–°] ${timestampResult.message || 'äº¤æ˜“å·²ç»“æŸï¼Œä»Šæ—¥å·²æ›´æ–°ï¼Œè·³è¿‡æ›´æ–°'}`);
                        // âœ… æ˜¾ç¤ºæç¤ºï¼Œå¹¶æä¾›å¼ºåˆ¶æ›´æ–°é€‰é¡¹
                        const message = timestampResult.message || 'äº¤æ˜“å·²ç»“æŸï¼Œä»Šæ—¥å·²æ›´æ–°ï¼Œæ— éœ€æ›´æ–°';
                        const confirmMsg = message + '\n\næ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼Ÿ';
                        if (confirm(confirmMsg)) {
                            // å¼ºåˆ¶æ›´æ–°ï¼šå¿½ç•¥æ—¶é—´æˆ³æ£€æŸ¥
                            console.log('[æ•°æ®æ›´æ–°] ç”¨æˆ·é€‰æ‹©å¼ºåˆ¶æ›´æ–°');
                            const startResp = await fetch('/api/start_data_update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ force: true })
                            });
                            const result = await startResp.json();
                            if (result.success) {
                                showDataUpdateProgress({ status: 'running', message: 'æ­£åœ¨å¼ºåˆ¶æ›´æ–°æ•°æ®...' });
                                startDataUpdatePolling();
                            } else {
                                showMessage(result.message || 'å¼ºåˆ¶æ›´æ–°å¯åŠ¨å¤±è´¥', 'error');
                            }
                        } else {
                            showMessage(message, 'info');
                        }
                        return;
                    }
                } catch (e) {
                    console.warn('[æ•°æ®æ›´æ–°] æ£€æŸ¥æ—¶é—´æˆ³å¤±è´¥ï¼Œç»§ç»­æ£€æŸ¥æ•°æ®æ–°é²œåº¦:', e);
                }
                
                // âœ… å…ˆæ£€æŸ¥æ•°æ®æ˜¯å¦å·²æ˜¯æœ€æ–°
                const freshnessResp = await fetch('/api/check_data_freshness', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const freshness = await freshnessResp.json();
                console.log('[æ•°æ®æ›´æ–°] æ•°æ®æ–°é²œåº¦æ£€æŸ¥ç»“æœ:', freshness);
                
                // âœ… æ£€æŸ¥æ˜¯å¦åº”è¯¥è·³è¿‡æ›´æ–°ï¼ˆä¼˜å…ˆæ£€æŸ¥ï¼Œå³ä½¿æ•°æ®ä¸æ–°é²œä¹Ÿè¦è·³è¿‡ï¼‰
                if (freshness.should_skip || freshness.skip_reason === 'trading_hours_ended' || freshness.skip_reason === 'trading_hours_ended_no_timestamp') {
                    console.log(`[æ•°æ®æ›´æ–°] âœ… ${freshness.message || 'äº¤æ˜“å·²ç»“æŸï¼Œä»Šæ—¥å·²æ›´æ–°ï¼Œè·³è¿‡æ›´æ–°'}`);
                    // âœ… æ˜¾ç¤ºæç¤ºï¼Œå¹¶æä¾›å¼ºåˆ¶æ›´æ–°é€‰é¡¹
                    const message = freshness.message || 'äº¤æ˜“å·²ç»“æŸï¼Œä»Šæ—¥å·²æ›´æ–°ï¼Œæ— éœ€æ›´æ–°';
                    const confirmMsg = message + '\n\næ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼Ÿ';
                    if (confirm(confirmMsg)) {
                        // å¼ºåˆ¶æ›´æ–°ï¼šå¿½ç•¥æ—¶é—´æˆ³æ£€æŸ¥
                        console.log('[æ•°æ®æ›´æ–°] ç”¨æˆ·é€‰æ‹©å¼ºåˆ¶æ›´æ–°');
                        const startResp = await fetch('/api/start_data_update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ force: true })
                        });
                        const result = await startResp.json();
                        if (result.success) {
                            showDataUpdateProgress({ status: 'running', message: 'æ­£åœ¨å¼ºåˆ¶æ›´æ–°æ•°æ®...' });
                            startDataUpdatePolling();
                        } else {
                            showMessage(result.message || 'å¼ºåˆ¶æ›´æ–°å¯åŠ¨å¤±è´¥', 'error');
                        }
                    } else {
                        showMessage(message, 'info');
                    }
                    return;
                }
                
                // âœ… é¢å¤–æ£€æŸ¥ï¼šå¦‚æœå½“å‰æ—¶é—´å·²ç»æ˜¯15:00åï¼Œä¹Ÿé˜»æ­¢æ›´æ–°ï¼ˆå³ä½¿æ•°æ®ä¸æ–°é²œï¼‰
                // å› ä¸ºäº¤æ˜“å·²ç»“æŸï¼Œä¸åº”è¯¥è‡ªåŠ¨æ›´æ–°
                // æ³¨æ„ï¼šè¿™ä¸ªæ£€æŸ¥ç”±åç«¯APIå®Œæˆï¼Œå‰ç«¯åªéœ€è¦æ£€æŸ¥è¿”å›çš„ should_skip å­—æ®µ
                
                if (freshness.fresh) {
                    console.log('[æ•°æ®æ›´æ–°] âœ… æ•°æ®å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°');
                    console.log(`[æ•°æ®æ›´æ–°] æœ€æ–°æ•°æ®æ—¥æœŸ: ${freshness.latest_data_date || 'æœªçŸ¥'}`);
                    console.log(`[æ•°æ®æ›´æ–°] ${freshness.message || 'æ•°æ®å·²æ˜¯æœ€æ–°'}`);
                    // ä¸æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œç›´æ¥è¿”å›
                    return;
                }
                
                console.log(`[æ•°æ®æ›´æ–°] âš ï¸ æ•°æ®éœ€è¦æ›´æ–°: ${freshness.message}`);
                
                // å…ˆæ£€æŸ¥æ›´æ–°çŠ¶æ€
                const progressResp = await fetch('/api/get_data_update_progress');
                const progress = await progressResp.json();
                
                if (progress.status === 'running') {
                    console.log('[æ•°æ®æ›´æ–°] æ•°æ®æ›´æ–°å·²åœ¨è¿›è¡Œä¸­ï¼Œå¼€å§‹ç›‘æ§è¿›åº¦...');
                    showDataUpdateProgress(progress);
                    startDataUpdatePolling();
                    return;
                }
                
                // å¯åŠ¨æ•°æ®æ›´æ–°
                const startResp = await fetch('/api/start_data_update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await startResp.json();
                
                if (result.success) {
                    console.log('[æ•°æ®æ›´æ–°] æ•°æ®æ›´æ–°å·²å¯åŠ¨');
                    showDataUpdateProgress({ status: 'running', message: 'æ­£åœ¨å¯åŠ¨æ•°æ®æ›´æ–°...' });
                    startDataUpdatePolling();
                } else {
                    // âœ… å¦‚æœè¿”å›å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ•°æ®å·²æ˜¯æœ€æ–°
                    if (result.message && result.message.includes('å·²æ˜¯æœ€æ–°')) {
                        console.log(`[æ•°æ®æ›´æ–°] âœ… ${result.message}`);
                        // ä¸æ˜¾ç¤ºè¿›åº¦æ¡
                        return;
                    }
                    console.warn('[æ•°æ®æ›´æ–°] å¯åŠ¨å¤±è´¥:', result.message);
                    showDataUpdateProgress({ status: 'error', message: `å¯åŠ¨å¤±è´¥: ${result.message}` });
                }
            } catch (error) {
                console.error('[æ•°æ®æ›´æ–°] æ£€æŸ¥æˆ–å¯åŠ¨å¤±è´¥:', error);
                showDataUpdateProgress({ status: 'error', message: 'æœåŠ¡å™¨é”™è¯¯: ' + error.message });
            }
        }
        
        function startDataUpdatePolling() {
            console.log('[æ•°æ®æ›´æ–°] å¼€å§‹è½®è¯¢æ•°æ®æ›´æ–°è¿›åº¦...');
            
            // å¦‚æœå·²ç»æœ‰è½®è¯¢åœ¨è¿è¡Œï¼Œå…ˆæ¸…é™¤
            if (dataUpdatePollingInterval) {
                clearInterval(dataUpdatePollingInterval);
            }
            
            // ç«‹å³è·å–ä¸€æ¬¡è¿›åº¦
            fetch('/api/get_data_update_progress')
                .then(response => response.json())
                .then(progress => {
                    console.log('[æ•°æ®æ›´æ–°] åˆå§‹è¿›åº¦:', progress);
                    showDataUpdateProgress(progress);
                })
                .catch(error => {
                    console.error('[æ•°æ®æ›´æ–°] è·å–åˆå§‹è¿›åº¦å¤±è´¥:', error);
                });
            
            // æ¯1ç§’è½®è¯¢ä¸€æ¬¡
            dataUpdatePollingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/get_data_update_progress', {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    const progress = await response.json();
                    
                    console.log('[æ•°æ®æ›´æ–°] è¿›åº¦æ›´æ–°:', progress); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                    showDataUpdateProgress(progress);
                    
                    if (progress.status === 'completed' || progress.status === 'error' || progress.status === 'stopped' || progress.status === 'merging') {
                        // merging çŠ¶æ€æ—¶ç»§ç»­è½®è¯¢ï¼Œç­‰å¾…èåˆå®Œæˆ
                        if (progress.status === 'merging') {
                            // ç»§ç»­è½®è¯¢ï¼Œä¸åœæ­¢
                        } else {
                            clearInterval(dataUpdatePollingInterval);
                            dataUpdatePollingInterval = null;
                            
                            // 3ç§’åéšè—è¿›åº¦æ¡
                            setTimeout(() => {
                                hideDataUpdateProgress();
                            }, 3000);
                        }
                    }
                } catch (error) {
                    console.error('[æ•°æ®æ›´æ–°] è·å–è¿›åº¦å¤±è´¥:', error);
                }
            }, 1000);
        }
        
        function showDataUpdateProgress(progress) {
            let progressDiv = document.getElementById('dataUpdateProgress');
            if (!progressDiv) {
                progressDiv = document.createElement('div');
                progressDiv.id = 'dataUpdateProgress';
                progressDiv.style.cssText = 'position:fixed;top:10px;right:10px;background:#fff;border:1px solid #ddd;border-radius:8px;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:9999;min-width:300px;font-size:13px;';
                document.body.appendChild(progressDiv);
            }
            
            const statusIcon = progress.status === 'running' ? 'ğŸ”„' : 
                              progress.status === 'merging' ? 'ğŸ”—' :
                              progress.status === 'completed' ? 'âœ…' : 
                              progress.status === 'error' ? 'âŒ' : 'â¸ï¸';
            
            const percentage = progress.percentage || 0;
            const barColor = progress.status === 'completed' ? '#27ae60' : 
                            progress.status === 'merging' ? '#9b59b6' :
                            progress.status === 'error' ? '#e74c3c' : '#3498db';
            
            // âœ… æ ¼å¼åŒ–å·²ç”¨æ—¶é—´
            let elapsedTimeStr = '';
            if (progress.elapsed_time !== undefined) {
                const elapsed = progress.elapsed_time;
                if (elapsed < 60) {
                    elapsedTimeStr = `${Math.floor(elapsed)}ç§’`;
                } else if (elapsed < 3600) {
                    const minutes = Math.floor(elapsed / 60);
                    const secs = Math.floor(elapsed % 60);
                    elapsedTimeStr = `${minutes}åˆ†${secs}ç§’`;
                } else {
                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const secs = Math.floor(elapsed % 60);
                    elapsedTimeStr = `${hours}å°æ—¶${minutes}åˆ†${secs}ç§’`;
                }
            }
            
            progressDiv.innerHTML = `
                <div style="font-weight:bold;margin-bottom:8px;">${statusIcon} æ•°æ®æ›´æ–°</div>
                <div style="background:#eee;border-radius:4px;height:8px;margin-bottom:8px;">
                    <div style="background:${barColor};height:100%;border-radius:4px;width:${percentage}%;transition:width 0.3s;"></div>
                </div>
                <div style="color:#666;font-size:12px;">
                    ${progress.message || ''}
                    ${progress.current_stock ? `<br>å½“å‰: ${progress.current_stock}` : ''}
                    ${progress.processed ? `<br>è¿›åº¦: ${progress.processed}/${progress.total} (${percentage}%)` : ''}
                    ${elapsedTimeStr ? `<br><strong>å·²ç”¨æ—¶é—´: ${elapsedTimeStr}</strong>` : ''}
                    ${progress.data_source ? `<br>æ•°æ®æº: ${progress.data_source === 'sina' ? 'æ–°æµª' : 'ä¸œæ–¹è´¢å¯Œ'}` : ''}
                    ${progress.updated_count ? `<br>å·²æ›´æ–°: ${progress.updated_count} åª` : ''}
                    ${progress.failed_count ? `<br>å¤±è´¥: ${progress.failed_count} åª` : ''}
                </div>
                ${progress.status === 'running' || progress.status === 'merging' ? `<button onclick="stopDataUpdate()" style="margin-top:8px;padding:4px 12px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">åœæ­¢</button>` : ''}
            `;
        }
        
        function hideDataUpdateProgress() {
            const progressDiv = document.getElementById('dataUpdateProgress');
            if (progressDiv) {
                progressDiv.style.opacity = '0';
                progressDiv.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    if (progressDiv.parentNode) {
                        progressDiv.parentNode.removeChild(progressDiv);
                    }
                }, 500);
            }
        }
        
        async function stopDataUpdate() {
            try {
                await fetch('/api/stop_data_update', { method: 'POST' });
                showMessage('å·²å‘é€åœæ­¢è¯·æ±‚', 'success');
            } catch (error) {
                console.error('[æ•°æ®æ›´æ–°] åœæ­¢å¤±è´¥:', error);
            }
        }
        
        function isLocalEnvironment() {
            // é€šè¿‡ hostname åˆ¤æ–­ï¼šlocalhost æˆ– 127.0.0.1 æˆ–æœ¬åœ°IPåœ°å€
            const hostname = window.location.hostname;
            const isLocal = hostname === 'localhost' || 
                          hostname === '127.0.0.1' || 
                          hostname.startsWith('192.168.') ||
                          hostname.startsWith('10.') ||
                          hostname.startsWith('172.16.') ||
                          hostname.startsWith('172.17.') ||
                          hostname.startsWith('172.18.') ||
                          hostname.startsWith('172.19.') ||
                          hostname.startsWith('172.20.') ||
                          hostname.startsWith('172.21.') ||
                          hostname.startsWith('172.22.') ||
                          hostname.startsWith('172.23.') ||
                          hostname.startsWith('172.24.') ||
                          hostname.startsWith('172.25.') ||
                          hostname.startsWith('172.26.') ||
                          hostname.startsWith('172.27.') ||
                          hostname.startsWith('172.28.') ||
                          hostname.startsWith('172.29.') ||
                          hostname.startsWith('172.30.') ||
                          hostname.startsWith('172.31.');
            
            // å¦‚æœä¸æ˜¯æœ¬åœ°ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ Vercel åŸŸå
            if (!isLocal) {
                const isVercel = hostname.includes('vercel.app') || 
                               hostname.includes('daniugu.online') ||
                               hostname.includes('netlify.app') ||
                               hostname.includes('github.io');
                return !isVercel; // å¦‚æœä¸æ˜¯ Vercel åŸŸåï¼Œå¯èƒ½æ˜¯æœ¬åœ°ç½‘ç»œç¯å¢ƒ
            }
            
            return isLocal;
        }
        
        // æ ¹æ®ç¯å¢ƒå’Œç”¨æˆ·ç­‰çº§æ˜¾ç¤º/éšè—åŠŸèƒ½æŒ‰é’®
        async function updateFunctionButtonsVisibility() {
            const isLocal = isLocalEnvironment();
            const localButtons = document.getElementById('localVersionButtons');
            const webButtons = document.getElementById('webVersionButtons');
            const vipButtons = document.getElementById('vipUserButtons');
            const freeButtons = document.getElementById('freeUserButtons');
            const superButtons = document.getElementById('superUserButtons');
            
            console.log('[updateFunctionButtonsVisibility] ç¯å¢ƒæ£€æµ‹:', {
                hostname: window.location.hostname,
                isLocal: isLocal,
                localButtons: !!localButtons,
                webButtons: !!webButtons
            });
            
            if (isLocal) {
                // æœ¬åœ°ç¯å¢ƒï¼šæ˜¾ç¤ºæ‰€æœ‰åŠŸèƒ½
                console.log('[updateFunctionButtonsVisibility] æœ¬åœ°ç¯å¢ƒï¼Œæ˜¾ç¤ºæ‰€æœ‰åŠŸèƒ½æŒ‰é’®');
                if (localButtons) {
                    localButtons.style.display = 'block';
                    console.log('[updateFunctionButtonsVisibility] æœ¬åœ°æŒ‰é’®å·²æ˜¾ç¤º');
                }
                if (webButtons) webButtons.style.display = 'none';
                
                // æ˜¾ç¤ºåè½¬ä¸ªè‚¡åŠŸèƒ½
                const reversalSection = document.getElementById('reversalStockSection');
                if (reversalSection) {
                    reversalSection.style.display = 'block';
                    console.log('[updateFunctionButtonsVisibility] åè½¬ä¸ªè‚¡åŠŸèƒ½å·²æ˜¾ç¤º');
                }
                
                // æ˜¾ç¤ºKDJæ¨¡å¼åŠŸèƒ½
                const kdjSection = document.getElementById('kdjModeSection');
                if (kdjSection) {
                    kdjSection.style.display = 'block';
                    console.log('[updateFunctionButtonsVisibility] KDJæ¨¡å¼åŠŸèƒ½å·²æ˜¾ç¤º');
                }
            } else {
                // ç½‘ç»œç¯å¢ƒï¼šæ ¹æ®ç”¨æˆ·ç­‰çº§æ˜¾ç¤º
                if (localButtons) localButtons.style.display = 'none';
                if (webButtons) webButtons.style.display = 'block';
                
                // éšè—åè½¬ä¸ªè‚¡åŠŸèƒ½
                const reversalSection = document.getElementById('reversalStockSection');
                if (reversalSection) reversalSection.style.display = 'none';
                
                // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå·²å†…ç½®è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ï¼Œè¿™é‡Œåªè®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é—´ï¼‰
                try {
                    // âœ… ç½‘ç»œç¯å¢ƒä½¿ç”¨é•¿è¶…æ—¶ï¼ˆ60ç§’ï¼‰ï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨çŸ­è¶…æ—¶ï¼ˆ3ç§’ï¼‰
                    const timeout = isNetworkEnvironment() ? 60000 : 3000;
                    const user = await Promise.race([
                        getUserInfo(), // getUserInfo å†…éƒ¨å·²æœ‰è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
                        new Promise((resolve) => setTimeout(() => {
                            console.warn(`[updateFunctionButtonsVisibility] è·å–ç”¨æˆ·ä¿¡æ¯è¶…æ—¶ï¼ˆ${timeout/1000}ç§’ï¼‰ï¼Œä½¿ç”¨é»˜è®¤æ˜¾ç¤º`);
                            resolve(null);
                        }, timeout))
                    ]);
                    
                    if (user) {
                        const tier = user.tier || 'free';
                        const isSuper = user.is_super || false;
                        
                        const stocksListSection = document.getElementById('stocksListSection');
                        
                        if (isSuper || tier === 'super') {
                            // è¶…çº§ç”¨æˆ·ï¼šæ˜¾ç¤ºæ‰€æœ‰åŠŸèƒ½
                            if (superButtons) superButtons.style.display = 'block';
                            if (vipButtons) {
                                vipButtons.style.display = 'none';
                                // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼ˆå¦‚æœä¹‹å‰è¢«ç¦ç”¨ï¼‰
                                enableVipButtons(vipButtons);
                            }
                            if (freeButtons) freeButtons.style.display = 'none';
                            if (stocksListSection) stocksListSection.style.display = 'block';
                        } else if (tier === 'premium') {
                            // VIPç”¨æˆ·ï¼šæ˜¾ç¤ºæ‰«æå…¨å¸‚åœºï¼ˆæ— é™æ¬¡ï¼‰
                            if (vipButtons) {
                                vipButtons.style.display = 'block';
                                // å¯ç”¨æ‰€æœ‰æŒ‰é’®
                                enableVipButtons(vipButtons);
                            }
                            if (freeButtons) freeButtons.style.display = 'none';
                            if (superButtons) superButtons.style.display = 'none';
                            if (stocksListSection) stocksListSection.style.display = 'block';
                        } else {
                            // å…è´¹ç”¨æˆ·ï¼šæ˜¾ç¤ºæ‰€æœ‰æŒ‰é’®ï¼Œä½†è®¾ç½®ä¸ºç¦ç”¨çŠ¶æ€ï¼ˆç°è‰²ï¼‰ï¼Œéšè—è‚¡ç¥¨åˆ—è¡¨
                            if (vipButtons) {
                                vipButtons.style.display = 'block';
                                disableVipButtons(vipButtons);
                            }
                            if (freeButtons) freeButtons.style.display = 'none';
                            if (superButtons) superButtons.style.display = 'none';
                            if (stocksListSection) stocksListSection.style.display = 'none';
                        }
                    } else {
                        // æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œé»˜è®¤æ˜¾ç¤ºå…è´¹ç”¨æˆ·æŒ‰é’®ï¼ˆç¦ç”¨çŠ¶æ€ï¼‰
                        const stocksListSection = document.getElementById('stocksListSection');
                        if (vipButtons) {
                            vipButtons.style.display = 'block';
                            disableVipButtons(vipButtons);
                        }
                        if (freeButtons) freeButtons.style.display = 'none';
                        if (superButtons) superButtons.style.display = 'none';
                        if (stocksListSection) stocksListSection.style.display = 'none';
                    }
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    // å‡ºé”™æ—¶é»˜è®¤æ˜¾ç¤ºå…è´¹ç”¨æˆ·æŒ‰é’®ï¼ˆç¦ç”¨çŠ¶æ€ï¼‰
                    const stocksListSection = document.getElementById('stocksListSection');
                    if (vipButtons) {
                        disableVipButtons(vipButtons);
                        vipButtons.style.display = 'block';
                    }
                    if (freeButtons) freeButtons.style.display = 'none';
                    if (superButtons) superButtons.style.display = 'none';
                    if (stocksListSection) stocksListSection.style.display = 'none';
                }
            }
        }
        
        async function viewScanResults() {
            try {
                showMessage('æ­£åœ¨åŠ è½½æ‰«æç»“æœ...', 'success');
                
                // è·å–ç”¨æˆ·ä¿¡æ¯ä»¥ç¡®å®šç”¨æˆ·ç­‰çº§
                const user = await getUserInfo().catch(() => null);
                const tier = user?.tier || 'free';
                
                // å…è´¹ç”¨æˆ·ä½¿ç”¨ä¸“é—¨çš„APIæŸ¥çœ‹11:30å’Œ15:00çš„æ‰«æç»“æœ
                if (tier === 'free') {
                    const response = await fetch('/api/get_free_user_scan_results', {
                        method: 'GET',
                        cache: 'no-store'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success && result.results && result.results.length > 0) {
                        // ä½¿ç”¨å…è´¹ç”¨æˆ·çš„æ˜¾ç¤ºå‡½æ•°
                        if (typeof displayScanResultsCharts === 'function') {
                            displayScanResultsCharts(result.results);
                        } else {
                            // å¦‚æœæ²¡æœ‰displayScanResultsChartså‡½æ•°ï¼Œä½¿ç”¨ç®€å•æ˜¾ç¤º
                            const container = document.getElementById('stocksContainer');
                            if (container) {
                                let html = '<h3>æ‰«æç»“æœ</h3>';
                                result.results.forEach((item, index) => {
                                    html += `<div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                                        <h4>${item.title}</h4>
                                        <p>æ‰«ææ—¶é—´: ${item.scan_time}</p>
                                        <p>æ‰¾åˆ° ${item.result?.found_count || 0} åªè‚¡ç¥¨</p>
                                    </div>`;
                                });
                                container.innerHTML = html;
                            }
                        }
                        showMessage(`æˆåŠŸåŠ è½½ ${result.results.length} ç»„æ‰«æç»“æœ`, 'success');
                    } else {
                        showMessage(result.message || 'æš‚æ— æ‰«æç»“æœï¼Œç³»ç»Ÿæ¯å¤©åœ¨11:30å’Œ15:00è‡ªåŠ¨æ‰«æï¼Œè¯·ç¨åå†æŸ¥çœ‹ã€‚', 'info');
                    }
                } else {
                    // VIP/è¶…çº§ç”¨æˆ·ä½¿ç”¨æ ‡å‡†API
                    const response = await fetch('/api/get_scan_results', {
                        method: 'GET',
                        cache: 'no-store'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success && result.candidates && result.candidates.length > 0) {
                        // æ˜¾ç¤ºæ‰«æç»“æœï¼ˆä½¿ç”¨ç°æœ‰çš„æ˜¾ç¤ºå‡½æ•°ï¼‰
                        if (typeof displayScanResults === 'function') {
                            displayScanResults({
                                candidates: result.candidates,
                                found_count: result.found_count || result.candidates.length,
                                total_scanned: result.total_scanned || 0
                            });
                        } else {
                            // å¦‚æœæ²¡æœ‰displayScanResultså‡½æ•°ï¼Œä½¿ç”¨ç®€å•æ˜¾ç¤º
                            const container = document.getElementById('buyPointsResult');
                            if (container) {
                                container.style.display = 'block';
                                container.innerHTML = `<h3>æ‰«æç»“æœï¼ˆæ‰¾åˆ° ${result.candidates.length} åªè‚¡ç¥¨ï¼‰</h3>`;
                            }
                        }
                        showMessage(`æˆåŠŸåŠ è½½ ${result.candidates.length} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨`, 'success');
                    } else {
                        showMessage(result.message || 'æš‚æ— æ‰«æç»“æœ', 'info');
                    }
                }
            } catch (error) {
                console.error('æŸ¥çœ‹æ‰«æç»“æœå¤±è´¥:', error);
                showMessage('åŠ è½½æ‰«æç»“æœå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–è‚¡ç¥¨åˆ—è¡¨ï¼ˆä¼˜åŒ–åŠ è½½é¡ºåºï¼Œé¿å…é˜»å¡ï¼‰
        // åŠ è½½æ¨¡å‹åˆ—è¡¨
        async function loadModelList() {
            try {
                const response = await fetch('/api/list_models');
                const result = await response.json();
                
                if (result.success && result.models) {
                    const selector = document.getElementById('modelSelector');
                    if (!selector) return;
                    
                    selector.innerHTML = '';
                    result.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.filename;
                        option.textContent = `${model.filename} (${model.feature_count}ç‰¹å¾, ${model.stock_count}è‚¡ç¥¨, ${model.trained_at ? model.trained_at.substring(0, 10) : 'æœªçŸ¥æ—¥æœŸ'})`;
                        if (model.is_current) {
                            option.selected = true;
                            option.textContent += ' [å½“å‰]';
                        }
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // åˆ‡æ¢æ¨¡å‹ï¼ˆVIPç”¨æˆ·ï¼‰
        async function switchModel() {
            const selector = document.getElementById('modelSelector');
            if (!selector) return;
            
            const selectedModel = selector.value;
            if (!selectedModel) return;
            
            try {
                showMessage('æ­£åœ¨åˆ‡æ¢æ¨¡å‹ï¼Œè¯·ç¨å€™...', 'success');
                
                const response = await fetch('/api/switch_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model_filename: selectedModel
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`âœ… ${result.message}`, 'success');
                    // é‡æ–°åŠ è½½æ‰€æœ‰æ¨¡å‹åˆ—è¡¨ä»¥æ›´æ–°"å½“å‰"æ ‡è®°
                    await Promise.all([
                        loadModelList(),
                        loadModelListSuper()
                    ]);
                    // é‡æ–°æ£€æŸ¥æ¨¡å‹çŠ¶æ€
                    await checkMatchScoreStatus();
                } else {
                    showMessage(`âŒ ${result.message}`, 'error');
                    // æ¢å¤é€‰æ‹©
                    await Promise.all([
                        loadModelList(),
                        loadModelListSuper()
                    ]);
                }
            } catch (error) {
                console.error('åˆ‡æ¢æ¨¡å‹å¤±è´¥:', error);
                showMessage('åˆ‡æ¢æ¨¡å‹å¤±è´¥: ' + error.message, 'error');
                // æ¢å¤é€‰æ‹©
                await Promise.all([
                    loadModelList(),
                    loadModelListSuper()
                ]);
            }
        }
        
        // åˆ‡æ¢æ¨¡å‹ï¼ˆè¶…çº§ç”¨æˆ·ï¼‰
        async function deleteModel() {
            const selector = document.getElementById('modelSelector');
            if (!selector) return;
            
            const selectedModel = selector.value;
            if (!selectedModel) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹', 'error');
                return;
            }
            
            // ä¸å…è®¸åˆ é™¤é»˜è®¤æ¨¡å‹
            if (selectedModel === 'trained_model.json') {
                showMessage('ä¸èƒ½åˆ é™¤é»˜è®¤æ¨¡å‹ trained_model.json', 'error');
                return;
            }
            
            // ç¡®è®¤åˆ é™¤
            const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹ "${selectedModel}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`);
            if (!confirmed) return;
            
            try {
                showMessage('æ­£åœ¨åˆ é™¤æ¨¡å‹...', 'success');
                
                const response = await fetch('/api/delete_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model_filename: selectedModel
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`âœ… ${result.message}${result.switched_to_default ? 'ï¼ˆå·²åˆ‡æ¢åˆ°é»˜è®¤æ¨¡å‹ï¼‰' : ''}`, 'success');
                    // é‡æ–°åŠ è½½æ‰€æœ‰æ¨¡å‹åˆ—è¡¨
                    await Promise.all([
                        loadModelList(),
                        loadModelListSuper()
                    ]);
                } else {
                    showMessage(`âŒ ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ¨¡å‹å¤±è´¥:', error);
                showMessage('åˆ é™¤æ¨¡å‹å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        async function deleteModelSuper() {
            const selector = document.getElementById('superModelSelector');
            if (!selector) return;
            
            const selectedModel = selector.value;
            if (!selectedModel) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹', 'error');
                return;
            }
            
            // ä¸å…è®¸åˆ é™¤é»˜è®¤æ¨¡å‹
            if (selectedModel === 'trained_model.json') {
                showMessage('ä¸èƒ½åˆ é™¤é»˜è®¤æ¨¡å‹ trained_model.json', 'error');
                return;
            }
            
            // ç¡®è®¤åˆ é™¤
            const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹ "${selectedModel}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`);
            if (!confirmed) return;
            
            try {
                showMessage('æ­£åœ¨åˆ é™¤æ¨¡å‹...', 'success');
                
                const response = await fetch('/api/delete_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model_filename: selectedModel
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`âœ… ${result.message}${result.switched_to_default ? 'ï¼ˆå·²åˆ‡æ¢åˆ°é»˜è®¤æ¨¡å‹ï¼‰' : ''}`, 'success');
                    // é‡æ–°åŠ è½½æ‰€æœ‰æ¨¡å‹åˆ—è¡¨
                    await Promise.all([
                        loadModelList(),
                        loadModelListSuper()
                    ]);
                } else {
                    showMessage(`âŒ ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ¨¡å‹å¤±è´¥:', error);
                showMessage('åˆ é™¤æ¨¡å‹å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        async function switchModelSuper() {
            const selector = document.getElementById('superModelSelector');
            if (!selector) return;
            
            const selectedModel = selector.value;
            if (!selectedModel) return;
            
            try {
                showMessage('æ­£åœ¨åˆ‡æ¢æ¨¡å‹ï¼Œè¯·ç¨å€™...', 'success');
                
                const response = await fetch('/api/switch_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model_filename: selectedModel
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`âœ… ${result.message}`, 'success');
                    // é‡æ–°åŠ è½½æ‰€æœ‰æ¨¡å‹åˆ—è¡¨ä»¥æ›´æ–°"å½“å‰"æ ‡è®°
                    await Promise.all([
                        loadModelList(),
                        loadModelListSuper()
                    ]);
                    // é‡æ–°æ£€æŸ¥æ¨¡å‹çŠ¶æ€
                    await checkMatchScoreStatus();
                } else {
                    showMessage(`âŒ ${result.message}`, 'error');
                    // æ¢å¤é€‰æ‹©
                    await Promise.all([
                        loadModelList(),
                        loadModelListSuper()
                    ]);
                }
            } catch (error) {
                console.error('åˆ‡æ¢æ¨¡å‹å¤±è´¥:', error);
                showMessage('åˆ‡æ¢æ¨¡å‹å¤±è´¥: ' + error.message, 'error');
                // æ¢å¤é€‰æ‹©
                await Promise.all([
                    loadModelList(),
                    loadModelListSuper()
                ]);
            }
        }
        
        // åŠ è½½æ¨¡å‹åˆ—è¡¨ï¼ˆè¶…çº§ç”¨æˆ·ï¼‰
        async function loadModelListSuper() {
            try {
                const response = await fetch('/api/list_models');
                const result = await response.json();
                
                if (result.success && result.models) {
                    const selector = document.getElementById('superModelSelector');
                    if (!selector) return;
                    
                    selector.innerHTML = '';
                    result.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.filename;
                        option.textContent = `${model.filename} (${model.feature_count}ç‰¹å¾, ${model.stock_count}è‚¡ç¥¨, ${model.trained_at ? model.trained_at.substring(0, 10) : 'æœªçŸ¥æ—¥æœŸ'})`;
                        if (model.is_current) {
                            option.selected = true;
                            option.textContent += ' [å½“å‰]';
                        }
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        async function initPageLoad() {
            console.log('[initPageLoad] å¼€å§‹åˆå§‹åŒ–é¡µé¢...');
            
            // âœ… ç«‹å³éšè—"åŠ è½½ä¸­..."æç¤ºï¼ˆé¡µé¢å·²åŠ è½½å®Œæˆï¼‰
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
            
            // âœ… ç«‹å³æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å ä½ç¬¦ï¼ˆä¸ç­‰å¾…ç½‘ç»œè¯·æ±‚ï¼‰
            const userInfoDiv = document.getElementById('userInfoDisplay');
            if (userInfoDiv) {
                userInfoDiv.innerHTML = '<div style="font-size: 12px; color: #666;">åŠ è½½ä¸­...</div>';
            }
            
            // âœ… ç«‹å³åŠ è½½è‚¡ç¥¨åˆ—è¡¨ï¼ˆä¸ç­‰å¾…ä»»ä½•æ£€æŸ¥ï¼‰
            loadStocks();
            
            // âœ… å®Œå…¨å¼‚æ­¥æ‰§è¡Œæ‰€æœ‰åˆå§‹åŒ–ä»»åŠ¡ï¼Œä¸é˜»å¡é¡µé¢
            // ä»»åŠ¡1ï¼šæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
            displayUserInfo().catch(err => {
                console.error('[initPageLoad] æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
            });
            
            // âœ… ç§»é™¤ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼ˆåç«¯å·²æœ‰æ£€æŸ¥ï¼Œé¿å…é‡å¤è¯·æ±‚ï¼‰
            // ä»»åŠ¡2ï¼šå·²ç§»é™¤ï¼ˆåç«¯è·¯ç”±å·²æœ‰ @require_login è£…é¥°å™¨ï¼‰
            
            // ä»»åŠ¡3ï¼šæ›´æ–°æŒ‰é’®æ˜¾ç¤ºï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
            updateFunctionButtonsVisibility().catch(err => {
                console.error('[initPageLoad] æ›´æ–°æŒ‰é’®æ˜¾ç¤ºå¤±è´¥:', err);
            });
            
            // âœ… æœ¬åœ°ç¯å¢ƒï¼šå»¶è¿Ÿå¯åŠ¨æ•°æ®æ›´æ–°ï¼ˆä¸é˜»å¡é¡µé¢åŠ è½½ï¼‰
            // âœ… æ·»åŠ äº¤æ˜“æ—¥15:00åæ£€æŸ¥ï¼Œé¿å…é‡å¤æ›´æ–°
            if (isLocalEnvironment()) {
                console.log('[initPageLoad] æœ¬åœ°ç¯å¢ƒï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ•°æ®...');
                
                // âœ… å…ˆæ£€æŸ¥å½“å‰æ—¶é—´ï¼Œå¦‚æœæ˜¯15:00åï¼Œç›´æ¥è·³è¿‡è‡ªåŠ¨æ›´æ–°
                // ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•ï¼šç›´æ¥è°ƒç”¨åç«¯APIæ£€æŸ¥æ—¶é—´
                setTimeout(() => {
                    // å…ˆæ£€æŸ¥æ›´æ–°æ—¶é—´æˆ³ï¼ˆåç«¯ä¼šæ£€æŸ¥æ—¶é—´ï¼‰
                    fetch('/api/get_data_update_timestamp')
                        .then(res => res.json())
                        .then(result => {
                            if (result.success && result.should_skip) {
                                console.log(`[initPageLoad] ${result.message || 'äº¤æ˜“å·²ç»“æŸï¼Œä»Šæ—¥å·²æ›´æ–°ï¼Œè·³è¿‡è‡ªåŠ¨æ›´æ–°'}`);
                                return; // è·³è¿‡è‡ªåŠ¨æ›´æ–°
                            }
                            // å¦‚æœåç«¯æ²¡æœ‰è¯´è·³è¿‡ï¼Œå†æ£€æŸ¥æ•°æ®æ–°é²œåº¦ï¼ˆåç«¯ä¹Ÿä¼šæ£€æŸ¥æ—¶é—´ï¼‰
                            startAutoDataUpdate().catch(err => {
                                console.error('[initPageLoad] å¯åŠ¨æ•°æ®æ›´æ–°å¤±è´¥:', err);
                            });
                        })
                        .catch(err => {
                            console.error('[initPageLoad] æ£€æŸ¥æ›´æ–°æ—¶é—´æˆ³å¤±è´¥:', err);
                            // æ£€æŸ¥å¤±è´¥æ—¶ï¼Œç›´æ¥è°ƒç”¨ startAutoDataUpdateï¼Œå®ƒå†…éƒ¨ä¼šæ£€æŸ¥æ—¶é—´
                            startAutoDataUpdate().catch(e => {
                                console.error('[initPageLoad] å¯åŠ¨æ•°æ®æ›´æ–°å¤±è´¥:', e);
                            });
                        });
                }, 5000); // âœ… å»¶è¿Ÿ5ç§’ï¼Œç¡®ä¿é¡µé¢å…ˆåŠ è½½å®Œæˆ
            }
            
            // âœ… æ ¹æ®ç”¨æˆ·ç­‰çº§åŠ è½½å†…å®¹ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
            // âœ… ç½‘ç»œç¯å¢ƒä½¿ç”¨é•¿è¶…æ—¶ï¼ˆ60ç§’ï¼‰ï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨çŸ­è¶…æ—¶ï¼ˆ3ç§’ï¼‰
            const timeout = isNetworkEnvironment() ? 60000 : 3000;
            Promise.race([
                (async () => {
                    try {
                        const user = await Promise.race([
                            getUserInfo(),
                            new Promise((resolve) => setTimeout(() => resolve(null), timeout))
                        ]);
                        
                        if (user && !isLocalEnvironment()) {
                            const tier = user.tier || 'free';
                            if (tier === 'free') {
                                // å…è´¹ç”¨æˆ·ï¼šæ˜¾ç¤ºæ‰«æç»“æœå›¾è¡¨
                                await loadAndDisplayFreeUserScanResults();
                            }
                            // VIPç”¨æˆ·ï¼šè‚¡ç¥¨åˆ—è¡¨å·²åœ¨ä¸Šé¢åŠ è½½
                        }
                    } catch (error) {
                        console.error('[initPageLoad] è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    }
                })(),
                new Promise((resolve) => setTimeout(() => {
                    console.warn(`[initPageLoad] è·å–ç”¨æˆ·ä¿¡æ¯è¶…æ—¶ï¼ˆ${timeout/1000}ç§’ï¼‰ï¼Œä½¿ç”¨é»˜è®¤åŠ è½½`);
                    resolve();
                }, timeout))
            ]).catch(err => {
                console.error('[initPageLoad] åŠ è½½å†…å®¹å¤±è´¥:', err);
            });
            
            // âœ… é¡µé¢åŠ è½½æ—¶æ£€æŸ¥åŒ¹é…åº¦çŠ¶æ€ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œä¸é˜»å¡åˆå§‹åŠ è½½ï¼‰
            setTimeout(() => {
                checkMatchScoreStatus().catch(err => {
                    console.error('[initPageLoad] æ£€æŸ¥åŒ¹é…åº¦çŠ¶æ€å¤±è´¥:', err);
                });
                // åŠ è½½æ¨¡å‹åˆ—è¡¨
                Promise.all([
                    loadModelList().catch(err => {
                        console.error('[initPageLoad] åŠ è½½VIPæ¨¡å‹åˆ—è¡¨å¤±è´¥:', err);
                    }),
                    loadModelListSuper().catch(err => {
                        console.error('[initPageLoad] åŠ è½½è¶…çº§ç”¨æˆ·æ¨¡å‹åˆ—è¡¨å¤±è´¥:', err);
                    })
                ]);
            }, 2000); // âœ… å»¶è¿Ÿ2ç§’æ‰§è¡Œï¼Œä¸é˜»å¡åˆå§‹åŠ è½½
            
            // âœ… æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ç”¨æˆ·ä¿¡æ¯å’ŒæŒ‰é’®æ˜¾ç¤ºï¼ˆå‡å°‘åˆ·æ–°é¢‘ç‡ï¼‰
            setInterval(async () => {
                try {
                    await displayUserInfo();
                    await updateFunctionButtonsVisibility();
                } catch (err) {
                    console.error('[initPageLoad] å®šæ—¶åˆ·æ–°å¤±è´¥:', err);
                }
            }, 300000); // 5åˆ†é’Ÿ
            
            console.log('[initPageLoad] é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        }
        
        // åŠ è½½å¹¶æ˜¾ç¤ºå…è´¹ç”¨æˆ·çš„æ‰«æç»“æœ
        async function loadAndDisplayFreeUserScanResults() {
            try {
                console.log('[loadAndDisplayFreeUserScanResults] å¼€å§‹åŠ è½½å…è´¹ç”¨æˆ·æ‰«æç»“æœ...');
                
                const response = await fetch('/api/get_free_user_scan_results', {
                    method: 'GET',
                    cache: 'no-store'
                });
                
                const result = await response.json();
                
                if (result.success && result.results && result.results.length > 0) {
                    console.log('[loadAndDisplayFreeUserScanResults] æ‰¾åˆ°æ‰«æç»“æœ:', result.results.length, 'ç»„');
                    displayScanResultsCharts(result.results);
                } else {
                    console.log('[loadAndDisplayFreeUserScanResults] æš‚æ— æ‰«æç»“æœ');
                    const container = document.getElementById('stocksContainer');
                    if (container) {
                        container.innerHTML = `
                            <div style="padding: 40px; text-align: center; color: #666;">
                                <h3 style="margin-bottom: 10px;">æš‚æ— æ‰«æç»“æœ</h3>
                                <p>ç³»ç»Ÿæ¯å¤©åœ¨11:30å’Œ15:00è‡ªåŠ¨æ‰«æï¼Œè¯·ç¨åå†æŸ¥çœ‹ã€‚</p>
                                <p style="font-size: 12px; color: #999; margin-top: 10px;">å½“å‰æ—¶é—´: ${result.current_time || 'æœªçŸ¥'}</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('[loadAndDisplayFreeUserScanResults] åŠ è½½æ‰«æç»“æœå¤±è´¥:', error);
                const container = document.getElementById('stocksContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #e74c3c;">
                            <h3 style="margin-bottom: 10px;">åŠ è½½å¤±è´¥</h3>
                            <p>æ— æ³•åŠ è½½æ‰«æç»“æœï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</p>
                        </div>
                    `;
                }
            }
        }
        
        // æ˜¾ç¤ºæ‰«æç»“æœå›¾è¡¨
        function displayScanResultsCharts(results) {
            const container = document.getElementById('stocksContainer');
            if (!container) {
                console.error('[displayScanResultsCharts] æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ ');
                return;
            }
            
            let html = '<div style="padding: 20px;">';
            
            // ä¸ºæ¯ä¸ªæ‰«æç»“æœåˆ›å»ºä¸€ä¸ªå›¾è¡¨
            results.forEach((resultItem, index) => {
                const result = resultItem.result;
                const candidates = result.candidates || [];
                const scanTime = resultItem.scan_time || 'æœªçŸ¥';
                const scanDate = resultItem.scan_date || 'æœªçŸ¥';
                const title = resultItem.title || `æ‰«æç»“æœ ${index + 1}`;
                
                // åˆ›å»ºå›¾è¡¨å®¹å™¨
                const chartId = `scanChart_${index}`;
                html += `
                    <div style="margin-bottom: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">
                            ğŸ“Š ${title} - æ‰«ææ—¶é—´: ${scanTime}
                        </h3>
                        <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">
                            æ‰¾åˆ° ${candidates.length} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ï¼Œæ‰«ææ€»æ•°: ${result.total_scanned || 0} åª
                        </p>
                        <div id="${chartId}" style="width: 100%; height: 500px; margin-bottom: 20px;"></div>
                        <div id="${chartId}_table"></div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // ä¸ºæ¯ä¸ªç»“æœåˆ›å»ºå›¾è¡¨
            results.forEach((resultItem, index) => {
                const chartId = `scanChart_${index}`;
                const tableId = `${chartId}_table`;
                const result = resultItem.result;
                const candidates = result.candidates || [];
                
                // åˆ›å»º ECharts å›¾è¡¨
                const chartDom = document.getElementById(chartId);
                if (chartDom && candidates.length > 0) {
                    // æ£€æŸ¥ ECharts æ˜¯å¦å·²åŠ è½½
                    if (typeof echarts === 'undefined') {
                        chartDom.innerHTML = '<div style="text-align: center; padding: 50px; color: #ff4444;">âš ï¸ EChartsåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
                        return;
                    }
                    const myChart = echarts.init(chartDom);
                    
                    // å‡†å¤‡æ•°æ®ï¼šæŒ‰åŒ¹é…åº¦ä»é«˜åˆ°ä½æ’åºï¼Œå–å‰30åªï¼ˆä¸åˆ—è¡¨å±•ç¤ºä¸Šé™ä¸€è‡´ï¼‰
                    candidates.sort((a, b) => (b.åŒ¹é…åº¦ || b.match_score || 0) - (a.åŒ¹é…åº¦ || a.match_score || 0));
                    const topCandidates = candidates.slice(0, 30);
                    const stockNames = topCandidates.map(c => c.name || c.code || 'æœªçŸ¥');
                    const matchScores = topCandidates.map(c => (c.match_score || 0) * 100);
                    const buyPrices = topCandidates.map(c => c.buy_price || 0);
                    
                    const option = {
                        title: {
                            text: `${resultItem.title} - Top ${topCandidates.length}`,
                            left: 'center',
                            textStyle: { fontSize: 16 }
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            formatter: function(params) {
                                const dataIndex = params[0].dataIndex;
                                const candidate = topCandidates[dataIndex];
                                let html = `<strong>${candidate.name || candidate.code}</strong><br/>`;
                                html += `åŒ¹é…åº¦: ${((candidate.match_score || 0) * 100).toFixed(2)}%<br/>`;
                                html += `ä¹°ç‚¹ä»·æ ¼: ${(candidate.buy_price || 0).toFixed(2)}å…ƒ<br/>`;
                                if (candidate.buy_date) html += `ä¹°ç‚¹æ—¥æœŸ: ${candidate.buy_date}<br/>`;
                                if (candidate.gain_10w) html += `10å‘¨æ¶¨å¹…: ${candidate.gain_10w.toFixed(2)}%`;
                                return html;
                            }
                        },
                        xAxis: {
                            type: 'category',
                            data: stockNames,
                            axisLabel: {
                                rotate: 45,
                                fontSize: 10
                            }
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: 'åŒ¹é…åº¦ (%)',
                                position: 'left',
                                axisLabel: { formatter: '{value}%' }
                            },
                            {
                                type: 'value',
                                name: 'ä¹°ç‚¹ä»·æ ¼ (å…ƒ)',
                                position: 'right',
                                axisLabel: { formatter: '{value}å…ƒ' }
                            }
                        ],
                        series: [
                            {
                                name: 'åŒ¹é…åº¦',
                                type: 'bar',
                                data: matchScores,
                                itemStyle: {
                                    color: function(params) {
                                        const score = matchScores[params.dataIndex];
                                        if (score >= 93) return '#27ae60';
                                        if (score >= 90) return '#f39c12';
                                        return '#e74c3c';
                                    }
                                }
                            },
                            {
                                name: 'ä¹°ç‚¹ä»·æ ¼',
                                type: 'line',
                                yAxisIndex: 1,
                                data: buyPrices,
                                itemStyle: { color: '#667eea' },
                                lineStyle: { width: 2 }
                            }
                        ]
                    };
                    
                    myChart.setOption(option);
                    
                    // åˆ›å»ºè¡¨æ ¼
                    const tableContainer = document.getElementById(tableId);
                    if (tableContainer) {
                        let tableHtml = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px;">';
                        tableHtml += '<tr style="background: #f0f0f0;">';
                        tableHtml += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æ’å</th>';
                        tableHtml += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è‚¡ç¥¨ä»£ç </th>';
                        tableHtml += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è‚¡ç¥¨åç§°</th>';
                        tableHtml += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">åŒ¹é…åº¦</th>';
                        tableHtml += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ä¹°ç‚¹æ—¥æœŸ</th>';
                        tableHtml += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ä¹°ç‚¹ä»·æ ¼</th>';
                        tableHtml += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">10å‘¨æ¶¨å¹…</th>';
                        tableHtml += '</tr>';
                        
                        candidates.slice(0, 30).forEach((candidate, idx) => {
                            const matchColor = (candidate.match_score || 0) >= 0.93 ? '#27ae60' : 
                                             (candidate.match_score || 0) >= 0.90 ? '#f39c12' : '#e74c3c';
                            tableHtml += '<tr>';
                            tableHtml += `<td style="padding: 8px; border: 1px solid #ddd;">${idx + 1}</td>`;
                            tableHtml += `<td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #667eea;">${candidate.code || 'N/A'}</td>`;
                            tableHtml += `<td style="padding: 8px; border: 1px solid #ddd;">${candidate.name || 'N/A'}</td>`;
                            tableHtml += `<td style="padding: 8px; border: 1px solid #ddd; color: ${matchColor}; font-weight: bold;">${((candidate.match_score || 0) * 100).toFixed(2)}%</td>`;
                            tableHtml += `<td style="padding: 8px; border: 1px solid #ddd;">${candidate.buy_date || 'N/A'}</td>`;
                            tableHtml += `<td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #e74c3c;">${(candidate.buy_price || 0).toFixed(2)}</td>`;
                            tableHtml += `<td style="padding: 8px; border: 1px solid #ddd;">${candidate.gain_10w ? candidate.gain_10w.toFixed(2) + '%' : 'N/A'}</td>`;
                            tableHtml += '</tr>';
                        });
                        
                        tableHtml += '</table>';
                        tableContainer.innerHTML = tableHtml;
                    }
                }
            });
        }
        
        // åˆ‡æ¢VIPæ‰«æå‚æ•°é¢æ¿
        function toggleVipScanParams() {
            const content = document.getElementById('vipScanParamsContent');
            const toggle = document.getElementById('vipScanParamsToggle');
            if (content && toggle) {
                if (content.style.display === 'none' || !content.style.display) {
                    content.style.display = 'block';
                    toggle.textContent = 'â–² æ”¶èµ·';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = 'â–¼ å±•å¼€';
                }
            }
        }
        
        function toggleLocalScanParams() {
            const content = document.getElementById('localScanParamsContent');
            const toggle = document.getElementById('localScanParamsToggle');
            if (content && toggle) {
                if (content.style.display === 'none' || !content.style.display) {
                    content.style.display = 'block';
                    toggle.textContent = 'â–² æ”¶èµ·';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = 'â–¼ å±•å¼€';
                }
            }
        }
        
        function toggleSuperScanParams() {
            const content = document.getElementById('superScanParamsContent');
            const toggle = document.getElementById('superScanParamsToggle');
            if (content && toggle) {
                if (content.style.display === 'none' || !content.style.display) {
                    content.style.display = 'block';
                    toggle.textContent = 'â–² æ”¶èµ·';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = 'â–¼ å±•å¼€';
                }
            }
        }
        
        // æŸ¥çœ‹VIPæ‰«æå†å²è®°å½•ï¼ˆVIPä¸“äº«åŠŸèƒ½ï¼‰
        async function viewVipScanHistory() {
            try {
                showMessage('æ­£åœ¨åŠ è½½å†å²è®°å½•...', 'success');
                
                const response = await fetch('/api/get_vip_scan_history', {
                    method: 'GET',
                    cache: 'no-store'
                });
                
                const result = await response.json();
                
                if (result.success && result.history && result.history.length > 0) {
                    const container = document.getElementById('buyPointsResult');
                    if (container) {
                        let html = '<div style="margin-top: 15px; padding: 20px; background: white; border-radius: 8px;">';
                        html += `<h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">ğŸ“š VIPæ‰«æå†å²è®°å½•ï¼ˆæœ€è¿‘30å¤©ï¼‰</h3>`;
                        html += `<p style="color: #666; font-size: 13px; margin-bottom: 20px;">å…±æ‰¾åˆ° ${result.history.length} æ¡å†å²è®°å½•</p>`;
                        
                        // æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤º
                        const historyByDate = {};
                        result.history.forEach(item => {
                            const date = item.date || 'æœªçŸ¥æ—¥æœŸ';
                            if (!historyByDate[date]) {
                                historyByDate[date] = [];
                            }
                            historyByDate[date].push(item);
                        });
                        
                        // æ˜¾ç¤ºå†å²è®°å½•
                        Object.keys(historyByDate).sort().reverse().forEach(date => {
                            const items = historyByDate[date];
                            html += `<div style="margin-bottom: 30px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #9b59b6;">`;
                            html += `<h4 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">ğŸ“… ${date}</h4>`;
                            
                            items.forEach((item, idx) => {
                                const time = item.completed_at || item.scan_time || 'æœªçŸ¥æ—¶é—´';
                                html += `<div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px;">`;
                                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
                                html += `<span style="font-weight: bold; color: #667eea;">æ‰«æ #${idx + 1}</span>`;
                                html += `<span style="font-size: 12px; color: #999;">${time}</span>`;
                                html += `</div>`;
                                html += `<div style="font-size: 13px; color: #666;">`;
                                html += `æ‰¾åˆ° ${item.found_count} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ï¼Œæ‰«ææ€»æ•°: ${item.total_scanned} åª`;
                                html += `</div>`;
                                
                                // æ˜¾ç¤ºå‰5åªè‚¡ç¥¨
                                if (item.candidates && item.candidates.length > 0) {
                                    html += `<div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px; font-size: 12px;">`;
                                    html += `<strong>å‰5åªè‚¡ç¥¨ï¼š</strong><br/>`;
                                    item.candidates.slice(0, 5).forEach((c, i) => {
                                        const code = c.code || c.è‚¡ç¥¨ä»£ç  || 'N/A';
                                        const name = c.name || c.è‚¡ç¥¨åç§° || 'N/A';
                                        const match = c.match_score || c.åŒ¹é…åº¦ || 0;
                                        html += `${i + 1}. ${code} ${name} (åŒ¹é…åº¦: ${(match * 100).toFixed(2)}%)<br/>`;
                                    });
                                    html += `</div>`;
                                }
                                
                                html += `</div>`;
                            });
                            
                            html += `</div>`;
                        });
                        
                        html += '</div>';
                        container.innerHTML = html;
                    }
                    showMessage(`âœ… æˆåŠŸåŠ è½½ ${result.history.length} æ¡å†å²è®°å½•`, 'success');
                } else {
                    showMessage('æš‚æ— å†å²è®°å½•', 'info');
                    const container = document.getElementById('buyPointsResult');
                    if (container) {
                        container.innerHTML = `
                            <div style="margin-top: 15px; padding: 40px; text-align: center; background: white; border-radius: 8px; color: #666;">
                                <h3 style="margin-bottom: 10px;">æš‚æ— å†å²è®°å½•</h3>
                                <p>æ‚¨è¿˜æ²¡æœ‰æ‰«æè®°å½•ï¼Œè¯·å…ˆè¿›è¡Œæ‰«æã€‚</p>
                                <p style="font-size: 12px; color: #999; margin-top: 10px;">å†å²è®°å½•ä¼šä¿å­˜7å¤©</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('æŸ¥çœ‹å†å²è®°å½•å¤±è´¥:', error);
                showMessage(`æŸ¥çœ‹å†å²è®°å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å¯¼å‡ºæ‰«æç»“æœï¼ˆVIPä¸“äº«åŠŸèƒ½ï¼‰
        async function exportScanResults(format) {
            try {
                // æ£€æŸ¥ç”¨æˆ·ç­‰çº§
                const user = await getUserInfo();
                if (!user) {
                    showMessage('è¯·å…ˆç™»å½•', 'error');
                    return;
                }
                
                const tier = user.tier || 'free';
                if (tier !== 'premium' && tier !== 'super' && !user.is_super) {
                    showMessage('å¯¼å‡ºåŠŸèƒ½ä»…é™VIPç”¨æˆ·ä½¿ç”¨', 'error');
                    showVipUpgradeModal();  // æ˜¾ç¤ºå‡çº§å¼•å¯¼
                    return;
                }
                
                showMessage(`æ­£åœ¨å¯¼å‡º${format.toUpperCase()}æ ¼å¼...`, 'success');
                
                // è·å–å½“å‰æ‰«æç»“æœ
                let candidates = [];
                
                // æ–¹æ³•1: ä»å…¨å±€å˜é‡è·å–ï¼ˆdisplayScanResultså‡½æ•°ä¿å­˜çš„ï¼‰
                if (window.currentScanResults && window.currentScanResults.candidates) {
                    candidates = window.currentScanResults.candidates;
                } else {
                    // æ–¹æ³•2: ä»DOMä¸­æå–è¡¨æ ¼æ•°æ®ï¼ˆå¦‚æœè¡¨æ ¼å­˜åœ¨ï¼‰
                    const table = document.querySelector('#buyPointsResult table');
                    if (table) {
                        const rows = table.querySelectorAll('tr');
                        rows.forEach((row, idx) => {
                            if (idx === 0) return; // è·³è¿‡è¡¨å¤´
                            const cells = row.querySelectorAll('td');
                            if (cells.length >= 6) {
                                // æå–è¡¨æ ¼æ•°æ®ï¼Œç»Ÿä¸€æ ¼å¼
                                const matchScoreText = cells[3].textContent.trim();
                                const matchScore = parseFloat(matchScoreText) || 0;
                                
                                candidates.push({
                                    'code': cells[1].textContent.trim(),
                                    'name': cells[2].textContent.trim(),
                                    'match_score': matchScore < 1 ? matchScore : matchScore / 100, // å¦‚æœæ˜¯ç™¾åˆ†æ¯”ï¼Œè½¬æ¢ä¸ºå°æ•°
                                    'buy_date': cells[4].textContent.trim(),
                                    'buy_price': parseFloat(cells[5].textContent.trim()) || 0,
                                    'current_price': cells[6] ? parseFloat(cells[6].textContent.trim()) || 0 : 0,
                                    'market_cap': cells[7] ? parseFloat(cells[7].textContent.trim()) || 0 : 0
                                });
                            }
                        });
                    }
                }
                
                if (candidates.length === 0) {
                    showMessage('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼Œè¯·å…ˆæ‰«æè‚¡ç¥¨', 'error');
                    return;
                }
                
                // è°ƒç”¨å¯¼å‡ºAPI
                const response = await fetch('/api/export_scan_results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        format: format,
                        candidates: candidates
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'å¯¼å‡ºå¤±è´¥');
                }
                
                // è·å–æ–‡ä»¶å¹¶ä¸‹è½½
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // ä»å“åº”å¤´è·å–æ–‡ä»¶å
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `æ‰«æç»“æœ_${new Date().getTime()}.${format}`;
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                        // å¤„ç†URLç¼–ç çš„æ–‡ä»¶å
                        try {
                            filename = decodeURIComponent(filename);
                        } catch (e) {
                            // å¦‚æœè§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶å
                        }
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showMessage(`âœ… å¯¼å‡ºæˆåŠŸï¼å·²ä¸‹è½½ ${filename}`, 'success');
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡æŒ‰é’®æ˜¾ç¤ºæ›´æ–°ï¼ˆä¸ç­‰å¾…å¼‚æ­¥æ“ä½œï¼‰
        (function() {
            const isLocal = isLocalEnvironment();
            const localButtons = document.getElementById('localVersionButtons');
            const webButtons = document.getElementById('webVersionButtons');
            const reversalSection = document.getElementById('reversalStockSection');
            
            console.log('[ç«‹å³æ‰§è¡Œ] ç¯å¢ƒæ£€æµ‹:', {
                hostname: window.location.hostname,
                isLocal: isLocal,
                localButtons: !!localButtons,
                webButtons: !!webButtons
            });
            
            if (isLocal && localButtons) {
                localButtons.style.display = 'block';
                console.log('[ç«‹å³æ‰§è¡Œ] æœ¬åœ°æŒ‰é’®å·²æ˜¾ç¤º');
            }
            if (isLocal && reversalSection) {
                reversalSection.style.display = 'block';
                console.log('[ç«‹å³æ‰§è¡Œ] åè½¬ä¸ªè‚¡åŠŸèƒ½å·²æ˜¾ç¤º');
            }
            // æ˜¾ç¤ºKDJæ¨¡å¼åŠŸèƒ½ï¼ˆæœ¬åœ°ç¯å¢ƒï¼‰
            const kdjSection = document.getElementById('kdjModeSection');
            if (isLocal && kdjSection) {
                kdjSection.style.display = 'block';
                console.log('[ç«‹å³æ‰§è¡Œ] KDJæ¨¡å¼åŠŸèƒ½å·²æ˜¾ç¤º');
            }
            if (!isLocal && webButtons) {
                webButtons.style.display = 'block';
            }
        })();
        
        // å¤šç§æ–¹å¼ç¡®ä¿é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        try {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('[initPageLoad] DOMContentLoadedäº‹ä»¶è§¦å‘');
                    setTimeout(initPageLoad, 50);
                });
            } else {
                // DOMå·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³æ‰§è¡Œ
                console.log('[initPageLoad] DOMå·²åŠ è½½å®Œæˆï¼Œç«‹å³åˆå§‹åŒ–');
                setTimeout(initPageLoad, 50);
            }
        } catch (error) {
            console.error('[initPageLoad] è®¾ç½®äº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', error);
        }
        
        // æ‰€æœ‰ç”¨æˆ·éƒ½ä¸è‡ªåŠ¨åˆ·æ–°ï¼Œåªæœ‰ç”¨æˆ·æœ‰éœ€æ±‚æ—¶æ‰æ‰‹åŠ¨åˆ·æ–°
        // æœ¬åœ°ç¯å¢ƒï¼šæä¾›æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®ï¼ˆç”¨æˆ·ç‚¹å‡»æ—¶åˆ·æ–°ï¼‰
        // ç½‘ç»œç¯å¢ƒï¼šæ‰€æœ‰ç”¨æˆ·éƒ½éœ€è¦æ‰‹åŠ¨åˆ·æ–°
        console.log('[å®šæ—¶åˆ·æ–°] å·²ç¦ç”¨è‡ªåŠ¨åˆ·æ–°ï¼Œç”¨æˆ·éœ€è¦æ—¶æ‰‹åŠ¨åˆ·æ–°');
        
        // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ·»åŠ è¶…æ—¶æ§åˆ¶å’Œé‡è¯•æœºåˆ¶ï¼‰
        async function getUserInfo(retryCount = 0) {
            const maxRetries = 0; // âœ… ä¸é‡è¯•ï¼Œç›´æ¥è¿”å›
            // âœ… ç½‘ç»œç¯å¢ƒï¼ˆRenderï¼‰éœ€è¦æ›´é•¿è¶…æ—¶ï¼ˆ60ç§’ï¼‰ï¼Œå› ä¸ºæœåŠ¡å™¨å¯èƒ½ä¼‘çœ éœ€è¦å”¤é†’
            // âœ… æœ¬åœ°ç¯å¢ƒä½¿ç”¨çŸ­è¶…æ—¶ï¼ˆ3ç§’ï¼‰
            const timeout = isNetworkEnvironment() ? 60000 : 3000;
            
            try {
                // æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼ˆ3ç§’ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.warn(`[getUserInfo] è¯·æ±‚è¶…æ—¶ï¼ˆ${timeout/1000}ç§’ï¼‰ï¼Œè¿”å› null`);
                    controller.abort();
                }, timeout);
                
                let response;
                try {
                    console.log(`[getUserInfo] æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...`);
                    response = await fetch('/api/user_info', {
                        signal: controller.signal,
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError' || fetchError.message?.includes('aborted')) {
                        console.warn(`[getUserInfo] è¯·æ±‚è¶…æ—¶æˆ–ä¸­æ–­ï¼Œè¿”å› null`);
                        return null;
                    }
                    throw fetchError;
                }
                
                if (!response.ok) {
                    console.error(`[getUserInfo] HTTPé”™è¯¯: ${response.status}`);
                    return null;
                }
                
                const result = await response.json();
                if (result.success && result.user) {
                    console.log(`[getUserInfo] âœ… æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯`);
                    return result.user;
                }
                return null;
            } catch (error) {
                console.error(`[getUserInfo] è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:`, error);
                return null;
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆæ·»åŠ è¶…æ—¶æ§åˆ¶å’Œé”™è¯¯å¤„ç†ï¼‰
        // ç”¨æˆ·ç™»å‡º
        async function logoutUser() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('å·²é€€å‡ºç™»å½•', 'success');
                    // å»¶è¿Ÿä¸€ä¸‹å†è·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤ºæ¶ˆæ¯
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 500);
                } else {
                    showMessage(result.message || 'é€€å‡ºç™»å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                showMessage('é€€å‡ºç™»å½•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function displayUserInfo() {
            const userInfoDiv = document.getElementById('userInfoDisplay');
            if (!userInfoDiv) {
                console.warn('æ‰¾ä¸åˆ°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ');
                return;
            }
            
            // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆç½‘ç»œç¯å¢ƒæ˜¾ç¤ºæ›´è¯¦ç»†çš„æç¤ºï¼‰
            if (isNetworkEnvironment()) {
                userInfoDiv.innerHTML = '<div style="font-size: 12px; color: #666;">â³ æ­£åœ¨è¿æ¥æœåŠ¡å™¨ï¼ˆå…è´¹ç‰ˆå¯èƒ½éœ€è¦60ç§’å”¤é†’ï¼‰...</div>';
            } else {
                userInfoDiv.innerHTML = '<div style="font-size: 12px; color: #666;">åŠ è½½ä¸­...</div>';
            }
            
            try {
                // âœ… ç½‘ç»œç¯å¢ƒä½¿ç”¨é•¿è¶…æ—¶ï¼ˆ60ç§’ï¼‰ï¼Œæœ¬åœ°ç¯å¢ƒä½¿ç”¨çŸ­è¶…æ—¶ï¼ˆ3ç§’ï¼‰- ä»…å£°æ˜ä¸€æ¬¡
                const userInfoTimeout = isNetworkEnvironment() ? 60000 : 3000;
                const isLoggedIn = await Promise.race([
                    checkLoginStatus(),
                    new Promise((resolve) => setTimeout(() => {
                        console.warn(`[displayUserInfo] æ£€æŸ¥ç™»å½•çŠ¶æ€è¶…æ—¶ï¼ˆ${userInfoTimeout/1000}ç§’ï¼‰`);
                        resolve(false);
                    }, userInfoTimeout))
                ]);
                
                if (!isLoggedIn) {
                    console.warn('[displayUserInfo] ç”¨æˆ·æœªç™»å½•æˆ–æ£€æŸ¥è¶…æ—¶');
                    // âœ… æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œå…è®¸ç”¨æˆ·ç‚¹å‡»åˆ·æ–°
                    if (isNetworkEnvironment()) {
                        userInfoDiv.innerHTML = `
                            <div style="font-size: 12px; color: #e74c3c; cursor: pointer;" onclick="location.reload()" title="ç‚¹å‡»åˆ·æ–°é¡µé¢">
                                âš ï¸ æœåŠ¡å™¨å”¤é†’ä¸­ï¼Œç‚¹å‡»åˆ·æ–°é‡è¯•
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">
                                æç¤ºï¼šå…è´¹ç‰ˆæœåŠ¡å™¨ä¼‘çœ åé¦–æ¬¡è®¿é—®éœ€è¦60ç§’å”¤é†’
                            </div>
                        `;
                    } else {
                        userInfoDiv.innerHTML = `
                            <div style="font-size: 12px; color: #e74c3c; cursor: pointer;" onclick="location.reload()" title="ç‚¹å‡»åˆ·æ–°é¡µé¢">
                                åŠ è½½è¶…æ—¶ï¼Œç‚¹å‡»åˆ·æ–°
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">
                                æç¤ºï¼šå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œè¯·åˆ·æ–°é‡è¯•
                            </div>
                        `;
                    }
                    return;
                }
                
                // âœ… å¦‚æœå·²ç™»å½•ï¼Œè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ï¼ˆç½‘ç»œç¯å¢ƒä½¿ç”¨é•¿è¶…æ—¶ï¼‰
                let loginCheckResponse;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), userInfoTimeout);
                    
                    loginCheckResponse = await fetch('/api/check_login', {
                        method: 'GET',
                        signal: controller.signal,
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    console.error('[displayUserInfo] è·å–ç™»å½•çŠ¶æ€å¤±è´¥:', fetchError);
                    const isLocal = isLocalEnvironment();
                    if (isLocal) {
                        userInfoDiv.innerHTML = `
                            <div style="font-size: 12px; color: #e74c3c; cursor: pointer;" onclick="location.reload()" title="ç‚¹å‡»åˆ·æ–°é¡µé¢">
                                ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œç‚¹å‡»åˆ·æ–°
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">
                                æç¤ºï¼šè¯·æ£€æŸ¥æœ¬åœ°æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
                            </div>
                        `;
                    } else {
                        userInfoDiv.innerHTML = `
                            <div style="font-size: 12px; color: #e74c3c; cursor: pointer;" onclick="location.reload()" title="ç‚¹å‡»åˆ·æ–°é¡µé¢">
                                ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œç‚¹å‡»åˆ·æ–°
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">
                                æç¤ºï¼šå¯èƒ½æ˜¯ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é‡è¯•
                            </div>
                        `;
                    }
                    return;
                }
                
                if (!loginCheckResponse.ok) {
                    console.error('[displayUserInfo] æ£€æŸ¥ç™»å½•çŠ¶æ€HTTPé”™è¯¯:', loginCheckResponse.status);
                    const isLocal = isLocalEnvironment();
                    if (isLocal) {
                        userInfoDiv.innerHTML = `
                            <div style="font-size: 12px; color: #e74c3c; cursor: pointer;" onclick="location.reload()" title="ç‚¹å‡»åˆ·æ–°é¡µé¢">
                                æœåŠ¡å™¨é”™è¯¯ (${loginCheckResponse.status})ï¼Œç‚¹å‡»åˆ·æ–°
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">
                                æç¤ºï¼šè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æˆ–é‡å¯æœåŠ¡å™¨
                            </div>
                        `;
                    } else {
                        userInfoDiv.innerHTML = `
                            <div style="font-size: 12px; color: #e74c3c; cursor: pointer;" onclick="location.reload()" title="ç‚¹å‡»åˆ·æ–°é¡µé¢">
                                æœåŠ¡å™¨é”™è¯¯ (${loginCheckResponse.status})ï¼Œç‚¹å‡»åˆ·æ–°
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">
                                æç¤ºï¼šæœåŠ¡å™¨å¯èƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•
                            </div>
                        `;
                    }
                    return;
                }
                
                const loginCheckResult = await loginCheckResponse.json();
                
                if (!loginCheckResult.success || !loginCheckResult.logged_in) {
                    // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                    console.log('[displayUserInfo] ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
                    window.location.href = '/login';
                    return;
                }
                
                // âœ… è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¤ç”¨ä¸Šæ–¹è¶…æ—¶è®¾ç½®ï¼‰
                const user = await Promise.race([
                    getUserInfo(),
                    new Promise((resolve) => setTimeout(() => {
                        console.warn(`[displayUserInfo] è·å–ç”¨æˆ·ä¿¡æ¯è¶…æ—¶ï¼ˆ${userInfoTimeout/1000}ç§’ï¼‰`);
                        resolve(null);
                    }, userInfoTimeout))
                ]);
                if (!user) {
                    // âœ… å¦‚æœè·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    console.warn('[displayUserInfo] è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨æœªå“åº”');
                    const isLocal = isLocalEnvironment();
                    if (isLocal) {
                        userInfoDiv.innerHTML = `
                            <div style="font-size: 12px; color: #e74c3c; cursor: pointer;" onclick="location.reload()" title="ç‚¹å‡»åˆ·æ–°é¡µé¢">
                                åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»åˆ·æ–°
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">
                                æç¤ºï¼šè¯·ç¡®ä¿æœ¬åœ°æœåŠ¡å™¨å·²å¯åŠ¨
                            </div>
                        `;
                    } else {
                        userInfoDiv.innerHTML = `
                            <div style="font-size: 12px; color: #e74c3c; cursor: pointer;" onclick="location.reload()" title="ç‚¹å‡»åˆ·æ–°é¡µé¢">
                                åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»åˆ·æ–°
                            </div>
                            <div style="font-size: 10px; color: #999; margin-top: 3px;">
                                æç¤ºï¼šå¯èƒ½æ˜¯ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·åˆ·æ–°é‡è¯•
                            </div>
                        `;
                    }
                    return;
                }
                
                const tierNames = {
                    'free': 'ğŸ†“ å…è´¹ç‰ˆ',
                    'premium': 'ğŸ’ VIPä¼šå‘˜',
                    'super': 'ğŸ‘‘ è¶…çº§ç”¨æˆ·'
                };
                
                const tierName = tierNames[user.tier] || 'æœªçŸ¥';
                const username = user.username || 'æœªçŸ¥ç”¨æˆ·';
                const restrictions = user.scan_restrictions || {};
                
                let html = `<div style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">${tierName}</div>`;
                html += `<div style="font-size: 12px; color: #666; margin-bottom: 3px;">ç”¨æˆ·: ${username}</div>`;
                
                // æ˜¾ç¤ºæ‰«æé™åˆ¶ä¿¡æ¯
                if (user.tier === 'free') {
                    html += `<div style="font-size: 11px; color: #999; margin-top: 5px;">ç³»ç»Ÿæ¯å¤©15:00è‡ªåŠ¨æ‰«æ</div>`;
                    if (restrictions.current_time) {
                        html += `<div style="font-size: 10px; color: #999;">å½“å‰: ${restrictions.current_time.split(' ')[1]}</div>`;
                    }
                } else if (user.tier === 'premium') {
                    html += `<div style="font-size: 11px; color: #999; margin-top: 5px;">ğŸ’ VIPä¸“äº«ï¼šæ— é™æ¬¡æ‰«æ</div>`;
                    html += `<div style="font-size: 11px; color: #999;">ç³»ç»Ÿæ¯å¤©11:30è‡ªåŠ¨æ‰«æ</div>`;
                    if (restrictions.current_time) {
                        html += `<div style="font-size: 10px; color: #999;">å½“å‰: ${restrictions.current_time.split(' ')[1]}</div>`;
                    }
                } else if (user.tier === 'super') {
                    html += `<div style="font-size: 11px; color: #999; margin-top: 5px;">æ— é™åˆ¶è®¿é—®</div>`;
                }
                
                // æ·»åŠ ç™»å‡ºæŒ‰é’®
                html += `<div style="margin-top: 10px;">
                    <button onclick="logoutUser()" style="background: #95a5a6; color: white; border: none; padding: 6px 15px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: normal; transition: all 0.3s;" onmouseover="this.style.background='#7f8c8d'" onmouseout="this.style.background='#95a5a6'">
                        é€€å‡ºç™»å½•
                    </button>
                </div>`;
                
                userInfoDiv.innerHTML = html;
            } catch (error) {
                console.error('æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                const isLocal = isLocalEnvironment();
                if (isLocal) {
                    userInfoDiv.innerHTML = `
                        <div style="font-size: 12px; color: #e74c3c; cursor: pointer;" onclick="location.reload()" title="ç‚¹å‡»åˆ·æ–°é¡µé¢">
                            åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»åˆ·æ–°é‡è¯•
                        </div>
                        <div style="font-size: 10px; color: #999; margin-top: 3px;">
                            é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'} | æç¤ºï¼šè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
                        </div>
                    `;
                } else {
                    userInfoDiv.innerHTML = `
                        <div style="font-size: 12px; color: #e74c3c; cursor: pointer;" onclick="location.reload()" title="ç‚¹å‡»åˆ·æ–°é¡µé¢">
                            åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»åˆ·æ–°é‡è¯•
                        </div>
                        <div style="font-size: 10px; color: #999; margin-top: 3px;">
                            æç¤ºï¼šæœåŠ¡å™¨å¯èƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚å¦‚é—®é¢˜æŒç»­ï¼Œè¯·è”ç³»å®¢æœ
                        </div>
                    `;
                }
            }
        }
        
        // Vercel åˆ†æ‰¹æ‰«æï¼šè‡ªåŠ¨ç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹æ¬¡
        async function autoContinueScan(scanId, currentBatch, totalBatches) {
            if (!scanId || currentBatch >= totalBatches) {
                console.log('æ‰€æœ‰æ‰¹æ¬¡å·²å®Œæˆ');
                return;
            }
            
            // æ ¹æ®ç”¨æˆ·ç­‰çº§è·å–å»¶è¿Ÿæ—¶é—´
            const userInfo = await getUserInfo();
            const batchDelay = userInfo?.scan_config?.batch_delay || 3; // é»˜è®¤3ç§’ï¼ˆå…è´¹ç‰ˆï¼‰
            await new Promise(resolve => setTimeout(resolve, batchDelay * 1000));
            
            try {
                console.log(`å¼€å§‹å¤„ç†ç¬¬ ${currentBatch + 1}/${totalBatches} æ‰¹...`);
                console.log(`è°ƒç”¨ /api/continue_scanï¼Œscan_id: ${scanId}`);
                
                const response = await fetch('/api/continue_scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',  // ç¡®ä¿æºå¸¦cookieå’Œsession
                    body: JSON.stringify({
                        scan_id: scanId
                    })
                });
                
                // è¯¦ç»†è®°å½•å“åº”ä¿¡æ¯
                console.log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    // å°è¯•è§£æé”™è¯¯å“åº”
                    let errorMessage = `HTTPé”™è¯¯: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                        console.error('é”™è¯¯å“åº”:', errorData);
                    } catch (e) {
                        const errorText = await response.text();
                        console.error('é”™è¯¯å“åº”æ–‡æœ¬:', errorText);
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                console.log(`ç¬¬ ${currentBatch + 1} æ‰¹å¤„ç†ç»“æœ:`, result);
                
                if (result.success) {
                    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                    if (result.progress) {
                        // æ›´æ–° scan_idï¼ˆå¦‚æœå“åº”ä¸­æä¾›äº†ï¼Œè¯´æ˜å¯èƒ½æœ‰æ›´æ–°ï¼‰
                        if (result.progress.scan_id && result.progress.scan_id !== scanId) {
                            console.warn(`[autoContinueScan] scan_id å·²æ›´æ–°: ${scanId} -> ${result.progress.scan_id}`);
                            scanId = result.progress.scan_id; // ä½¿ç”¨æ–°çš„ scan_id
                        }
                        
                        updateProgress(
                            result.progress.percentage || 0,
                            result.progress.status || 'è¿›è¡Œä¸­',
                            result.progress.detail || `æ­£åœ¨å¤„ç†ç¬¬ ${currentBatch + 1}/${totalBatches} æ‰¹...`
                        );
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ‰¹æ¬¡
                    if (result.has_more && !result.is_complete) {
                        // ç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹æ¬¡ï¼ˆä½¿ç”¨æ›´æ–°åçš„ scanIdï¼‰
                        window.currentScanBatch = currentBatch + 1;
                        // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œç¡®ä¿è¿›åº¦å·²ä¿å­˜åˆ° Redis
                        await new Promise(resolve => setTimeout(resolve, 500));
                        autoContinueScan(scanId, currentBatch + 1, totalBatches);
                    } else if (result.is_complete) {
                        // æ‰€æœ‰æ‰¹æ¬¡å®Œæˆ
                        console.log('æ‰€æœ‰æ‰¹æ¬¡å¤„ç†å®Œæˆï¼');
                        const foundCount = result.progress?.found || 0;
                        const totalScanned = result.progress?.total_scanned || result.progress?.scanned || 0;
                        if (foundCount > 0) {
                            showMessage(`æ‰«æå®Œæˆï¼å…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ ${foundCount} åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶`, 'success');
                        } else {
                            showMessage(`æ‰«æå®Œæˆï¼å…±æ‰«æ ${totalScanned} åªè‚¡ç¥¨ï¼Œå…±æœ‰ 0 åªè‚¡ç¥¨ç¬¦åˆæ¡ä»¶`, 'warning');
                        }
                        hideProgress();
                        stopProgressPolling();
                        const stopBtn = document.getElementById('stopScanBtn');
                        if (stopBtn) stopBtn.disabled = true;
                        
                        // é‡ç½®æ‰«ææ ‡å¿—
                        if (typeof isScanning !== 'undefined') {
                            isScanning = false;
                        }
                        
                        // ã€ä¸å¯å˜ã€‘è¿‡ç¨‹ä¸æœ€åä¸€è‡´ï¼šæœ‰ _liveScanCandidateMap æ—¶ä¸è¦†ç›–ï¼›ä»…å½“ç¼“å­˜ä¸ºç©ºæ—¶æ‰ä» get_scan_results æ‹‰å–å¹¶ MERGE å updateLiveScanResultsã€‚è§ æ‰«ææ˜¾ç¤ºä¸å¯å˜é€»è¾‘.md
                        const cachedCount = window._liveScanCandidateMap ? Object.keys(window._liveScanCandidateMap).length : 0;
                        if (cachedCount === 0) {
                            // å¦‚æœç¼“å­˜ä¸ºç©ºï¼Œå°è¯•ä»åç«¯è·å–
                            console.log('[æ‰¹æ¬¡å®Œæˆ] ç¼“å­˜ä¸ºç©ºï¼Œå°è¯•ä»åç«¯è·å–æœ€ç»ˆç»“æœ...');
                            try {
                                const resultsResponse = await fetch('/api/get_scan_results', { cache: 'no-store' });
                                const resultsResult = await resultsResponse.json();
                                if (resultsResult.success && resultsResult.candidates && resultsResult.candidates.length > 0) {
                                    // å°†ç»“æœåŒæ­¥åˆ°ç¼“å­˜
                                    if (!window._liveScanCandidateMap) window._liveScanCandidateMap = {};
                                    for (const c of resultsResult.candidates) {
                                        const code = c.è‚¡ç¥¨ä»£ç  || c.code || '';
                                        const date = c.æœ€ä½³ä¹°ç‚¹æ—¥æœŸ || c.buy_date || '';
                                        if (!code) continue;
                                        const key = `${code}__${date}`;
                                        window._liveScanCandidateMap[key] = c;
                                    }
                                    // ä½¿ç”¨ updateLiveScanResults æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯ displayScanResults
                                    updateLiveScanResults({
                                        status: 'å®Œæˆ',
                                        found: resultsResult.found_count || resultsResult.candidates.length,
                                        current: resultsResult.total_scanned || 0,
                                        total: resultsResult.total_scanned || 0,
                                        candidates: resultsResult.candidates
                                    });
                                } else {
                                    // åç«¯ä¹Ÿæ²¡æœ‰ç»“æœï¼Œä½†å®æ—¶ç»“æœå¯èƒ½å·²ç»æ˜¾ç¤ºäº†ï¼Œä¸è¦†ç›–
                                    console.log('[æ‰¹æ¬¡å®Œæˆ] åç«¯ä¹Ÿæ²¡æœ‰ç»“æœï¼Œä¿æŒå½“å‰æ˜¾ç¤º');
                                }
                            } catch (error) {
                                console.error('è·å–æ‰«æç»“æœå¤±è´¥:', error);
                            }
                        } else {
                            console.log(`[æ‰¹æ¬¡å®Œæˆ] å®æ—¶ç¼“å­˜å·²æœ‰ ${cachedCount} åªè‚¡ç¥¨ï¼Œä¸è¦†ç›–æ˜¾ç¤º`);
                        }
                        
                        // åˆ·æ–°è‚¡ç¥¨åˆ—è¡¨
                        loadStocks();
                    }
                } else {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ‰«æä»»åŠ¡ä¸¢å¤±çš„é”™è¯¯
                    if (result.error_code === 'SCAN_NOT_FOUND') {
                        throw new Error(`æ‰¾ä¸åˆ°æ‰«æä»»åŠ¡ï¼ˆscan_id: ${scanId}ï¼‰ã€‚å¯èƒ½åŸå› ï¼š1) æ•°æ®å·²è¿‡æœŸï¼ˆè¶…è¿‡24å°æ—¶ï¼‰ 2) ä»»åŠ¡å·²åˆ é™¤ 3) Redisè¿æ¥é—®é¢˜ã€‚éƒ¨åˆ†ç»“æœå¯èƒ½å·²ä¿å­˜ï¼Œè¯·æŸ¥çœ‹æ‰«æç»“æœã€‚å¦‚éœ€è¦ï¼Œè¯·é‡æ–°å¼€å§‹æ‰«æã€‚`);
                    }
                    throw new Error(result.message || 'å¤„ç†æ‰¹æ¬¡å¤±è´¥');
                }
            } catch (error) {
                console.error(`å¤„ç†ç¬¬ ${currentBatch + 1} æ‰¹å¤±è´¥:`, error);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ 404ã€400 æˆ–æ‰«æä»»åŠ¡ä¸¢å¤±é”™è¯¯
                const isNotFoundError = error.message && (
                    error.message.includes('404') || 
                    error.message.includes('400') ||
                    error.message.includes('SCAN_NOT_FOUND') ||
                    error.message.includes('æ‰¾ä¸åˆ°æ‰«æä»»åŠ¡') ||
                    error.message.includes('æ•°æ®å·²è¿‡æœŸ')
                );
                
                if (isNotFoundError) {
                    const errorMsg = error.message.includes('æ‰¾ä¸åˆ°æ‰«æä»»åŠ¡') || error.message.includes('SCAN_NOT_FOUND') || error.message.includes('æ•°æ®å·²è¿‡æœŸ')
                        ? `æ‰«æä»»åŠ¡å·²ä¸¢å¤±ï¼ˆå¯èƒ½æ•°æ®å·²è¿‡æœŸï¼Œè¶…è¿‡24å°æ—¶ï¼‰ã€‚å·²å¤„ç† ${currentBatch}/${totalBatches} æ‰¹ã€‚è¯·é‡æ–°å¼€å§‹æ‰«æã€‚`
                        : `å¤„ç†ç¬¬ ${currentBatch + 1} æ‰¹å¤±è´¥ï¼ˆ${error.message}ï¼‰ã€‚å¯èƒ½åŸå› ï¼šæ•°æ®å·²è¿‡æœŸæˆ–ä»»åŠ¡å·²åˆ é™¤ã€‚è¯·é‡æ–°å¼€å§‹æ‰«æã€‚`;
                    
                    showMessage(errorMsg, 'error');
                    hideProgress();
                    stopProgressPolling();
                    const stopBtn = document.getElementById('stopScanBtn');
                    if (stopBtn) stopBtn.disabled = true;
                    
                    // é‡ç½®æ‰«ææ ‡å¿—
                    if (typeof isScanning !== 'undefined') {
                        isScanning = false;
                    }
                    
                    // å¦‚æœå·²ç»å¤„ç†äº†ä¸€äº›æ‰¹æ¬¡ï¼Œæç¤ºç”¨æˆ·å¯ä»¥æŸ¥çœ‹éƒ¨åˆ†ç»“æœ
                    if (currentBatch > 0) {
                        console.log('éƒ¨åˆ†ç»“æœå·²ä¿å­˜ï¼Œå¯ä»¥å°è¯•æŸ¥çœ‹æ‰«æç»“æœ');
                        showMessage('éƒ¨åˆ†ç»“æœå·²ä¿å­˜ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å·²æ‰«æçš„ç»“æœ', 'info');
                    }
                    return; // åœæ­¢ç»§ç»­å¤„ç†
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é”™è¯¯ï¼ˆ401ï¼‰
                if (error.message && error.message.includes('401')) {
                    showMessage('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    // é‡ç½®æ‰«ææ ‡å¿—
                    if (typeof isScanning !== 'undefined') {
                        isScanning = false;
                    }
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }
                
                // å…¶ä»–é”™è¯¯ï¼Œå°è¯•é‡è¯•
                console.warn(`å¤„ç†ç¬¬ ${currentBatch + 1} æ‰¹å¤±è´¥: ${error.message}ï¼Œ5ç§’åé‡è¯•...`);
                showMessage(`å¤„ç†ç¬¬ ${currentBatch + 1} æ‰¹å¤±è´¥: ${error.message}ï¼Œæ­£åœ¨é‡è¯•...`, 'warning');
                
                // å°è¯•ç»§ç»­ä¸‹ä¸€æ‰¹æ¬¡ï¼ˆå¦‚æœå¯èƒ½ï¼Œä¸”ä¸æ˜¯è‡´å‘½é”™è¯¯ï¼‰ï¼Œå¢åŠ é‡è¯•å»¶è¿Ÿä»¥æé«˜ç¨³å®šæ€§
                if (currentBatch + 1 < totalBatches) {
                    console.log(`5ç§’åé‡è¯•ç¬¬ ${currentBatch + 2} æ‰¹...`);
                    setTimeout(() => autoContinueScan(scanId, currentBatch + 1, totalBatches), 5000);
                } else {
                    // å¦‚æœæ˜¯æœ€åä¸€æ‰¹ï¼Œåœæ­¢å¤„ç†
                    console.error('æ— æ³•ç»§ç»­å¤„ç†ï¼Œåœæ­¢æ‰«æ');
                    showMessage(`æ‰«æå¤±è´¥: ${error.message}`, 'error');
                    hideProgress();
                    stopProgressPolling();
                    const stopBtn = document.getElementById('stopScanBtn');
                    if (stopBtn) stopBtn.disabled = true;
                    
                    // é‡ç½®æ‰«ææ ‡å¿—
                    if (typeof isScanning !== 'undefined') {
                        isScanning = false;
                    }
                }
            }
        }
        
        // æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
        async function displayVersionInfo() {
            try {
                const response = await fetch('/api/version', {
                    method: 'GET',
                    cache: 'no-store'
                });
                const version = await response.json();
                
                if (version.success) {
                    const versionDiv = document.getElementById('versionInfo');
                    if (versionDiv) {
                        const env = version.environment === 'vercel' ? 'ğŸŒ ç½‘ç»œç‰ˆ' : 'ğŸ’» æœ¬åœ°ç‰ˆ';
                        const sha = version.commit_short || 'unknown';
                        const message = version.commit_message || 'unknown';
                        versionDiv.innerHTML = `
                            <div style="font-size: 11px; color: #999; text-align: center; padding: 10px; border-top: 1px solid #eee; margin-top: 20px;">
                                ${env} | Commit: <code style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px;">${sha}</code>
                                ${message !== 'unknown' ? `| ${message.substring(0, 30)}${message.length > 30 ? '...' : ''}` : ''}
                            </div>
                        `;
                        console.log('[ç‰ˆæœ¬ä¿¡æ¯]', version);
                    }
                }
            } catch (error) {
                console.error('[ç‰ˆæœ¬ä¿¡æ¯] è·å–å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', displayVersionInfo);
        } else {
            displayVersionInfo();
        }
        
        // ä¸ªè‚¡æ·±åº¦åˆ†æåŠŸèƒ½ï¼ˆVIPä¸“äº«ï¼‰
        async function analyzeStockDetail(stockCode, stockName, buyDate, buyPrice, matchScore) {
            try {
                // æ£€æŸ¥ç”¨æˆ·ç­‰çº§ï¼ˆä»…VIPå’Œè¶…çº§ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ·±åº¦åˆ†æï¼‰
                const user = await getUserInfo();
                if (!user || (user.tier !== 'premium' && user.tier !== 'super' && !user.is_super)) {
                    showMessage('ä¸ªè‚¡æ·±åº¦åˆ†æåŠŸèƒ½ä»…é™VIPç”¨æˆ·ä½¿ç”¨', 'error');
                    showVipUpgradeModal();  // æ˜¾ç¤ºå‡çº§å¼•å¯¼
                    return;
                }
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modal = document.getElementById('stockDetailModal');
                const content = document.getElementById('stockDetailContent');
                const title = document.getElementById('stockDetailTitle');
                
                if (!modal || !content || !title) {
                    showMessage('æ·±åº¦åˆ†æç•Œé¢åŠ è½½å¤±è´¥', 'error');
                    return;
                }
                
                modal.style.display = 'block';
                title.textContent = `ğŸ”¬ ${stockName} (${stockCode}) æ·±åº¦åˆ†æ`;
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <p>æ­£åœ¨åŠ è½½æ·±åº¦åˆ†ææ•°æ®...</p>
                    </div>
                `;
                
                // è°ƒç”¨APIè·å–æ·±åº¦åˆ†ææ•°æ®
                const response = await fetch('/api/analyze_stock_detail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        stock_code: stockCode,
                        stock_name: stockName,
                        buy_date: buyDate,
                        buy_price: buyPrice,
                        match_score: matchScore
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayStockDetailContent(result);
                } else {
                    content.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #e74c3c;">
                            <h3>âŒ åˆ†æå¤±è´¥</h3>
                            <p>${result.message || 'æ— æ³•è·å–æ·±åº¦åˆ†ææ•°æ®'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æ·±åº¦åˆ†æå¤±è´¥:', error);
                const content = document.getElementById('stockDetailContent');
                if (content) {
                    content.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #e74c3c;">
                            <h3>âŒ åˆ†æå¤±è´¥</h3>
                            <p>${error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'}</p>
                        </div>
                    `;
                }
            }
        }
        
        // æ˜¾ç¤ºæ·±åº¦åˆ†æå†…å®¹
        function displayStockDetailContent(result) {
            const content = document.getElementById('stockDetailContent');
            if (!content) return;
            
            const data = result.data || {};
            const features = data.features || {};
            const matchDetails = data.match_details || {};
            const predictions = data.predictions || {};
            const klineData = data.kline_data || null;
            
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">ğŸ“Š åŸºæœ¬ä¿¡æ¯</h3>
                        <table style="width: 100%; font-size: 13px;">
                            <tr><td style="padding: 5px; color: #666;">è‚¡ç¥¨ä»£ç ï¼š</td><td style="padding: 5px; font-weight: bold;">${data.stock_code || 'N/A'}</td></tr>
                            <tr><td style="padding: 5px; color: #666;">è‚¡ç¥¨åç§°ï¼š</td><td style="padding: 5px; font-weight: bold;">${data.stock_name || 'N/A'}</td></tr>
                            <tr><td style="padding: 5px; color: #666;">åŒ¹é…åº¦ï¼š</td><td style="padding: 5px; font-weight: bold; color: ${(data.match_score || 0) >= 0.93 ? '#27ae60' : '#f39c12'};">${((data.match_score || 0) * 100).toFixed(2)}%</td></tr>
                            <tr><td style="padding: 5px; color: #666;">æœ€ä½³ä¹°ç‚¹æ—¥æœŸï¼š</td><td style="padding: 5px;">${data.buy_date || 'N/A'}</td></tr>
                            <tr><td style="padding: 5px; color: #666;">æœ€ä½³ä¹°ç‚¹ä»·æ ¼ï¼š</td><td style="padding: 5px; font-weight: bold; color: #e74c3c;">${(data.buy_price || 0).toFixed(2)} å…ƒ</td></tr>
                            ${data.current_price ? `<tr><td style="padding: 5px; color: #666;">å½“å‰ä»·æ ¼ï¼š</td><td style="padding: 5px;">${data.current_price.toFixed(2)} å…ƒ</td></tr>` : ''}
                            ${data.market_cap ? `<tr><td style="padding: 5px; color: #666;">å¸‚å€¼ï¼š</td><td style="padding: 5px;">${data.market_cap.toFixed(2)} äº¿å…ƒ</td></tr>` : ''}
                        </table>
                    </div>
                    
                    <!-- æ¶¨è·Œå¹…é¢„æµ‹ -->
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">ğŸ’¹ æ¶¨è·Œå¹…é¢„æµ‹</h3>
                        <table style="width: 100%; font-size: 13px;">
                            ${predictions.gain_4w !== undefined ? `<tr><td style="padding: 5px; color: #666;">4å‘¨æ¶¨å¹…ï¼š</td><td style="padding: 5px; font-weight: bold; color: ${predictions.gain_4w > 0 ? '#27ae60' : '#e74c3c'};">${predictions.gain_4w > 0 ? '+' : ''}${predictions.gain_4w.toFixed(2)}%</td></tr>` : ''}
                            ${predictions.gain_10w !== undefined ? `<tr><td style="padding: 5px; color: #666;">10å‘¨æ¶¨å¹…ï¼š</td><td style="padding: 5px; font-weight: bold; color: ${predictions.gain_10w > 0 ? '#27ae60' : '#e74c3c'};">${predictions.gain_10w > 0 ? '+' : ''}${predictions.gain_10w.toFixed(2)}%</td></tr>` : ''}
                            ${predictions.gain_20w !== undefined ? `<tr><td style="padding: 5px; color: #666;">20å‘¨æ¶¨å¹…ï¼š</td><td style="padding: 5px; font-weight: bold; color: ${predictions.gain_20w > 0 ? '#27ae60' : '#e74c3c'};">${predictions.gain_20w > 0 ? '+' : ''}${predictions.gain_20w.toFixed(2)}%</td></tr>` : ''}
                            ${predictions.max_gain_10w !== undefined ? `<tr><td style="padding: 5px; color: #666;">10å‘¨æœ€å¤§æ¶¨å¹…ï¼š</td><td style="padding: 5px; font-weight: bold; color: #27ae60;">+${predictions.max_gain_10w.toFixed(2)}%</td></tr>` : ''}
                            ${predictions.stop_loss_price !== undefined ? `<tr><td style="padding: 5px; color: #666;">æ­¢æŸä»·æ ¼ï¼š</td><td style="padding: 5px; font-weight: bold; color: #e74c3c;">${predictions.stop_loss_price.toFixed(2)} å…ƒ</td></tr>` : ''}
                            ${predictions.best_sell_price !== undefined ? `<tr><td style="padding: 5px; color: #666;">æœ€ä½³å–ç‚¹ä»·æ ¼ï¼š</td><td style="padding: 5px; font-weight: bold; color: #27ae60;">${predictions.best_sell_price.toFixed(2)} å…ƒ</td></tr>` : ''}
                            ${predictions.best_sell_date ? `<tr><td style="padding: 5px; color: #666;">æœ€ä½³å–ç‚¹æ—¥æœŸï¼š</td><td style="padding: 5px;">${predictions.best_sell_date}</td></tr>` : ''}
                        </table>
                    </div>
                </div>
                
                <!-- è¯¦ç»†ç‰¹å¾åˆ†æ -->
                <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">ğŸ”¬ è¯¦ç»†ç‰¹å¾åˆ†æ</h3>
                    <div id="featuresDetail" style="font-size: 13px;">
                        <!-- ç‰¹å¾åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            `;
            
            // ç”Ÿæˆç‰¹å¾åˆ—è¡¨
            if (matchDetails.all_features_match && Object.keys(matchDetails.all_features_match).length > 0) {
                html += `
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">â­ ç‰¹å¾åŒ¹é…è¯¦æƒ…ï¼ˆæŒ‰åŒ¹é…åº¦æ’åºï¼‰</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <tr style="background: #e0e0e0;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ç‰¹å¾åç§°</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">åŒ¹é…åº¦</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ç‰¹å¾å€¼</th>
                            </tr>
                `;
                
                // å°†ç‰¹å¾æŒ‰åŒ¹é…åº¦æ’åº
                const sortedFeatures = Object.entries(matchDetails.all_features_match || {})
                    .sort((a, b) => (b[1] || 0) - (a[1] || 0));
                
                for (const [featureName, matchScore] of sortedFeatures) {
                    const featureValue = features[featureName] !== undefined ? features[featureName] : 'N/A';
                    const score = (matchScore || 0) * 100;
                    const color = score >= 90 ? '#27ae60' : score >= 80 ? '#f39c12' : '#e74c3c';
                    const isCore = matchDetails.core_features_match && featureName in matchDetails.core_features_match;
                    html += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${isCore ? 'â­ ' : ''}${featureName}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: ${color}; font-weight: bold;">${score.toFixed(2)}%</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${typeof featureValue === 'number' ? featureValue.toFixed(4) : featureValue}</td>
                        </tr>
                    `;
                }
                
                html += '</table></div>';
            }
            
            // å¦‚æœæœ‰Kçº¿æ•°æ®ï¼Œæ˜¾ç¤ºKçº¿å›¾ï¼ˆç®€åŒ–ç‰ˆï¼Œåç»­å¯ä»¥å¢å¼ºï¼‰
            if (klineData) {
                html += `
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">ğŸ“‰ Kçº¿å›¾ï¼ˆä¹°ç‚¹ä½ç½®ï¼‰</h3>
                        <div id="klineChart" style="width: 100%; height: 400px;"></div>
                        <p style="margin-top: 10px; font-size: 12px; color: #666;">æ³¨ï¼šKçº¿å›¾å¢å¼ºåŠŸèƒ½ï¼ˆæ”¯æ’‘ä½/é˜»åŠ›ä½ã€æŠ€æœ¯æŒ‡æ ‡ï¼‰æ­£åœ¨å¼€å‘ä¸­</p>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            
            // å¦‚æœæœ‰Kçº¿æ•°æ®ï¼Œç»˜åˆ¶Kçº¿å›¾ï¼ˆä½¿ç”¨EChartsï¼‰
            if (klineData) {
                if (typeof echarts === 'undefined') {
                    const klineChartDom = document.getElementById('klineChart');
                    if (klineChartDom) {
                        klineChartDom.innerHTML = '<div style="text-align: center; padding: 50px; color: #ff4444;">âš ï¸ EChartsåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
                    }
                    return;
                }
                setTimeout(() => {
                    const klineChartDom = document.getElementById('klineChart');
                    if (klineChartDom) {
                        const klineChart = echarts.init(klineChartDom);
                        // è¿™é‡Œå¯ä»¥æ·»åŠ Kçº¿å›¾çš„è¯¦ç»†é…ç½®
                        // æš‚æ—¶ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬
                        klineChart.setOption({
                            title: {
                                text: `${data.stock_name || data.stock_code} Kçº¿å›¾`,
                                left: 'center'
                            },
                            tooltip: {
                                trigger: 'axis'
                            },
                            xAxis: {
                                type: 'category',
                                data: klineData.dates || []
                            },
                            yAxis: {
                                type: 'value',
                                scale: true
                            },
                            series: [{
                                type: 'candlestick',
                                data: klineData.values || []
                            }]
                        });
                    }
                }, 100);
            }
        }
        
        // å…³é—­æ·±åº¦åˆ†ææ¨¡æ€æ¡†
        function closeStockDetailModal() {
            const modal = document.getElementById('stockDetailModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('stockDetailModal');
            if (modal && event.target === modal) {
                closeStockDetailModal();
            }
            const watchlistModal = document.getElementById('watchlistModal');
            if (watchlistModal && event.target === watchlistModal) {
                closeWatchlistModal();
            }
        });
        
        // å…³æ³¨åˆ—è¡¨å’Œä»·æ ¼é¢„è­¦åŠŸèƒ½ï¼ˆVIPä¸“äº«ï¼‰
        async function addToWatchlist(stockCode, stockName, buyPrice, buyDate, matchScore) {
            try {
                // æ£€æŸ¥ç”¨æˆ·ç­‰çº§
                const user = await getUserInfo();
                if (!user || (user.tier !== 'premium' && user.tier !== 'super' && !user.is_super)) {
                    showMessage('å…³æ³¨åˆ—è¡¨åŠŸèƒ½ä»…é™VIPç”¨æˆ·ä½¿ç”¨', 'error');
                    showVipUpgradeModal();  // æ˜¾ç¤ºå‡çº§å¼•å¯¼
                    return;
                }
                
                const stockInfo = {
                    stock_code: stockCode,
                    stock_name: stockName,
                    buy_price: buyPrice,
                    buy_date: buyDate,
                    match_score: matchScore
                };
                
                const response = await fetch('/api/add_to_watchlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stock_info: stockInfo })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`${stockName} (${stockCode}) å·²æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨`, 'success');
                } else {
                    showMessage(result.message || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨å¤±è´¥:', error);
                showMessage('æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æŸ¥çœ‹å…³æ³¨åˆ—è¡¨
        async function viewWatchlist() {
            try {
                // æ£€æŸ¥ç”¨æˆ·ç­‰çº§
                const user = await getUserInfo();
                if (!user || (user.tier !== 'premium' && user.tier !== 'super' && !user.is_super)) {
                    showMessage('å…³æ³¨åˆ—è¡¨åŠŸèƒ½ä»…é™VIPç”¨æˆ·ä½¿ç”¨', 'error');
                    showVipUpgradeModal();  // æ˜¾ç¤ºå‡çº§å¼•å¯¼
                    return;
                }
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modal = document.getElementById('watchlistModal');
                const content = document.getElementById('watchlistContent');
                
                if (!modal || !content) {
                    showMessage('å…³æ³¨åˆ—è¡¨ç•Œé¢åŠ è½½å¤±è´¥', 'error');
                    return;
                }
                
                modal.style.display = 'block';
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #e67e22; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div><p>æ­£åœ¨åŠ è½½å…³æ³¨åˆ—è¡¨...</p></div>';
                
                // è·å–å…³æ³¨åˆ—è¡¨å’Œä»·æ ¼é¢„è­¦
                const [watchlistResponse, alertsResponse] = await Promise.all([
                    fetch('/api/get_watchlist', { method: 'GET', cache: 'no-store' }),
                    fetch('/api/get_price_alerts', { method: 'GET', cache: 'no-store' })
                ]);
                
                const watchlistResult = await watchlistResponse.json();
                const alertsResult = await alertsResponse.json();
                
                // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
                window.currentAlerts = alertsResult.alerts || [];
                
                displayWatchlistContent(watchlistResult, alertsResult);
            } catch (error) {
                console.error('è·å–å…³æ³¨åˆ—è¡¨å¤±è´¥:', error);
                const content = document.getElementById('watchlistContent');
                if (content) {
                    content.innerHTML = '<div style="padding: 40px; text-align: center; color: #e74c3c;"><h3>âŒ åŠ è½½å¤±è´¥</h3><p>' + (error.message || 'æ— æ³•è·å–å…³æ³¨åˆ—è¡¨æ•°æ®') + '</p></div>';
                }
            }
        }
        
        // æ˜¾ç¤ºå…³æ³¨åˆ—è¡¨å†…å®¹
        function displayWatchlistContent(watchlistResult, alertsResult) {
            const content = document.getElementById('watchlistContent');
            if (!content) return;
            
            const watchlist = watchlistResult.watchlist || [];
            const alerts = alertsResult.alerts || [];
            
            // æ„å»ºé¢„è­¦æ˜ å°„ï¼ˆè‚¡ç¥¨ä»£ç  -> é¢„è­¦ä¿¡æ¯ï¼‰
            const alertsMap = {};
            alerts.forEach(function(alert) {
                alertsMap[alert.stock_code] = alert;
            });
            
            let html = '<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;"><div style="padding: 15px; background: #f8f9fa; border-radius: 8px;"><h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">â­ æˆ‘çš„å…³æ³¨åˆ—è¡¨</h3><p style="margin: 0 0 15px 0; color: #666; font-size: 13px;">å·²å…³æ³¨ ' + watchlist.length + '/50 åªè‚¡ç¥¨</p>';
            
            if (watchlist.length === 0) {
                html += '<div style="padding: 40px; text-align: center; color: #999;">æš‚æ— å…³æ³¨çš„è‚¡ç¥¨ï¼Œè¯·ä»æ‰«æç»“æœä¸­æ·»åŠ </div>';
            } else {
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 13px;"><tr style="background: #e0e0e0;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è‚¡ç¥¨ä»£ç </th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è‚¡ç¥¨åç§°</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ä¹°ç‚¹ä»·æ ¼</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æ“ä½œ</th></tr>';
                
                watchlist.forEach(function(stock) {
                    const stockCode = stock.stock_code || stock.code || 'N/A';
                    const stockName = stock.stock_name || stock.name || 'N/A';
                    const buyPrice = stock.buy_price || 0;
                    const hasAlert = alertsMap[stockCode];
                    
                    html += '<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #667eea;">' + stockCode + '</td>';
                    html += '<td style="padding: 8px; border: 1px solid #ddd;">' + stockName + '</td>';
                    html += '<td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #e74c3c;">' + buyPrice.toFixed(2) + '</td>';
                    html += '<td style="padding: 8px; border: 1px solid #ddd;"><div style="display: flex; gap: 5px; flex-wrap: wrap;">';
                    html += '<button onclick="removeFromWatchlist(\'' + stockCode + '\')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">åˆ é™¤</button>';
                    html += '<button onclick="showPriceAlertDialog(\'' + stockCode + '\', \'' + stockName + '\')" style="background: ' + (hasAlert ? '#f39c12' : '#3498db') + '; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">' + (hasAlert ? 'ä¿®æ”¹é¢„è­¦' : 'è®¾ç½®é¢„è­¦') + '</button>';
                    html += '</div></td></tr>';
                });
                
                html += '</table>';
            }
            
            html += '</div><div style="padding: 15px; background: #f8f9fa; border-radius: 8px;"><h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">ğŸ”” ä»·æ ¼é¢„è­¦</h3><p style="margin: 0 0 15px 0; color: #666; font-size: 13px;">å·²è®¾ç½® ' + alerts.length + ' ä¸ªé¢„è­¦</p>';
            
            if (alerts.length === 0) {
                html += '<div style="padding: 20px; text-align: center; color: #999; font-size: 12px;">æš‚æ— ä»·æ ¼é¢„è­¦ï¼Œè¯·åœ¨å…³æ³¨åˆ—è¡¨ä¸­è®¾ç½®</div>';
            } else {
                html += '<div style="max-height: 400px; overflow-y: auto;">';
                alerts.forEach(function(alert) {
                    const stockCode = alert.stock_code || 'N/A';
                    const stockName = alert.stock_name || 'N/A';
                    const priceHigh = alert.price_high;
                    const priceLow = alert.price_low;
                    const triggered = alert.triggered || false;
                    const triggerType = alert.trigger_type;
                    const triggerPrice = alert.trigger_price || 0;
                    
                    html += '<div style="padding: 10px; margin-bottom: 10px; background: white; border-radius: 6px; border-left: 4px solid ' + (triggered ? '#e74c3c' : '#3498db') + ';">';
                    html += '<div style="font-weight: bold; margin-bottom: 5px; color: #333;">' + stockName + ' (' + stockCode + ')</div>';
                    if (priceHigh !== null && priceHigh !== undefined) {
                        html += '<div style="font-size: 12px; color: #666;">ä»·æ ¼ä¸Šé™: <span style="color: #e74c3c; font-weight: bold;">' + priceHigh.toFixed(2) + '</span></div>';
                    }
                    if (priceLow !== null && priceLow !== undefined) {
                        html += '<div style="font-size: 12px; color: #666;">ä»·æ ¼ä¸‹é™: <span style="color: #27ae60; font-weight: bold;">' + priceLow.toFixed(2) + '</span></div>';
                    }
                    if (triggered) {
                        html += '<div style="font-size: 12px; color: #e74c3c; font-weight: bold; margin-top: 5px;">âš ï¸ å·²è§¦å‘: ' + (triggerType === 'high' ? 'è¶…è¿‡ä¸Šé™' : 'è·Œç ´ä¸‹é™') + ' (' + triggerPrice.toFixed(2) + ')</div>';
                    }
                    html += '<button onclick="removePriceAlert(\'' + stockCode + '\')" style="background: #e74c3c; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-top: 5px;">åˆ é™¤é¢„è­¦</button>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            html += '</div></div>';
            
            content.innerHTML = html;
        }
        
        // ä»å…³æ³¨åˆ—è¡¨åˆ é™¤
        async function removeFromWatchlist(stockCode) {
            if (!confirm('ç¡®å®šè¦ä»å…³æ³¨åˆ—è¡¨åˆ é™¤ ' + stockCode + ' å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/remove_from_watchlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stock_code: stockCode })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('å·²ä»å…³æ³¨åˆ—è¡¨åˆ é™¤', 'success');
                    // åˆ·æ–°å…³æ³¨åˆ—è¡¨
                    viewWatchlist();
                } else {
                    showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å…³æ³¨åˆ—è¡¨å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºä»·æ ¼é¢„è­¦è®¾ç½®å¯¹è¯æ¡†
        function showPriceAlertDialog(stockCode, stockName) {
            const existingAlert = window.currentAlerts ? window.currentAlerts.find(function(a) { return a.stock_code === stockCode; }) : null;
            
            const priceHigh = existingAlert && existingAlert.price_high !== null && existingAlert.price_high !== undefined ? existingAlert.price_high.toString() : '';
            const priceLow = existingAlert && existingAlert.price_low !== null && existingAlert.price_low !== undefined ? existingAlert.price_low.toString() : '';
            
            const priceHighInput = prompt('è®¾ç½® ' + stockName + ' (' + stockCode + ') çš„ä»·æ ¼ä¸Šé™ï¼ˆç•™ç©ºè¡¨ç¤ºä¸è®¾ç½®ï¼‰:', priceHigh);
            if (priceHighInput === null) return; // ç”¨æˆ·å–æ¶ˆ
            
            const priceLowInput = prompt('è®¾ç½® ' + stockName + ' (' + stockCode + ') çš„ä»·æ ¼ä¸‹é™ï¼ˆç•™ç©ºè¡¨ç¤ºä¸è®¾ç½®ï¼‰:', priceLow);
            if (priceLowInput === null) return; // ç”¨æˆ·å–æ¶ˆ
            
            if (!priceHighInput && !priceLowInput) {
                showMessage('è¯·è‡³å°‘è®¾ç½®ä»·æ ¼ä¸Šé™æˆ–ä¸‹é™', 'error');
                return;
            }
            
            // è®¾ç½®ä»·æ ¼é¢„è­¦
            setPriceAlertFunction(stockCode, stockName, priceHighInput, priceLowInput);
        }
        
        // è®¾ç½®ä»·æ ¼é¢„è­¦ï¼ˆé‡å‘½åä»¥é¿å…ä¸HTMLå…ƒç´ IDå†²çªï¼‰
        async function setPriceAlertFunction(stockCode, stockName, priceHigh, priceLow) {
            try {
                const alertData = {
                    stock_code: stockCode,
                    stock_name: stockName,
                    price_high: priceHigh ? parseFloat(priceHigh) : null,
                    price_low: priceLow ? parseFloat(priceLow) : null
                };
                
                const response = await fetch('/api/set_price_alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(alertData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('ä»·æ ¼é¢„è­¦è®¾ç½®æˆåŠŸ', 'success');
                    // åˆ·æ–°å…³æ³¨åˆ—è¡¨
                    viewWatchlist();
                } else {
                    showMessage(result.message || 'è®¾ç½®å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è®¾ç½®ä»·æ ¼é¢„è­¦å¤±è´¥:', error);
                showMessage('è®¾ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ é™¤ä»·æ ¼é¢„è­¦
        async function removePriceAlert(stockCode) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»·æ ¼é¢„è­¦å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/remove_price_alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stock_code: stockCode })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('ä»·æ ¼é¢„è­¦å·²åˆ é™¤', 'success');
                    // åˆ·æ–°å…³æ³¨åˆ—è¡¨
                    viewWatchlist();
                } else {
                    showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ä»·æ ¼é¢„è­¦å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // å…³é—­å…³æ³¨åˆ—è¡¨æ¨¡æ€æ¡†
        function closeWatchlistModal() {
            const modal = document.getElementById('watchlistModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // å¯ç”¨VIPæŒ‰é’®ï¼ˆæ¢å¤æŒ‰é’®çš„æ­£å¸¸çŠ¶æ€ï¼‰
        function enableVipButtons(vipButtonsElement) {
            const buttons = vipButtonsElement.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                // æ¢å¤åŸæœ‰çš„onclick
                const originalOnclick = btn.getAttribute('data-original-onclick');
                if (originalOnclick && btn.hasAttribute('data-free-click-handled')) {
                    btn.setAttribute('onclick', originalOnclick);
                    btn.removeAttribute('data-free-click-handled');
                    btn.removeAttribute('data-original-onclick');
                    // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼ˆåˆ›å»ºæ–°èŠ‚ç‚¹æ›¿æ¢ï¼‰
                    const parent = btn.parentNode;
                    const newBtn = btn.cloneNode(true);
                    parent.replaceChild(newBtn, btn);
                }
            });
            // å¯ç”¨æ‰€æœ‰è¾“å…¥æ¡†
            const inputs = vipButtonsElement.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.disabled = false;
                input.style.opacity = '1';
                input.style.cursor = 'auto';
            });
        }
        
        // ç¦ç”¨VIPæŒ‰é’®ï¼ˆå…è´¹ç”¨æˆ·çŠ¶æ€ï¼‰
        function disableVipButtons(vipButtonsElement) {
            const buttons = vipButtonsElement.querySelectorAll('button');
            buttons.forEach(btn => {
                if (!btn.hasAttribute('data-free-click-handled')) {
                    const originalOnclick = btn.getAttribute('onclick');
                    if (originalOnclick) {
                        btn.setAttribute('data-original-onclick', originalOnclick);
                        btn.removeAttribute('onclick');
                        btn.setAttribute('data-free-click-handled', 'true');
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            showVipUpgradePrompt();
                        });
                    }
                }
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            // ç¦ç”¨æ‰€æœ‰è¾“å…¥æ¡†
            const inputs = vipButtonsElement.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.disabled = true;
                input.style.opacity = '0.5';
                input.style.cursor = 'not-allowed';
            });
        }
        
        // VIPå‡çº§ä¿¡æ¯ï¼ˆå…è´¹ç”¨æˆ·ç‚¹å‡»"å‡çº§ä¸ºVIPå®¢æˆ·"æŒ‰é’®æ—¶æ˜¾ç¤ºï¼‰
        function showVipUpgradeInfo() {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 12px; padding: 30px; max-width: 550px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative;';
            
            content.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="margin: 0 0 20px 0; color: #333; font-size: 26px; font-weight: bold;">ğŸ’ å‡çº§ä¸ºVIPå®¢æˆ·</h2>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 10px; margin-bottom: 25px; color: white;">
                        <div style="font-size: 18px; margin-bottom: 15px; font-weight: bold;">ğŸ“¦ ä»·æ ¼æ–¹æ¡ˆ</div>
                        <div style="display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap;">
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                                <div style="font-size: 14px; margin-bottom: 8px; opacity: 0.9;">åŒ…æœˆ</div>
                                <div style="font-size: 28px; font-weight: bold;">99å…ƒ</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">/æœˆ</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                                <div style="font-size: 14px; margin-bottom: 8px; opacity: 0.9;">åŒ…å¹´</div>
                                <div style="font-size: 28px; font-weight: bold;">999å…ƒ</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">/å¹´</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; text-align: left;">
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 15px;">ğŸ“± æ”¯ä»˜æ”¯ä»˜å®è´¦æˆ·ï¼š</div>
                            <div style="font-size: 20px; color: #e74c3c; font-weight: bold; word-break: break-all; text-align: center; padding: 10px; background: white; border-radius: 6px; border: 2px solid #e74c3c;">522168878@qq.com</div>
                        </div>
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 15px;">ğŸ’¬ è”ç³»æ–¹å¼ï¼š</div>
                            <div style="font-size: 16px; color: #667eea; font-weight: bold; text-align: center; padding: 10px; background: white; border-radius: 6px; border: 2px solid #667eea;">QQï¼š522168878</div>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #ffc107;">
                        <div style="color: #856404; font-size: 14px; line-height: 1.6;">
                            <strong>ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</strong><br>
                            1. è¯·é€‰æ‹©åŒ…æœˆæˆ–åŒ…å¹´å¥—é¤è¿›è¡Œæ”¯ä»˜<br>
                            2. æ‰“æ¬¾åï¼Œè¯·åŠæ—¶è”ç³»QQï¼š<strong>522168878</strong> å¼€é€šVIPæƒé™<br>
                            3. æˆ‘ä»¬ä¼šåœ¨æ”¶åˆ°ä»˜æ¬¾å24å°æ—¶å†…ä¸ºæ‚¨å¼€é€šVIPæœåŠ¡
                        </div>
                    </div>
                    
                    <button onclick="this.closest('div').parentElement.parentElement.remove()" style="background: #667eea; color: white; border: none; padding: 12px 50px; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; transition: all 0.3s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">
                        æˆ‘çŸ¥é“äº†
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // VIPå‡çº§æç¤ºï¼ˆå…è´¹ç”¨æˆ·ç‚¹å‡»ç¦ç”¨æŒ‰é’®æ—¶æ˜¾ç¤ºï¼‰
        async function showVipUpgradePrompt() {
            try {
                // è·å–æ”¯ä»˜ä¿¡æ¯
                const response = await fetch('/api/vip/payment_info', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                const alipayAccount = result.success ? (result.alipay_account || '522168878@qq.com') : '522168878@qq.com';
                const wechatAccount = result.success ? (result.wechat_account || 'è¯·ç­‰å¾…ç®¡ç†å‘˜é…ç½®') : 'è¯·ç­‰å¾…ç®¡ç†å‘˜é…ç½®';
                
                // åˆ›å»ºæ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                
                const content = document.createElement('div');
                content.style.cssText = 'background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative;';
                
                content.innerHTML = `
                    <div style="text-align: center;">
                        <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">ğŸ’ å‡çº§VIPä¼šå‘˜</h2>
                        <p style="color: #666; margin-bottom: 25px; font-size: 16px; line-height: 1.6;">
                            æ­¤åŠŸèƒ½ä¸ºVIPä¸“äº«åŠŸèƒ½ï¼Œå‡çº§VIPåå³å¯ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ã€‚
                        </p>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; text-align: left;">
                            <div style="margin-bottom: 15px;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 15px;">ğŸ“± æ”¯ä»˜å®è´¦å·ï¼š</div>
                                <div style="font-size: 18px; color: #e74c3c; font-weight: bold; word-break: break-all;">${alipayAccount}</div>
                            </div>
                            ${wechatAccount !== 'è¯·ç­‰å¾…ç®¡ç†å‘˜é…ç½®' ? `
                            <div>
                                <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 15px;">ğŸ’¬ å¾®ä¿¡è´¦å·ï¼š</div>
                                <div style="font-size: 18px; color: #07c160; font-weight: bold; word-break: break-all;">${wechatAccount}</div>
                            </div>
                            ` : ''}
                        </div>
                        <p style="color: #999; font-size: 14px; margin-bottom: 25px;">
                            ä»˜æ¬¾åè¯·è”ç³»ç®¡ç†å‘˜å¼€é€šVIPæƒé™
                        </p>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #667eea; color: white; border: none; padding: 12px 40px; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold;">
                            çŸ¥é“äº†
                        </button>
                    </div>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } catch (error) {
                console.error('æ˜¾ç¤ºVIPå‡çº§æç¤ºå¤±è´¥:', error);
                alert('æ­¤åŠŸèƒ½ä¸ºVIPä¸“äº«åŠŸèƒ½ï¼Œå‡çº§VIPåå³å¯ä½¿ç”¨ã€‚\n\næ”¯ä»˜å®è´¦å·ï¼š522168878@qq.com\n\nä»˜æ¬¾åè¯·è”ç³»ç®¡ç†å‘˜å¼€é€šVIPæƒé™ã€‚');
            }
        }
        
        // VIPå‡çº§å¼•å¯¼åŠŸèƒ½
        async function showVipUpgradeModal() {
            const modal = document.getElementById('vipUpgradeModal');
            if (modal) {
                modal.style.display = 'block';
                // åŠ è½½ä»˜æ¬¾ä¿¡æ¯
                await loadPaymentInfo();
                // æ£€æŸ¥ç”³è¯·çŠ¶æ€
                checkVipApplicationStatus();
            }
        }
        
        // åŠ è½½ä»˜æ¬¾ä¿¡æ¯
        async function loadPaymentInfo() {
            try {
                const response = await fetch('/api/vip/payment_info', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const alipayEl = document.getElementById('alipayAccount');
                    const wechatEl = document.getElementById('wechatAccount');
                    
                    if (alipayEl) {
                        alipayEl.textContent = result.alipay_account || 'è¯·ç­‰å¾…ç®¡ç†å‘˜é…ç½®';
                    }
                    if (wechatEl) {
                        wechatEl.textContent = result.wechat_account || 'è¯·ç­‰å¾…ç®¡ç†å‘˜é…ç½®';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ä»˜æ¬¾ä¿¡æ¯å¤±è´¥:', error);
                const alipayEl = document.getElementById('alipayAccount');
                const wechatEl = document.getElementById('wechatAccount');
                if (alipayEl) alipayEl.textContent = 'åŠ è½½å¤±è´¥';
                if (wechatEl) wechatEl.textContent = 'åŠ è½½å¤±è´¥';
            }
        }
        
        function closeVipUpgradeModal() {
            const modal = document.getElementById('vipUpgradeModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // æ£€æŸ¥VIPç”³è¯·çŠ¶æ€
        async function checkVipApplicationStatus() {
            try {
                const response = await fetch('/api/vip/check_application', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                
                if (result.success && result.has_application) {
                    // æ˜¾ç¤ºç”³è¯·çŠ¶æ€
                    const formDiv = document.getElementById('vipApplicationForm');
                    const statusDiv = document.getElementById('vipApplicationStatus');
                    const statusContent = document.getElementById('applicationStatusContent');
                    
                    if (formDiv && statusDiv && statusContent) {
                        formDiv.style.display = 'none';
                        statusDiv.style.display = 'block';
                        
                        const status = result.application.status;
                        const statusText = {
                            'pending': 'â³ å¾…å¤„ç†',
                            'approved': 'âœ… å·²æ‰¹å‡†',
                            'rejected': 'âŒ å·²æ‹’ç»',
                            'completed': 'âœ… å·²å®Œæˆ'
                        }[status] || 'æœªçŸ¥';
                        
                        const statusColors = {
                            'pending': '#ffc107',
                            'approved': '#28a745',
                            'rejected': '#dc3545',
                            'completed': '#28a745'
                        }[status] || '#999';
                        
                        statusContent.innerHTML = `
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 18px; font-weight: bold; color: ${statusColors}; margin-bottom: 10px;">${statusText}</div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                                    <div><strong>å¥—é¤ï¼š</strong>${result.application.plan_name}</div>
                                    <div><strong>é‡‘é¢ï¼š</strong>${result.application.amount}å…ƒ</div>
                                    <div><strong>ç”³è¯·æ—¶é—´ï¼š</strong>${new Date(result.application.created_at).toLocaleString('zh-CN')}</div>
                                </div>
                                ${status === 'pending' ? '<div style="font-size: 12px; color: #856404; background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 10px;">ğŸ’¡ æˆ‘ä»¬ä¼šåœ¨24å°æ—¶å†…å¤„ç†æ‚¨çš„ç”³è¯·ï¼Œå¹¶é€šè¿‡æ‚¨æä¾›çš„è”ç³»æ–¹å¼ä¸æ‚¨ç¡®è®¤ä»˜æ¬¾ä¿¡æ¯ã€‚</div>' : ''}
                            </div>
                        `;
                    }
                } else {
                    // æ˜¾ç¤ºç”³è¯·è¡¨å•
                    const formDiv = document.getElementById('vipApplicationForm');
                    const statusDiv = document.getElementById('vipApplicationStatus');
                    
                    if (formDiv && statusDiv) {
                        formDiv.style.display = 'block';
                        statusDiv.style.display = 'none';
                        // æ¸…ç©ºè¡¨å•
                        document.getElementById('vipContact').value = '';
                        document.getElementById('vipNote').value = '';
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥VIPç”³è¯·çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // æäº¤VIPç”³è¯·
        async function submitVipApplication() {
            const plan = document.getElementById('vipPlan').value;
            const contact = document.getElementById('vipContact').value.trim();
            const note = document.getElementById('vipNote').value.trim();
            
            if (!contact) {
                showMessage('è¯·è¾“å…¥è”ç³»æ–¹å¼ï¼ˆå¾®ä¿¡/QQ/æ‰‹æœºå·ï¼‰', 'error');
                return;
            }
            
            try {
                showMessage('æ­£åœ¨æäº¤ç”³è¯·...', 'info');
                
                const response = await fetch('/api/vip/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        plan: plan,
                        contact: contact,
                        note: note
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // åˆ·æ–°ç”³è¯·çŠ¶æ€
                    setTimeout(() => {
                        checkVipApplicationStatus();
                    }, 1000);
                } else {
                    showMessage(result.message || 'æäº¤ç”³è¯·å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æäº¤VIPç”³è¯·å¤±è´¥:', error);
                showMessage('æäº¤ç”³è¯·å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const vipModal = document.getElementById('vipUpgradeModal');
            if (event.target === vipModal) {
                closeVipUpgradeModal();
            }
            
            const watchlistModal = document.getElementById('watchlistModal');
            if (event.target === watchlistModal) {
                closeWatchlistModal();
            }
            
            const stockDetailModal = document.getElementById('stockDetailModal');
            if (event.target === stockDetailModal) {
                closeStockDetailModal();
            }
        }
    </script>
    <div id="versionInfo"></div>
    
    <!-- æ·±åº¦åˆ†ææ¨¡æ€æ¡† -->
    <div id="stockDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
        <div style="position: relative; width: 90%; max-width: 1200px; margin: 20px auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                <h2 id="stockDetailTitle" style="margin: 0; color: #333; font-size: 20px;">ğŸ”¬ ä¸ªè‚¡æ·±åº¦åˆ†æ</h2>
                <button onclick="closeStockDetailModal()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">âœ• å…³é—­</button>
            </div>
            <div id="stockDetailContent" style="min-height: 400px;">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <p>æ­£åœ¨åŠ è½½æ·±åº¦åˆ†ææ•°æ®...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å…³æ³¨åˆ—è¡¨æ¨¡æ€æ¡† -->
    <div id="watchlistModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; overflow-y: auto;">
        
    <!-- VIPå‡çº§å¼•å¯¼æ¨¡æ€æ¡† -->
    <div id="vipUpgradeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10002; overflow-y: auto;">
        <div style="position: relative; width: 90%; max-width: 900px; margin: 20px auto; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                <h2 style="margin: 0; color: #333; font-size: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ğŸ’ å‡çº§VIPä¼šå‘˜</h2>
                <button onclick="closeVipUpgradeModal()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 16px;">âœ• å…³é—­</button>
            </div>
            
            <!-- VIPåŠŸèƒ½åˆ—è¡¨ -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">âœ¨ VIPä¸“äº«åŠŸèƒ½</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">ğŸ” æ— é™æ¬¡æ‰‹åŠ¨æ‰«æ</div>
                        <div style="font-size: 12px; color: #666;">éšæ—¶éšåœ°æ‰«æå…¨å¸‚åœºï¼Œæ— æ¬¡æ•°é™åˆ¶</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">âš¡ æ‰«æé€Ÿåº¦æå‡2-3å€</div>
                        <div style="font-size: 12px; color: #666;">20-30åˆ†é’Ÿå®Œæˆå…¨å¸‚åœºæ‰«æ</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">ğŸ”¬ ä¸ªè‚¡æ·±åº¦åˆ†æ</div>
                        <div style="font-size: 12px; color: #666;">è¯¦ç»†ç‰¹å¾åˆ†æã€æ¶¨è·Œå¹…é¢„æµ‹</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">â­ å…³æ³¨åˆ—è¡¨å’Œä»·æ ¼é¢„è­¦</div>
                        <div style="font-size: 12px; color: #666;">æœ€å¤šå…³æ³¨50åªè‚¡ç¥¨ï¼Œä»·æ ¼æé†’</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">ğŸ“Š å†å²è®°å½•30å¤©</div>
                        <div style="font-size: 12px; color: #666;">æŸ¥çœ‹30å¤©å†…çš„æ‰€æœ‰æ‰«æç»“æœ</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">ğŸ“¤ æ‰«æç»“æœå¯¼å‡º</div>
                        <div style="font-size: 12px; color: #666;">Excel/CSVæ ¼å¼å¯¼å‡º</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">ğŸ¯ è‡ªå®šä¹‰æ‰«æå‚æ•°</div>
                        <div style="font-size: 12px; color: #666;">åŒ¹é…åº¦ã€å¸‚å€¼ã€è¡Œä¸šç­‰ç­›é€‰</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">ğŸ”„ æ‰«æç»“æœå¯¹æ¯”</div>
                        <div style="font-size: 12px; color: #666;">å¯¹æ¯”ä¸åŒæ—¶é—´çš„æ‰«æç»“æœ</div>
                    </div>
                </div>
            </div>
            
            <!-- ä»·æ ¼æ–¹æ¡ˆ -->
            <div style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px;">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 18px; text-align: center;">ğŸ’° ä»·æ ¼æ–¹æ¡ˆ</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <div style="padding: 20px; background: white; border-radius: 8px; border: 2px solid #667eea; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: #667eea; margin-bottom: 5px;">99å…ƒ</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 15px;">æœˆè´¹</div>
                        <div style="font-size: 12px; color: #999;">é€‚åˆå¶å°”ä½¿ç”¨çš„ç”¨æˆ·</div>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; border: 2px solid #764ba2; text-align: center; color: white; position: relative;">
                        <div style="position: absolute; top: -10px; right: 10px; background: #ff4444; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold;">æ¨è</div>
                        <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">999å…ƒ</div>
                        <div style="font-size: 14px; margin-bottom: 5px;">å¹´è´¹ï¼ˆçº¦83å…ƒ/æœˆï¼‰</div>
                        <div style="font-size: 12px; opacity: 0.9;">èŠ‚çœ16%ï¼Œé€‚åˆé•¿æœŸä½¿ç”¨</div>
                    </div>
                </div>
            </div>
            
            <!-- ä»˜è´¹ç”³è¯·è¡¨å• -->
            <div id="vipApplicationForm">
                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">ğŸ“ å¡«å†™ç”³è¯·ä¿¡æ¯</h3>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">é€‰æ‹©å¥—é¤ *</label>
                    <select id="vipPlan" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        <option value="monthly">æœˆè´¹ï¼š99å…ƒ/æœˆ</option>
                        <option value="yearly" selected>å¹´è´¹ï¼š999å…ƒ/å¹´ï¼ˆæ¨èï¼ŒèŠ‚çœ16%ï¼‰</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">è”ç³»æ–¹å¼ *</label>
                    <input type="text" id="vipContact" placeholder="è¯·è¾“å…¥å¾®ä¿¡/QQ/æ‰‹æœºå·" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    <small style="color: #999; font-size: 12px;">æˆ‘ä»¬å°†é€šè¿‡æ­¤è”ç³»æ–¹å¼ä¸æ‚¨ç¡®è®¤ä»˜æ¬¾å’Œå¼€é€šVIP</small>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰</label>
                    <textarea id="vipNote" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œè¯·åœ¨æ­¤å¡«å†™" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <!-- ä»˜æ¬¾ä¿¡æ¯ï¼ˆç®¡ç†å‘˜é…ç½®ï¼‰ -->
                <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">ğŸ’³ ä»˜æ¬¾æ–¹å¼</div>
                    <div style="font-size: 14px; color: #856404; line-height: 1.8;">
                        <div><strong>æ”¯ä»˜å®è´¦å·ï¼š</strong><span id="alipayAccount">åŠ è½½ä¸­...</span></div>
                        <div><strong>å¾®ä¿¡è´¦å·ï¼š</strong><span id="wechatAccount">åŠ è½½ä¸­...</span></div>
                        <div style="margin-top: 10px; font-size: 12px; color: #856404;">ğŸ’¡ æäº¤ç”³è¯·åï¼Œæˆ‘ä»¬ä¼šé€šè¿‡æ‚¨æä¾›çš„è”ç³»æ–¹å¼ä¸æ‚¨ç¡®è®¤ä»˜æ¬¾ä¿¡æ¯ã€‚ä»˜æ¬¾å®Œæˆåï¼Œæˆ‘ä»¬ä¼šåœ¨24å°æ—¶å†…ä¸ºæ‚¨å¼€é€šVIPã€‚</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="closeVipUpgradeModal()" style="padding: 12px 24px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">å–æ¶ˆ</button>
                    <button onclick="submitVipApplication()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">æäº¤ç”³è¯·</button>
                </div>
            </div>
            
            <!-- ç”³è¯·çŠ¶æ€æ˜¾ç¤º -->
            <div id="vipApplicationStatus" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <div id="applicationStatusContent"></div>
            </div>
        </div>
    </div>
        <div style="position: relative; width: 90%; max-width: 1400px; margin: 20px auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;">
                <h2 style="margin: 0; color: #333; font-size: 20px;">â­ æˆ‘çš„å…³æ³¨åˆ—è¡¨ï¼ˆVIPä¸“äº«ï¼‰</h2>
                <button onclick="closeWatchlistModal()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">âœ• å…³é—­</button>
            </div>
            <div id="watchlistContent" style="min-height: 400px;">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #e67e22; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <p>æ­£åœ¨åŠ è½½å…³æ³¨åˆ—è¡¨...</p>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>


