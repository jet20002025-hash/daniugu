<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ç‰›è‚¡åˆ†æå™¨ - æ·»åŠ å¤§ç‰›è‚¡</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .add-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stocks-list {
            margin-top: 30px;
        }
        
        .stocks-list h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .stock-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .stock-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .stock-info {
            flex: 1;
        }
        
        .stock-code {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stock-name {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stock-meta {
            font-size: 12px;
            color: #999;
        }
        
        .stock-actions {
            display: flex;
            gap: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .message {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.show {
            display: block;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .progress-container {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .progress-container.show {
            display: block;
        }
        
        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }
        
        .progress-status {
            font-weight: 500;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‚ å¤§ç‰›è‚¡åˆ†æå™¨</h1>
            <p>æ·»åŠ å¤§ç‰›è‚¡ï¼Œåˆ†æå¤§æ¶¨å‰çš„ç‰¹å¾</p>
        </div>
        
        <div class="content">
            <!-- æ¶ˆæ¯æç¤º -->
            <div id="message" class="message"></div>
            
            <!-- è¿›åº¦æ¡ -->
            <div id="progressContainer" class="progress-container">
                <div class="progress-bar-wrapper">
                    <div id="progressBarFill" class="progress-bar-fill" style="width: 0%;">0%</div>
                </div>
                <div class="progress-info">
                    <span id="progressStatus" class="progress-status">å‡†å¤‡ä¸­...</span>
                    <span id="progressDetail">-</span>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="stockCount">0</div>
                    <div class="stat-label">å·²æ·»åŠ è‚¡ç¥¨</div>
                </div>
            </div>
            
            <!-- æ·»åŠ è¡¨å• -->
            <div class="add-form">
                <h2 style="margin-bottom: 20px; color: #333;">æ·»åŠ å¤§ç‰›è‚¡</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="stockCode">è‚¡ç¥¨ä»£ç  *</label>
                        <input type="text" id="stockCode" placeholder="ä¾‹å¦‚ï¼š000001" maxlength="6">
                    </div>
                    <div class="form-group">
                        <label for="stockName">è‚¡ç¥¨åç§°ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="stockName" placeholder="ä¾‹å¦‚ï¼šå¹³å®‰é“¶è¡Œï¼ˆä¸å¡«å°†è‡ªåŠ¨è·å–ï¼‰">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="addStock()">æ·»åŠ è‚¡ç¥¨</button>
                    <button class="btn btn-secondary" onclick="clearStocks()">æ¸…ç©ºæ‰€æœ‰</button>
                    <button class="btn btn-primary" onclick="analyzeAllStocks()" style="background: #27ae60;">åˆ†ææ‰€æœ‰è‚¡ç¥¨</button>
                    <button class="btn btn-primary" onclick="trainFeatures()" style="background: #e67e22;">è®­ç»ƒç‰¹å¾æ¨¡å‹</button>
                    <button class="btn btn-primary" onclick="scanAllStocks()" style="background: #e74c3c;">ğŸ” æ‰«æå…¨å¸‚åœº</button>
                    <button class="btn btn-primary" onclick="stopScan()" style="background: #95a5a6;" id="stopScanBtn" disabled>ğŸ›‘ åœæ­¢æ‰«æ</button>
                </div>
                <!-- åè½¬ä¸ªè‚¡ç­›é€‰æ¡ä»¶ -->
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #9b59b6;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">ğŸ“ˆ æœç´¢åè½¬ä¸ªè‚¡ï¼ˆä¸Šå‘¨é˜´çº¿+æœ¬å‘¨é˜³çº¿ï¼‰</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 13px; font-weight: 500;">å¸‚å€¼ä¸Šé™ï¼ˆäº¿å…ƒï¼‰</label>
                            <input type="number" id="reversalMarketCapMax" placeholder="ä¾‹å¦‚: 100" value="100" min="0" step="0.1" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="scanReversalStocks()" style="background: #9b59b6; font-size: 15px; padding: 12px 24px;">ğŸ” å¼€å§‹æœç´¢</button>
                    </div>
                </div>
                
                <!-- åè½¬ä¸ªè‚¡æ‰«æç»“æœåŒºåŸŸ -->
                <div id="reversalResults" style="margin-top: 20px; display: none;"></div>
                
                <!-- å‘¨Kçº¿å›¾æ¨¡æ€æ¡† -->
                <div id="weeklyKlineModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow: auto;">
                    <div style="max-width: 1200px; margin: 20px auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 id="weeklyKlineTitle" style="margin: 0; color: #333;">å‘¨Kçº¿å›¾</h3>
                            <button onclick="closeWeeklyKline()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 16px;">å…³é—­</button>
                        </div>
                        <div id="weeklyKlineChart" style="width: 100%; height: 600px;"></div>
                    </div>
                </div>
                
                <!-- æ‰¾ä¹°ç‚¹åŠŸèƒ½ -->
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ” æ‰¾ä¹°ç‚¹åŠŸèƒ½</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="findBuyPointCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç " style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                        <button class="btn btn-primary" onclick="findBuyPoints()" style="background: #9b59b6;">æŸ¥æ‰¾ä¹°ç‚¹</button>
                    </div>
                    <div id="buyPointsResult" style="margin-top: 15px;"></div>
                </div>
                
            </div>
            
            <!-- è‚¡ç¥¨åˆ—è¡¨ -->
            <div class="stocks-list">
                <h2>å·²æ·»åŠ çš„å¤§ç‰›è‚¡</h2>
                <div id="stocksContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>è¿˜æ²¡æœ‰æ·»åŠ å¤§ç‰›è‚¡</p>
                        <p style="font-size: 12px; margin-top: 10px;">è¯·åœ¨ä¸Šæ–¹è¾“å…¥è‚¡ç¥¨ä»£ç æ·»åŠ </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 3000);
        }
        
        // æ·»åŠ è‚¡ç¥¨
        async function addStock() {
            const code = document.getElementById('stockCode').value.trim();
            const name = document.getElementById('stockName').value.trim();
            
            if (!code) {
                showMessage('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
                return;
            }
            
            if (code.length !== 6 || !/^\d+$/.test(code)) {
                showMessage('è‚¡ç¥¨ä»£ç å¿…é¡»æ˜¯6ä½æ•°å­—', 'error');
                return;
            }
            
            try {
                showMessage('æ­£åœ¨æ·»åŠ è‚¡ç¥¨ï¼Œè¯·ç¨å€™...', 'success');
                
                const response = await fetch('/api/add_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        name: name || null
                    })
                });
                
                // æ£€æŸ¥HTTPçŠ¶æ€ç 
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTPé”™è¯¯:', response.status, errorText);
                    showMessage(`æ·»åŠ å¤±è´¥: HTTP ${response.status} - ${errorText.substring(0, 100)}`, 'error');
                    return;
                }
                
                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('æœåŠ¡å™¨è¿”å›éJSONæ•°æ®:', text.substring(0, 200));
                    showMessage('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„æ•°æ®ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—', 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('æ·»åŠ è‚¡ç¥¨ç»“æœ:', result);
                
                if (result.success) {
                    showMessage(result.message || 'âœ… æ·»åŠ æˆåŠŸ', 'success');
                    document.getElementById('stockCode').value = '';
                    document.getElementById('stockName').value = '';
                    // å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°åˆ—è¡¨ï¼Œç¡®ä¿æ•°æ®å·²ä¿å­˜
                    setTimeout(() => {
                        loadStocks();
                    }, 500);
                } else {
                    // å¦‚æœæ˜¯é‡å¤æ·»åŠ ï¼Œæ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
                    showMessage(result.message || 'âŒ æ·»åŠ å¤±è´¥', 'error');
                    // å¦‚æœè‚¡ç¥¨å·²å­˜åœ¨ï¼Œä¸æ¸…ç©ºè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·çŸ¥é“
                    if (result.message && result.message.includes('å·²å­˜åœ¨')) {
                        // å¯ä»¥é€‰æ‹©ä¸æ¸…ç©ºï¼Œæˆ–è€…æ¸…ç©º
                        // document.getElementById('stockCode').value = '';
                    }
                }
            } catch (error) {
                console.error('æ·»åŠ è‚¡ç¥¨å¼‚å¸¸:', error);
                showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ç§»é™¤è‚¡ç¥¨
        async function removeStock(code) {
            if (!confirm(`ç¡®å®šè¦ç§»é™¤è‚¡ç¥¨ ${code} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/remove_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadStocks();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('ç§»é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰è‚¡ç¥¨
        async function clearStocks() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²æ·»åŠ çš„å¤§ç‰›è‚¡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear_stocks', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadStocks();
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½è‚¡ç¥¨åˆ—è¡¨
        // æ£€æŸ¥åŒ¹é…åº¦çŠ¶æ€å¹¶æ›´æ–°UI
        async function checkMatchScoreStatus() {
            try {
                const response = await fetch('/api/get_trained_features');
                const result = await response.json();
                
                console.log('æ¨¡å‹æ£€æŸ¥ç»“æœ:', result);
                console.log('æ¨¡å‹æ£€æŸ¥è¯¦æƒ…:', {
                    success: result.success,
                    hasCommonFeatures: !!result.common_features,
                    commonFeaturesLength: result.common_features ? Object.keys(result.common_features).length : 0,
                    commonFeaturesKeys: result.common_features ? Object.keys(result.common_features).slice(0, 5) : []
                });
                
                // æ£€æŸ¥æ¨¡å‹æ˜¯å¦å­˜åœ¨ï¼šsuccess ä¸º true ä¸” common_features å­˜åœ¨ä¸”ä¸ä¸ºç©º
                const hasFeatures = result.success && 
                    result.common_features && 
                    Object.keys(result.common_features).length > 0;
                
                console.log('hasFeatures:', hasFeatures);
                
                if (hasFeatures) {
                    // æ¨¡å‹å­˜åœ¨ï¼Œéšè—è­¦å‘Šä¿¡æ¯
                    const messageEl = document.getElementById('message');
                    if (messageEl && messageEl.textContent.includes('è¯·å…ˆæ·»åŠ å¤§ç‰›è‚¡')) {
                        messageEl.classList.remove('show');
                        messageEl.textContent = '';
                    }
                    
                    // å¦‚æœåŒ¹é…åº¦å·²è¾¾æ ‡ï¼Œéšè—åˆ†æå’Œè®­ç»ƒæŒ‰é’®
                    if (result.match_score_ready) {
                        const analyzeBtn = document.querySelector('button[onclick="analyzeAllStocks()"]');
                        const trainBtn = document.querySelector('button[onclick="trainFeatures()"]');
                        
                        if (analyzeBtn) {
                            analyzeBtn.style.display = 'none';
                        }
                        if (trainBtn) {
                            trainBtn.style.display = 'none';
                        }
                        
                        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                        const btnGroup = document.querySelector('.btn-group');
                        if (btnGroup && !document.getElementById('matchScoreReadyMsg')) {
                            const msg = document.createElement('div');
                            msg.id = 'matchScoreReadyMsg';
                            msg.style.cssText = 'padding: 10px; background: #d4edda; color: #155724; border-radius: 6px; margin-top: 10px; font-size: 14px;';
                            msg.innerHTML = `âœ… åŒ¹é…åº¦å·²è¾¾æ ‡ï¼ˆæœ€é«˜: ${result.max_match_score.toFixed(3)} >= 0.95ï¼‰ï¼Œå¯ç›´æ¥æµ‹è¯•ï¼`;
                            btnGroup.appendChild(msg);
                        }
                    } else {
                        // æ¨¡å‹å­˜åœ¨ä½†åŒ¹é…åº¦æœªè¾¾æ ‡ï¼Œæ˜¾ç¤ºæç¤º
                        const btnGroup = document.querySelector('.btn-group');
                        if (btnGroup && !document.getElementById('modelLoadedMsg')) {
                            const msg = document.createElement('div');
                            msg.id = 'modelLoadedMsg';
                            msg.style.cssText = 'padding: 10px; background: #d1ecf1; color: #0c5460; border-radius: 6px; margin-top: 10px; font-size: 14px;';
                            msg.innerHTML = `âœ… æ¨¡å‹å·²åŠ è½½ï¼ˆç‰¹å¾æ•°: ${Object.keys(result.common_features).length}ï¼‰ï¼Œå¯ä»¥ç›´æ¥æ‰«æå…¨å¸‚åœºï¼`;
                            btnGroup.appendChild(msg);
                        }
                    }
                } else {
                    // æ¨¡å‹ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºè­¦å‘Šï¼ˆä½†åªåœ¨å¿…è¦æ—¶æ˜¾ç¤ºï¼Œé¿å…é¡µé¢åŠ è½½æ—¶é—ªçƒï¼‰
                    console.log('æ¨¡å‹ä¸å­˜åœ¨ï¼Œéœ€è¦è®­ç»ƒ');
                }
            } catch (error) {
                console.error('æ£€æŸ¥åŒ¹é…åº¦çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        async function loadStocks(retryCount = 0) {
            const maxRetries = 3;
            try {
                console.log('[loadStocks] å¼€å§‹è·å–è‚¡ç¥¨åˆ—è¡¨... (å°è¯• ' + (retryCount + 1) + '/' + (maxRetries + 1) + ')');
                
                // æ·»åŠ è¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
                
                const response = await fetch('/api/get_stocks', {
                    signal: controller.signal,
                    cache: 'no-cache' // ç¦ç”¨ç¼“å­˜
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    console.error('[loadStocks] HTTPé”™è¯¯:', response.status);
                    const container = document.getElementById('stocksContainer');
                    const countEl = document.getElementById('stockCount');
                    if (countEl) countEl.textContent = '0';
                    if (container) {
                        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: HTTP ${response.status}</p><p style="font-size: 12px; margin-top: 10px;">è¯·åˆ·æ–°é¡µé¢é‡è¯•</p></div>`;
                    }
                    return;
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('[loadStocks] æœåŠ¡å™¨è¿”å›éJSONæ•°æ®:', text.substring(0, 200));
                    return;
                }
                
                const result = await response.json();
                console.log('[loadStocks] è·å–ç»“æœ:', result);
                
                const container = document.getElementById('stocksContainer');
                const countEl = document.getElementById('stockCount');
                
                if (!container || !countEl) {
                    console.error('[loadStocks] æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´  - container:', container, 'countEl:', countEl);
                    return;
                }
                
                // å…¼å®¹ä¸åŒçš„è¿”å›æ ¼å¼ - ä¸æ£€æŸ¥successå­—æ®µï¼Œç›´æ¥ä½¿ç”¨countå’Œstocks
                const stockCount = result.count !== undefined ? result.count : (result.stocks ? result.stocks.length : 0);
                const stocks = result.stocks || [];
                
                // console.log('[loadStocks] è‚¡ç¥¨æ•°é‡:', stockCount, 'è‚¡ç¥¨åˆ—è¡¨é•¿åº¦:', stocks.length, 'è‚¡ç¥¨åˆ—è¡¨:', stocks); // å·²éšè—ï¼šé¿å…æ§åˆ¶å°è¾“å‡ºè¿‡å¤šæ—¥å¿—
                
                // æ›´æ–°è®¡æ•°
                countEl.textContent = stockCount;
                // console.log('[loadStocks] å·²æ›´æ–°è®¡æ•°æ˜¾ç¤ºä¸º:', stockCount); // å·²éšè—ï¼šé¿å…æ§åˆ¶å°è¾“å‡ºè¿‡å¤šæ—¥å¿—
                
                if (stockCount === 0 || stocks.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <p>è¿˜æ²¡æœ‰æ·»åŠ å¤§ç‰›è‚¡</p>
                            <p style="font-size: 12px; margin-top: 10px;">è¯·åœ¨ä¸Šæ–¹è¾“å…¥è‚¡ç¥¨ä»£ç æ·»åŠ </p>
                        </div>
                    `;
                    console.log('[loadStocks] æ˜¾ç¤ºç©ºçŠ¶æ€');
                } else {
                    // console.log('[loadStocks] å¼€å§‹æ¸²æŸ“è‚¡ç¥¨åˆ—è¡¨ï¼Œå…±', stocks.length, 'åª'); // å·²éšè—ï¼šé¿å…æ§åˆ¶å°è¾“å‡ºè¿‡å¤šæ—¥å¿—
                    container.innerHTML = stocks.map(stock => {
                        // ä½¿ç”¨æ–¹æ‹¬å·è®¿é—®ä¸­æ–‡å­—æ®µåï¼Œç¡®ä¿å…¼å®¹æ€§
                        const code = stock['ä»£ç '] || stock.ä»£ç  || '';
                        const name = stock['åç§°'] || stock.åç§° || '';
                        const addTime = stock['æ·»åŠ æ—¶é—´'] || stock.æ·»åŠ æ—¶é—´ || '';
                        const dataCount = stock['æ•°æ®æ¡æ•°'] || stock.æ•°æ®æ¡æ•° || 0;
                        
                        // console.log('[loadStocks] æ¸²æŸ“è‚¡ç¥¨:', code, name); // å·²éšè—ï¼šé¿å…æ§åˆ¶å°è¾“å‡ºè¿‡å¤šæ—¥å¿—
                        
                        return `
                            <div class="stock-item" id="stock-${code}">
                                <div class="stock-item-header">
                                    <div class="stock-info">
                                        <div class="stock-code">${code}</div>
                                        <div class="stock-name">${name}</div>
                                        <div class="stock-meta">
                                            æ·»åŠ æ—¶é—´: ${addTime} | æ•°æ®æ¡æ•°: ${dataCount}
                                        </div>
                                    </div>
                                    <div class="stock-actions">
                                        <button class="btn btn-primary" onclick="analyzeStock('${code}')" style="background: #27ae60; margin-right: 10px;">åˆ†æ</button>
                                        <button class="btn btn-danger" onclick="removeStock('${code}')">ç§»é™¤</button>
                                    </div>
                                </div>
                                <div class="stock-item-content" id="analysis-${code}">
                                    <!-- åˆ†æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                                </div>
                            </div>
                        `;
                    }).join('');
                    // console.log('[loadStocks] è‚¡ç¥¨åˆ—è¡¨æ¸²æŸ“å®Œæˆ'); // å·²éšè—ï¼šé¿å…æ§åˆ¶å°è¾“å‡ºè¿‡å¤šæ—¥å¿—
                }
            } catch (error) {
                console.error('[loadStocks] å¼‚å¸¸:', error);
                
                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ä¸”è¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œè‡ªåŠ¨é‡è¯•
                if ((error.name === 'TypeError' || error.name === 'Failed to fetch' || error.message.includes('fetch')) && retryCount < maxRetries) {
                    console.log('[loadStocks] ç½‘ç»œé”™è¯¯ï¼Œ' + (2000 * (retryCount + 1)) + 'msåé‡è¯•...');
                    setTimeout(() => {
                        loadStocks(retryCount + 1);
                    }, 2000 * (retryCount + 1)); // é€’å¢å»¶è¿Ÿï¼š2ç§’ã€4ç§’ã€6ç§’
                    return;
                }
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errorMsg = error.name === 'AbortError' ? 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥' : 
                                (error.message || 'ç½‘ç»œè¿æ¥å¤±è´¥');
                showMessage('åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥: ' + errorMsg, 'error');
                
                const container = document.getElementById('stocksContainer');
                const countEl = document.getElementById('stockCount');
                if (countEl) countEl.textContent = '0';
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨</p>
                            <p style="font-size: 12px; margin-top: 10px;">é”™è¯¯: ${errorMsg}</p>
                            <p style="font-size: 12px; margin-top: 5px;">
                                <button onclick="location.reload()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                    åˆ·æ–°é¡µé¢
                                </button>
                            </p>
                        </div>`;
                }
            }
        }
        
        // å›è½¦é”®æ·»åŠ  - å»¶è¿Ÿç»‘å®šï¼Œç¡®ä¿DOMå·²åŠ è½½
        function bindEnterKeyEvents() {
            const stockCodeEl = document.getElementById('stockCode');
            const stockNameEl = document.getElementById('stockName');
            
            if (stockCodeEl) {
                stockCodeEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addStock();
                    }
                });
            }
            
            if (stockNameEl) {
                stockNameEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addStock();
                    }
                });
            }
        }
        
        // ç¡®ä¿DOMåŠ è½½åå†ç»‘å®šäº‹ä»¶
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', bindEnterKeyEvents);
        } else {
            bindEnterKeyEvents();
        }
        
        // åˆ†æå•åªè‚¡ç¥¨
        async function analyzeStock(code) {
            showMessage('æ­£åœ¨åˆ†æ ' + code + '...', 'success');
            
            try {
                const response = await fetch('/api/analyze_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                });
                
                const result = await response.json();
                
                if (result.success && result.interval) {
                    const interval = result.interval;
                    const analysisDiv = document.getElementById('analysis-' + code);
                    
                    analysisDiv.innerHTML = `
                        <div class="analysis-result">
                            <h4>ğŸ“ˆ æ¶¨å¹…æœ€å¤§åŒºé—´åˆ†æç»“æœ</h4>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">èµ·ç‚¹æ—¥æœŸ:</span>
                                <span class="analysis-result-value">${interval.èµ·ç‚¹æ—¥æœŸ}</span>
                            </div>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">èµ·ç‚¹ä»·æ ¼:</span>
                                <span class="analysis-result-value">${interval.èµ·ç‚¹ä»·æ ¼.toFixed(2)} å…ƒ</span>
                            </div>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">ç»ˆç‚¹æ—¥æœŸ:</span>
                                <span class="analysis-result-value">${interval.ç»ˆç‚¹æ—¥æœŸ}</span>
                            </div>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">ç»ˆç‚¹ä»·æ ¼:</span>
                                <span class="analysis-result-value">${interval.ç»ˆç‚¹ä»·æ ¼.toFixed(2)} å…ƒ</span>
                            </div>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">æ¶¨å¹…:</span>
                                <span class="analysis-result-value gain-positive">${interval.æ¶¨å¹….toFixed(2)}% (ç¿»${interval.ç¿»å€å€æ•°.toFixed(2)}å€)</span>
                            </div>
                            <div class="analysis-result-item">
                                <span class="analysis-result-label">äº¤æ˜“æ—¥æ•°:</span>
                                <span class="analysis-result-value">${interval.äº¤æ˜“æ—¥æ•°} å¤©</span>
                            </div>
                        </div>
                    `;
                    analysisDiv.classList.add('show');
                    showMessage(result.message, 'success');
                } else {
                    showMessage(result.message || 'åˆ†æå¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('åˆ†æå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤º/éšè—è¿›åº¦æ¡
        function showProgress() {
            document.getElementById('progressContainer').classList.add('show');
        }
        
        function hideProgress() {
            document.getElementById('progressContainer').classList.remove('show');
        }
        
        function updateProgress(percentage, status, detail) {
            document.getElementById('progressBarFill').style.width = percentage + '%';
            document.getElementById('progressBarFill').textContent = percentage.toFixed(1) + '%';
            document.getElementById('progressStatus').textContent = status;
            document.getElementById('progressDetail').textContent = detail;
        }
        
        // è½®è¯¢è¿›åº¦
        let progressInterval = null;
        
        function startProgressPolling() {
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/get_progress');
                    const result = await response.json();
                    
                    if (result.success && result.progress) {
                        const progress = result.progress;
                        let detailText = progress.detail || '';
                        if (progress.found !== undefined) {
                            detailText += ` | å·²æ‰¾åˆ°: ${progress.found} åª`;
                        }
                        updateProgress(progress.percentage, progress.status, detailText);
                        
                        // å¦‚æœå®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
                        if (progress.status === 'å®Œæˆ' || progress.status === 'å¤±è´¥' || progress.status === 'ç©ºé—²') {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            
                            if (progress.status === 'å®Œæˆ') {
                                setTimeout(() => {
                                    hideProgress();
                                }, 2000);
                            }
                        }
                    }
                } catch (error) {
                    console.error('è·å–è¿›åº¦å¤±è´¥:', error);
                }
            }, 500); // æ¯500msè½®è¯¢ä¸€æ¬¡
        }
        
        function stopProgressPolling() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }
        
        // åˆ†ææ‰€æœ‰è‚¡ç¥¨
        async function analyzeAllStocks() {
            if (!confirm('ç¡®å®šè¦åˆ†ææ‰€æœ‰å·²æ·»åŠ çš„å¤§ç‰›è‚¡å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) {
                return;
            }
            
            showMessage('æ­£åœ¨åˆ†ææ‰€æœ‰è‚¡ç¥¨ï¼Œè¯·ç¨å€™...', 'success');
            showProgress();
            updateProgress(0, 'å‡†å¤‡ä¸­', 'å¼€å§‹åˆ†æ...');
            startProgressPolling();
            
            try {
                const response = await fetch('/api/analyze_all', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                stopProgressPolling();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // åˆ·æ–°è‚¡ç¥¨åˆ—è¡¨ä»¥æ˜¾ç¤ºåˆ†æç»“æœ
                    loadStocks();
                    
                    // ä¸ºæ¯ä¸ªæœ‰åˆ†æç»“æœçš„è‚¡ç¥¨æ˜¾ç¤ºç»“æœ
                    if (result.results) {
                        result.results.forEach(item => {
                            if (item.åˆ†æç»“æœ && item.åˆ†æç»“æœ.success && item.åˆ†æç»“æœ.interval) {
                                const code = item.è‚¡ç¥¨ä»£ç ;
                                const interval = item.åˆ†æç»“æœ.interval;
                                const analysisDiv = document.getElementById('analysis-' + code);
                                
                                if (analysisDiv) {
                                    analysisDiv.innerHTML = `
                                        <div class="analysis-result">
                                            <h4>ğŸ“ˆ æ¶¨å¹…æœ€å¤§åŒºé—´åˆ†æç»“æœ</h4>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">èµ·ç‚¹æ—¥æœŸ:</span>
                                                <span class="analysis-result-value">${interval.èµ·ç‚¹æ—¥æœŸ}</span>
                                            </div>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">èµ·ç‚¹ä»·æ ¼:</span>
                                                <span class="analysis-result-value">${interval.èµ·ç‚¹ä»·æ ¼.toFixed(2)} å…ƒ</span>
                                            </div>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">ç»ˆç‚¹æ—¥æœŸ:</span>
                                                <span class="analysis-result-value">${interval.ç»ˆç‚¹æ—¥æœŸ}</span>
                                            </div>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">ç»ˆç‚¹ä»·æ ¼:</span>
                                                <span class="analysis-result-value">${interval.ç»ˆç‚¹ä»·æ ¼.toFixed(2)} å…ƒ</span>
                                            </div>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">æ¶¨å¹…:</span>
                                                <span class="analysis-result-value gain-positive">${interval.æ¶¨å¹….toFixed(2)}% (ç¿»${interval.ç¿»å€å€æ•°.toFixed(2)}å€)</span>
                                            </div>
                                            <div class="analysis-result-item">
                                                <span class="analysis-result-label">äº¤æ˜“æ—¥æ•°:</span>
                                                <span class="analysis-result-value">${interval.äº¤æ˜“æ—¥æ•°} å¤©</span>
                                            </div>
                                        </div>
                                    `;
                                    analysisDiv.classList.add('show');
                                }
                            }
                        });
                    }
                } else {
                    showMessage(result.message || 'åˆ†æå¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('åˆ†æå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // è®­ç»ƒç‰¹å¾æ¨¡å‹
        async function trainFeatures() {
            if (!confirm('ç¡®å®šè¦è®­ç»ƒç‰¹å¾æ¨¡å‹å—ï¼Ÿéœ€è¦å…ˆåˆ†ææ‰€æœ‰å¤§ç‰›è‚¡ã€‚')) {
                return;
            }
            
            showMessage('æ­£åœ¨è®­ç»ƒç‰¹å¾æ¨¡å‹ï¼Œè¯·ç¨å€™...', 'success');
            showProgress();
            updateProgress(0, 'å‡†å¤‡ä¸­', 'å¼€å§‹è®­ç»ƒ...');
            startProgressPolling();
            
            try {
                const response = await fetch('/api/train_features', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                stopProgressPolling();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    // æ˜¾ç¤ºè®­ç»ƒç»“æœ
                    if (result.common_features) {
                        let resultHtml = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">';
                        resultHtml += '<h4>è®­ç»ƒç»“æœï¼š</h4>';
                        resultHtml += `<p>æ ·æœ¬æ•°: ${result.sample_count}</p>`;
                        resultHtml += `<p>ç‰¹å¾æ•°: ${Object.keys(result.common_features).length}</p>`;
                        resultHtml += '<h5>æ ¸å¿ƒç‰¹å¾ï¼š</h5><ul>';
                        const coreFeatures = ['èµ·ç‚¹å½“æ—¥é‡æ¯”', 'ä»·æ ¼ç›¸å¯¹ä½ç½®', 'æˆäº¤é‡èç¼©ç¨‹åº¦', 'ä»·æ ¼ç›¸å¯¹MA20', 'èµ·ç‚¹å‰20å¤©æ³¢åŠ¨ç‡'];
                        coreFeatures.forEach(feature => {
                            if (result.common_features[feature]) {
                                const stats = result.common_features[feature];
                                resultHtml += `<li><strong>${feature}</strong>: å‡å€¼=${stats.å‡å€¼}, èŒƒå›´[${stats.æœ€å°å€¼}, ${stats.æœ€å¤§å€¼}]</li>`;
                            }
                        });
                        resultHtml += '</ul></div>';
                        document.getElementById('buyPointsResult').innerHTML = resultHtml;
                    }
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('è®­ç»ƒå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æŸ¥æ‰¾ä¹°ç‚¹
        async function findBuyPoints() {
            const code = document.getElementById('findBuyPointCode').value.trim();
            
            if (!code) {
                showMessage('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ', 'error');
                return;
            }
            
            if (code.length !== 6 || !/^\d+$/.test(code)) {
                showMessage('è‚¡ç¥¨ä»£ç å¿…é¡»æ˜¯6ä½æ•°å­—', 'error');
                return;
            }
            
            showMessage('æ­£åœ¨æŸ¥æ‰¾ä¹°ç‚¹ï¼Œè¯·ç¨å€™...', 'success');
            
            try {
                const response = await fetch('/api/find_buy_points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        tolerance: 0.3,
                        search_years: 5,  // æœç´¢5å¹´å†å²æ•°æ®
                        match_threshold: 0.95  // åŒ¹é…åº¦é˜ˆå€¼0.95
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('æœåŠ¡å™¨è¿”å›éJSONæ•°æ®:', text.substring(0, 200));
                    throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„æ•°æ®');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.buy_points && result.buy_points.length > 0) {
                        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                        let statsHtml = '';
                        if (result.statistics) {
                            statsHtml = `<div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; border-left: 4px solid #27ae60;">
                                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                                    <div><strong>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š</strong></div>
                                    <div><strong>æ‰¾åˆ°ä¹°ç‚¹æ€»æ•°:</strong> <span style="color: #1976d2; font-weight: bold; font-size: 16px;">${result.statistics.total}</span></div>
                                    <div><strong>æœ€ä½³ä¹°ç‚¹ï¼ˆ10å‘¨å†…ç¿»å€ï¼‰:</strong> <span style="color: #f39c12; font-weight: bold; font-size: 16px;">â­ ${result.statistics.best_buy_points}</span></div>
                                    <div><strong>4å‘¨ç›ˆåˆ©:</strong> <span style="color: #27ae60; font-weight: bold;">${result.statistics.profitable_4w}</span></div>
                                    <div><strong>10å‘¨ç›ˆåˆ©:</strong> <span style="color: #27ae60; font-weight: bold;">${result.statistics.profitable_10w}</span></div>
                                </div>
                                ${result.max_match_score ? `<div style="margin-top: 10px; color: #555; font-size: 13px;">æœ€é«˜åŒ¹é…åº¦: ${result.max_match_score.toFixed(3)} | å¹³å‡åŒ¹é…åº¦: ${result.avg_match_score ? result.avg_match_score.toFixed(3) : 'N/A'}</div>` : ''}
                            </div>`;
                        }
                        
                        // ç­›é€‰åŒ¹é…åº¦ > 0.9 çš„ä¹°ç‚¹ï¼ˆä¸¥æ ¼å¤§äº0.9ï¼‰
                        const filteredBuyPoints = result.buy_points.filter(bp => {
                            const matchScore = bp.åŒ¹é…åº¦ || bp['åŒ¹é…åº¦'] || 0;
                            return matchScore > 0.9;
                        });
                        
                        // è·å–è‚¡ç¥¨ä»£ç å’Œåç§°ï¼ˆä¼˜å…ˆä½¿ç”¨è¾“å…¥çš„ä»£ç ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼‰
                        const stockCode = code || result.stock_code || '';
                        const stockName = result.stock_name || '';
                        
                        // æ„å»ºæ˜¾ç¤ºåç§°ï¼šå¦‚æœæœ‰æœ‰æ•ˆçš„è‚¡ç¥¨åç§°ï¼ˆä¸ç­‰äºä»£ç ï¼‰ï¼Œæ˜¾ç¤º"ä»£ç  åç§°"ï¼Œå¦åˆ™åªæ˜¾ç¤ºä»£ç 
                        let displayName = stockCode;
                        if (stockName && stockName.trim() !== '' && stockName !== stockCode) {
                            displayName = `${stockCode} ${stockName}`;
                        }
                        
                        let html = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">';
                        html += statsHtml;
                        html += `<h4>${displayName} - æ‰¾åˆ° ${filteredBuyPoints.length} ä¸ªå†å²ä¹°ç‚¹ï¼ˆåŒ¹é…åº¦>0.9ï¼‰ï¼š</h4>`;
                        if (result.buy_points.length > filteredBuyPoints.length) {
                            html += `<p style="color: #999; font-size: 12px; margin-top: 5px;">å·²è¿‡æ»¤ ${result.buy_points.length - filteredBuyPoints.length} ä¸ªåŒ¹é…åº¦â‰¤0.9çš„ä¹°ç‚¹</p>`;
                        }
                        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
                        html += '<tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">æ—¥æœŸ</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ä»·æ ¼</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">åŒ¹é…åº¦</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">4å‘¨æ¶¨å¹…</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">10å‘¨æ¶¨å¹…</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">10å‘¨æœ€å¤§æ¶¨å¹…</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">20å‘¨æ¶¨å¹…</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">æœ€ä½³ä¹°ç‚¹</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">æœ€ä½³å–ç‚¹ä»·æ ¼</th><th style="padding: 10px; border: 1px solid #ddd; text-align: left;">æ­¢æŸä»·æ ¼</th></tr>';
                        
                        filteredBuyPoints.forEach(bp => {
                            // ä½¿ç”¨æ–¹æ‹¬å·è®¿é—®å±æ€§ï¼Œå› ä¸ºå±æ€§åå¯èƒ½åŒ…å«æ•°å­—æˆ–ç‰¹æ®Šå­—ç¬¦
                            const gain4w = bp['ä¹°å…¥å4å‘¨æ¶¨å¹…'] !== undefined ? bp['ä¹°å…¥å4å‘¨æ¶¨å¹…'] : (bp.ä¹°å…¥å4å‘¨æ¶¨å¹… !== undefined ? bp.ä¹°å…¥å4å‘¨æ¶¨å¹… : null);
                            const gain10w = bp['ä¹°å…¥å10å‘¨æ¶¨å¹…'] !== undefined ? bp['ä¹°å…¥å10å‘¨æ¶¨å¹…'] : (bp.ä¹°å…¥å10å‘¨æ¶¨å¹… !== undefined ? bp.ä¹°å…¥å10å‘¨æ¶¨å¹… : null);
                            const maxGain10w = bp['10å‘¨å†…æœ€å¤§æ¶¨å¹…'] !== undefined ? bp['10å‘¨å†…æœ€å¤§æ¶¨å¹…'] : null;
                            const gain20w = bp['ä¹°å…¥å20å‘¨æ¶¨å¹…'] !== undefined ? bp['ä¹°å…¥å20å‘¨æ¶¨å¹…'] : (bp.ä¹°å…¥å20å‘¨æ¶¨å¹… !== undefined ? bp.ä¹°å…¥å20å‘¨æ¶¨å¹… : null);
                            const isBest = bp['æ˜¯å¦æœ€ä½³ä¹°ç‚¹'] !== undefined ? bp['æ˜¯å¦æœ€ä½³ä¹°ç‚¹'] : (bp.æ˜¯å¦æœ€ä½³ä¹°ç‚¹ !== undefined ? bp.æ˜¯å¦æœ€ä½³ä¹°ç‚¹ : false);
                            
                            // ä¸­å›½è‚¡å¸‚ä¹ æƒ¯ï¼šä¸Šæ¶¨ç”¨çº¢è‰²ï¼Œä¸‹è·Œç”¨ç»¿è‰²
                            // ä¸Šæ¶¨ï¼ˆ>0ï¼‰ç”¨çº¢è‰² #e74c3cï¼Œä¸‹è·Œï¼ˆ<=0ï¼‰ç”¨ç»¿è‰² #27ae60
                            const gain4wColor = gain4w !== null ? (gain4w > 0 ? '#e74c3c' : '#27ae60') : '#999';
                            const gain10wColor = gain10w !== null ? (gain10w > 0 ? '#e74c3c' : '#27ae60') : '#999';
                            const maxGain10wColor = maxGain10w !== null ? (maxGain10w > 0 ? '#e74c3c' : '#27ae60') : '#999';
                            const gain20wColor = gain20w !== null ? (gain20w > 0 ? '#e74c3c' : '#27ae60') : '#999';
                            const bestMark = isBest ? '<span style="color: #f39c12; font-weight: bold;">â­ æœ€ä½³</span>' : '';
                            
                            const matchScore = bp.åŒ¹é…åº¦ || bp['åŒ¹é…åº¦'] || 0;
                            const matchScoreColor = matchScore >= 0.95 ? '#27ae60' : (matchScore >= 0.9 ? '#f39c12' : '#e74c3c');
                            
                            html += `<tr style="${isBest ? 'background: linear-gradient(135deg, #fff9e6 0%, #ffe0b2 100%); font-weight: bold;' : ''}">
                                <td style="padding: 10px; border: 1px solid #ddd;">${bp.æ—¥æœŸ || bp['æ—¥æœŸ'] || 'N/A'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; font-weight: ${isBest ? 'bold' : 'normal'};">${(bp.ä»·æ ¼ || bp['ä»·æ ¼'] || 0).toFixed(2)} å…ƒ</td>
                                <td style="padding: 10px; border: 1px solid #ddd; color: ${matchScoreColor}; font-weight: bold;">${matchScore.toFixed(3)}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; color: ${gain4wColor}; font-weight: ${gain4w !== null && gain4w > 0 ? 'bold' : 'normal'};">${gain4w !== null ? gain4w.toFixed(2) + '%' : 'N/A'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; color: ${gain10wColor}; font-weight: ${gain10w !== null && gain10w > 0 ? 'bold' : 'normal'};">${gain10w !== null ? gain10w.toFixed(2) + '%' : 'N/A'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; color: ${maxGain10wColor}; font-weight: ${maxGain10w !== null && maxGain10w > 50 ? 'bold' : 'normal'};">${maxGain10w !== null ? maxGain10w.toFixed(2) + '%' : 'N/A'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; color: ${gain20wColor}; font-weight: ${gain20w !== null && gain20w > 0 ? 'bold' : 'normal'};">${gain20w !== null ? gain20w.toFixed(2) + '%' : 'N/A'}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${bestMark}</td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #ff9800;">
                                    ${(() => {
                                        const sellPrice = bp.æœ€ä½³å–ç‚¹ä»·æ ¼ !== undefined ? bp.æœ€ä½³å–ç‚¹ä»·æ ¼ : bp['æœ€ä½³å–ç‚¹ä»·æ ¼'];
                                        const sellWeeks = bp.æœ€ä½³å–ç‚¹å‘¨æ•° !== undefined ? bp.æœ€ä½³å–ç‚¹å‘¨æ•° : bp['æœ€ä½³å–ç‚¹å‘¨æ•°'];
                                        const sellType = bp.å–ç‚¹ç±»å‹ || bp['å–ç‚¹ç±»å‹'];
                                        if (sellPrice !== null && sellPrice !== undefined) {
                                            let html = sellPrice.toFixed(2) + ' å…ƒ';
                                            if (sellWeeks !== null && sellWeeks !== undefined) {
                                                if (sellWeeks < 0) {
                                                    html += '<br><span style="font-size: 11px; color: #999;">(æ•°æ®ä¸è¶³' + Math.abs(sellWeeks) + 'å‘¨)</span>';
                                                } else {
                                                    html += '<br><span style="font-size: 11px; color: #666;">(' + sellWeeks + 'å‘¨å)</span>';
                                                }
                                            }
                                            if (sellType) {
                                                html += '<br><span style="font-size: 11px; color: ' + (sellType === 'é¢„æµ‹å–ç‚¹' ? '#e74c3c' : '#27ae60') + ';">' + 
                                                        (sellType === 'é¢„æµ‹å–ç‚¹' ? 'ğŸ”® é¢„æµ‹' : 'ğŸ“Š å†å²') + '</span>';
                                            }
                                            return html;
                                        } else {
                                            return '<span style="color: #999; font-size: 12px;">æ•°æ®ä¸è¶³<br>(ä¹°å…¥åæ— è¶³å¤Ÿæ•°æ®)</span>';
                                        }
                                    })()}
                                </td>
                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #e74c3c;">
                                    ${(() => {
                                        const stopLoss = bp.æ­¢æŸä»·æ ¼ !== undefined ? bp.æ­¢æŸä»·æ ¼ : bp['æ­¢æŸä»·æ ¼'];
                                        const buyPrice = bp.ä»·æ ¼ !== undefined ? bp.ä»·æ ¼ : bp['ä»·æ ¼'];
                                        if (stopLoss !== null && stopLoss !== undefined && buyPrice !== null && buyPrice !== undefined) {
                                            const lossPercent = Math.abs((stopLoss - buyPrice) / buyPrice * 100);
                                            return stopLoss.toFixed(2) + ' å…ƒ' + 
                                                   '<br><span style="font-size: 11px; color: #999;">(æ­¢æŸ-' + lossPercent.toFixed(1) + '%)</span>';
                                        } else {
                                            return 'N/A';
                                        }
                                    })()}
                                </td>
                            </tr>`;
                        });
                        
                        html += '</table></div></div>';
                        
                        // å¦‚æœè¿‡æ»¤åæ²¡æœ‰ä¹°ç‚¹ï¼Œæ˜¾ç¤ºæç¤ºï¼ˆä¿ç•™è‚¡ç¥¨åç§°ï¼‰
                        if (filteredBuyPoints.length === 0) {
                            html = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">';
                            html += statsHtml;
                            html += `<h4>${displayName} - æœªæ‰¾åˆ°åŒ¹é…åº¦>0.9çš„ä¹°ç‚¹</h4>`;
                            if (result.buy_points.length > 0) {
                                html += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; color: #856404; font-size: 12px;">æç¤ºï¼šå…±æœ‰ ${result.buy_points.length} ä¸ªä¹°ç‚¹ï¼Œä½†åŒ¹é…åº¦å‡â‰¤0.9</div>`;
                            }
                            html += '</div>';
                        }
                        
                        document.getElementById('buyPointsResult').innerHTML = html;
                        showMessage(result.message, 'success');
                    } else {
                        document.getElementById('buyPointsResult').innerHTML = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; color: #999;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¹°ç‚¹</div>';
                        showMessage('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¹°ç‚¹', 'error');
                    }
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('æŸ¥æ‰¾ä¹°ç‚¹å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åœæ­¢æ‰«æ
        let scanCheckInterval = null;  // å­˜å‚¨æ‰«ææ£€æŸ¥çš„interval ID
        
        async function stopScan() {
            if (!confirm('ç¡®å®šè¦åœæ­¢å½“å‰æ‰«æå—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/stop_scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('å·²å‘é€åœæ­¢æ‰«æè¯·æ±‚ï¼Œæ­£åœ¨åœæ­¢...', 'success');
                    // ä¸ç«‹å³ç¦ç”¨åœæ­¢æŒ‰é’®ï¼Œç­‰å¾…æ‰«æçœŸæ­£åœæ­¢
                    // åœæ­¢æŒ‰é’®ä¼šåœ¨çŠ¶æ€å˜ä¸º"å·²åœæ­¢"æ—¶è‡ªåŠ¨ç¦ç”¨
                    
                    // ç­‰å¾…å‡ ç§’åæ£€æŸ¥çŠ¶æ€ï¼Œå¦‚æœå·²åœæ­¢åˆ™è·å–ç»“æœ
                    setTimeout(async () => {
                        try {
                            const progressResponse = await fetch('/api/get_scan_progress');
                            const progress = await progressResponse.json();
                            
                            if (progress && progress.status === 'å·²åœæ­¢') {
                                // ç¦ç”¨åœæ­¢æŒ‰é’®
                                const stopBtn = document.getElementById('stopScanBtn');
                                if (stopBtn) {
                                    stopBtn.disabled = true;
                                }
                                
                                // æ ¹æ®æ‰«æç±»å‹è·å–ä¸åŒçš„ç»“æœ
                                if (progress.type === 'reversal_scan') {
                                    // åè½¬æ‰«æå·²åœæ­¢ï¼Œè·å–åè½¬æ‰«æç»“æœ
                                    const resultsResponse = await fetch('/api/get_reversal_scan_results');
                                    const resultsResult = await resultsResponse.json();
                                    console.log('åœæ­¢åçš„åè½¬æ‰«æç»“æœ:', resultsResult);
                                    
                                    if (resultsResult.success) {
                                        if (resultsResult.stocks && resultsResult.stocks.length > 0) {
                                            displayReversalResults(resultsResult);
                                            showMessage(`åè½¬æ‰«æå·²åœæ­¢ï¼Œå·²æ‰¾åˆ° ${resultsResult.found_count || resultsResult.stocks.length || 0} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ã€‚`, 'success');
                                        } else {
                                            const totalScanned = progress.total || 0;
                                            const current = progress.current || 0;
                                            showMessage(`åè½¬æ‰«æå·²åœæ­¢ï¼Œå·²å¤„ç† ${current}/${totalScanned} åªè‚¡ç¥¨ï¼Œä½†æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ã€‚`, 'warning');
                                        }
                                    }
                                } else {
                                    // æ™®é€šæ‰«æå·²åœæ­¢ï¼Œè·å–æ™®é€šæ‰«æç»“æœ
                                    const resultsResponse = await fetch('/api/get_scan_results');
                                    const resultsResult = await resultsResponse.json();
                                    console.log('åœæ­¢åçš„æ‰«æç»“æœ:', resultsResult);
                                    
                                    if (resultsResult.success) {
                                        if (resultsResult.candidates && resultsResult.candidates.length > 0) {
                                            displayScanResults(resultsResult);
                                            showMessage(`æ‰«æå·²åœæ­¢ï¼Œå·²æ‰¾åˆ° ${resultsResult.found_count || resultsResult.candidates.length || 0} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ã€‚å¯ä»¥ç‚¹å‡»"æ‰«æå…¨å¸‚åœº"ç»§ç»­æ‰«æã€‚`, 'success');
                                        } else {
                                            const totalScanned = resultsResult.total_scanned || 0;
                                            showMessage(`æ‰«æå·²åœæ­¢ï¼Œå·²å¤„ç† ${totalScanned} åªè‚¡ç¥¨ï¼Œä½†æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ã€‚å¯ä»¥ç‚¹å‡»"æ‰«æå…¨å¸‚åœº"ç»§ç»­æ‰«æã€‚`, 'warning');
                                        }
                                    }
                                }
                                
                                // åœæ­¢è¿›åº¦è½®è¯¢
                                stopProgressPolling();
                                hideProgress();
                            }
                        } catch (error) {
                            console.error('æ£€æŸ¥åœæ­¢çŠ¶æ€å¤±è´¥:', error);
                        }
                    }, 2000); // 2ç§’åæ£€æŸ¥ä¸€æ¬¡
                } else {
                    showMessage('åœæ­¢æ‰«æå¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('åœæ­¢æ‰«æå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ‰«æå…¨å¸‚åœº
        async function scanAllStocks() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æ‰«æ
            try {
                const progressResponse = await fetch('/api/get_progress');
                const progressResult = await progressResponse.json();
                if (progressResult.success && progressResult.progress && progressResult.progress.status === 'å·²åœæ­¢') {
                    if (confirm('æ£€æµ‹åˆ°æœªå®Œæˆçš„æ‰«æï¼Œæ˜¯å¦ç»§ç»­æ‰«æï¼Ÿ\nï¼ˆç‚¹å‡»"ç¡®å®š"ç»§ç»­ï¼Œç‚¹å‡»"å–æ¶ˆ"é‡æ–°å¼€å§‹ï¼‰')) {
                        // ç»§ç»­æ‰«æ
                        showMessage('ç»§ç»­æ‰«æ...', 'success');
                        // ç»§ç»­ä½¿ç”¨ç›¸åŒçš„å‚æ•°ï¼ˆä»åç«¯è·å–ï¼‰
                    } else {
                        // é‡æ–°å¼€å§‹ï¼Œæ¸…é™¤çŠ¶æ€
                        // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€ä¸ªæ¸…é™¤çŠ¶æ€çš„APIè°ƒç”¨
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ‰«æçŠ¶æ€å¤±è´¥:', error);
            }
            
            // å…ˆæ£€æŸ¥æ˜¯å¦å·²è®­ç»ƒç‰¹å¾æ¨¡å‹
            try {
                const featuresResponse = await fetch('/api/get_trained_features');
                const featuresResult = await featuresResponse.json();
                
                console.log('ç‰¹å¾æ¨¡å‹æ£€æŸ¥ç»“æœ:', featuresResult);
                console.log('ç‰¹å¾æ¨¡å‹æ£€æŸ¥è¯¦æƒ…:', {
                    success: featuresResult.success,
                    hasCommonFeatures: !!featuresResult.common_features,
                    commonFeaturesLength: featuresResult.common_features ? Object.keys(featuresResult.common_features).length : 0,
                    message: featuresResult.message
                });
                
                // æ£€æŸ¥æ¨¡å‹æ˜¯å¦å­˜åœ¨ï¼šsuccess ä¸º true ä¸” common_features å­˜åœ¨ä¸”ä¸ä¸ºç©º
                const hasFeatures = featuresResult.success && 
                    featuresResult.common_features && 
                    Object.keys(featuresResult.common_features).length > 0;
                
                console.log('hasFeatures (scanAllStocks):', hasFeatures);
                
                if (!hasFeatures) {
                    showMessage('è¯·å…ˆæ·»åŠ å¤§ç‰›è‚¡ã€åˆ†æè‚¡ç¥¨å¹¶è®­ç»ƒç‰¹å¾æ¨¡å‹ï¼', 'error');
                    return;
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç‰¹å¾æ¨¡å‹å¤±è´¥:', error);
                showMessage('æ— æ³•æ£€æŸ¥ç‰¹å¾æ¨¡å‹çŠ¶æ€: ' + error.message, 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ‰«ææ‰€æœ‰Aè‚¡å—ï¼Ÿè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆçº¦5000åªè‚¡ç¥¨ï¼‰ã€‚')) {
                return;
            }
            
            // è·å–å‚æ•°
            const minMatchInput = prompt('è¯·è¾“å…¥æœ€å°åŒ¹é…åº¦ï¼ˆ0-1ï¼Œé»˜è®¤0.93ï¼‰:', '0.93');
            if (minMatchInput === null) {
                return; // ç”¨æˆ·å–æ¶ˆ
            }
            const minMatch = parseFloat(minMatchInput) || 0.93;
            
            const maxCapInput = prompt('è¯·è¾“å…¥æœ€å¤§å¸‚å€¼ï¼ˆäº¿å…ƒï¼Œé»˜è®¤100ï¼‰:', '100');
            if (maxCapInput === null) {
                return; // ç”¨æˆ·å–æ¶ˆ
            }
            const maxCap = parseFloat(maxCapInput) || 100;
            
            const limitInput = prompt('é™åˆ¶æ‰«ææ•°é‡ï¼ˆç•™ç©ºè¡¨ç¤ºå…¨éƒ¨ï¼Œå»ºè®®å…ˆæµ‹è¯•100åªï¼‰:', '');
            if (limitInput === null) {
                return; // ç”¨æˆ·å–æ¶ˆ
            }
            const scanLimit = limitInput ? parseInt(limitInput) : null;
            
            console.log('å¼€å§‹æ‰«æï¼Œå‚æ•°:', { minMatch, maxCap, scanLimit });
            
            // å¯ç”¨åœæ­¢æŒ‰é’®
            const stopBtn = document.getElementById('stopScanBtn');
            if (stopBtn) {
                stopBtn.disabled = false;
            }
            
            showMessage('å¼€å§‹æ‰«æå…¨å¸‚åœºï¼Œè¯·ç¨å€™...', 'success');
            showProgress();
            updateProgress(0, 'å‡†å¤‡ä¸­', 'å¼€å§‹æ‰«æ...');
            startProgressPolling();
            
            try {
                // ç¡®ä¿ stopBtn åœ¨ä½œç”¨åŸŸå†…
                const stopBtn = document.getElementById('stopScanBtn');
                // ä½¿ç”¨AbortControllerè®¾ç½®è¶…æ—¶ï¼ˆ30ç§’ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                const response = await fetch('/api/scan_all_stocks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        min_match_score: minMatch,
                        max_market_cap: maxCap,
                        limit: scanLimit
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('æ‰«æAPIå“åº”:', result);
                
                if (result.success) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ Vercel åˆ†æ‰¹æ‰«ææ¨¡å¼
                    const scanId = result.scan_id;
                    const hasMore = result.has_more;
                    const totalBatches = result.total_batches;
                    
                    if (scanId && hasMore !== undefined) {
                        // Vercel åˆ†æ‰¹æ‰«ææ¨¡å¼
                        showMessage(`æ‰«æå·²å¼€å§‹ï¼ˆå…± ${totalBatches} æ‰¹ï¼‰ï¼Œæ­£åœ¨å¤„ç†ç¬¬ 1 æ‰¹...`, 'success');
                        
                        // ä¿å­˜ scan_id åˆ°å…¨å±€å˜é‡
                        window.currentScanId = scanId;
                        window.currentScanBatches = totalBatches;
                        window.currentScanBatch = 1;
                        
                        // å¼€å§‹è‡ªåŠ¨å¤„ç†ä¸‹ä¸€æ‰¹æ¬¡
                        autoContinueScan(scanId, 1, totalBatches);
                    } else {
                        // æœ¬åœ°ç¯å¢ƒï¼šä¼ ç»Ÿè½®è¯¢æ¨¡å¼
                        showMessage('æ‰«æå·²å¼€å§‹ï¼Œè¯·ç­‰å¾…å®Œæˆ...', 'success');
                        
                        // è½®è¯¢æ‰«æç»“æœï¼ˆç§»é™¤å›ºå®šè¶…æ—¶ï¼Œåªè¦æ‰«æåœ¨è¿›è¡Œä¸­å°±ç»§ç»­ç­‰å¾…ï¼‰
                        let checkCount = 0;
                        let lastProgressTime = Date.now(); // è®°å½•æœ€åè¿›åº¦æ›´æ–°æ—¶é—´
                        let noUpdateCount = 0; // è¿ç»­æœªæ›´æ–°æ¬¡æ•°
                        scanCheckInterval = setInterval(async () => {
                            checkCount++;
                            
                            try {
                                const progressResponse = await fetch('/api/get_progress', {
                                    cache: 'no-store',
                                    headers: {
                                        'Cache-Control': 'no-cache'
                                    }
                                });
                                const progressResult = await progressResponse.json();
                                
                                if (progressResult.success && progressResult.progress) {
                                    const progress = progressResult.progress;
                                    
                                    // æ£€æŸ¥è¿›åº¦æ˜¯å¦é•¿æ—¶é—´æœªæ›´æ–°ï¼ˆå¯èƒ½å¡ä½äº†ï¼‰
                                    if (progress.last_update_time) {
                                        const timeSinceUpdate = (Date.now() / 1000) - progress.last_update_time;
                                        
                                        // å¦‚æœè¿›åº¦æœ‰æ›´æ–°ï¼Œé‡ç½®è®¡æ•°å™¨
                                        if (progress.percentage > 0 || progress.current > 0) {
                                            const currentProgress = progress.percentage || 0;
                                            const currentTime = Date.now();
                                            if (currentProgress > 0 || currentTime - lastProgressTime > 1000) {
                                                lastProgressTime = currentTime;
                                                noUpdateCount = 0; // é‡ç½®æœªæ›´æ–°è®¡æ•°
                                            }
                                        }
                                        
                                        // å¦‚æœè¶…è¿‡10åˆ†é’Ÿæœªæ›´æ–°ï¼Œæ‰è®¤ä¸ºå¯èƒ½å¡ä½äº†ï¼ˆå…¨å¸‚åœºæ‰«æéœ€è¦å¾ˆé•¿æ—¶é—´ï¼‰
                                        if (timeSinceUpdate > 600) {  // 10åˆ†é’Ÿæœªæ›´æ–°ï¼Œå¯èƒ½å¡ä½äº†
                                            noUpdateCount++;
                                            console.warn(`âš ï¸ è¿›åº¦å·² ${timeSinceUpdate.toFixed(0)} ç§’æœªæ›´æ–°ï¼Œå¯èƒ½å¡åœ¨: ${progress.current_stock || 'æœªçŸ¥è‚¡ç¥¨'}`);
                                            
                                            // å¦‚æœè¿ç»­5æ¬¡æ£€æŸ¥éƒ½è¶…è¿‡10åˆ†é’Ÿæœªæ›´æ–°ï¼Œæ‰çœŸæ­£è®¤ä¸ºå¡ä½äº†
                                            if (noUpdateCount >= 5) {
                                                clearInterval(scanCheckInterval);
                                                scanCheckInterval = null;
                                                stopProgressPolling();
                                                showMessage(`æ‰«æå¯èƒ½å·²å¡ä½ï¼ˆå·²è¶…è¿‡ ${Math.floor(timeSinceUpdate / 60)} åˆ†é’Ÿæœªæ›´æ–°ï¼‰ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æˆ–æ‰‹åŠ¨åœæ­¢æ‰«æ`, 'error');
                                                return;
                                            }
                                        } else {
                                            noUpdateCount = 0; // æœ‰æ›´æ–°ï¼Œé‡ç½®è®¡æ•°
                                        }
                                    }
                                    
                                    updateProgress(
                                        progress.percentage || 0,
                                        progress.status || 'è¿›è¡Œä¸­',
                                        progress.detail || 'æ‰«æä¸­...'
                                    );
                                    
                                    // å¦‚æœçŠ¶æ€æ˜¯"è¿›è¡Œä¸­"ï¼Œç»§ç»­ç­‰å¾…ï¼Œä¸è®¾ç½®è¶…æ—¶
                                    if (progress.status === 'è¿›è¡Œä¸­') {
                                        // ç»§ç»­ç­‰å¾…ï¼Œä¸è®¾ç½®è¶…æ—¶é™åˆ¶
                                        // æ¯100æ¬¡æ£€æŸ¥è¾“å‡ºä¸€æ¬¡æ—¥å¿—ï¼ˆçº¦100ç§’ï¼‰
                                        if (checkCount % 100 === 0) {
                                            console.log(`æ‰«æè¿›è¡Œä¸­... å·²æ£€æŸ¥ ${checkCount} æ¬¡ï¼Œå½“å‰è¿›åº¦: ${progress.percentage}%`);
                                        }
                                    } else if (progress.status === 'å®Œæˆ') {
                                        clearInterval(scanCheckInterval);
                                        scanCheckInterval = null;
                                        stopProgressPolling();
                                        
                                        // ç¦ç”¨åœæ­¢æŒ‰é’®
                                        if (stopBtn) {
                                            stopBtn.disabled = true;
                                        }
                                        
                                        // è·å–æ‰«æç»“æœ
                                        const resultsResponse = await fetch('/api/get_scan_results');
                                        const resultsResult = await resultsResponse.json();
                                        
                                        if (resultsResult.success && resultsResult.candidates) {
                                            displayScanResults(resultsResult);
                                            showMessage(`æ‰«æå®Œæˆï¼æ‰¾åˆ° ${resultsResult.found_count || 0} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨`, 'success');
                                        } else {
                                            showMessage(resultsResult.message || 'æ‰«æå®Œæˆï¼Œä½†æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨', 'error');
                                        }
                                    } else if (progress.status === 'å¤±è´¥' || progress.status === 'å·²åœæ­¢') {
                                        clearInterval(scanCheckInterval);
                                        scanCheckInterval = null;
                                        stopProgressPolling();
                                        
                                        // ç¦ç”¨åœæ­¢æŒ‰é’®
                                        if (stopBtn) {
                                            stopBtn.disabled = true;
                                        }
                                        
                                        if (progress.status === 'å·²åœæ­¢') {
                                            showMessage('æ‰«æå·²åœæ­¢', 'warning');
                                            // å¦‚æœå·²åœæ­¢ï¼Œç«‹å³è·å–å·²æ‰«æçš„ç»“æœ
                                            try {
                                                const resultsResponse = await fetch('/api/get_scan_results');
                                                const resultsResult = await resultsResponse.json();
                                                console.log('åœæ­¢åçš„æ‰«æç»“æœ:', resultsResult);
                                                
                                                if (resultsResult.success) {
                                                    if (resultsResult.candidates && resultsResult.candidates.length > 0) {
                                                        displayScanResults(resultsResult);
                                                        showMessage(`æ‰«æå·²åœæ­¢ï¼Œå·²æ‰¾åˆ° ${resultsResult.found_count || resultsResult.candidates.length || 0} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨`, 'success');
                                                    } else {
                                                        showMessage('æ‰«æå·²åœæ­¢ï¼Œä½†æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨', 'warning');
                                                    }
                                                } else {
                                                    showMessage('æ‰«æå·²åœæ­¢ï¼Œä½†æ— æ³•è·å–ç»“æœ: ' + (resultsResult.message || 'æœªçŸ¥é”™è¯¯'), 'warning');
                                                }
                                            } catch (error) {
                                                console.error('è·å–åœæ­¢åçš„æ‰«æç»“æœå¤±è´¥:', error);
                                                showMessage('æ‰«æå·²åœæ­¢ï¼Œä½†è·å–ç»“æœæ—¶å‡ºé”™: ' + error.message, 'warning');
                                            }
                                        } else {
                                            showMessage(progress.detail || 'æ‰«æå¤±è´¥', 'error');
                                        }
                                    }
                                } else {
                                    // å¦‚æœè·å–è¿›åº¦å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡é‡å¯äº†
                                    console.warn('æ— æ³•è·å–è¿›åº¦ä¿¡æ¯ï¼Œæ‰«æå¯èƒ½å·²åœæ­¢');
                                }
                            } catch (error) {
                                console.error('æ£€æŸ¥æ‰«æç»“æœå¤±è´¥:', error);
                                // å¦‚æœè¿ç»­å¤šæ¬¡å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡é—®é¢˜
                                if (checkCount > 10 && checkCount % 10 === 0) {
                                    console.warn(`âš ï¸ å·²è¿ç»­ ${checkCount} æ¬¡æ— æ³•è·å–è¿›åº¦ï¼Œæ‰«æå¯èƒ½å·²åœæ­¢`);
                                }
                            }
                        }, 1000); // æ¯1ç§’æ£€æŸ¥ä¸€æ¬¡
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    // è¯·æ±‚è¶…æ—¶ï¼Œä½†æ‰«æå¯èƒ½å·²åœ¨åå°å¯åŠ¨
                    showMessage('è¯·æ±‚è¶…æ—¶ï¼Œä½†æ‰«æå¯èƒ½å·²åœ¨åå°å¯åŠ¨ï¼Œè¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'warning');
                    // ä¸åœæ­¢è¿›åº¦è½®è¯¢ï¼Œå› ä¸ºæ‰«æå¯èƒ½åœ¨åå°ç»§ç»­
                } else {
                    // ç¦ç”¨åœæ­¢æŒ‰é’®
                    if (stopBtn) {
                        stopBtn.disabled = true;
                    }
                    stopProgressPolling();
                    hideProgress();
                    console.error('æ‰«æå¤±è´¥:', error);
                    showMessage('æ‰«æå¯åŠ¨å¤±è´¥: ' + error.message, 'error');
                }
            }
        }
        
        // æœç´¢åè½¬ä¸ªè‚¡ï¼ˆä¸Šå‘¨é˜´çº¿+æœ¬å‘¨é˜³çº¿ï¼‰
        async function scanReversalStocks() {
            console.log('scanReversalStocks å‡½æ•°è¢«è°ƒç”¨');
            
            // è·å–ç­›é€‰æ¡ä»¶
            const marketCapMaxInput = document.getElementById('reversalMarketCapMax');
            const marketCapMax = marketCapMaxInput ? parseFloat(marketCapMaxInput.value) : 100;
            
            if (isNaN(marketCapMax) || marketCapMax < 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„å¸‚å€¼ä¸Šé™ï¼ˆâ‰¥0ï¼‰', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦æœç´¢ä¸Šå‘¨é˜´çº¿+æœ¬å‘¨é˜³çº¿çš„åè½¬ä¸ªè‚¡å—ï¼Ÿ\nç­›é€‰æ¡ä»¶ï¼šå¸‚å€¼ < ${marketCapMax}äº¿å…ƒ\nè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ã€‚`)) {
                console.log('ç”¨æˆ·å–æ¶ˆäº†æœç´¢');
                return;
            }
            
            console.log('å¼€å§‹æœç´¢åè½¬ä¸ªè‚¡...', { marketCapMax });
            showMessage(`å¼€å§‹æœç´¢åè½¬ä¸ªè‚¡ï¼ˆå¸‚å€¼ < ${marketCapMax}äº¿å…ƒï¼‰ï¼Œè¯·ç¨å€™...`, 'success');
            showProgress();
            updateProgress(0, 'å‡†å¤‡ä¸­', 'å¼€å§‹æœç´¢åè½¬ä¸ªè‚¡...');
            
            // å¯ç”¨åœæ­¢æŒ‰é’®
            const stopBtn = document.getElementById('stopScanBtn');
            if (stopBtn) {
                stopBtn.disabled = false;
            }
            
            try {
                console.log('å‘é€è¯·æ±‚åˆ° /api/scan_reversal_stocks');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                const response = await fetch('/api/scan_reversal_stocks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        market_cap_max: marketCapMax
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('æ”¶åˆ°å“åº”:', result);
                
                if (result.success) {
                    console.log('æœç´¢å·²å¯åŠ¨ï¼Œå¼€å§‹è½®è¯¢è¿›åº¦');
                    // å¼€å§‹è½®è¯¢è¿›åº¦
                    let reversalCheckInterval = setInterval(async () => {
                        try {
                            // è·å–è¿›åº¦
                            const progressResponse = await fetch('/api/get_scan_progress');
                            if (!progressResponse.ok) {
                                console.error('è·å–è¿›åº¦å¤±è´¥:', progressResponse.status);
                                return;
                            }
                            
                            const progress = await progressResponse.json();
                            console.log('è¿›åº¦æ›´æ–°:', progress);
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯åè½¬æ‰«æ
                            if (progress && progress.type === 'reversal_scan') {
                                updateProgress(
                                    progress.percentage || 0,
                                    progress.status || 'è¿›è¡Œä¸­',
                                    progress.detail || 'æœç´¢ä¸­...'
                                );
                                
                                if (progress.status === 'å®Œæˆ') {
                                    clearInterval(reversalCheckInterval);
                                    stopProgressPolling();
                                    
                                    // ç¦ç”¨åœæ­¢æŒ‰é’®
                                    if (stopBtn) {
                                        stopBtn.disabled = true;
                                    }
                                    
                                    // è·å–æ‰«æç»“æœ
                                    const resultsResponse = await fetch('/api/get_reversal_scan_results');
                                    const resultsResult = await resultsResponse.json();
                                    
                                    if (resultsResult.success && resultsResult.stocks) {
                                        displayReversalResults(resultsResult);
                                        showMessage(`æœç´¢å®Œæˆï¼æ‰¾åˆ° ${resultsResult.found_count || 0} åªåè½¬ä¸ªè‚¡`, 'success');
                                    } else {
                                        showMessage(resultsResult.message || 'æœç´¢å®Œæˆï¼Œä½†æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨', 'error');
                                    }
                                    } else if (progress.status === 'å¤±è´¥' || progress.status === 'å·²åœæ­¢') {
                                        clearInterval(reversalCheckInterval);
                                        stopProgressPolling();
                                        
                                        // ç¦ç”¨åœæ­¢æŒ‰é’®
                                        if (stopBtn) {
                                            stopBtn.disabled = true;
                                        }
                                        
                                        if (progress.status === 'å·²åœæ­¢') {
                                            // å·²åœæ­¢ï¼Œè·å–åè½¬æ‰«æç»“æœ
                                            const resultsResponse = await fetch('/api/get_reversal_scan_results');
                                            const resultsResult = await resultsResponse.json();
                                            
                                            if (resultsResult.success && resultsResult.stocks) {
                                                displayReversalResults(resultsResult);
                                                showMessage(`åè½¬æ‰«æå·²åœæ­¢ï¼Œå·²æ‰¾åˆ° ${resultsResult.found_count || resultsResult.stocks.length || 0} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ã€‚`, 'success');
                                            } else {
                                                const totalScanned = progress.total || 0;
                                                const current = progress.current || 0;
                                                showMessage(`åè½¬æ‰«æå·²åœæ­¢ï¼Œå·²å¤„ç† ${current}/${totalScanned} åªè‚¡ç¥¨ã€‚`, 'warning');
                                            }
                                        } else {
                                            showMessage(progress.detail || 'æœç´¢å¤±è´¥', 'error');
                                        }
                                    }
                            }
                        } catch (error) {
                            console.error('æ£€æŸ¥åè½¬æ‰«æè¿›åº¦å¤±è´¥:', error);
                        }
                    }, 1000); // æ¯1ç§’æ£€æŸ¥ä¸€æ¬¡
                } else {
                    // ç¦ç”¨åœæ­¢æŒ‰é’®
                    if (stopBtn) {
                        stopBtn.disabled = true;
                    }
                    stopProgressPolling();
                    hideProgress();
                    showMessage(result.message || 'æœç´¢å¯åŠ¨å¤±è´¥', 'error');
                    console.error('æœç´¢å¯åŠ¨å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('æœç´¢åè½¬ä¸ªè‚¡å‡ºé”™:', error);
                if (error.name === 'AbortError') {
                    showMessage('è¯·æ±‚è¶…æ—¶ï¼Œä½†æœç´¢å¯èƒ½å·²åœ¨åå°å¯åŠ¨ï¼Œè¯·ç»§ç»­ç­‰å¾…è¿›åº¦æ›´æ–°...', 'warning');
                } else {
                    // ç¦ç”¨åœæ­¢æŒ‰é’®
                    if (stopBtn) {
                        stopBtn.disabled = true;
                    }
                    stopProgressPolling();
                    hideProgress();
                    console.error('æœç´¢å¤±è´¥:', error);
                    showMessage('æœç´¢å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
                }
            }
        }
        
        // æ˜¾ç¤ºåè½¬ä¸ªè‚¡æ‰«æç»“æœ
        function displayReversalResults(result) {
            const container = document.getElementById('reversalResults');
            container.style.display = 'block';
            
            if (!result.stocks || result.stocks.length === 0) {
                container.innerHTML = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; color: #999;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åè½¬ä¸ªè‚¡</div>';
                return;
            }
            
            let html = '<div style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            html += `<h3 style="margin-bottom: 15px; color: #333;">ğŸ“ˆ åè½¬ä¸ªè‚¡æœç´¢ç»“æœï¼ˆæ‰¾åˆ° ${result.found_count || result.stocks.length} åªï¼‰</h3>`;
            
            // æ˜¾ç¤ºç­›é€‰æ¡ä»¶
            const marketCapMax = result.market_cap_max || 100;
            html += '<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #9b59b6;">';
            html += '<h4 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">ğŸ“‹ ç­›é€‰æ¡ä»¶ï¼š</h4>';
            html += '<ul style="margin: 0; padding-left: 20px; color: #555; font-size: 13px; line-height: 1.8;">';
            html += '<li>âœ… ä¸Šå‘¨æ˜¯é˜´çº¿ï¼ˆæ”¶ç›˜ä»· < å¼€ç›˜ä»·ï¼‰</li>';
            html += '<li>âœ… æœ¬å‘¨æ˜¯é˜³çº¿ï¼ˆæ”¶ç›˜ä»· > å¼€ç›˜ä»·ï¼‰</li>';
            html += '<li>âœ… æœ¬å‘¨æ­¢è·Œï¼ˆæœ¬å‘¨æ”¶ç›˜ä»· â‰¥ ä¸Šå‘¨æ”¶ç›˜ä»·ï¼Œæˆ–æœ¬å‘¨æ¶¨å¹… > 0ï¼‰</li>';
            html += '<li>âœ… è‚¡ä»·åœ¨5å‘¨å‡çº¿ä¹‹ä¸Šï¼ˆå½“å‰ä»·æ ¼ > MA5ï¼‰</li>';
            html += `<li>âœ… å¸‚å€¼ < ${marketCapMax}äº¿å…ƒ</li>`;
            html += '</ul>';
            html += '</div>';
            
            // åˆ›å»ºè¡¨æ ¼
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">è‚¡ç¥¨ä»£ç </th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">è‚¡ç¥¨åç§°</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">ä¸Šå‘¨æ—¥æœŸ</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">ä¸Šå‘¨æ¶¨è·Œå¹…</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">æœ¬å‘¨æ—¥æœŸ</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">æœ¬å‘¨æ¶¨è·Œå¹…</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">å½“å‰ä»·æ ¼</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">5å‘¨å‡çº¿</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">ä»·æ ¼ç›¸å¯¹MA5</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">å¸‚å€¼(äº¿)</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">æ“ä½œ</th>';
            html += '</tr></thead><tbody>';
            
            result.stocks.forEach(stock => {
                const lastWeekChange = parseFloat(stock['ä¸Šå‘¨æ¶¨è·Œå¹…']) || 0;
                const thisWeekChange = parseFloat(stock['æœ¬å‘¨æ¶¨è·Œå¹…']) || 0;
                const lastWeekColor = lastWeekChange >= 0 ? '#e74c3c' : '#27ae60';
                const thisWeekColor = thisWeekChange >= 0 ? '#e74c3c' : '#27ae60';
                
                const ma5 = parseFloat(stock['5å‘¨å‡çº¿']) || 0;
                const priceToMa5 = parseFloat(stock['ä»·æ ¼ç›¸å¯¹MA5']) || 0;
                const priceToMa5Color = priceToMa5 >= 0 ? '#e74c3c' : '#27ae60';
                
                html += '<tr style="border-bottom: 1px solid #dee2e6;">';
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['è‚¡ç¥¨ä»£ç ']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['è‚¡ç¥¨åç§°']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['ä¸Šå‘¨æ—¥æœŸ']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; color: ${lastWeekColor};">${lastWeekChange.toFixed(2)}%</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['æœ¬å‘¨æ—¥æœŸ']}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; color: ${thisWeekColor};">${thisWeekChange.toFixed(2)}%</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${stock['å½“å‰ä»·æ ¼'].toFixed(2)} å…ƒ</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${ma5.toFixed(2)} å…ƒ</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6; color: ${priceToMa5Color};">${priceToMa5 >= 0 ? '+' : ''}${priceToMa5.toFixed(2)}%</td>`;
                const marketCap = stock['å¸‚å€¼'] !== null && stock['å¸‚å€¼'] !== undefined ? stock['å¸‚å€¼'].toFixed(2) : 'N/A';
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${marketCap}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><button class="btn btn-sm" onclick="showWeeklyKline('${stock['è‚¡ç¥¨ä»£ç ']}', '${stock['è‚¡ç¥¨åç§°']}')" style="background: #9b59b6; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">å‘¨Kçº¿</button><button class="btn btn-sm" onclick="findBuyPoints('${stock['è‚¡ç¥¨ä»£ç ']}')" style="background: #3498db; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">æ‰¾ä¹°ç‚¹</button></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // æ˜¾ç¤ºå‘¨Kçº¿å›¾
        let weeklyKlineChart = null;
        async function showWeeklyKline(stockCode, stockName) {
            const modal = document.getElementById('weeklyKlineModal');
            const title = document.getElementById('weeklyKlineTitle');
            const chartDiv = document.getElementById('weeklyKlineChart');
            
            title.textContent = `${stockCode} ${stockName} - å‘¨Kçº¿å›¾`;
            modal.style.display = 'block';
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            chartDiv.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">æ­£åœ¨åŠ è½½å‘¨Kçº¿æ•°æ®...</div>';
            
            try {
                const response = await fetch('/api/get_weekly_kline_for_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: stockCode })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    chartDiv.innerHTML = `<div style="text-align: center; padding: 50px; color: #e74c3c;">${data.error}</div>`;
                    return;
                }
                
                // ç»˜åˆ¶Kçº¿å›¾
                if (weeklyKlineChart) {
                    weeklyKlineChart.dispose();
                }
                // ç¡®ä¿å®¹å™¨æœ‰å°ºå¯¸
                chartDiv.style.width = '100%';
                chartDiv.style.height = '600px';
                weeklyKlineChart = echarts.init(chartDiv);
                
                // å‡†å¤‡Kçº¿æ•°æ®ï¼ˆECharts candlestickæ ¼å¼ï¼š[å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]ï¼‰
                const klineData = data.kline.map((k) => [k[0], k[1], k[2], k[3]]);  // [å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]
                
                // ç¡®ä¿å‡çº¿æ•°æ®é•¿åº¦ä¸Kçº¿æ•°æ®ä¸€è‡´ï¼Œå°†nullå€¼å¤„ç†ä¸ºundefinedï¼ˆEChartsä¼šè·³è¿‡undefinedï¼‰
                const ma5Data = data.ma5.map(v => v === null ? undefined : v);
                const ma10Data = data.ma10.map(v => v === null ? undefined : v);
                const ma20Data = data.ma20.map(v => v === null ? undefined : v);
                const ma60Data = data.ma60.map(v => v === null ? undefined : v);
                
                console.log('Kçº¿æ•°æ®:', klineData.slice(0, 5));  // è°ƒè¯•ï¼šæ˜¾ç¤ºå‰5æ¡æ•°æ®
                console.log('æ—¥æœŸæ•°æ®:', data.dates.slice(0, 5));  // è°ƒè¯•ï¼šæ˜¾ç¤ºå‰5ä¸ªæ—¥æœŸ
                console.log('MA5æ•°æ®:', ma5Data.slice(0, 5));  // è°ƒè¯•ï¼šæ˜¾ç¤ºå‰5æ¡MA5æ•°æ®
                
                const option = {
                    title: {
                        text: `${data.name} (${data.code}) å‘¨Kçº¿å›¾`,
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    legend: {
                        data: ['Kçº¿', 'MA5', 'MA10', 'MA20', 'MA60', 'æˆäº¤é‡'],
                        top: 30
                    },
                    grid: [
                        {
                            left: '10%',
                            right: '8%',
                            top: '15%',
                            height: '50%'
                        },
                        {
                            left: '10%',
                            right: '8%',
                            top: '70%',
                            height: '15%'
                        }
                    ],
                    xAxis: [
                        {
                            type: 'category',
                            data: data.dates,
                            scale: true,
                            boundaryGap: false,
                            axisLine: { onZero: false },
                            splitLine: { show: false },
                            min: 'dataMin',
                            max: 'dataMax'
                        },
                        {
                            type: 'category',
                            gridIndex: 1,
                            data: data.dates,
                            scale: true,
                            boundaryGap: false,
                            axisLine: { onZero: false },
                            axisTick: { show: false },
                            splitLine: { show: false },
                            min: 'dataMin',
                            max: 'dataMax'
                        }
                    ],
                    yAxis: [
                        {
                            scale: true,
                            splitArea: {
                                show: true
                            }
                        },
                        {
                            scale: true,
                            gridIndex: 1,
                            splitNumber: 2,
                            axisLabel: { show: false },
                            axisLine: { show: false },
                            axisTick: { show: false },
                            splitLine: { show: false }
                        }
                    ],
                    dataZoom: [
                        {
                            type: 'inside',
                            xAxisIndex: [0, 1],
                            start: 80,
                            end: 100
                        },
                        {
                            show: true,
                            xAxisIndex: [0, 1],
                            type: 'slider',
                            top: '90%',
                            start: 80,
                            end: 100
                        }
                    ],
                    series: [
                        {
                            name: 'Kçº¿',
                            type: 'candlestick',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: klineData,
                            itemStyle: {
                                // ä¸­å›½Kçº¿ä¹ æƒ¯ï¼šä¸Šæ¶¨ç”¨çº¢è‰²å®ä½“ï¼Œä¸‹è·Œç”¨ç»¿è‰²å®ä½“
                                color: '#ff4444',  // ä¸Šæ¶¨ï¼šçº¢è‰²å®ä½“ï¼ˆæ”¶ç›˜ä»· > å¼€ç›˜ä»·ï¼‰
                                color0: '#00aa00', // ä¸‹è·Œï¼šç»¿è‰²å®ä½“ï¼ˆæ”¶ç›˜ä»· < å¼€ç›˜ä»·ï¼‰
                                borderColor: '#ff4444',  // ä¸Šæ¶¨ï¼šçº¢è‰²è¾¹æ¡†
                                borderColor0: '#00aa00'  // ä¸‹è·Œï¼šç»¿è‰²è¾¹æ¡†
                            },
                            emphasis: {
                                itemStyle: {
                                    borderWidth: 2
                                }
                            }
                        },
                        {
                            name: 'MA5',
                            type: 'line',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: ma5Data,
                            smooth: false,
                            lineStyle: { width: 2, color: '#ff7f00' },
                            showSymbol: false,
                            connectNulls: false
                        },
                        {
                            name: 'MA10',
                            type: 'line',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: ma10Data,
                            smooth: false,
                            lineStyle: { width: 2, color: '#00ff00' },
                            showSymbol: false,
                            connectNulls: false
                        },
                        {
                            name: 'MA20',
                            type: 'line',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: ma20Data,
                            smooth: false,
                            lineStyle: { width: 2, color: '#0000ff' },
                            showSymbol: false,
                            connectNulls: false
                        },
                        {
                            name: 'MA60',
                            type: 'line',
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            data: ma60Data,
                            smooth: false,
                            lineStyle: { width: 2, color: '#ff00ff' },
                            showSymbol: false,
                            connectNulls: false
                        },
                        {
                            name: 'æˆäº¤é‡',
                            type: 'bar',
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            data: data.volumes,
                            itemStyle: {
                                // æˆäº¤é‡é¢œè‰²ï¼šä¸Šæ¶¨ç”¨çº¢è‰²ï¼Œä¸‹è·Œç”¨ç»¿è‰²ï¼ˆç¬¦åˆä¸­å›½Kçº¿ä¹ æƒ¯ï¼‰
                                color: function(params) {
                                    const k = data.kline[params.dataIndex];
                                    // k[0]æ˜¯å¼€ç›˜ä»·ï¼Œk[1]æ˜¯æ”¶ç›˜ä»·
                                    return k[1] >= k[0] ? '#ff4444' : '#00aa00';
                                }
                            }
                        }
                    ]
                };
                
                try {
                    weeklyKlineChart.setOption(option, true);  // notMerge=trueï¼Œå®Œå…¨æ›¿æ¢é…ç½®
                    console.log('Kçº¿å›¾é…ç½®å·²è®¾ç½®');
                    
                    // ç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“
                    setTimeout(() => {
                        if (weeklyKlineChart) {
                            weeklyKlineChart.resize();
                            console.log('Kçº¿å›¾å·²è°ƒæ•´å°ºå¯¸');
                        }
                    }, 200);
                } catch (chartError) {
                    console.error('è®¾ç½®Kçº¿å›¾é…ç½®å¤±è´¥:', chartError);
                    chartDiv.innerHTML = `<div style="text-align: center; padding: 50px; color: #e74c3c;">å›¾è¡¨æ¸²æŸ“å¤±è´¥: ${chartError.message}</div>`;
                    return;
                }
                
                // å“åº”å¼è°ƒæ•´
                window.addEventListener('resize', function() {
                    if (weeklyKlineChart) {
                        weeklyKlineChart.resize();
                    }
                });
                
            } catch (error) {
                console.error('åŠ è½½å‘¨Kçº¿æ•°æ®å¤±è´¥:', error);
                chartDiv.innerHTML = `<div style="text-align: center; padding: 50px; color: #e74c3c;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function closeWeeklyKline() {
            const modal = document.getElementById('weeklyKlineModal');
            modal.style.display = 'none';
            if (weeklyKlineChart) {
                weeklyKlineChart.dispose();
                weeklyKlineChart = null;
            }
        }
        
        // æ˜¾ç¤ºæ‰«æç»“æœ
        function displayScanResults(result) {
            const container = document.getElementById('buyPointsResult');
            
            if (!result.candidates || result.candidates.length === 0) {
                container.innerHTML = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; color: #999;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</div>';
                return;
            }
            
            let html = '<div style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px;">';
            html += `<h4>ğŸ¯ æ‰«æç»“æœï¼šæ‰¾åˆ° ${result.found_count} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ï¼ˆæ˜¾ç¤ºå‰ ${result.candidates.length} åªï¼‰</h4>`;
            html += `<p style="color: #666; font-size: 12px;">æ‰«ææ€»æ•°: ${result.total_scanned} åª</p>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px;">';
            html += '<tr style="background: #f0f0f0;"><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æ’å</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è‚¡ç¥¨ä»£ç </th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">è‚¡ç¥¨åç§°</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">åŒ¹é…åº¦</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æœ€ä½³ä¹°ç‚¹æ—¥æœŸ</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">æœ€ä½³ä¹°ç‚¹ä»·æ ¼</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å½“å‰ä»·æ ¼</th><th style="padding: 8px; border: 1px solid #ddd; text-align: left;">å¸‚å€¼(äº¿)</th></tr>';
            
            result.candidates.forEach((candidate, index) => {
                const matchColor = candidate.åŒ¹é…åº¦ >= 0.8 ? '#27ae60' : candidate.åŒ¹é…åº¦ >= 0.7 ? '#f39c12' : '#e74c3c';
                html += `<tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #667eea;">${candidate.è‚¡ç¥¨ä»£ç }</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${candidate.è‚¡ç¥¨åç§°}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; color: ${matchColor}; font-weight: bold;">${candidate.åŒ¹é…åº¦.toFixed(3)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${candidate.æœ€ä½³ä¹°ç‚¹æ—¥æœŸ}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #e74c3c;">${candidate.æœ€ä½³ä¹°ç‚¹ä»·æ ¼.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${candidate.å½“å‰ä»·æ ¼.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${candidate.å¸‚å€¼ ? candidate.å¸‚å€¼.toFixed(2) : 'N/A'}</td>
                </tr>`;
            });
            
            html += '</table></div>';
            container.innerHTML = html;
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–è‚¡ç¥¨åˆ—è¡¨
        function initPageLoad() {
            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥åŒ¹é…åº¦çŠ¶æ€
            checkMatchScoreStatus();
            try {
                console.log('[initPageLoad] åˆå§‹åŒ–é¡µé¢åŠ è½½...');
                console.log('[initPageLoad] document.readyState:', document.readyState);
                
                // æ£€æŸ¥å¿…è¦çš„DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
                const container = document.getElementById('stocksContainer');
                const countEl = document.getElementById('stockCount');
                console.log('[initPageLoad] stocksContainer:', container ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                console.log('[initPageLoad] stockCount:', countEl ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                
                if (!container || !countEl) {
                    console.warn('[initPageLoad] DOMå…ƒç´ æœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿ100msåé‡è¯•...');
                    setTimeout(initPageLoad, 100);
                    return;
                }
                
                console.log('[initPageLoad] DOMå…ƒç´ å·²å‡†å¤‡å¥½ï¼Œå¼€å§‹åŠ è½½è‚¡ç¥¨åˆ—è¡¨...');
                loadStocks();
            } catch (error) {
                console.error('[initPageLoad] åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // å¤šç§æ–¹å¼ç¡®ä¿é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        try {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('[initPageLoad] DOMContentLoadedäº‹ä»¶è§¦å‘');
                    setTimeout(initPageLoad, 50);
                });
            } else {
                // DOMå·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³æ‰§è¡Œ
                console.log('[initPageLoad] DOMå·²åŠ è½½å®Œæˆï¼Œç«‹å³åˆå§‹åŒ–');
                setTimeout(initPageLoad, 50);
            }
        } catch (error) {
            console.error('[initPageLoad] è®¾ç½®äº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', error);
        }
        
        // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
        setInterval(function() {
            console.log('[å®šæ—¶åˆ·æ–°] è‡ªåŠ¨åˆ·æ–°è‚¡ç¥¨åˆ—è¡¨...');
            loadStocks();
        }, 5000);
        
        // Vercel åˆ†æ‰¹æ‰«æï¼šè‡ªåŠ¨ç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹æ¬¡
        async function autoContinueScan(scanId, currentBatch, totalBatches) {
            if (!scanId || currentBatch >= totalBatches) {
                console.log('æ‰€æœ‰æ‰¹æ¬¡å·²å®Œæˆ');
                return;
            }
            
            // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œè®©ä¸Šä¸€æ‰¹æ¬¡å®Œæˆï¼ˆå¢åŠ å»¶è¿Ÿä»¥æé«˜ç¨³å®šæ€§ï¼‰
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            try {
                console.log(`å¼€å§‹å¤„ç†ç¬¬ ${currentBatch + 1}/${totalBatches} æ‰¹...`);
                
                const response = await fetch('/api/continue_scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scan_id: scanId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                console.log(`ç¬¬ ${currentBatch + 1} æ‰¹å¤„ç†ç»“æœ:`, result);
                
                if (result.success) {
                    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                    if (result.progress) {
                        updateProgress(
                            result.progress.percentage || 0,
                            result.progress.status || 'è¿›è¡Œä¸­',
                            result.progress.detail || `æ­£åœ¨å¤„ç†ç¬¬ ${currentBatch + 1}/${totalBatches} æ‰¹...`
                        );
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ‰¹æ¬¡
                    if (result.has_more && !result.is_complete) {
                        // ç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹æ¬¡
                        window.currentScanBatch = currentBatch + 1;
                        autoContinueScan(scanId, currentBatch + 1, totalBatches);
                    } else if (result.is_complete) {
                        // æ‰€æœ‰æ‰¹æ¬¡å®Œæˆ
                        console.log('æ‰€æœ‰æ‰¹æ¬¡å¤„ç†å®Œæˆï¼');
                        showMessage(`æ‰«æå®Œæˆï¼å…±æ‰¾åˆ° ${result.progress?.found || 0} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨`, 'success');
                        hideProgress();
                        stopProgressPolling();
                        const stopBtn = document.getElementById('stopScanBtn');
                        if (stopBtn) stopBtn.disabled = true;
                        
                        // åˆ·æ–°è‚¡ç¥¨åˆ—è¡¨
                        loadStocks();
                    }
                } else {
                    throw new Error(result.message || 'å¤„ç†æ‰¹æ¬¡å¤±è´¥');
                }
            } catch (error) {
                console.error(`å¤„ç†ç¬¬ ${currentBatch + 1} æ‰¹å¤±è´¥:`, error);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ 404 é”™è¯¯ï¼ˆæ‰«æä»»åŠ¡ä¸¢å¤±ï¼‰
                if (error.message && error.message.includes('404')) {
                    showMessage(`æ‰«æä»»åŠ¡å·²ä¸¢å¤±ï¼ˆå¯èƒ½æ•°æ®å·²è¿‡æœŸï¼‰ã€‚å·²å¤„ç† ${currentBatch}/${totalBatches} æ‰¹ã€‚`, 'error');
                    hideProgress();
                    stopProgressPolling();
                    const stopBtn = document.getElementById('stopScanBtn');
                    if (stopBtn) stopBtn.disabled = true;
                    return; // åœæ­¢ç»§ç»­å¤„ç†
                }
                
                    showMessage(`å¤„ç†ç¬¬ ${currentBatch + 1} æ‰¹å¤±è´¥: ${error.message}`, 'error');
                    // å°è¯•ç»§ç»­ä¸‹ä¸€æ‰¹æ¬¡ï¼ˆå¦‚æœå¯èƒ½ï¼Œä¸”ä¸æ˜¯ 404 é”™è¯¯ï¼‰ï¼Œå¢åŠ é‡è¯•å»¶è¿Ÿä»¥æé«˜ç¨³å®šæ€§
                    if (currentBatch + 1 < totalBatches && !error.message.includes('404')) {
                        console.log(`5ç§’åé‡è¯•ç¬¬ ${currentBatch + 2} æ‰¹...`);
                        setTimeout(() => autoContinueScan(scanId, currentBatch + 1, totalBatches), 5000);
                } else {
                    // å¦‚æœæ˜¯æœ€åä¸€æ‰¹æˆ– 404 é”™è¯¯ï¼Œåœæ­¢å¤„ç†
                    console.error('æ— æ³•ç»§ç»­å¤„ç†ï¼Œåœæ­¢æ‰«æ');
                    hideProgress();
                    stopProgressPolling();
                    const stopBtn = document.getElementById('stopScanBtn');
                    if (stopBtn) stopBtn.disabled = true;
                }
            }
        }
    </script>
</body>
</html>

