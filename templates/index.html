<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aè‚¡é‡ä»·åˆ†æé€‰è‚¡è½¯ä»¶</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js">        
        // æ¡ä»¶å¼€å…³åˆ‡æ¢æ—¶æ˜¾ç¤º/éšè—å‚æ•°
        document.addEventListener('DOMContentLoaded', function() {
            for (let i = 1; i <= 8; i++) {
                const checkbox = document.getElementById(`cond${i}_enabled`);
                const params = document.getElementById(`cond${i}_params`);
                if (checkbox && params) {
                    checkbox.addEventListener('change', function() {
                        params.style.display = this.checked ? 'block' : 'none';
                    });
                    // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
                    params.style.display = checkbox.checked ? 'block' : 'none';
                }
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .progress-section {
            display: none;
        }
        
        .progress-section.active {
            display: block;
        }
        
        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            color: #666;
        }
        
        .results-section {
            display: none;
        }
        
        .results-section.active {
            display: block;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .results-table th {
            background: #667eea;
            color: white;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background: #28a745;
        }
        
        .status-disconnected {
            background: #dc3545;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .found-stocks {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .stock-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        
        .stock-item strong {
            color: #667eea;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }
        
        .progress-bar {
            transition: width 0.2s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ Aè‚¡é‡ä»·åˆ†æé€‰è‚¡è½¯ä»¶</h1>
            <p>åŸºäºé‡ä»·åˆ†æç†è®ºçš„æ™ºèƒ½é€‰è‚¡ç³»ç»Ÿ</p>
            <div style="margin-top: 10px;">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">æœªè¿æ¥</span>
            </div>
        </div>
        
        <div class="content">
            <!-- æ¡ä»¶è®¾ç½®åŒºåŸŸ -->
            <div class="section">
                <h2>ğŸ“‹ ç­›é€‰æ¡ä»¶è®¾ç½®</h2>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="exclude_st" checked>
                        <label for="exclude_st">æ’é™¤STè‚¡ç¥¨</label>
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: #e9ecef; border-radius: 5px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">é€‰è‚¡æ¡ä»¶é…ç½®</h3>
                    
                    <!-- æ¡ä»¶1 -->
                    <div class="condition-item" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">
                        <div class="checkbox-group" style="margin-bottom: 8px;">
                            <input type="checkbox" id="cond1_enabled" checked>
                            <label for="cond1_enabled"><strong>æ¡ä»¶1ï¼š</strong>è¿‡å»ä¸€å¹´å†…å‡ºç°è¿‡å†å²æœ€å¤§æˆäº¤é‡</label>
                        </div>
                        <div style="margin-left: 25px; display: none;" id="cond1_params">
                            <label>æŸ¥è¯¢å¤©æ•°ï¼š</label>
                            <input type="number" id="cond1_days" value="365" min="30" style="width: 100px;">
                        </div>
                    </div>
                    
                    <!-- æ¡ä»¶2 -->
                    <div class="condition-item" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">
                        <div class="checkbox-group" style="margin-bottom: 8px;">
                            <input type="checkbox" id="cond2_enabled" checked>
                            <label for="cond2_enabled"><strong>æ¡ä»¶2ï¼š</strong>è‚¡ä»·æŒç»­è¿è¡Œåœ¨å¹´çº¿ä¹‹ä¸Šï¼Œé‡å¿ƒç¨³æ­¥ä¸Šç§»</label>
                        </div>
                        <div style="margin-left: 25px; display: none;" id="cond2_params">
                            <label>å¹´çº¿å‘¨æœŸï¼ˆæ—¥å‡çº¿ï¼‰ï¼š</label>
                            <input type="number" id="cond2_ma_period" value="250" min="50" style="width: 100px;">
                            <label style="margin-left: 15px;">é‡å¿ƒæ£€æŸ¥å¤©æ•°ï¼š</label>
                            <input type="number" id="cond2_recent_days" value="30" min="10" style="width: 100px;">
                        </div>
                    </div>
                    
                    <!-- æ¡ä»¶3 -->
                    <div class="condition-item" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">
                        <div class="checkbox-group" style="margin-bottom: 8px;">
                            <input type="checkbox" id="cond3_enabled" checked>
                            <label for="cond3_enabled"><strong>æ¡ä»¶3ï¼š</strong>æ‰¾åˆ°å¯åŠ¨ä»·ï¼ˆè¿ç»­ä¸‹è·Œä¸è¶…è¿‡2ä¸ªæœˆï¼Œä¸è·Œç ´20æœˆå‡çº¿ï¼Œæœˆçº¿åè½¬ï¼‰</label>
                        </div>
                        <div style="margin-left: 25px; display: none;" id="cond3_params">
                            <label>æœ€å¤§è¿ç»­ä¸‹è·Œæœˆæ•°ï¼š</label>
                            <input type="number" id="cond3_max_decline" value="2" min="1" max="6" style="width: 80px;">
                            <label style="margin-left: 15px;">æœˆå‡çº¿å‘¨æœŸï¼š</label>
                            <input type="number" id="cond3_ma_period" value="20" min="5" style="width: 80px;">
                        </div>
                    </div>
                    
                    <!-- æ¡ä»¶4 -->
                    <div class="condition-item" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">
                        <div class="checkbox-group" style="margin-bottom: 8px;">
                            <input type="checkbox" id="cond4_enabled" checked>
                            <label for="cond4_enabled"><strong>æ¡ä»¶4ï¼š</strong>å½“å‰ä»·åœ¨å¯åŠ¨ä»·é™„è¿‘ï¼Œä¸”ä¸è·Œç ´åè½¬æ—¥æœ€ä½ä»·</label>
                        </div>
                        <div style="margin-left: 25px; display: none;" id="cond4_params">
                            <label>å¯åŠ¨ä»·é˜ˆå€¼ï¼ˆ%ï¼‰ï¼š</label>
                            <input type="number" id="cond4_threshold" value="3" min="1" max="10" step="0.5" style="width: 100px;">
                        </div>
                    </div>
                    
                    <!-- æ¡ä»¶5 -->
                    <div class="condition-item" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">
                        <div class="checkbox-group" style="margin-bottom: 8px;">
                            <input type="checkbox" id="cond5_enabled" checked>
                            <label for="cond5_enabled"><strong>æ¡ä»¶5ï¼š</strong>æœ€è¿‘ä¸€ä¸ªäº¤æ˜“æ—¥æˆäº¤é‡ â‰¥ ä¸Šä¸€ä¸ªäº¤æ˜“æ—¥çš„Nå€</label>
                        </div>
                        <div style="margin-left: 25px; display: none;" id="cond5_params">
                            <label>æˆäº¤é‡å€æ•°ï¼š</label>
                            <input type="number" id="cond5_multiplier" value="2.0" min="1" max="10" step="0.1" style="width: 100px;">
                        </div>
                    </div>
                    
                    <!-- æ¡ä»¶6 -->
                    <div class="condition-item" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">
                        <div class="checkbox-group" style="margin-bottom: 8px;">
                            <input type="checkbox" id="cond6_enabled" checked>
                            <label for="cond6_enabled"><strong>æ¡ä»¶6ï¼š</strong>æœ€è¿‘Nä¸ªäº¤æ˜“æ—¥å†…å‡ºç°è¿‡æ¶¨åœ</label>
                        </div>
                        <div style="margin-left: 25px; display: none;" id="cond6_params">
                            <label>æŸ¥è¯¢å¤©æ•°ï¼š</label>
                            <input type="number" id="cond6_days" value="10" min="1" max="30" style="width: 100px;">
                        </div>
                    </div>
                    
                    <!-- æ¡ä»¶7 -->
                    <div class="condition-item" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">
                        <div class="checkbox-group" style="margin-bottom: 8px;">
                            <input type="checkbox" id="cond7_enabled" checked>
                            <label for="cond7_enabled"><strong>æ¡ä»¶7ï¼š</strong>è¿‡å»Nä¸ªæœˆå†…æœ‰æœ€å¤§æœˆæˆäº¤é‡</label>
                        </div>
                        <div style="margin-left: 25px; display: none;" id="cond7_params">
                            <label>æŸ¥è¯¢æœˆæ•°ï¼š</label>
                            <input type="number" id="cond7_months" value="12" min="3" max="24" style="width: 100px;">
                        </div>
                    </div>
                    
                    <!-- æ¡ä»¶8 -->
                    <div class="condition-item" style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 5px;">
                        <div class="checkbox-group" style="margin-bottom: 8px;">
                            <input type="checkbox" id="cond8_enabled" checked>
                            <label for="cond8_enabled"><strong>æ¡ä»¶8ï¼š</strong>æœˆçº¿çº§åˆ«è‚¡ä»·ç¨³æ­¥ä¸Šå‡</label>
                        </div>
                        <div style="margin-left: 25px; display: none;" id="cond8_params">
                            <label>è¶‹åŠ¿æ£€æŸ¥æœˆæ•°ï¼š</label>
                            <input type="number" id="cond8_months" value="6" min="3" max="12" style="width: 100px;">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="startBtn" onclick="startAnalysis()">ğŸš€ å¼€å§‹åˆ†æï¼ˆåˆ†æå…¨éƒ¨è‚¡ç¥¨ï¼‰</button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopAnalysis()" disabled>â¹ åœæ­¢åˆ†æ</button>
            </div>
            
            <!-- è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="section progress-section" id="progressSection">
                <h2>ğŸ“Š åˆ†æè¿›åº¦</h2>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="progress-info">
                    <span>å·²åˆ†æ: <strong id="currentCount" style="color: #667eea; font-size: 1.2em;">0</strong> / <strong id="totalCount" style="color: #667eea; font-size: 1.2em;">0</strong></span>
                    <span>å·²ç”¨æ—¶: <strong id="elapsedTime">0</strong> ç§’</span>
                    <span>é¢„è®¡å‰©ä½™: <strong id="remainingTime">0</strong> ç§’</span>
                </div>
                <div class="progress-info">
                    <span>æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨: <strong id="foundCount" style="color: #28a745; font-size: 1.2em;">0</strong> åª</span>
                </div>
                <div id="currentMessage" style="margin-top: 10px; color: #666; font-weight: bold;"></div>
                
                <!-- å®æ—¶å‘ç°çš„è‚¡ç¥¨ -->
                <div class="found-stocks" id="foundStocks" style="display: none;">
                    <h3 style="margin-bottom: 10px; color: #667eea;">âœ… å·²å‘ç°çš„è‚¡ç¥¨ï¼š</h3>
                    <div id="foundStocksList"></div>
                </div>
            </div>
            
            <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
            <div class="section results-section" id="resultsSection">
                <h2>ğŸ“ˆ é€‰è‚¡ç»“æœ</h2>
                <div id="resultsSummary"></div>
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th>è‚¡ç¥¨åç§°</th>
                            <th>å½“å‰ä»·æ ¼</th>
                            <th>å¯åŠ¨ä»·</th>
                            <th>åè½¬æ—¥æœŸ</th>
                            <th>æ¶¨åœæ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        const socket = io();
        let analysisRunning = false;
        let foundStocks = [];
        
        // è¿æ¥çŠ¶æ€
        socket.on('connect', () => {
            console.log('WebSocketå·²è¿æ¥');
            document.getElementById('statusIndicator').className = 'status-indicator status-connected';
            document.getElementById('statusText').textContent = 'å·²è¿æ¥';
        });
        
        socket.on('disconnect', () => {
            document.getElementById('statusIndicator').className = 'status-indicator status-disconnected';
            document.getElementById('statusText').textContent = 'æœªè¿æ¥';
        });
        
        socket.on('connected', (data) => {
            console.log('æœåŠ¡å™¨è¿æ¥:', data);
        });
        
        // è¿›åº¦æ›´æ–°
        socket.on('progress', (data) => {
            console.log('æ”¶åˆ°è¿›åº¦æ›´æ–°:', data);  // è°ƒè¯•æ—¥å¿—
            updateProgress(data);
        });
        
        // å‘ç°è‚¡ç¥¨
        socket.on('stock_found', (data) => {
            foundStocks.push(data);
            addFoundStock(data);
        });
        
        // åˆ†æå®Œæˆ
        socket.on('complete', (data) => {
            analysisRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            showResults(data);
        });
        
        // é”™è¯¯å¤„ç†
        socket.on('error', (data) => {
            console.error('é”™è¯¯:', data);
            alert('é”™è¯¯: ' + data.message);
        });
        
        // å¼€å§‹åˆ†æ
        function startAnalysis() {
            const exclude_st = document.getElementById('exclude_st').checked;
            
            // æ”¶é›†æ¡ä»¶è®¾ç½®
            const conditions = {
                condition1_enabled: document.getElementById('cond1_enabled').checked,
                condition1_days: parseInt(document.getElementById('cond1_days').value),
                
                condition2_enabled: document.getElementById('cond2_enabled').checked,
                condition2_ma_period: parseInt(document.getElementById('cond2_ma_period').value),
                condition2_recent_days: parseInt(document.getElementById('cond2_recent_days').value),
                
                condition3_enabled: document.getElementById('cond3_enabled').checked,
                condition3_max_decline_months: parseInt(document.getElementById('cond3_max_decline').value),
                condition3_ma_monthly_period: parseInt(document.getElementById('cond3_ma_period').value),
                
                condition4_enabled: document.getElementById('cond4_enabled').checked,
                condition4_threshold: parseFloat(document.getElementById('cond4_threshold').value) / 100,
                
                condition5_enabled: document.getElementById('cond5_enabled').checked,
                condition5_multiplier: parseFloat(document.getElementById('cond5_multiplier').value),
                
                condition6_enabled: document.getElementById('cond6_enabled').checked,
                condition6_days: parseInt(document.getElementById('cond6_days').value),
                
                condition7_enabled: document.getElementById('cond7_enabled').checked,
                condition7_months: parseInt(document.getElementById('cond7_months').value),
                
                condition8_enabled: document.getElementById('cond8_enabled').checked,
                condition8_months: parseInt(document.getElementById('cond8_months').value),
            };
            
            analysisRunning = true;
            foundStocks = [];
            document.getElementById('foundStocksList').innerHTML = '';
            document.getElementById('resultsBody').innerHTML = '';
            
            // é‡ç½®è¿›åº¦æ˜¾ç¤º
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            document.getElementById('currentCount').textContent = '0';
            document.getElementById('totalCount').textContent = 'ç­‰å¾…ä¸­...';
            document.getElementById('foundCount').textContent = '0';
            document.getElementById('elapsedTime').textContent = '0ç§’';
            document.getElementById('remainingTime').textContent = 'è®¡ç®—ä¸­...';
            document.getElementById('currentMessage').textContent = 'æ­£åœ¨è·å–è‚¡ç¥¨åˆ—è¡¨...';
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('resultsSection').classList.remove('active');
            
            console.log('å¼€å§‹åˆ†æï¼Œç­‰å¾…è¿›åº¦æ›´æ–°...');
            
            fetch('/api/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    limit: null,  // ä¸é™åˆ¶æ•°é‡ï¼Œåˆ†æå…¨éƒ¨
                    exclude_st: exclude_st,
                    conditions: conditions
                })
            }).then(response => response.json())
              .then(data => {
                  if (data.error) {
                      alert('é”™è¯¯: ' + data.error);
                      analysisRunning = false;
                      document.getElementById('startBtn').disabled = false;
                      document.getElementById('stopBtn').disabled = true;
                  }
              });
        }
        
        // åœæ­¢åˆ†æ
        function stopAnalysis() {
            fetch('/api/stop', {
                method: 'POST'
            }).then(() => {
                analysisRunning = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            });
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress(data) {
            console.log('æ›´æ–°è¿›åº¦:', data);  // è°ƒè¯•æ—¥å¿—
            
            const percentage = data.percentage || 0;
            const current = data.current || 0;
            const total = data.total || 0;
            
            // å¼ºåˆ¶æ›´æ–°è¿›åº¦æ¡
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
                progressBar.textContent = percentage.toFixed(1) + '%';
            }
            
            // æ›´æ–°å…¶ä»–ä¿¡æ¯ - ç«‹å³æ›´æ–°ï¼Œä¸ç­‰å¾…
            const currentCountEl = document.getElementById('currentCount');
            const totalCountEl = document.getElementById('totalCount');
            const elapsedTimeEl = document.getElementById('elapsedTime');
            const remainingTimeEl = document.getElementById('remainingTime');
            const foundCountEl = document.getElementById('foundCount');
            const currentMessageEl = document.getElementById('currentMessage');
            
            // å¦‚æœtotalæœ‰å€¼ï¼Œç«‹å³æ›´æ–°æ€»æ•°ï¼ˆå³ä½¿currentè¿˜æ˜¯0ï¼‰
            if (total > 0 && totalCountEl) {
                totalCountEl.textContent = total;
            }
            
            // æ›´æ–°å·²åˆ†ææ•°é‡
            if (currentCountEl) {
                currentCountEl.textContent = current;
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                currentCountEl.style.transition = 'all 0.3s';
                currentCountEl.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    currentCountEl.style.transform = 'scale(1)';
                }, 300);
            }
            
            if (elapsedTimeEl) elapsedTimeEl.textContent = formatTime(data.elapsed || 0);
            if (remainingTimeEl) remainingTimeEl.textContent = formatTime(data.remaining || 0);
            if (foundCountEl) {
                foundCountEl.textContent = data.found_count || 0;
                // å¦‚æœæ‰¾åˆ°è‚¡ç¥¨ï¼Œæ·»åŠ é—ªçƒæ•ˆæœ
                if (data.found_count > 0) {
                    foundCountEl.style.animation = 'pulse 0.5s';
                }
            }
            if (currentMessageEl) currentMessageEl.textContent = data.message || '';
            
            // ç¡®ä¿è¿›åº¦åŒºåŸŸå¯è§
            const progressSection = document.getElementById('progressSection');
            if (progressSection && !progressSection.classList.contains('active')) {
                progressSection.classList.add('active');
            }
        }
        
        // æ·»åŠ å‘ç°çš„è‚¡ç¥¨
        function addFoundStock(data) {
            const foundStocksDiv = document.getElementById('foundStocks');
            const foundStocksList = document.getElementById('foundStocksList');
            
            // æ˜¾ç¤ºå‘ç°è‚¡ç¥¨çš„å®¹å™¨
            foundStocksDiv.style.display = 'block';
            
            // åˆ›å»ºè‚¡ç¥¨é¡¹
            const stockItem = document.createElement('div');
            stockItem.className = 'stock-item';
            stockItem.style.animation = 'fadeIn 0.5s';
            
            const price = data.price || data.detail?.å½“å‰ä»·æ ¼ || 'N/A';
            const priceStr = typeof price === 'number' ? price.toFixed(2) : price;
            const startupPrice = data.startup_price || data.detail?.å¯åŠ¨ä»·;
            const startupPriceStr = startupPrice ? startupPrice.toFixed(2) : 'N/A';
            
            stockItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #667eea; font-size: 1.1em;">${data.code}</strong> 
                        <span style="font-weight: bold;">${data.name}</span>
                    </div>
                    <div style="text-align: right;">
                        <div>å½“å‰ä»·æ ¼: <strong style="color: #28a745;">${priceStr}</strong></div>
                        ${startupPrice ? `<div>å¯åŠ¨ä»·: <strong>${startupPriceStr}</strong></div>` : ''}
                    </div>
                </div>
            `;
            
            // æ’å…¥åˆ°åˆ—è¡¨é¡¶éƒ¨ï¼ˆæœ€æ–°å‘ç°çš„åœ¨æœ€ä¸Šé¢ï¼‰
            foundStocksList.insertBefore(stockItem, foundStocksList.firstChild);
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œç¡®ä¿æ–°å‘ç°çš„è‚¡ç¥¨å¯è§
            foundStocksDiv.scrollTop = 0;
            
            // æ·»åŠ é—ªçƒæ•ˆæœæç¤º
            stockItem.style.backgroundColor = '#fff3cd';
            setTimeout(() => {
                stockItem.style.backgroundColor = 'white';
            }, 2000);
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResults(data) {
            document.getElementById('resultsSection').classList.add('active');
            
            const summary = `
                <div class="alert alert-success">
                    <strong>åˆ†æå®Œæˆï¼</strong><br>
                    å…±åˆ†æ ${data.total} åªè‚¡ç¥¨ï¼Œæ‰¾åˆ° ${data.found} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨<br>
                    æ€»è€—æ—¶: ${formatTime(data.time)}
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="exportResults()">ğŸ“¥ å¯¼å‡ºåˆ°Excel</button>
                    </div>
                </div>
            `;
            document.getElementById('resultsSummary').innerHTML = summary;
            
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            
            // å…ˆå°è¯•ä»æœåŠ¡å™¨è·å–å®Œæ•´ç»“æœ
            fetch('/api/results')
                .then(response => response.json())
                .then(resultData => {
                    if (resultData.results && resultData.results.length > 0) {
                        // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„å®Œæ•´ç»“æœ
                        resultData.results.forEach(stock => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = stock.è‚¡ç¥¨ä»£ç  || 'N/A';
                            row.insertCell(1).textContent = stock.è‚¡ç¥¨åç§° || 'N/A';
                            row.insertCell(2).textContent = stock.å½“å‰ä»·æ ¼?.toFixed(2) || 'N/A';
                            row.insertCell(3).textContent = stock.å¯åŠ¨ä»·?.toFixed(2) || 'N/A';
                            row.insertCell(4).textContent = stock.åè½¬æ—¥æœŸ ? (typeof stock.åè½¬æ—¥æœŸ === 'string' ? stock.åè½¬æ—¥æœŸ : stock.åè½¬æ—¥æœŸ.toString()) : 'N/A';
                            row.insertCell(5).textContent = stock.æ¶¨åœæ—¥æœŸ ? (Array.isArray(stock.æ¶¨åœæ—¥æœŸ) ? stock.æ¶¨åœæ—¥æœŸ.join(', ') : stock.æ¶¨åœæ—¥æœŸ.toString()) : 'N/A';
                            row.insertCell(6).textContent = stock.å†å²æœ€å¤§é‡æ—¥æœŸ ? (typeof stock.å†å²æœ€å¤§é‡æ—¥æœŸ === 'string' ? stock.å†å²æœ€å¤§é‡æ—¥æœŸ : stock.å†å²æœ€å¤§é‡æ—¥æœŸ.toString()) : 'N/A';
                            row.insertCell(7).textContent = stock.æœˆæˆäº¤é‡æœ€å¤§æ—¥æœŸ ? (typeof stock.æœˆæˆäº¤é‡æœ€å¤§æ—¥æœŸ === 'string' ? stock.æœˆæˆäº¤é‡æœ€å¤§æ—¥æœŸ : stock.æœˆæˆäº¤é‡æœ€å¤§æ—¥æœŸ.toString()) : 'N/A';
                        });
                    } else if (foundStocks.length > 0) {
                        // å¦‚æœæ²¡æœ‰æœåŠ¡å™¨ç»“æœï¼Œä½¿ç”¨foundStocksæ•°ç»„
                        foundStocks.forEach(stock => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = stock.code;
                            row.insertCell(1).textContent = stock.name;
                            row.insertCell(2).textContent = stock.price?.toFixed(2) || stock.detail?.å½“å‰ä»·æ ¼?.toFixed(2) || 'N/A';
                            row.insertCell(3).textContent = stock.startup_price?.toFixed(2) || stock.detail?.å¯åŠ¨ä»·?.toFixed(2) || 'N/A';
                            row.insertCell(4).textContent = stock.reversal_date || stock.detail?.åè½¬æ—¥æœŸ || 'N/A';
                            row.insertCell(5).textContent = stock.detail?.æ¶¨åœæ—¥æœŸ?.join(', ') || 'N/A';
                            row.insertCell(6).textContent = stock.detail?.å†å²æœ€å¤§é‡æ—¥æœŸ || 'N/A';
                            row.insertCell(7).textContent = stock.detail?.æœˆæˆäº¤é‡æœ€å¤§æ—¥æœŸ || 'N/A';
                        });
                    }
                })
                .catch(error => {
                    console.error('è·å–ç»“æœå¤±è´¥:', error);
                    // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨foundStocksæ•°ç»„
                    if (foundStocks.length > 0) {
                        foundStocks.forEach(stock => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = stock.code;
                            row.insertCell(1).textContent = stock.name;
                            row.insertCell(2).textContent = stock.price?.toFixed(2) || stock.detail?.å½“å‰ä»·æ ¼?.toFixed(2) || 'N/A';
                            row.insertCell(3).textContent = stock.startup_price?.toFixed(2) || stock.detail?.å¯åŠ¨ä»·?.toFixed(2) || 'N/A';
                            row.insertCell(4).textContent = stock.reversal_date || stock.detail?.åè½¬æ—¥æœŸ || 'N/A';
                            row.insertCell(5).textContent = stock.detail?.æ¶¨åœæ—¥æœŸ?.join(', ') || 'N/A';
                            row.insertCell(6).textContent = stock.detail?.å†å²æœ€å¤§é‡æ—¥æœŸ || 'N/A';
                            row.insertCell(7).textContent = stock.detail?.æœˆæˆäº¤é‡æœ€å¤§æ—¥æœŸ || 'N/A';
                        });
                    }
                });
        }
        
        // å¯¼å‡ºç»“æœ
        function exportResults() {
            fetch('/api/export', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`âœ… ${data.message}\n\næ–‡ä»¶å·²ä¿å­˜åˆ°å½“å‰ç›®å½•: ${data.filename}`);
                    // å¯ä»¥æ·»åŠ ä¸‹è½½é“¾æ¥
                    window.location.href = `/${data.filename}`;
                } else {
                    alert('âŒ ' + data.message);
                }
            })
            .catch(error => {
                alert('å¯¼å‡ºå¤±è´¥: ' + error);
            });
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}åˆ†${secs}ç§’`;
        }
            
        // æ¡ä»¶å¼€å…³åˆ‡æ¢æ—¶æ˜¾ç¤º/éšè—å‚æ•°
        document.addEventListener('DOMContentLoaded', function() {
            for (let i = 1; i <= 8; i++) {
                const checkbox = document.getElementById(`cond${i}_enabled`);
                const params = document.getElementById(`cond${i}_params`);
                if (checkbox && params) {
                    checkbox.addEventListener('change', function() {
                        params.style.display = this.checked ? 'block' : 'none';
                    });
                    // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
                    params.style.display = checkbox.checked ? 'block' : 'none';
                }
            }
        });
    </script>
</body>
</html>

