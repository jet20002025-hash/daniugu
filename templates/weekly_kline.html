<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨çº¿Kçº¿å›¾ - è‚¡ç¥¨åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #FFFFFF;  // çº¯ç™½è‰²èƒŒæ™¯
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-box input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-box button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .search-box button:hover {
            transform: translateY(-2px);
        }
        
        .search-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            display: none;
        }
        
        .search-results.active {
            display: block;
        }
        
        .search-result-item {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: #f5f5f5;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .chart-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .chart-panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .chart-container {
            width: 100%;
            height: 600px;
        }
        
        .info-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .info-panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .stock-info {
            margin-bottom: 30px;
        }
        
        .stock-info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .stock-info-item:last-child {
            border-bottom: none;
        }
        
        .stock-info-label {
            color: #666;
            font-weight: 500;
        }
        
        .stock-info-value {
            color: #333;
            font-weight: bold;
        }
        
        .indicators {
            margin-top: 20px;
        }
        
        .indicator-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .indicator-item:last-child {
            border-bottom: none;
        }
        
        .indicator-label {
            color: #666;
            font-size: 14px;
        }
        
        .indicator-value {
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }
        
        .indicator-value.positive {
            color: #e74c3c;
        }
        
        .indicator-value.negative {
            color: #27ae60;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .progress-status {
            font-weight: 500;
            color: #667eea;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .note {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            color: #1976d2;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ å‘¨çº¿Kçº¿å›¾åˆ†æ</h1>
            <div class="search-box">
                <input type="text" id="stockSearch" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°æœç´¢ï¼ˆå¦‚ï¼š000001 æˆ– å¹³å®‰é“¶è¡Œï¼‰" autocomplete="off">
                <button onclick="searchStock()">æœç´¢</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <div class="main-content">
            <div class="chart-panel">
                <h2 id="chartTitle">è¯·æœç´¢è‚¡ç¥¨ä»£ç æŸ¥çœ‹å‘¨çº¿Kçº¿å›¾</h2>
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progressBar">0%</div>
                    </div>
                    <div class="progress-info">
                        <span class="progress-status" id="progressStatus">å‡†å¤‡åŠ è½½...</span>
                        <span id="progressDetail">-</span>
                    </div>
                </div>
                <div id="klineChart" class="chart-container"></div>
            </div>
            
            <div class="info-panel">
                <h2>è‚¡ç¥¨ä¿¡æ¯</h2>
                <div id="stockInfo" class="stock-info">
                    <div class="loading">ç­‰å¾…åŠ è½½...</div>
                </div>
                
                <h2 style="margin-top: 30px;">æŠ€æœ¯æŒ‡æ ‡ï¼ˆåŸºäºå‘¨çº¿ï¼‰</h2>
                <div id="indicators" class="indicators">
                    <div class="loading">ç­‰å¾…åŠ è½½...</div>
                </div>
                
                <div class="note">
                    <strong>ğŸ“Œ è¯´æ˜ï¼š</strong><br>
                    æ‰€æœ‰Kçº¿æ•°æ®å’ŒæŠ€æœ¯æŒ‡æ ‡éƒ½åŸºäºå‘¨çº¿æ•°æ®è¿›è¡Œåˆ†æ
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let klineChart = null;
        let currentStockCode = null;
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const chartDom = document.getElementById('klineChart');
            klineChart = echarts.init(chartDom);
            
            // è®¾ç½®é»˜è®¤ç©ºå›¾è¡¨
            const option = {
                title: {
                    text: 'è¯·æœç´¢è‚¡ç¥¨ä»£ç ',
                    left: 'center',
                    top: 'center',
                    textStyle: {
                        color: '#999',
                        fontSize: 20
                    }
                }
            };
            klineChart.setOption(option);
        }
        
        // æœç´¢è‚¡ç¥¨
        let searchTimeout = null;
        document.getElementById('stockSearch').addEventListener('input', function() {
            const keyword = this.value.trim();
            if (keyword.length < 2) {
                document.getElementById('searchResults').classList.remove('active');
                return;
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchStock(keyword);
            }, 300);
        });
        
        async function searchStock(keyword) {
            if (!keyword) {
                keyword = document.getElementById('stockSearch').value.trim();
            }
            
            if (!keyword) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°');
                return;
            }
            
            try {
                const response = await fetch('/api/search_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword: keyword })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                if (data.stocks && data.stocks.length > 0) {
                    showSearchResults(data.stocks);
                } else {
                    document.getElementById('searchResults').classList.remove('active');
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                alert('æœç´¢å¤±è´¥: ' + error.message);
            }
        }
        
        function showSearchResults(stocks) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            
            stocks.forEach(stock => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = `${stock.code} - ${stock.name}`;
                item.onclick = () => {
                    loadStockData(stock.code);
                    resultsDiv.classList.remove('active');
                    document.getElementById('stockSearch').value = `${stock.code} ${stock.name}`;
                };
                resultsDiv.appendChild(item);
            });
            
            resultsDiv.classList.add('active');
        }
        
        // æ˜¾ç¤ºè¿›åº¦æ¡
        function showProgress(percentage, status, detail) {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            const statusEl = document.getElementById('progressStatus');
            const detailEl = document.getElementById('progressDetail');
            
            container.classList.add('active');
            bar.style.width = percentage + '%';
            bar.textContent = percentage.toFixed(1) + '%';
            statusEl.textContent = status;
            detailEl.textContent = detail || '-';
        }
        
        // éšè—è¿›åº¦æ¡
        function hideProgress() {
            document.getElementById('progressContainer').classList.remove('active');
        }
        
        // åŠ è½½è‚¡ç¥¨æ•°æ®
        async function loadStockData(stockCode) {
            currentStockCode = stockCode;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('chartTitle').textContent = 'åŠ è½½ä¸­...';
            document.getElementById('stockInfo').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            document.getElementById('indicators').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            showProgress(0, 'å¼€å§‹åŠ è½½æ•°æ®...', '');
            
            try {
                // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
                showProgress(20, 'æ­£åœ¨è·å–å‘¨Kçº¿æ•°æ®...', '');
                
                // è·å–å‘¨Kçº¿æ•°æ®ï¼ˆæ·»åŠ è¶…æ—¶å¤„ç†ï¼‰
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ç§’è¶…æ—¶
                
                let response;
                try {
                    response = await fetch('/api/weekly_kline', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ code: stockCode }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                    }
                    throw error;
                }
                
                showProgress(60, 'æ­£åœ¨å¤„ç†Kçº¿æ•°æ®...', '');
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIå“åº”é”™è¯¯:', response.status, errorText);
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('æ”¶åˆ°æ•°æ®:', {
                    code: data.code,
                    name: data.name,
                    klineCount: data.kline ? data.kline.length : 0,
                    datesCount: data.dates ? data.dates.length : 0
                });
                
                if (data.error) {
                    console.error('æ•°æ®ä¸­åŒ…å«é”™è¯¯:', data.error);
                    throw new Error(data.error);
                }
                
                // éªŒè¯æ•°æ®å®Œæ•´æ€§
                if (!data.kline || !data.dates || data.kline.length === 0) {
                    console.error('æ•°æ®ä¸å®Œæ•´:', data);
                    throw new Error('è·å–çš„æ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡è¯•');
                }
                
                showProgress(80, 'æ­£åœ¨ç»˜åˆ¶Kçº¿å›¾...', '');
                
                // æ›´æ–°æ ‡é¢˜
                document.getElementById('chartTitle').textContent = `${data.name} (${data.code}) - å‘¨çº¿Kçº¿å›¾`;
                
                // ç»˜åˆ¶Kçº¿å›¾
                drawKlineChart(data);
                
                showProgress(90, 'æ­£åœ¨åŠ è½½æŠ€æœ¯æŒ‡æ ‡...', '');
                
                // æ˜¾ç¤ºè‚¡ç¥¨ä¿¡æ¯
                displayStockInfo(data);
                
                // è·å–å¹¶æ˜¾ç¤ºæŠ€æœ¯æŒ‡æ ‡
                await loadIndicators(stockCode);
                
                showProgress(100, 'åŠ è½½å®Œæˆï¼', '');
                
                // å»¶è¿Ÿéšè—è¿›åº¦æ¡
                setTimeout(() => {
                    hideProgress();
                }, 500);
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
                document.getElementById('chartTitle').textContent = 'åŠ è½½å¤±è´¥';
                document.getElementById('stockInfo').innerHTML = `<div class="error">é”™è¯¯: ${errorMsg}<br/><small>è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯</small></div>`;
                document.getElementById('indicators').innerHTML = `<div class="error">é”™è¯¯: ${errorMsg}</div>`;
                hideProgress();
            }
        }
        
        // ç»˜åˆ¶Kçº¿å›¾
        function drawKlineChart(data) {
            // å‡†å¤‡Kçº¿æ•°æ®ï¼ˆECharts candlestickæ ¼å¼ï¼š[å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]ï¼‰
            // æ³¨æ„ï¼šcandlestickç±»å‹çš„æ•°æ®ä¸éœ€è¦åŒ…å«æ—¥æœŸï¼Œæ—¥æœŸç”±xAxisæä¾›
            // æ£€æŸ¥åŸå§‹æ•°æ®æ ¼å¼
            console.log('åŸå§‹Kçº¿æ•°æ®ç¤ºä¾‹ï¼ˆå‰3æ¡ï¼‰:', data.kline.slice(0, 3));
            
            // ä»é”™è¯¯æ—¥å¿—çœ‹ï¼Œæ•°æ®é¡ºåºå¯èƒ½æ˜¯ï¼š[æœ€ä½, æœ€é«˜, å¼€ç›˜, æ”¶ç›˜] è€Œä¸æ˜¯ [å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]
            // å°è¯•è‡ªåŠ¨è¯†åˆ«æ•°æ®é¡ºåº
            const klineData = data.kline.map((k, idx) => {
                const val0 = Number(k[0]) || 0;
                const val1 = Number(k[1]) || 0;
                const val2 = Number(k[2]) || 0;
                const val3 = Number(k[3]) || 0;
                
                // å°è¯•ä¸¤ç§å¯èƒ½çš„é¡ºåº
                // é¡ºåº1ï¼š[å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]
                const test1 = {
                    open: val0,
                    close: val1,
                    low: val2,
                    high: val3,
                    score: 0
                };
                const minOC1 = Math.min(test1.open, test1.close);
                const maxOC1 = Math.max(test1.open, test1.close);
                if (test1.low > minOC1) test1.score += (test1.low - minOC1);
                if (test1.high < maxOC1) test1.score += (maxOC1 - test1.high);
                
                // é¡ºåº2ï¼š[æœ€ä½, æœ€é«˜, å¼€ç›˜, æ”¶ç›˜]
                const test2 = {
                    open: val2,
                    close: val3,
                    low: val0,
                    high: val1,
                    score: 0
                };
                const minOC2 = Math.min(test2.open, test2.close);
                const maxOC2 = Math.max(test2.open, test2.close);
                if (test2.low > minOC2) test2.score += (test2.low - minOC2);
                if (test2.high < maxOC2) test2.score += (maxOC2 - test2.high);
                
                // é€‰æ‹©åˆ†æ•°æ›´ä½çš„ï¼ˆæ›´ç¬¦åˆé€»è¾‘çš„ï¼‰
                let result;
                if (test1.score <= test2.score) {
                    result = test1;
                } else {
                    result = test2;
                    if (idx < 3) {
                        console.log(`Kçº¿[${idx}]ä½¿ç”¨é¡ºåº2ï¼š[æœ€ä½, æœ€é«˜, å¼€ç›˜, æ”¶ç›˜]`);
                    }
                }
                
                // æœ€ç»ˆä¿®æ­£
                const minOC = Math.min(result.open, result.close);
                const maxOC = Math.max(result.open, result.close);
                
                let finalLow = result.low;
                let finalHigh = result.high;
                
                if (result.low > minOC) {
                    finalLow = minOC;
                }
                if (result.high < maxOC) {
                    finalHigh = maxOC;
                }
                
                return [
                    result.open,   // å¼€ç›˜ä»·
                    result.close,  // æ”¶ç›˜ä»·
                    finalLow,      // æœ€ä½ä»·ï¼ˆä¸‹å½±çº¿ï¼‰
                    finalHigh      // æœ€é«˜ä»·ï¼ˆä¸Šå½±çº¿ï¼‰
                ];
            });
            
            // è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œæ£€æŸ¥æœ€ä½ä»·æ˜¯å¦ä¸åŒ
            console.log('Kçº¿æ•°æ®æœ€ä½ä»·æ£€æŸ¥ï¼ˆå‰10æ¡ï¼‰:');
            klineData.slice(0, 10).forEach((k, idx) => {
                console.log(`ç¬¬${idx+1}æ¡: å¼€ç›˜=${k[0].toFixed(2)}, æ”¶ç›˜=${k[1].toFixed(2)}, æœ€ä½=${k[2].toFixed(2)}, æœ€é«˜=${k[3].toFixed(2)}`);
            });
            
            // è¾“å‡ºKçº¿æ•°æ®ç”¨äºè°ƒè¯•
            console.log('Kçº¿æ•°æ®ç¤ºä¾‹ï¼ˆå‰5æ¡ï¼‰:', klineData.slice(0, 5));
            console.log('Kçº¿æ•°æ®æ€»æ•°:', klineData.length);
            
            // æ‰¾åˆ°æœ€ä½ç‚¹å’Œæœ€é«˜ç‚¹ç”¨äºYè½´èŒƒå›´å’Œæ ‡æ³¨
            let minPrice = Infinity;
            let maxPrice = 0;
            let minPriceIndex = -1;
            klineData.forEach((k, idx) => {
                const low = Number(k[2]);   // æœ€ä½ä»·
                const high = Number(k[3]);  // æœ€é«˜ä»·
                if (low > 0 && low < minPrice) {
                    minPrice = low;
                    minPriceIndex = idx;
                }
                if (high > maxPrice) {
                    maxPrice = high;
                }
            });
            
            // è®¡ç®—Yè½´èŒƒå›´ï¼ˆç•™å‡º5%çš„è¾¹è·ï¼‰
            const yAxisMin = minPrice > 0 && minPrice !== Infinity ? Math.floor(minPrice * 0.95 * 100) / 100 : 0;
            const yAxisMax = maxPrice > 0 ? Math.ceil(maxPrice * 1.05 * 100) / 100 : 100;
            
            const option = {
                title: {
                    text: `${data.name} (${data.code}) - å‘¨çº¿Kçº¿å›¾`,
                    left: 'center',
                    top: 5,
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: '#333'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(function(item) {
                            if (item.seriesName === 'Kçº¿') {
                                // candlestickç±»å‹çš„valueæ ¼å¼ï¼š[å¼€ç›˜, æ”¶ç›˜, æœ€ä½, æœ€é«˜]
                                const values = item.value;
                                if (Array.isArray(values) && values.length >= 4) {
                                    result += `${item.marker}${item.seriesName}<br/>`;
                                    // ç¡®ä¿å€¼æ˜¯æ•°å­—ç±»å‹
                                    const open = Number(values[0]) || 0;
                                    const close = Number(values[1]) || 0;
                                    const low = Number(values[2]) || 0;
                                    const high = Number(values[3]) || 0;
                                    result += `å¼€ç›˜: ${open.toFixed(2)}<br/>`;
                                    result += `æ”¶ç›˜: ${close.toFixed(2)}<br/>`;
                                    result += `æœ€ä½: ${low.toFixed(2)}<br/>`;
                                    result += `æœ€é«˜: ${high.toFixed(2)}<br/>`;
                                }
                            } else if (item.seriesName === 'æˆäº¤é‡') {
                                const volume = Number(item.value) || 0;
                                result += `${item.marker}${item.seriesName}: ${volume.toLocaleString()}<br/>`;
                            } else {
                                // ç¡®ä¿å€¼æ˜¯æ•°å­—ç±»å‹
                                const numValue = Number(item.value);
                                if (!isNaN(numValue)) {
                                    result += `${item.marker}${item.seriesName}: ${numValue.toFixed(2)}<br/>`;
                                } else {
                                    result += `${item.marker}${item.seriesName}: ${item.value}<br/>`;
                                }
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['Kçº¿', 'MA5', 'MA10', 'MA20', 'MA60', 'MA120', 'æˆäº¤é‡', 'VOL_MA5', 'VOL_MA20'],
                    top: 10,
                    left: 'center',
                    textStyle: {
                        fontSize: 12
                    },
                    itemGap: 15,
                    selectedMode: true  // å…è®¸ç‚¹å‡»å›¾ä¾‹æ˜¾ç¤º/éšè—
                },
                backgroundColor: '#FFFFFF',  // çº¯ç™½è‰²èƒŒæ™¯
                grid: [
                    {
                        left: '8%',
                        right: '8%',
                        top: '12%',
                        height: '60%',  // Kçº¿å›¾åŒºåŸŸï¼ˆä¸Šéƒ¨åˆ†ï¼‰
                        backgroundColor: '#FFFFFF'  // çº¯ç™½è‰²èƒŒæ™¯
                    },
                    {
                        left: '8%',
                        right: '8%',
                        top: '75%',
                        height: '18%',  // æˆäº¤é‡å›¾åŒºåŸŸï¼ˆä¸‹éƒ¨åˆ†ï¼‰
                        backgroundColor: '#FFFFFF'  // çº¯ç™½è‰²èƒŒæ™¯
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: data.dates,
                        scale: false,  // ä¸ä½¿ç”¨scaleï¼Œä¿æŒç­‰é—´è·
                        boundaryGap: true,  // è¾¹ç•Œç•™ç™½ï¼Œè®©Kçº¿ä»0å¼€å§‹æ˜¾ç¤º
                        axisLine: { 
                            onZero: true,  // åæ ‡è½´åœ¨0ä½ç½®
                            lineStyle: {
                                color: '#CCCCCC'  // æ·¡ç°è‰²åæ ‡è½´çº¿
                            }
                        },
                        axisLabel: {
                            color: '#666666',  // æ ‡ç­¾é¢œè‰²
                            rotate: 45,  // æ—‹è½¬45åº¦é¿å…é‡å 
                            interval: 'auto'  // è‡ªåŠ¨é—´éš”
                        },
                        splitLine: { show: false },
                        min: 0,  // ä»0å¼€å§‹
                        max: data.dates.length - 1  // åˆ°æœ€åä¸€ä¸ªæ•°æ®ç‚¹
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: data.dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        scale: true,  // ä½¿ç”¨scaleï¼Œè‡ªåŠ¨è°ƒæ•´ä»·æ ¼èŒƒå›´ï¼Œç¡®ä¿èƒ½æ˜¾ç¤ºæ‰€æœ‰ä¸åŒçš„æœ€ä½ä»·
                        splitArea: {
                            show: false  // å…³é—­åŒºåŸŸå¡«å……
                        },
                        splitLine: {
                            show: true,  // æ˜¾ç¤ºæ°´å¹³ç½‘æ ¼çº¿
                            lineStyle: {
                                color: '#E0E0E0',  // æ·¡ç°è‰²ç½‘æ ¼çº¿
                                width: 1,
                                type: 'solid'
                            }
                        },
                        axisLine: {
                            onZero: false,  // åæ ‡è½´ä¸åœ¨0ä½ç½®ï¼Œæ ¹æ®æ•°æ®è‡ªåŠ¨è°ƒæ•´
                            lineStyle: {
                                color: '#CCCCCC'  // æ·¡ç°è‰²åæ ‡è½´çº¿
                            }
                        },
                        axisLabel: {
                            formatter: function(value) {
                                return value.toFixed(2);
                            },
                            color: '#666666'  // æ ‡ç­¾é¢œè‰²
                        },
                        // ä¸è®¾ç½®minå’Œmaxï¼Œè®©EChartsè‡ªåŠ¨è®¡ç®—ï¼Œç¡®ä¿èƒ½æ˜¾ç¤ºæ‰€æœ‰ä¸åŒçš„æœ€ä½ä»·
                        // min: yAxisMin,
                        // max: yAxisMax
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitNumber: 4,
                        min: 0,  // æˆäº¤é‡Yè½´ä»0å¼€å§‹
                        axisLabel: { 
                            show: true,  // æ˜¾ç¤ºYè½´æ ‡ç­¾
                            formatter: function(value) {
                                // æ ¼å¼åŒ–æˆäº¤é‡æ˜¾ç¤ºï¼ˆä¸‡æ‰‹ï¼‰
                                if (value >= 10000) {
                                    return (value / 10000).toFixed(1) + 'ä¸‡';
                                } else if (value >= 1000) {
                                    return (value / 1000).toFixed(1) + 'åƒ';
                                }
                                return value.toFixed(0);
                            }
                        },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { 
                            show: true,
                            lineStyle: {
                                type: 'dashed',
                                opacity: 0.3
                            }
                        }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 70,
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1],
                        type: 'slider',
                        top: '95%',
                        start: 70,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'Kçº¿',
                        type: 'candlestick',
                        data: klineData,
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        large: false,  // å…³é—­å¤§æ•°æ®é‡ä¼˜åŒ–ï¼Œç¡®ä¿candlestickæ­£ç¡®æ˜¾ç¤º
                        itemStyle: {
                            color: '#e74c3c',        // ä¸Šæ¶¨é¢œè‰²ï¼ˆçº¢ï¼‰
                            color0: '#27ae60',       // ä¸‹è·Œé¢œè‰²ï¼ˆç»¿ï¼‰
                            borderColor: '#e74c3c',   // ä¸Šæ¶¨è¾¹æ¡†é¢œè‰²ï¼ˆçº¢ï¼‰
                            borderColor0: '#27ae60',   // ä¸‹è·Œè¾¹æ¡†é¢œè‰²ï¼ˆç»¿ï¼‰
                            borderWidth: 1,
                            shadowBlur: 0,
                            shadowColor: 'rgba(0,0,0,0)'
                        },
                        emphasis: {
                            focus: 'series',
                            itemStyle: {
                                borderWidth: 2,
                                shadowBlur: 10,
                                shadowColor: 'rgba(0,0,0,0.3)'
                            }
                        },
                        // ç§»é™¤æœ€ä½ç‚¹æ ‡æ³¨ï¼Œé¿å…æ˜¾ç¤ºå¼‚å¸¸
                        // markPoint: minPriceIndex >= 0 && minPrice > 0 ? {
                        //     data: [
                        //         {
                        //             name: 'æœ€ä½ç‚¹',
                        //             coord: [minPriceIndex, minPrice],
                        //             value: minPrice.toFixed(2),
                        //             symbol: 'pin',
                        //             symbolSize: 50,
                        //             itemStyle: {
                        //                 color: '#FF0000'
                        //             },
                        //             label: {
                        //                 formatter: `â†${minPrice.toFixed(2)}`,
                        //                 fontSize: 12,
                        //                 fontWeight: 'bold',
                        //                 color: '#FF0000',
                        //                 position: 'left'
                        //             }
                        //         }
                        //     ]
                        // } : {}
                    },
                    {
                        name: 'MA5',
                        type: 'line',
                        data: data.ma5,
                        smooth: true,  // çº¿æ¡å¹³æ»‘
                        lineStyle: { 
                            width: 2,
                            color: '#4169E1'  // è“è‰²
                        },
                        showSymbol: false,
                        z: 10  // ç¡®ä¿å‡çº¿åœ¨Kçº¿ä¸Šæ–¹
                    },
                    {
                        name: 'MA10',
                        type: 'line',
                        data: data.ma10,
                        smooth: true,  // çº¿æ¡å¹³æ»‘
                        lineStyle: { 
                            width: 2,
                            color: '#9370DB'  // ç´«è‰²
                        },
                        showSymbol: false,
                        z: 10
                    },
                    {
                        name: 'MA20',
                        type: 'line',
                        data: data.ma20,
                        smooth: true,  // çº¿æ¡å¹³æ»‘
                        lineStyle: { 
                            width: 2,
                            color: '#00BFFF'  // å¤©è“è‰²
                        },
                        showSymbol: false,
                        z: 10
                    },
                    {
                        name: 'MA60',
                        type: 'line',
                        data: data.ma60,
                        smooth: true,  // çº¿æ¡å¹³æ»‘
                        lineStyle: { 
                            width: 2,
                            color: '#FF8C00'  // æ©˜è‰²
                        },
                        showSymbol: false,
                        z: 10
                    },
                    {
                        name: 'MA120',
                        type: 'line',
                        data: data.ma120 || [],
                        smooth: true,  // çº¿æ¡å¹³æ»‘
                        lineStyle: { 
                            width: 2,
                            color: '#FF69B4'  // ç²‰è‰²
                        },
                        showSymbol: false,
                        z: 10
                    },
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: (function() {
                            // å¤„ç†æˆäº¤é‡æ•°æ®å¹¶æ·»åŠ è°ƒè¯•ä¿¡æ¯
                            const volumes = data.volumes.map((v, idx) => {
                                const volume = Number(v) || 0;
                                if (isNaN(volume) || volume < 0) {
                                    console.warn(`æˆäº¤é‡æ•°æ®å¼‚å¸¸ [${idx}]:`, v);
                                    return 0;
                                }
                                return volume;
                            });
                            
                            // è¾“å‡ºæˆäº¤é‡æ•°æ®èŒƒå›´ç”¨äºè°ƒè¯•
                            if (volumes.length > 0) {
                                const minVol = Math.min(...volumes.filter(v => v > 0));
                                const maxVol = Math.max(...volumes);
                                const avgVol = volumes.reduce((a, b) => a + b, 0) / volumes.length;
                                console.log('æˆäº¤é‡æ•°æ®ç»Ÿè®¡:', {
                                    min: minVol,
                                    max: maxVol,
                                    avg: avgVol,
                                    range: maxVol - minVol,
                                    ratio: (maxVol / minVol).toFixed(2) + ':1'
                                });
                            }
                            
                            return volumes;
                        })(),
                        barWidth: '60%',
                        barMaxWidth: 50,
                        itemStyle: {
                            color: function(params) {
                                // æ ¹æ®Kçº¿æ¶¨è·Œæ˜¾ç¤ºé¢œè‰²ï¼šçº¢æ¶¨ç»¿è·Œ
                                const kline = data.kline[params.dataIndex];
                                if (Array.isArray(kline) && kline.length >= 2) {
                                    const open = Number(kline[0]) || 0;
                                    const close = Number(kline[1]) || 0;
                                    return close >= open ? '#e74c3c' : '#27ae60';  // ä¸Šæ¶¨çº¢è‰²ï¼Œä¸‹è·Œç»¿è‰²
                                }
                                return '#999';
                            }
                        },
                        emphasis: {
                            focus: 'series'
                        }
                    },
                    {
                        name: 'VOL_MA5',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: data.volume_ma5 || [],
                        smooth: false,
                        lineStyle: { 
                            width: 1.5,
                            color: '#4169E1'  // è“è‰²ï¼ˆå¿«çº¿ï¼‰
                        },
                        showSymbol: false
                    },
                    {
                        name: 'VOL_MA20',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: data.volume_ma20 || [],
                        smooth: false,
                        lineStyle: { 
                            width: 1.5,
                            color: '#FF8C00'  // æ©™è‰²ï¼ˆæ…¢çº¿ï¼‰
                        },
                        showSymbol: false
                    }
                ],
                // åœ¨æœ€ä½ç‚¹æ ‡æ³¨ä»·æ ¼ï¼ˆä½¿ç”¨markPointæ›´ç®€å•å¯é ï¼‰
                // graphicé…ç½®å¯èƒ½å¯¼è‡´åŠ è½½é—®é¢˜ï¼Œæš‚æ—¶æ³¨é‡Šæ‰ï¼Œæ”¹ç”¨markPoint
                // graphic: minPriceIndex >= 0 ? [...] : []
            };
            
            // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œå…ˆæ¸…ç©ºå¹¶é‡æ–°åˆå§‹åŒ–
            if (klineChart) {
                klineChart.dispose();
            }
            
            const chartDom = document.getElementById('klineChart');
            klineChart = echarts.init(chartDom, null, {
                renderer: 'canvas'  // ä½¿ç”¨canvasæ¸²æŸ“ï¼Œç¡®ä¿candlestickæ­£ç¡®æ˜¾ç¤º
            });
            
            // è®¾ç½®å›¾è¡¨é€‰é¡¹ï¼ˆå®Œå…¨æ›¿æ¢ï¼‰
            klineChart.setOption(option, true);
            
            // éªŒè¯Kçº¿å›¾é…ç½®
            console.log('Kçº¿å›¾å·²è®¾ç½®ï¼Œç±»å‹: candlestick');
            console.log('Kçº¿æ•°æ®æ¡æ•°:', klineData.length);
            console.log('Kçº¿æ•°æ®ç¤ºä¾‹:', klineData.slice(0, 3));
            
            // å“åº”å¼è°ƒæ•´
            window.addEventListener('resize', function() {
                if (klineChart) {
                    klineChart.resize();
                }
            });
        }
        
        // æ˜¾ç¤ºè‚¡ç¥¨ä¿¡æ¯
        function displayStockInfo(data) {
            let html = `
                <div class="stock-info-item">
                    <span class="stock-info-label">è‚¡ç¥¨ä»£ç </span>
                    <span class="stock-info-value">${data.code}</span>
                </div>
                <div class="stock-info-item">
                    <span class="stock-info-label">è‚¡ç¥¨åç§°</span>
                    <span class="stock-info-value">${data.name}</span>
                </div>
                <div class="stock-info-item">
                    <span class="stock-info-label">å½“å‰ä»·æ ¼</span>
                    <span class="stock-info-value">${data.current_price ? data.current_price.toFixed(2) : 'N/A'} å…ƒ</span>
                </div>
                <div class="stock-info-item">
                    <span class="stock-info-label">æ€»å¸‚å€¼</span>
                    <span class="stock-info-value">${data.market_cap ? data.market_cap.toFixed(2) : 'N/A'} äº¿å…ƒ</span>
                </div>
                <div class="stock-info-item">
                    <span class="stock-info-label">å‘¨çº¿æ•°æ®</span>
                    <span class="stock-info-value">${data.total_weeks} å‘¨</span>
                </div>
            `;
            document.getElementById('stockInfo').innerHTML = html;
        }
        
        // åŠ è½½æŠ€æœ¯æŒ‡æ ‡
        async function loadIndicators(stockCode) {
            try {
                showProgress(95, 'æ­£åœ¨è®¡ç®—æŠ€æœ¯æŒ‡æ ‡...', '');
                
                const response = await fetch('/api/weekly_indicators', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: stockCode })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                let html = '';
                for (const [key, value] of Object.entries(data)) {
                    let valueStr = 'N/A';
                    let className = '';
                    
                    if (value !== null && value !== undefined) {
                        if (typeof value === 'number') {
                            if (key.includes('æ¶¨å¹…') || key.includes('ç›¸å¯¹') || key.includes('è·ç¦»')) {
                                valueStr = value.toFixed(2) + '%';
                                className = value >= 0 ? 'positive' : 'negative';
                            } else if (key.includes('å€æ•°')) {
                                valueStr = value.toFixed(2) + 'å€';
                            } else {
                                valueStr = value.toFixed(2);
                            }
                        } else {
                            valueStr = String(value);
                        }
                    }
                    
                    html += `
                        <div class="indicator-item">
                            <span class="indicator-label">${key}</span>
                            <span class="indicator-value ${className}">${valueStr}</span>
                        </div>
                    `;
                }
                
                document.getElementById('indicators').innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½æŠ€æœ¯æŒ‡æ ‡å¤±è´¥:', error);
                document.getElementById('indicators').innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­æœç´¢ç»“æœ
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-box')) {
                document.getElementById('searchResults').classList.remove('active');
            }
        });
        
        // åˆå§‹åŒ–
        initChart();
    </script>
</body>
</html>

