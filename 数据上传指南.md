# 📤 股票数据上传指南

## 📋 概述

本指南介绍如何将本地下载的股票数据上传到云存储，以便在 Render 环境中使用，减少网络请求压力。

---

## 📊 数据统计

- **cache 目录**: ~1.2GB，~35,937 个文件
- **stock_data 目录**: ~269MB，~10,938 个文件
- **总计**: ~1.5GB，~46,875 个文件

---

## 🚀 步骤 1：创建数据压缩包

### 执行上传脚本

```bash
cd /Users/zwj/股票分析
python3 upload_stock_data.py
```

脚本会：
1. 检查数据目录
2. 创建压缩包（`.tar.gz` 格式）
3. 显示压缩后大小
4. 提供上传选项

### 预期输出

```
============================================================
📦 创建数据上传包
============================================================
📊 cache 目录: 1200.00 MB, 35937 个文件
📊 stock_data 目录: 269.00 MB, 10938 个文件
📊 总计: 1469.00 MB, 46875 个文件

📦 正在创建压缩包: stock_data_20260126_120000.tar.gz
   这可能需要几分钟时间...
   添加 cache 目录...
   添加 stock_data 目录...
✅ 压缩包创建成功: stock_data_20260126_120000.tar.gz
   压缩后大小: 450.00 MB
   压缩率: 69.4%
```

---

## 📤 步骤 2：上传到云存储

### 方案一：GitHub Releases（推荐，免费）

#### 2.1 创建 GitHub Token

1. 访问 https://github.com/settings/tokens
2. 点击 "Generate new token (classic)"
3. 勾选 `repo` 权限
4. 生成并复制 Token

#### 2.2 设置环境变量

```bash
export GITHUB_TOKEN="your-token-here"
```

#### 2.3 上传

```bash
python3 upload_stock_data.py
# 选择选项 1（GitHub Releases）
```

或者手动上传：

1. 访问 https://github.com/jet20002025-hash/daniugu/releases
2. 点击 "Draft a new release"
3. 填写版本号（如 `data-20260126`）
4. 上传压缩包文件
5. 发布 Release

#### 2.4 获取下载 URL

发布后，复制下载链接，例如：
```
https://github.com/jet20002025-hash/daniugu/releases/download/data-20260126/stock_data_20260126_120000.tar.gz
```

---

### 方案二：其他云存储服务

#### AWS S3

```bash
aws s3 cp stock_data_*.tar.gz s3://your-bucket/stock_data.tar.gz
```

#### Google Cloud Storage

```bash
gsutil cp stock_data_*.tar.gz gs://your-bucket/stock_data.tar.gz
```

#### 阿里云 OSS

```bash
ossutil cp stock_data_*.tar.gz oss://your-bucket/stock_data.tar.gz
```

#### Cloudflare R2（免费，推荐）

1. 注册 Cloudflare 账号
2. 创建 R2 Bucket
3. 上传文件
4. 获取公开访问 URL

---

## ⚙️ 步骤 3：配置 Render 环境变量

### 在 Render Dashboard 设置

1. 访问 https://dashboard.render.com
2. 选择你的 Web 服务
3. 进入 **Environment** 标签
4. 添加环境变量：

**必需的环境变量**：
- `STOCK_DATA_URL` = `你的数据包下载URL`

**示例**：
```
STOCK_DATA_URL=https://github.com/jet20002025-hash/daniugu/releases/download/data-20260126/stock_data_20260126_120000.tar.gz
```

---

## 🔄 步骤 4：修改 Render 启动配置

### 选项 A：使用启动脚本（推荐）

修改 `Procfile`：

```
web: python render_start.sh
```

确保 `render_start.sh` 有执行权限（已设置）。

### 选项 B：在应用启动时自动下载

应用启动时会自动检查数据，如果不存在且设置了 `STOCK_DATA_URL`，会自动下载。

---

## ✅ 步骤 5：验证部署

### 检查日志

1. 访问 Render Dashboard → Logs
2. 查看启动日志，应该看到：
   ```
   📥 Render 数据下载工具
   📥 正在下载: https://...
   ✅ 下载完成
   📦 正在解压...
   ✅ 解压完成
   ✅ 数据下载并解压成功！
   ```

### 测试功能

1. 访问 https://daniugu.onrender.com
2. 执行一次扫描
3. 检查日志，确认使用了本地缓存数据

---

## 🔍 数据使用优先级

应用会按以下优先级使用数据：

1. **本地缓存** (`cache/` 目录)
2. **Redis 缓存** (如果配置了)
3. **网络实时获取** (如果缓存不存在)

---

## 💡 优化建议

### 1. 定期更新数据

建议每周更新一次数据包：

```bash
# 更新本地数据
python3 update_local_data.py

# 创建新的压缩包
python3 upload_stock_data.py

# 上传到 GitHub Releases
# 更新 STOCK_DATA_URL 环境变量
```

### 2. 增量更新

对于日常更新，可以只上传增量数据（新数据），而不是完整包。

### 3. 数据压缩

压缩包已经使用了 gzip 压缩，通常可以压缩到原来的 30-50%。

---

## 🐛 常见问题

### 问题 1：压缩包太大，GitHub 上传失败

**解决**：
- GitHub Releases 单个文件限制 2GB
- 如果超过，可以分多个文件上传
- 或使用其他云存储服务

### 问题 2：Render 下载超时

**解决**：
- 检查网络连接
- 使用 CDN 加速的下载链接
- 增加下载超时时间

### 问题 3：解压后数据不完整

**解决**：
- 检查压缩包是否完整
- 重新上传
- 检查磁盘空间

---

## 📝 文件说明

- `upload_stock_data.py` - 数据上传脚本
- `download_stock_data.py` - 数据下载脚本
- `render_start.sh` - Render 启动脚本（可选）

---

## ✅ 完成！

配置完成后，Render 环境会：
- ✅ 自动下载股票数据
- ✅ 使用本地缓存，减少网络请求
- ✅ 提高扫描速度
- ✅ 降低 API 调用压力

如有问题，查看 Render Dashboard → Logs 获取详细错误信息。
